# 上线部署指南（微信云托管）

当前部署方式：GitHub 推送 → 微信云托管自动构建部署
控制台：https://cloud.weixin.qq.com/cloudrun/service/backend
环境：prod（上海）| 环境ID：prod-7g0s09nb52f17608

---

## 日常更新

本地改完代码，一条命令搞定：

```bash
git add -A && git commit -m "描述" && git push
```

推送后云托管自动触发构建，5~10 分钟后生效。
在控制台「部署发布」页可以看到构建进度。

---

## 首次部署 / 重建环境

在云托管控制台 → backend 服务 → 服务设置 → 环境变量，配置以下变量：

- SPRING_DATASOURCE_URL：MySQL 内网连接地址
- SPRING_DATASOURCE_USERNAME：数据库用户名
- SPRING_DATASOURCE_PASSWORD：数据库密码
- APP_AUTH_JWT_SECRET：JWT 密钥（32位以上）
- FLYWAY_ENABLED：false（云端固定，禁止改为 true）
- WECHAT_MP_APPID：小程序 AppID
- WECHAT_MP_SECRET：小程序 AppSecret

---

## 数据库迁移

⚠️ 云端为 `FLYWAY_ENABLED=false`，Flyway 脚本不会自动执行。

正确做法：

1. 在 `backend/src/main/resources/db/migration/` 编写 `V*.sql`（用于版本留痕）。
2. 同步在微信云托管数据库面板手工执行对应 SQL。
3. 执行后必须做字段/索引/接口冒烟校验。

发布前请按清单逐项执行：

- `deployment/云端SQL发布检查清单.md`

发布门禁（强制）：

- 未执行云端 SQL：禁止发布
- 已执行但未校验：禁止发布
- 冒烟失败：立即停止发布并回滚

---

## 部署后初始化（仅新环境或数据清空后才需要）

登录云端系统，浏览器 F12 控制台执行：

```javascript
fetch("/api/internal/maintenance/reinit-process-tracking", {
  method: "POST", headers: {"Content-Type": "application/json"}
}).then(r=>r.json()).then(console.log)
```

返回 {code: 200} 即成功。

---

## 数据库备份

```bash
./deployment/backup-cloud-database.sh   # 云端数据库
./deployment/backup-database.sh         # 本地开发数据库
```

---

## 小程序发布

见 deployment/小程序发布指南.md

---

## 常见问题

推上去没生效 → 看控制台「部署发布」构建日志
数据库异常（Unknown column / 缺索引）→ 优先检查云端 SQL 是否已手工执行并校验
小程序扫码 404 → 检查小程序 config.js 里的 baseUrl 是否指向云托管服务域名

---

## ⚠️ 重要：防止容器休眠导致的接口报错

### 问题现象
日志反复出现：`Thread starvation or clock leap detected (housekeeper delta=15m...)`
首个请求/唤醒后第一次操作偶发报错（数据库连接失效）

### 根本原因
微信云托管在无流量时会自动**冻结容器**（约16分钟），JVM 被暂停后：
1. HikariCP 内的空闲连接被 MySQL 断开（变成死连接）
2. 容器唤醒后第一个请求用到死连接 → 报错
3. 这就是为什么本地开发好好的，上了云就出问题

### 解决方式（二选一，推荐同时做）

**方式1：控制台设置最小实例数为 1（最根本）**
> 微信云托管控制台 → backend 服务 → 服务设置 → 扩缩容配置 → **最小实例数设为 1**
> 
> 这样容器永不休眠，无需等待冷启动，接口响应稳定。
> 注意：会产生少量费用（按实例运行时间计费）

**方式2：HikariCP 配置已优化（已提交）**
> `application-prod.yml` 已将 `minimum-idle` 改为 `0`，添加了 `keepalive-time: 120000`
> 
> 容器唤醒后 HikariCP 会自动创建新连接，不再使用死连接  
> 但首个请求仍有约 1~3 秒建连延迟（无法完全消除）
