# 上线部署指南（微信云托管）

> 目标：让外网可以访问 PC 管理后台 + 小程序正常扫码

---

## 第一步：准备工作（今天做，30分钟）

### 1.1 生成强密码和密钥

在终端运行以下命令，分别生成密码和密钥：

```bash
# 生成 MySQL 密码
openssl rand -base64 24

# 生成 Redis 密码
openssl rand -base64 24

# 生成 JWT 密钥（必须32位以上）
openssl rand -base64 48
```

把生成的值填到 `deployment/.env` 文件（复制 `.env.example` 改名）。

### 1.2 获取微信小程序 AppID 和 Secret

- 打开 [mp.weixin.qq.com](https://mp.weixin.qq.com)
- 登录小程序账号 → 开发 → 开发管理 → 开发设置
- 复制 **AppID** 和 **AppSecret** 填入 `.env`

---

## 第二步：开通微信云托管（30分钟）

1. 打开**微信开发者工具**
2. 顶部菜单 → **云开发** → 进入云开发控制台
3. 左侧 → **云托管** → 点击**开通服务**
4. 选择地域：**上海**（国内访问最快）
5. 记录下你的 **环境ID**（格式：`cloud1-xxxxxx`）

---

## 第三步：创建云数据库（20分钟）

在云托管控制台 → **数据库** → **新建数据库**：

| 配置项 | 值 |
|--------|-----|
| 数据库类型 | MySQL 8.0 |
| 规格 | 1核2G（初期够用，后续可升级）|
| 存储空间 | 50G |
| 数据库名 | fashion_supplychain |

创建完成后记录：
- **内网地址**（格式：`gz-xxx.sql.tencentcdb.com`）
- **端口**（通常是 3306 或随机端口）
- **用户名/密码**（你设置的）

---

## 第四步：创建 Redis（10分钟）

云托管控制台 → **Redis** → **新建**：

| 配置项 | 值 |
|--------|-----|
| 规格 | 256M（初期够用）|
| 密码 | 用第一步生成的 Redis 密码 |

创建后记录内网地址。

---

## 第五步：部署后端服务（30分钟）

云托管控制台 → **服务列表** → **新建服务**：

**服务名称**：`backend`  
**监听端口**：`8088`  
**部署方式**：上传代码包 或 Docker 镜像

**方式一（推荐）：直接上传代码**
```bash
# 在项目根目录
cd /你的项目路径/服装66666/backend
# 打包
mvn package -DskipTests
# 整个 backend 目录上传到云托管
```

**方式二：本地构建镜像推送**
```bash
cd backend
docker build -t ccr.ccs.tencentyun.com/你的仓库/fashion-backend:latest .
docker push ccr.ccs.tencentyun.com/你的仓库/fashion-backend:latest
```

**在云托管控制台配置环境变量**（关键步骤）：

```
PORT=8088
SPRING_DATASOURCE_URL=jdbc:mysql://你的MySQL内网地址:端口/fashion_supplychain?useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
SPRING_DATASOURCE_USERNAME=root
SPRING_DATASOURCE_PASSWORD=你的MySQL密码
SPRING_REDIS_HOST=你的Redis内网地址
SPRING_REDIS_PORT=6379
SPRING_REDIS_PASSWORD=你的Redis密码
APP_AUTH_JWT_SECRET=你生成的JWT密钥
WECHAT_MP_APPID=你的小程序AppID
WECHAT_MP_SECRET=你的小程序Secret
WECHAT_MINI_PROGRAM_MOCK_ENABLED=false
FLYWAY_ENABLED=true
FASHION_DB_INITIALIZER_ENABLED=false
APP_CORS_ALLOWED_ORIGIN_PATTERNS=https://*.tcloudbase.com,https://*.ap-shanghai.service.tcloudbase.com
```

健康检查路径：`/actuator/health/liveness`

---

## 第六步：初始化数据库（10分钟）

后端第一次启动会自动执行 Flyway 迁移脚本，自动建表。  
如果需要手动导入现有数据：

```bash
# 从本地导出
docker exec fashion-mysql-simple mysqldump -uroot -pchangeme fashion_supplychain > 数据备份_$(date +%Y%m%d).sql

# 上传到云数据库（在云控制台执行或用 MySQL 客户端连接）
mysql -h云MySQL地址 -P端口 -u用户名 -p密码 fashion_supplychain < 数据备份.sql
```

---

## 第七步：部署前端服务（20分钟）

云托管控制台 → **服务列表** → **新建服务**：

**服务名称**：`frontend`  
**监听端口**：`80`  

**环境变量**：
```
BACKEND_URL=http://backend:8088
```

> `http://backend:8088` 是微信云托管内网地址，后端服务名就是 `backend`，无需改动。

---

## 第八步：获取访问链接（5分钟）

部署完成后，云托管控制台 → 服务详情 → **默认域名**：

```
PC管理后台：
https://前端服务ID.ap-shanghai.service.tcloudbase.com

后端API（供测试）：
https://后端服务ID.ap-shanghai.service.tcloudbase.com/actuator/health
```

把 **PC 管理后台链接**发给所有管理员，让他们收藏到浏览器书签即可。

---

## 第九步：配置微信小程序（10分钟）

小程序需要配置合法域名才能请求后端：

1. 登录 [mp.weixin.qq.com](https://mp.weixin.qq.com)
2. 开发 → 开发管理 → 开发设置 → **服务器域名**
3. **request 合法域名** 添加：
   ```
   https://后端服务默认域名.ap-shanghai.service.tcloudbase.com
   ```
4. 打开 `miniprogram/utils/request.js`（或 config），把 `BASE_URL` 改为上面的后端地址

---

## 验证上线成功

```
✅ 打开 PC 管理后台默认域名，能看到登录页
✅ 用 admin 账号登录成功
✅ 小程序扫码，后台能看到扫码记录
✅ 后端健康检查：https://后端域名/actuator/health 返回 {"status":"UP"}
```

---

## 费用参考（月）

| 项目 | 规格 | 月费 |
|------|------|------|
| 后端容器 | 2核4G × 1实例 | ¥150-250 |
| 前端容器 | 0.5核1G × 1实例 | ¥20-40 |
| MySQL | 1核2G，50G | ¥150-250 |
| Redis | 256M | ¥20-40 |
| 流量费 | 按实际 | ¥10-50 |
| **合计** | | **约 ¥350-600/月** |

> 扫码人数多时后端自动扩容，费用相应增加。
