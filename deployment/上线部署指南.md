# 上线部署指南（微信云托管）

当前部署方式：GitHub 推送 → 微信云托管自动构建部署
控制台：https://cloud.weixin.qq.com/cloudrun/service/backend
环境：prod（上海）| 环境ID：prod-7g0s09nb52f17608

---

## 日常更新

本地改完代码，一条命令搞定：

```bash
git add -A && git commit -m "描述" && git push
```

推送后云托管自动触发构建，5~10 分钟后生效。
在控制台「部署发布」页可以看到构建进度。

---

## 首次部署 / 重建环境

在云托管控制台 → backend 服务 → 服务设置 → 环境变量，配置以下变量：

- SPRING_DATASOURCE_URL：MySQL 内网连接地址
- SPRING_DATASOURCE_USERNAME：数据库用户名
- SPRING_DATASOURCE_PASSWORD：数据库密码
- APP_AUTH_JWT_SECRET：JWT 密钥（32位以上）
- FLYWAY_ENABLED：true
- WECHAT_MP_APPID：小程序 AppID
- WECHAT_MP_SECRET：小程序 AppSecret

---

## 数据库迁移

后端启动时 Flyway 自动执行，无需手动操作。
迁移脚本在 backend/src/main/resources/db/migration/ 目录下。

---

## 部署后初始化（仅新环境或数据清空后才需要）

登录云端系统，浏览器 F12 控制台执行：

```javascript
fetch("/api/internal/maintenance/reinit-process-tracking", {
  method: "POST", headers: {"Content-Type": "application/json"}
}).then(r=>r.json()).then(console.log)
```

返回 {code: 200} 即成功。

---

## 数据库备份

```bash
./deployment/backup-cloud-database.sh   # 云端数据库
./deployment/backup-database.sh         # 本地开发数据库
```

---

## 小程序发布

见 deployment/小程序发布指南.md

---

## 常见问题

推上去没生效 → 看控制台「部署发布」构建日志
数据库异常 → 看运行日志里的 Flyway 报错，或检查环境变量是否正确
小程序扫码 404 → 检查小程序 config.js 里的 baseUrl 是否指向云托管服务域名
