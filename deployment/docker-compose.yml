version: '3.8'

services:
  # MySQL 数据库
  mysql:
    image: mysql:8.0
    container_name: fashion-mysql-prod
    restart: always
    environment:
      MYSQL_DATABASE: fashion_supplychain
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: Asia/Shanghai
    command: --default-authentication-plugin=mysql_native_password --max_connections=100 --innodb_buffer_pool_size=512M --default-time-zone='+08:00'
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql/init:/docker-entrypoint-initdb.d
    networks:
      - fashion-net
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    security_opt:
      - no-new-privileges:true
    read_only: false

  # 后端服务
  backend:
    image: openjdk:17-slim
    container_name: fashion-backend
    restart: always
    working_dir: /app
    ports:
      - "8088:8088"
    volumes:
      # 这里假设你已经把打好的 jar 包放在了同级目录，或者你可以改成构建镜像
      - ./backend.jar:/app/app.jar
      - ./logs:/logs
      - ./uploads:/uploads
    command: java -Xmx1536m -Xms512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/logs -jar /app/app.jar --spring.profiles.active=prod
    environment:
      PORT: 8088
      TZ: Asia/Shanghai
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/fashion_supplychain?useUnicode=true&characterEncoding=utf-8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true&createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 20
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 5
      SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT: 30000
      APP_AUTH_JWT_SECRET: ${JWT_SECRET}
      # 生产环境通常把上传文件映射到外部 volume
      FASHION_UPLOAD_PATH: /uploads/
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - fashion-net
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Nginx (前端 + 反向代理)
  nginx:
    image: nginx:alpine
    container_name: fashion-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # 前端构建产物 (dist)
      - ./dist:/usr/share/nginx/html
      # Nginx 配置
      - ./nginx/conf.d:/etc/nginx/conf.d
      # SSL 证书 (如果需要 HTTPS)
      # - ./cert:/etc/nginx/cert
    depends_on:
      - backend
    networks:
      - fashion-net
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  mysql_data:
    driver: local

networks:
  fashion-net:
    driver: bridge
