# 云端 SQL 发布检查清单（Flyway 关闭场景）

> 适用范围：微信云托管环境（`FLYWAY_ENABLED=false`）
> 
> 目标：防止“代码已发布，云端库未变更”导致线上报错

---

## 1. 发布前检查（必须全部通过）

- [ ] 本次发布涉及数据库变更（新增表/字段/索引/约束）已识别清楚
- [ ] 对应迁移脚本已写入 `backend/src/main/resources/db/migration/`
- [ ] 已整理出“云端手工执行 SQL 清单”（按执行顺序）
- [ ] 已确认 SQL 幂等性（重复执行不会破坏数据）
- [ ] 已准备回滚 SQL（至少包含 `DROP INDEX` / `DROP COLUMN` 或替代回滚策略）
- [ ] 已指定执行人、复核人、执行时间窗口

---

## 2. 云端执行步骤（标准流程）

### Step A：备份

- [ ] 在云端数据库面板执行备份（或导出关键表）
- [ ] 记录备份文件名与时间

### Step B：手工执行 SQL

- [ ] 登录微信云托管控制台数据库面板
- [ ] 按顺序执行 SQL（禁止跳步）
- [ ] 每条 SQL 执行后截图或复制执行结果

### Step C：结构校验

- [ ] 新列校验：`SHOW COLUMNS FROM <table> LIKE '<column>';`
- [ ] 新索引校验：`SHOW INDEX FROM <table> WHERE Key_name = '<index_name>';`
- [ ] 新表校验：`SHOW TABLES LIKE '<table_name>';`

### Step D：接口冒烟

- [ ] 访问受影响核心接口，确认不报 500/SQL 异常
- [ ] 关键链路最少验证 1 次（开发→生产→出入库）

---

## 3. 发布门禁（必须遵守）

- [ ] 云端 SQL 未执行完成：禁止合并/禁止发版
- [ ] 云端 SQL 已执行但未校验：禁止发版
- [ ] 冒烟失败：立即停止发布，回滚 SQL 或回滚代码

---

## 4. 执行记录模板（每次发布都要填）

## 发布信息
- 发布版本：
- 发布时间：
- 执行人：
- 复核人：
- 是否涉及 DB 变更：是 / 否

## SQL 清单与执行结果
| 序号 | SQL 摘要 | 执行时间 | 执行结果 | 证据（截图/日志） |
|---|---|---|---|---|
| 1 | `V20260227a` — 创建 `t_intelligence_process_stats` 工序统计表 | 2026-02-27 | ✅ 成功，耗时 16ms | 截图已确认字段结构 |
| 2 | `V20260227a` — 创建 `t_intelligence_prediction_log` 预测日志表 | 2026-02-27 | ✅ 成功，耗时 37ms | 截图已确认字段结构 |
|---|---|---|---|---|
| 1 |  |  | 成功/失败 |  |
| 2 |  |  | 成功/失败 |  |
| 3 |  |  | 成功/失败 |  |

## 校验结果
| 校验项 | 命令/接口 | 结果 | 备注 |
|---|---|---|---|
| 字段校验 | `SHOW COLUMNS ...` | 通过/失败 |  |
| 索引校验 | `SHOW INDEX ...` | 通过/失败 |  |
| 冒烟接口 | `/api/...` | 通过/失败 |  |

## 结论
- 是否允许发布：允许 / 不允许
- 异常与处理：

---

## 5. 常见错误与处理

### 1) 代码已发布，接口报 “Unknown column”
原因：云端未执行加列 SQL。
处理：立刻执行对应 SQL，执行后重试接口。

### 2) 慢查询突然出现
原因：新索引未在云端执行。
处理：补执行索引 SQL，并复测响应时间。

### 3) 执行 SQL 报语法错误（MySQL 版本差异）
原因：云端 MySQL 不支持部分语法（如 `DROP INDEX IF EXISTS`）。
处理：改为兼容语法后重试，记录调整内容。

---

## 6. 建议的最小自动化（可选）

即使 Flyway 关闭，也建议在发布流程增加“人工确认闸门”：

- [ ] PR 模板增加：`[ ] 云端 SQL 已执行并校验`
- [ ] 发布单必须附执行记录截图
- [ ] 复核人签字后再推送生产
