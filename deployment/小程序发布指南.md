# 📱 小程序发布指南

> **重要**：小程序不需要打包到云服务器！它运行在用户手机的微信客户端上。

## 📊 小程序工作原理

```
用户手机微信 → 小程序 → API请求 → 云服务器后端(106.53.5.62:8088)
             ↑
        微信服务器
     （代码托管+分发）
```

## 🚀 小程序发布流程

### 第一步：配置服务器域名（只需一次）

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入：**开发 → 开发管理 → 开发设置**
3. 配置 **request合法域名**：
   ```
   https://你的域名.com
   ```
   ⚠️ **必须是HTTPS**，不能用IP地址

   如果暂时没有域名，开发阶段可以：
   - 在微信开发者工具勾选 **不校验合法域名**
   - 但正式发布必须配置HTTPS域名

### 第二步：修改小程序API地址

编辑 `miniprogram/config.js`：

```javascript
// 开发环境（本地测试）
const DEV_API_BASE = 'http://localhost:8088';

// 生产环境（云服务器）
const PROD_API_BASE = 'https://你的域名.com';  // 或 'http://106.53.5.62:8088'（仅限开发）

// 当前使用的环境
const isDev = false;  // 改为 false 使用生产环境

module.exports = {
  apiBaseUrl: isDev ? DEV_API_BASE : PROD_API_BASE,
  // ... 其他配置
};
```

### 第三步：微信开发者工具上传

1. **打开项目**：
   ```bash
   # 使用微信开发者工具打开
   miniprogram/
   ```

2. **检查AppID**：
   - 确认 `project.config.json` 中 `appid` 正确
   - 当前：`wx6d92fb9db5a7bfb4`

3. **编译测试**：
   - 点击 **编译** 按钮
   - 在模拟器中测试所有功能
   - 特别测试：扫码、订单、对账等核心功能

4. **上传代码**：
   - 点击右上角 **上传** 按钮
   - 填写版本号（如 `1.0.0`）
   - 填写项目备注（如 `初始版本`）
   - 点击 **上传**

### 第四步：微信公众平台提交审核

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入：**版本管理 → 开发版本**
3. 找到刚上传的版本，点击 **提交审核**
4. 填写审核信息：
   - **功能描述**：服装供应链管理系统
   - **测试账号**：admin / admin123
   - **测试说明**：提供订单管理、扫码生产、对账等功能
5. 提交后等待审核（通常1-7天）

### 第五步：发布上线

1. 审核通过后，在 **版本管理** 页面
2. 点击 **提交发布**
3. 发布后，所有用户即可在微信中使用小程序

## 🔒 HTTPS证书配置（必需）

### 方案1：使用免费证书（推荐）

使用 Let's Encrypt 免费证书：

```bash
# 在云服务器上安装 certbot
yum install -y certbot python3-certbot-nginx

# 申请证书（需要先有域名）
certbot --nginx -d 你的域名.com

# 自动续期
certbot renew --dry-run
```

### 方案2：购买证书

1. 在腾讯云/阿里云购买SSL证书
2. 下载Nginx格式证书
3. 上传到服务器 `deployment/cert/` 目录
4. 修改 `nginx/conf.d/default.conf`

## ⚙️ 小程序版本管理

### 开发版本
- 仅管理员可见
- 用于内部测试
- 无需审核

### 体验版本
- 可添加体验成员
- 用于灰度测试
- 无需审核

### 正式版本
- 所有用户可见
- 需要审核
- 发布后全量上线

## 📋 发布前检查清单

- [ ] API地址已改为生产环境
- [ ] 所有功能测试通过
- [ ] 已配置服务器域名（HTTPS）
- [ ] AppID正确
- [ ] 版本号和备注填写清晰
- [ ] 准备好测试账号和说明
- [ ] 云服务器后端已部署且正常运行

## 🐛 常见问题

### 1. 小程序无法访问API

**原因**：域名未配置或非HTTPS

**解决**：
- 开发阶段：勾选 **不校验合法域名**
- 正式发布：配置HTTPS域名

### 2. 上传失败

**原因**：代码包超过2MB限制

**解决**：
- 删除 `node_modules` 目录
- 检查 `project.config.json` 中 `packOptions.ignore`

### 3. 审核不通过

**常见原因**：
- 功能描述不清晰
- 缺少测试账号
- 违反微信规范

**解决**：根据审核意见修改后重新提交

## 📊 小程序数据监控

发布后可在微信公众平台查看：
- **数据分析**：访问量、用户数、使用时长
- **实时日志**：错误日志、调用日志
- **运维中心**：性能监控、告警通知

---

**总结**：小程序是独立发布的，不需要打包到云服务器。云服务器只负责提供API接口。
