# æœè£…ä¾›åº”é“¾ç³»ç»Ÿ - å¼€å‘æŒ‡å—

**ç³»ç»Ÿè¯„åˆ†**: 96/100  
**æ–‡æ¡£ç‰ˆæœ¬**: 3.0  
**æœ€åæ›´æ–°**: 2026-01-29

> âš ï¸ **è®¾è®¡è§„èŒƒå¼ºåˆ¶æ‰§è¡Œ**ï¼šæ‰€æœ‰æ–°ä»£ç å¿…é¡»éµå¾ª[è®¾è®¡ç³»ç»Ÿå®Œæ•´è§„èŒƒ-2026.md](è®¾è®¡ç³»ç»Ÿå®Œæ•´è§„èŒƒ-2026.md)ï¼Œè¿åè€…æ— æ³•é€šè¿‡Code Reviewã€‚

---

## ğŸ¨ è®¾è®¡ç³»ç»Ÿè§„èŒƒï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰

### å¿…è¯»æ–‡æ¡£
- **[è®¾è®¡ç³»ç»Ÿå®Œæ•´è§„èŒƒ-2026.md](è®¾è®¡ç³»ç»Ÿå®Œæ•´è§„èŒƒ-2026.md)** - å®Œæ•´è®¾è®¡è§„èŒƒv3.0ï¼ˆå­—ä½“ã€é¢œè‰²ã€ç»„ä»¶ã€é—´è·ï¼‰

### æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼ˆDesign Tokené©±åŠ¨ï¼‰

#### 1. å­—ä½“ç³»ç»Ÿï¼ˆTypographyï¼‰
```css
/* âœ… å…¨å±€é»˜è®¤å­—ä½“ï¼ˆå¼ºåˆ¶ä½¿ç”¨ï¼‰ */
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 
             'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei',
             'Roboto', 'Helvetica Neue', 'Arial', sans-serif;
```

**å­—ä½“è§„èŒƒ**ï¼š
- **åŸºå‡†å­—å·**: 14pxï¼ˆæ­£æ–‡ï¼‰
- **å­—æ®µæ ‡ç­¾**: 13px / 600å­—é‡
- **é‡è¦å­—æ®µå€¼**: 18px / 700å­—é‡
- **é¡µé¢æ ‡é¢˜**: 20px+ / 700å­—é‡
- âŒ **ç¦æ­¢**ï¼šè‡ªå®šä¹‰font-familyï¼ˆæ‰“å°é¡µé¢é™¤å¤–éœ€å®¡æ‰¹ï¼‰

#### 2. é¢œè‰²ç³»ç»Ÿï¼ˆçº¯è‰²ï¼Œæ‹’ç»æ¸å˜ï¼‰
```css
/* ä¸»è‰²è°ƒ - çº¯è“è‰² */
--primary-color: #2D7FF9;
--primary-hover: #1E6FE8;
--primary-active: #0F5BD7;

/* åŠŸèƒ½è‰² - çº¯è‰² */
--success-color: #52C41A;   /* æˆåŠŸ */
--warning-color: #FAAD14;   /* è­¦å‘Š */
--error-color: #F5222D;     /* é”™è¯¯ */

/* ä¸­æ€§è‰² */
--neutral-text: #1a1a1a;    /* ä¸»æ–‡å­— */
--neutral-white: #FFFFFF;   /* çº¯ç™½ */
--neutral-border: #E0E0E0;  /* è¾¹æ¡† */
```

**é¢œè‰²ä½¿ç”¨è§„åˆ™**ï¼š
- âœ… **å¼ºåˆ¶ä½¿ç”¨CSSå˜é‡**ï¼š`var(--primary-color)`
- âŒ **ç¦æ­¢ç¡¬ç¼–ç **ï¼š`#2D7FF9` ç›´æ¥å†™åœ¨ç»„ä»¶é‡Œ
- âŒ **ç¦æ­¢æ¸å˜**ï¼š`linear-gradient()` ä¸€å¾‹ä¸å…è®¸
- âœ… **ä¾§è¾¹æ **: çº¯æ·±è“ï¼ˆ#0b2d5cï¼Œæ— æ¸å˜ï¼‰
- âœ… **æŒ‰é’®**: çº¯è‰²èƒŒæ™¯ï¼Œæ— é˜´å½±æ¸å˜

#### 3. é—´è·ç³»ç»Ÿï¼ˆSpacingï¼‰
```css
--spacing-xs: 8px;      /* è¶…å°é—´è· */
--spacing-sm: 12px;     /* å°é—´è· */
--spacing-md: 16px;     /* ä¸­ç­‰é—´è· */
--spacing-lg: 24px;     /* å¤§é—´è· */
--spacing-xl: 32px;     /* è¶…å¤§é—´è· */
```

**é—´è·åŸåˆ™**ï¼š
- âœ… **ä½¿ç”¨8çš„å€æ•°**ï¼š8/16/24/32/48
- âŒ **ç¦æ­¢éæ ‡å‡†å€¼**ï¼š10px/15px/20pxç­‰
- âœ… **Modalå­—æ®µé—´è·**: 24pxï¼ˆModalFieldRowé»˜è®¤ï¼‰

#### 4. å¼¹çª—è§„èŒƒï¼ˆModal - ä¸‰çº§å°ºå¯¸ä½“ç³»ï¼‰
```tsx
/* âœ… å¤§çª—å£ï¼ˆ60vw Ã— 60vhï¼‰- ä¸»è¦å¼¹çª— */
<ResizableModal
  title="ç¼–è¾‘ç”Ÿäº§è®¢å•"
  visible={visible}
  defaultWidth="60vw"
  defaultHeight="60vh"
>
  {/* å¤æ‚è¡¨å•ã€å¤šTabå†…å®¹ */}
</ResizableModal>

/* âœ… ä¸­çª—å£ï¼ˆ40vw Ã— 50vhï¼‰- æ™®é€šå¼¹çª— */
<ResizableModal
  title="æ·»åŠ æ¬¾å¼"
  visible={visible}
  defaultWidth="40vw"
  defaultHeight="50vh"
>
  {/* æ™®é€šè¡¨å•ã€å•ä¸€åŠŸèƒ½ */}
</ResizableModal>

/* âœ… å°çª—å£ï¼ˆ30vw Ã— 40vhï¼‰- ç®€å•å¼¹çª— */
<ResizableModal
  title="ç¡®è®¤æ“ä½œ"
  visible={visible}
  defaultWidth="30vw"
  defaultHeight="40vh"
>
  {/* ç¡®è®¤æ¡†ã€ç®€å•è¾“å…¥ */}
</ResizableModal>
```

**å¼¹çª—å°ºå¯¸é€‰æ‹©**ï¼š
- âœ… **å¤§çª—å£60vw**: ç”Ÿäº§è®¢å•ã€è£å‰ªå•ã€å¯¹è´¦å•å®¡æ ¸
- âœ… **ä¸­çª—å£40vw**: æ¬¾å¼ç¼–è¾‘ã€å·¥å‚ç®¡ç†ã€ç”¨æˆ·ç®¡ç†
- âœ… **å°çª—å£30vw**: åˆ é™¤ç¡®è®¤ã€å¤‡æ³¨è¾“å…¥ã€çŠ¶æ€ä¿®æ”¹
- âŒ **ç¦æ­¢**: å›ºå®šåƒç´ å®½åº¦ï¼ˆå¦‚600pxï¼‰
- âŒ **ç¦æ­¢**: ä½¿ç”¨æ—§å°ºå¯¸80vw Ã— 85vh

**å¼¹çª—å†…å®¹å¸ƒå±€**: ä½¿ç”¨ModalContentLayoutç»„ä»¶
- ModalHeaderCard: å¤´éƒ¨ç°è‰²å¡ç‰‡ï¼ˆ#f8f9façº¯è‰²ï¼‰
- ModalField/ModalFieldRow: å­—æ®µå¸ƒå±€
- Footer: å–æ¶ˆåœ¨å·¦ï¼Œç¡®å®šåœ¨å³

#### 5. æŒ‰é’®è§„èŒƒï¼ˆButtonï¼‰
```tsx
/* âœ… æ ‡å‡†æŒ‰é’®å°ºå¯¸ */
<Button type="primary" size="middle">ä¿å­˜</Button>
<Button size="middle">å–æ¶ˆ</Button>
<Button type="link">æŸ¥çœ‹è¯¦æƒ…</Button>
```

**æŒ‰é’®è§„èŒƒ**ï¼š
- âœ… **é»˜è®¤å°ºå¯¸**: middleï¼ˆ32pxé«˜åº¦ï¼‰
- âœ… **å°æŒ‰é’®**: smallï¼ˆ24pxï¼Œä»…Tableè¡Œå†…æ“ä½œï¼‰
- âœ… **å¤§æŒ‰é’®**: largeï¼ˆ40pxï¼Œé¡µé¢ä¸»è¦æ“ä½œï¼‰
- âœ… **åœ†è§’**: 6px
- âœ… **çº¯è‰²èƒŒæ™¯**: æ— æ¸å˜ã€æ— é‡é˜´å½±
- âŒ **ç¦æ­¢**: æ··ç”¨smallå’Œmiddleï¼ˆç»Ÿä¸€é»˜è®¤middleï¼‰

#### 6. ç»„ä»¶è§„èŒƒï¼ˆComponentsï¼‰
```tsx
/* QRCodeBox - ç»Ÿä¸€äºŒç»´ç ï¼ˆçº¯è‰²è¾¹æ¡†ï¼‰ */
<QRCodeBox
  value={{ type: 'order', orderNo: 'PO20260122001' }}
  label="ğŸ“± è®¢å•æ‰«ç "
  variant="primary"  // primary/default/success/warning
  size={120}
/>

/* StyleCoverThumb - æ¬¾å¼å°é¢ */
<StyleCoverThumb
  styleId={record.styleId}
  styleNo={record.styleNo}
  src={record.styleCover}
  size={48}
  borderRadius={6}
/>

/* UniversalCardView - å¡ç‰‡è§†å›¾ï¼ˆçº¯è‰²å¡ç‰‡ï¼‰ */
<UniversalCardView
  dataSource={records}
  columns={4}           // PCç«¯4åˆ—
  coverField="coverImage"
  titleField="styleNo"
/>
```

### è®¾è®¡è§„èŒƒæ£€æŸ¥æ¸…å•ï¼ˆCode Reviewå¿…æŸ¥ï¼‰

#### æäº¤å‰è‡ªæ£€ï¼ˆå¿…é¡»100%é€šè¿‡ï¼‰
- [ ] **å­—ä½“**: æœªè‡ªå®šä¹‰font-familyï¼ˆæ‰“å°é¡µé¢é™¤å¤–ï¼‰
- [ ] **é¢œè‰²**: ä½¿ç”¨CSSå˜é‡ï¼Œæ— ç¡¬ç¼–ç é¢œè‰²å€¼
- [ ] **æ¸å˜**: æ— ä»»ä½•linear-gradient/radial-gradient
- [ ] **é—´è·**: ä½¿ç”¨8çš„å€æ•°ï¼ˆ8/16/24/32ï¼‰
- [ ] **Modal**: ä½¿ç”¨ResizableModalï¼ˆ60vw/40vw/30vwä¸‰çº§å°ºå¯¸ï¼‰
- [ ] **æŒ‰é’®**: é»˜è®¤ä½¿ç”¨middleå°ºå¯¸
- [ ] **ç»„ä»¶**: ä½¿ç”¨é€šç”¨ç»„ä»¶ï¼ˆQRCodeBox/StyleCoverThumbç­‰ï¼‰
- [ ] **å›¾æ ‡**: å°ºå¯¸ç¬¦åˆè§„èŒƒï¼ˆ12/14/16/20/24pxï¼‰
- [ ] **é˜´å½±**: ä½¿ç”¨æ ‡å‡†è½»é‡é˜´å½±ï¼ˆé¿å…è¿‡é‡ï¼‰

#### Code Reviewæ£€æŸ¥é¡¹
- [ ] **å­—ä½“ä¸€è‡´æ€§**: å…¨å±€å­—ä½“æ ˆæ­£ç¡®
- [ ] **é¢œè‰²è¯­ä¹‰åŒ–**: åŠŸèƒ½è‰²ä½¿ç”¨æ­£ç¡®ï¼ˆsuccess/warning/errorï¼‰
- [ ] **Modalå¸ƒå±€**: ä½¿ç”¨ModalContentLayoutç»„ä»¶
- [ ] **å“åº”å¼**: ç§»åŠ¨ç«¯é€‚é…æ­£ç¡®
- [ ] **æ€§èƒ½**: æ— ä¸å¿…è¦çš„é‡æ¸²æŸ“
- [ ] **ç®€æ´æ€§**: çº¯è‰²è®¾è®¡ï¼Œæ— èŠ±å“¨æ•ˆæœ

#### è¿è§„æ£€æŸ¥å·¥å…·
```bash
# è¿è¡Œè®¾è®¡è§„èŒƒæ£€æŸ¥
bash fix-design-violations.sh

# æŸ¥çœ‹æ£€æŸ¥é¡¹ï¼š
# 1. ç¡¬ç¼–ç é¢œè‰²ï¼ˆ610å¤„ï¼‰
# 2. æ¸å˜ä½¿ç”¨ï¼ˆç¦æ­¢ï¼‰
# 3. Modalå°ºå¯¸ï¼ˆ60vw/40vw/30vwï¼‰
# 4. è‡ªå®šä¹‰å­—ä½“
# 5. éæ ‡å‡†é—´è·
# 6. æŒ‰é’®å°ºå¯¸
# 7. Modalå¸ƒå±€
```

---

## ğŸ¯ ç³»ç»Ÿç°çŠ¶æ¦‚è§ˆ

### æŠ€æœ¯æ¶æ„å®Œæˆåº¦

| æ¨¡å—              | çŠ¶æ€    | å®Œæˆåº¦ | è¯´æ˜                                    |
| ----------------- | ------- | ------ | --------------------------------------- |
| åç«¯ Orchestrator | âœ… å®Œæˆ | 100%   | 26ä¸ªç¼–æ’å™¨è¿è¡Œç¨³å®š                      |
| å‰ç«¯æ¨¡å—åŒ–        | âœ… å®Œæˆ | 100%   | è¿ç§»å®Œæˆï¼Œæ„å»ºé€šè¿‡                      |
| å°ç¨‹åºæ¶æ„        | âœ… å®Œæˆ | 100%   | å·¥å…·å‡½æ•°æ¨¡å¼è¿è¡Œè‰¯å¥½                    |
| é€šç”¨ç»„ä»¶åº“        | âœ… å®Œæˆ | 95%    | ResizableModal/SortableColumn/QRCodeBox |
| SKUç³»ç»Ÿ           | âœ… å®Œæˆ | 100%   | ä¸‰ç«¯ç»Ÿä¸€ï¼ˆæ¬¾å·+é¢œè‰²+å°ºç ï¼‰              |
| æ‰«ç ç³»ç»Ÿ          | âœ… å®Œæˆ | 100%   | ä¸‰ç§æ¨¡å¼ï¼ˆORDER/BUNDLE/SKUï¼‰            |

### å‰ç«¯æ¨¡å—åŒ–è¿ç§»è¿›åº¦ï¼ˆ2026-01-26æ›´æ–°ï¼‰

**âœ… å·²å®Œæˆï¼ˆ100%ï¼‰**ï¼š

- âœ… æ¨¡å—ç›®å½•ç»“æ„åˆ›å»ºï¼ˆbasic/production/finance/system/dashboardï¼‰
- âœ… æ¨¡å—å…¥å£æ–‡ä»¶é…ç½®ï¼ˆindex.tsxæ‡’åŠ è½½å¯¼å‡ºï¼‰
- âœ… è·¯ç”±é…ç½®æ›´æ–°ï¼ˆrouteConfig.ts + App.tsxï¼‰
- âœ… 23ä¸ªé¡µé¢å†…å®¹å·²è¿ç§»åˆ°æ¨¡å—ç›®å½•
- âœ… æ‰€æœ‰å¯¼å…¥è·¯å¾„ä¿®å¤ï¼ˆç»Ÿä¸€ä½¿ç”¨ @ åˆ«åï¼‰
- âœ… Vite åˆ«åé…ç½®ï¼ˆ@ â†’ src/ï¼‰
- âœ… CSSæ ·å¼æ–‡ä»¶å¤åˆ¶å®Œæˆ
- âœ… æ„å»ºéªŒè¯é€šè¿‡ï¼ˆ9.69ç§’ï¼Œ159ä¸ªchunkï¼‰

**ğŸ“‚ å½“å‰æ–‡ä»¶ç»“æ„**ï¼š

```
frontend/src/
  â”œâ”€â”€ modules/              # âœ… æ–°æ¨¡å—ç›®å½•ï¼ˆå·²å®Œæˆï¼‰
  â”‚   â”œâ”€â”€ basic/            # 4ä¸ªé¡µé¢ âœ…
  â”‚   â”œâ”€â”€ production/       # 8ä¸ªé¡µé¢ âœ…
  â”‚   â”œâ”€â”€ finance/          # 4ä¸ªé¡µé¢ âœ…
  â”‚   â”œâ”€â”€ system/           # 6ä¸ªé¡µé¢ âœ…
  â”‚   â””â”€â”€ dashboard/        # 1ä¸ªé¡µé¢ âœ…
  â””â”€â”€ pages/                # âš ï¸ æ—§é¡µé¢ç›®å½•ï¼ˆå¾…æ¸…ç†ï¼‰
      â”œâ”€â”€ Login/            # ä¿ç•™
      â”œâ”€â”€ Register/         # ä¿ç•™
      â”œâ”€â”€ NotFound.tsx      # ä¿ç•™
      â””â”€â”€ ...               # å…¶ä»–å¾…åˆ é™¤
```

**â­ï¸ åç»­å·¥ä½œ**ï¼š

1. â³ åŠŸèƒ½æµ‹è¯•ï¼ˆéªŒè¯23ä¸ªé¡µé¢æ­£å¸¸å·¥ä½œï¼‰
2. â³ åˆ é™¤æ—§é¡µé¢æ–‡ä»¶ï¼ˆProduction/Finance/Systemç­‰ï¼‰
3. â³ ä¿®å¤2ä¸ªCSSè­¦å‘Šï¼ˆlayoutæ ·å¼ï¼‰

è¯¦è§ï¼š[docs/å‰ç«¯æ¨¡å—åŒ–è¿ç§»-å®Œæˆæ€»ç»“.md](docs/å‰ç«¯æ¨¡å—åŒ–è¿ç§»-å®Œæˆæ€»ç»“.md)

---

## ğŸ“š æ–‡æ¡£å¯¼èˆª

### æ ¸å¿ƒæ¶æ„æ–‡æ¡£

- [åç«¯ Orchestrator æ¨¡å¼](#ä¸€åç«¯æ¶æ„-orchestrator-æ¨¡å¼) - 26ä¸ªç¼–æ’å™¨è¯¦è§£
- [å°ç¨‹åºæ¶æ„è®¾è®¡](#äºŒå°ç¨‹åºæ¶æ„-è½»é‡çº§å·¥å…·å‡½æ•°æ¨¡å¼) - å·¥å…·å‡½æ•°æ¨¡å¼
- [å°ç¨‹åºé‡æ„æ–¹æ¡ˆ](#ä¸‰å°ç¨‹åºé‡æ„æ–¹æ¡ˆ-æ¸è¿›å¼ç¼–æ’æ¨¡å¼) - scan/index.js ä¼˜åŒ–
- [UIè®¾è®¡è§„èŒƒ](#å››uiè®¾è®¡è§„èŒƒ) - é¢œè‰²ã€å­—ä½“ã€ç»„ä»¶è§„èŒƒ
- [å‰ç«¯æ¨¡å—åŒ–è§„èŒƒ](#äº”å‰ç«¯æ¨¡å—åŒ–è§„èŒƒ) - æ¨¡å—è¾¹ç•Œä¸ç›®å½•ç»“æ„
- [å¼€å‘æœ€ä½³å®è·µ](#å…­å¼€å‘æœ€ä½³å®è·µ) - ä»£ç è§„èŒƒå’Œæ•…éšœæ’æŸ¥
- [å¿«é€Ÿå¼€å§‹](#ä¸ƒå¿«é€Ÿå¼€å§‹) - æ–°æ‰‹å…¥é—¨æŒ‡å—

### ä¸šåŠ¡æµç¨‹æ–‡æ¡£

- [SKU_QUICK_REFERENCE.md](SKU_QUICK_REFERENCE.md) - **SKUç³»ç»Ÿå¿«é€Ÿå‚è€ƒ**ï¼ˆæ¬¾å·+é¢œè‰²+å°ºç ç»Ÿä¸€ï¼‰
- [WORKFLOW_EXPLANATION.md](WORKFLOW_EXPLANATION.md) - å®Œæ•´ä¸šåŠ¡æµç¨‹
- [SCAN_SYSTEM_LOGIC.md](SCAN_SYSTEM_LOGIC.md) - æ‰«ç ç³»ç»Ÿæ ¸å¿ƒé€»è¾‘ï¼ˆä¸‰ç§æ¨¡å¼ï¼‰
- [QUICK_TEST_GUIDE.md](QUICK_TEST_GUIDE.md) - å¿«é€Ÿæµ‹è¯•æŒ‡å—

### æŠ€æœ¯å®ç°æ–‡æ¡£

- [MULTI_PAGE_SYNC_GUIDE.md](MULTI_PAGE_SYNC_GUIDE.md) - å¤šé¡µé¢åŒæ­¥æœºåˆ¶
- [DATA_SYNC_ANALYSIS.md](DATA_SYNC_ANALYSIS.md) - æ•°æ®åŒæ­¥åˆ†æ
- [docs/SORTABLE_COLUMN_GUIDE.md](docs/SORTABLE_COLUMN_GUIDE.md) - **é€šç”¨æ’åºåˆ—ç»„ä»¶ä½¿ç”¨æŒ‡å—**
- [docs/TIME_COLUMN_SORT_IMPLEMENTATION.md](docs/TIME_COLUMN_SORT_IMPLEMENTATION.md) - å…¨ç«™æ—¶é—´åˆ—æ’åºå®æ–½è®¡åˆ’
- [docs/PAYROLL_SORT_FEATURE.md](docs/PAYROLL_SORT_FEATURE.md) - å·¥èµ„æ’åºåŠŸèƒ½è¯´æ˜
- [docs/å¤šå·¥å‚æ•°æ®éš”ç¦»é…ç½®æŒ‡å—.md](docs/å¤šå·¥å‚æ•°æ®éš”ç¦»é…ç½®æŒ‡å—.md) - **å¤šå·¥å‚æ•°æ®æƒé™é…ç½®**ï¼ˆ4å±‚æƒé™ä½“ç³»ï¼‰

### éƒ¨ç½²è¿ç»´æ–‡æ¡£

- [deployment/DATABASE_CONFIG.md](deployment/DATABASE_CONFIG.md) - æ•°æ®åº“é…ç½®
- [DEPLOYMENT_CHECKLIST.md](DEPLOYMENT_CHECKLIST.md) - éƒ¨ç½²æ£€æŸ¥æ¸…å•
- [scripts/add_user_factory_id.sql](scripts/add_user_factory_id.sql) - å·¥å‚æƒé™æ•°æ®åº“è¿ç§»è„šæœ¬

---

## ä¸€ã€åç«¯æ¶æ„ - Orchestrator æ¨¡å¼

### 1.1 æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Controller å±‚                            â”‚
â”‚                  (æ¥æ”¶è¯·æ±‚ï¼Œå‚æ•°éªŒè¯)                          â”‚
â”‚  @RestController  @RequestMapping  @PreAuthorize            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ è°ƒç”¨
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Orchestrator å±‚ (æ ¸å¿ƒ)                      â”‚
â”‚              (è·¨æœåŠ¡ä¸šåŠ¡ç¼–æ’ï¼Œå¤æ‚äº‹åŠ¡ç®¡ç†)                    â”‚
â”‚  @Service  @Transactional  è·¨Serviceåè°ƒ                    â”‚
â”‚                                                              â”‚
â”‚  26ä¸ªç¼–æ’å™¨ï¼š                                                 â”‚
â”‚  â€¢ ProductionOrderOrchestrator                              â”‚
â”‚  â€¢ ShipmentReconciliationOrchestrator                       â”‚
â”‚  â€¢ FinanceOrchestrator                                      â”‚
â”‚  â€¢ QualityInspectionOrchestrator                            â”‚
â”‚  â€¢ ...                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ è°ƒç”¨
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Service å±‚                                â”‚
â”‚              (å•è¡¨/å•é¢†åŸŸ CRUD æ“ä½œ)                          â”‚
â”‚  ServiceImpl + Mapper  å•ä¸€èŒè´£                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ è°ƒç”¨
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Mapper å±‚                                 â”‚
â”‚              (MyBatis Plus æ•°æ®è®¿é—®)                         â”‚
â”‚  ç»§æ‰¿ BaseMapper<Entity>                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒ Orchestrator æ¸…å•ï¼ˆ26ä¸ªï¼‰

#### ç”Ÿäº§ç®¡ç†æ¨¡å—ï¼ˆ8ä¸ªï¼‰

1. **ProductionOrderOrchestrator** - è®¢å•ä¸šåŠ¡ç¼–æ’
   - åˆ›å»ºè®¢å• + åˆå§‹åŒ–å·¥åº + ç”Ÿæˆè²å·
   - è®¢å•è¿›åº¦æ›´æ–° + çŠ¶æ€æµè½¬
   - è·¨æœåŠ¡ï¼šOrder + Cutting + Finance

2. **CuttingTaskOrchestrator** - è£å‰ªä»»åŠ¡ç¼–æ’
   - ä»»åŠ¡åˆ†é… + é¢†å– + é€€å›
   - è·¨æœåŠ¡ï¼šTask + Order + User

3. **ProductionOrderScanOrchestrator** - æ‰«ç ä¸šåŠ¡ç¼–æ’
   - æ‰«ç æ‰§è¡Œ + å·¥åºåˆ¤æ–­ + è¿›åº¦æ›´æ–°
   - æ’¤é”€æ‰«ç  + å›æ»šæµç¨‹
   - è·¨æœåŠ¡ï¼šScanRecord + Order + Finance

4. **QualityInspectionOrchestrator** - è´¨æ£€ä¸šåŠ¡ç¼–æ’
   - è´¨æ£€å…¥åº“ + è®¢å•å®Œæˆåˆ¤æ–­
   - è·¨æœåŠ¡ï¼šQuality + Order + Warehousing

5. **CuttingBundleOrchestrator** - è²å·ç®¡ç†ç¼–æ’
   - è²å·ç”Ÿæˆ + äºŒç»´ç ç”Ÿæˆ
   - è²å·åˆ é™¤ + è®¢å•è¿›åº¦æ›´æ–°

6. **ProductionTemplateOrchestrator** - ç”Ÿäº§æ¨¡æ¿ç¼–æ’
   - æ¨¡æ¿åº”ç”¨åˆ°è®¢å•
   - å·¥åºé…ç½®åŒæ­¥

7. **ProgressNodeOrchestrator** - å·¥åºèŠ‚ç‚¹ç¼–æ’
   - å·¥åºé…ç½®ç®¡ç†
   - åŠ¨æ€å·¥åºåˆ—è¡¨

8. **BOMOrchestrator** - BOM ç®¡ç†ç¼–æ’
   - BOM åº”ç”¨åˆ°è®¢å•
   - ç‰©æ–™éœ€æ±‚è®¡ç®—

#### å¯¹è´¦æ¨¡å—ï¼ˆ3ä¸ªï¼‰

9. **ShipmentReconciliationOrchestrator** - å‘è´§å¯¹è´¦ç¼–æ’
   - å¯¹è´¦å•ç”Ÿæˆ + æ˜ç»†æ±‡æ€»
   - å®¡æ ¸æµç¨‹ + çŠ¶æ€å˜æ›´
   - è·¨æœåŠ¡ï¼šShipment + ScanRecord + Finance

10. **FactoryReconciliationOrchestrator** - å·¥å‚å¯¹è´¦ç¼–æ’
    - å·¥å‚å·¥èµ„è®¡ç®— + å¯¹è´¦å•ç”Ÿæˆ
    - è·¨æœåŠ¡ï¼šFactory + ScanRecord + Finance

11. **MaterialReconciliationOrchestrator** - ç‰©æ–™å¯¹è´¦ç¼–æ’
    - ç‰©æ–™é‡‡è´­å¯¹è´¦ + ä¾›åº”å•†ç»“ç®—
    - è·¨æœåŠ¡ï¼šMaterial + Supplier + Finance

#### è´¢åŠ¡æ¨¡å—ï¼ˆ3ä¸ªï¼‰

12. **FinanceOrchestrator** - è´¢åŠ¡ç»Ÿè®¡ç¼–æ’
    - å·¥èµ„è®¡ç®— + æˆæœ¬ç»Ÿè®¡
    - è·¨æœåŠ¡ï¼šScanRecord + Reconciliation + Order

13. **PayrollOrchestrator** - å·¥èµ„ç®¡ç†ç¼–æ’
    - å·¥èµ„æ¡ç”Ÿæˆ + å‘æ”¾è®°å½•

14. **CostAnalysisOrchestrator** - æˆæœ¬åˆ†æç¼–æ’
    - è®¢å•æˆæœ¬è®¡ç®— + åˆ©æ¶¦åˆ†æ

#### ä»“å‚¨æ¨¡å—ï¼ˆ2ä¸ªï¼‰

15. **WarehousingOrchestrator** - å…¥åº“ç®¡ç†ç¼–æ’
    - è´¨æ£€å…¥åº“ + åº“å­˜æ›´æ–°
    - å›é€€å¤„ç† + åº“å­˜æ‰£å‡

16. **InventoryOrchestrator** - åº“å­˜ç®¡ç†ç¼–æ’
    - åº“å­˜ç»Ÿè®¡ + é¢„è­¦

#### é‡‡è´­æ¨¡å—ï¼ˆ2ä¸ªï¼‰

17. **MaterialPurchaseOrchestrator** - ç‰©æ–™é‡‡è´­ç¼–æ’
    - é‡‡è´­å•åˆ›å»º + åˆ°è´§ç™»è®°
    - è·¨æœåŠ¡ï¼šPurchase + Material + Supplier

18. **SupplierOrchestrator** - ä¾›åº”å•†ç®¡ç†ç¼–æ’
    - ä¾›åº”å•†è¯„çº§ + ç»“ç®—ç®¡ç†

#### å·¥å‚ç®¡ç†æ¨¡å—ï¼ˆ2ä¸ªï¼‰

19. **FactoryOrchestrator** - å·¥å‚ç®¡ç†ç¼–æ’
    - å·¥å‚äº§èƒ½ç®¡ç† + ä»»åŠ¡åˆ†é…

20. **FactoryPerformanceOrchestrator** - å·¥å‚ç»©æ•ˆç¼–æ’
    - ç»©æ•ˆç»Ÿè®¡ + æ’åè®¡ç®—

#### ç³»ç»Ÿç®¡ç†æ¨¡å—ï¼ˆ6ä¸ªï¼‰

21. **UserOrchestrator** - ç”¨æˆ·ç®¡ç†ç¼–æ’
    - ç”¨æˆ·åˆ›å»º + è§’è‰²ç»‘å®š + æƒé™åˆ†é…
    - å®¡æ‰¹æµç¨‹ + çŠ¶æ€å˜æ›´

22. **RoleOrchestrator** - è§’è‰²ç®¡ç†ç¼–æ’
    - è§’è‰²åˆ›å»º + æƒé™ç»‘å®š
    - æ•°æ®æƒé™é…ç½®

23. **DashboardOrchestrator** - ä»ªè¡¨ç›˜ç¼–æ’
    - å¤šç»´åº¦æ•°æ®æ±‡æ€»
    - è·¨æœåŠ¡ï¼šOrder + Finance + Quality + User

24. **ReportOrchestrator** - æŠ¥è¡¨ç”Ÿæˆç¼–æ’
    - å„ç±»æŠ¥è¡¨ç”Ÿæˆ + æ•°æ®å¯¼å‡º

25. **NotificationOrchestrator** - é€šçŸ¥ç®¡ç†ç¼–æ’
    - æ¶ˆæ¯æ¨é€ + å°ç¨‹åºè®¢é˜…æ¶ˆæ¯

26. **AuditLogOrchestrator** - å®¡è®¡æ—¥å¿—ç¼–æ’
    - æ“ä½œæ—¥å¿—è®°å½• + æ•°æ®å˜æ›´è¿½è¸ª

### 1.3 å…¸å‹æ¡ˆä¾‹ï¼šå¯¹è´¦æµç¨‹

#### Controller å±‚

```java
@RestController
@RequestMapping("/api/reconciliation/shipment")
public class ShipmentReconciliationController {

    @Autowired
    private ShipmentReconciliationOrchestrator orchestrator;

    @PostMapping("/create")
    @PreAuthorize("hasAuthority('RECONCILIATION_CREATE')")
    public R<Long> create(@RequestBody ShipmentReconciliationCreateDTO dto) {
        Long id = orchestrator.createReconciliation(dto);
        return R.ok(id);
    }
}
```

#### Orchestrator å±‚ï¼ˆæ ¸å¿ƒï¼‰

```java
@Service
public class ShipmentReconciliationOrchestrator {

    @Autowired
    private ShipmentReconciliationService reconciliationService;

    @Autowired
    private ProductionOrderScanRecordService scanRecordService;

    @Autowired
    private FinanceService financeService;

    @Transactional(rollbackFor = Exception.class)
    public Long createReconciliation(ShipmentReconciliationCreateDTO dto) {
        // 1. åˆ›å»ºå¯¹è´¦å•ï¼ˆæœ¬æœåŠ¡ï¼‰
        ShipmentReconciliation reconciliation = new ShipmentReconciliation();
        reconciliation.setOrderId(dto.getOrderId());
        reconciliation.setStatus("PENDING");
        reconciliationService.save(reconciliation);

        // 2. æŸ¥è¯¢æ‰«ç è®°å½•ï¼ˆè·¨æœåŠ¡ï¼‰
        List<ScanRecord> records = scanRecordService.getValidRecords(
            dto.getOrderId(),
            dto.getStartDate(),
            dto.getEndDate()
        );

        // 3. è®¡ç®—æ±‡æ€»æ•°æ®ï¼ˆé¢†åŸŸé€»è¾‘ï¼‰
        BigDecimal totalAmount = records.stream()
            .map(r -> r.getUnitPrice().multiply(new BigDecimal(r.getQuantity())))
            .reduce(BigDecimal.ZERO, BigDecimal::add);

        reconciliation.setTotalAmount(totalAmount);
        reconciliation.setTotalQuantity(records.size());
        reconciliationService.updateById(reconciliation);

        // 4. æ›´æ–°è´¢åŠ¡ç»Ÿè®¡ï¼ˆè·¨æœåŠ¡ï¼‰
        financeService.updateShipmentStats(dto.getOrderId(), totalAmount);

        return reconciliation.getId();
    }
}
```

#### Service å±‚ï¼ˆå•ä¸€èŒè´£ï¼‰

```java
@Service
public class ShipmentReconciliationServiceImpl
    extends ServiceImpl<ShipmentReconciliationMapper, ShipmentReconciliation>
    implements ShipmentReconciliationService {

    // åªå¤„ç†å¯¹è´¦å•è¡¨çš„ CRUDï¼Œä¸æ¶‰åŠå…¶ä»–æœåŠ¡

    @Override
    public ShipmentReconciliation getById(Long id) {
        return baseMapper.selectById(id);
    }
}
```

---

## äºŒã€å°ç¨‹åºæ¶æ„ - è½»é‡çº§å·¥å…·å‡½æ•°æ¨¡å¼

### 2.1 æ¶æ„å¯¹æ¯”

#### åç«¯æ¶æ„ï¼ˆé‡é‡çº§ï¼‰

```
Controller â†’ Orchestrator â†’ Service â†’ Mapper
   â†“             â†“            â†“         â†“
 APIå…¥å£      ä¸šåŠ¡ç¼–æ’     å•è¡¨æ“ä½œ   æ•°æ®è®¿é—®
```

#### å°ç¨‹åºæ¶æ„ï¼ˆè½»é‡çº§ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Page é¡µé¢å±‚                        â”‚
â”‚            (ä¸šåŠ¡é€»è¾‘ + UIæ¸²æŸ“ + äº‹ä»¶å¤„ç†)              â”‚
â”‚                                                       â”‚
â”‚  â€¢ pages/scan/index.js (2927è¡Œ)                     â”‚
â”‚  â€¢ pages/work/index.js (796è¡Œ)                      â”‚
â”‚  â€¢ pages/home/index.js (416è¡Œ)                      â”‚
â”‚  â€¢ pages/admin/index.js (181è¡Œ)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                  â”‚
           â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Utils å·¥å…·å‡½æ•°å±‚   â”‚  â”‚  Components ç»„ä»¶     â”‚
â”‚  (å¯å¤ç”¨é€»è¾‘å°è£…)     â”‚  â”‚  (å¯å¤ç”¨UI)          â”‚
â”‚                     â”‚  â”‚                     â”‚
â”‚ â€¢ api.js            â”‚  â”‚ â€¢ global-search     â”‚
â”‚ â€¢ dataValidator.js  â”‚  â”‚ â€¢ custom-tab-bar    â”‚
â”‚ â€¢ errorHandler.js   â”‚  â”‚                     â”‚
â”‚ â€¢ eventBus.js       â”‚  â”‚                     â”‚
â”‚ â€¢ syncManager.js    â”‚  â”‚                     â”‚
â”‚ â€¢ orderStatusHelper.js                       â”‚
â”‚ â€¢ validationRules.jsâ”‚  â”‚                     â”‚
â”‚ â€¢ storage.js        â”‚  â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åç«¯ REST API                           â”‚
â”‚         (Controller â†’ Orchestrator â†’ ...)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ä¸ºä»€ä¹ˆä¸ç”¨ Orchestratorï¼Ÿ

| å¯¹æ¯”é¡¹     | åç«¯ Orchestrator     | å°ç¨‹åº Page         |
| ---------- | --------------------- | ------------------- |
| ä¸šåŠ¡å¤æ‚åº¦ | é«˜ï¼ˆè·¨æœåŠ¡åè°ƒï¼‰      | ä½ï¼ˆå•é¡µé¢é€»è¾‘ï¼‰    |
| äº‹åŠ¡ç®¡ç†   | éœ€è¦ `@Transactional` | ä¸éœ€è¦              |
| å¹¶å‘æ§åˆ¶   | éœ€è¦ï¼ˆå¤šç”¨æˆ·ï¼‰        | ä¸éœ€è¦ï¼ˆå•ç”¨æˆ·ï¼‰    |
| ä»£ç å¤ç”¨   | Serviceå±‚             | Utilså·¥å…·å‡½æ•°       |
| åˆ†å±‚ç»“æ„   | 4å±‚ï¼ˆä¸¥æ ¼åˆ†å±‚ï¼‰       | 2å±‚ï¼ˆæ‰å¹³åŒ–ï¼‰       |
| èŒè´£èŒƒå›´   | ä¸šåŠ¡ç¼–æ’ + æ•°æ®ä¸€è‡´æ€§ | ç”¨æˆ·äº¤äº’ + æ•°æ®å±•ç¤º |

### 2.3 æ ¸å¿ƒå·¥å…·æ¨¡å—ï¼ˆ11ä¸ªï¼‰

#### 1. api.js - APIå°è£…å±‚

```javascript
// ç»Ÿä¸€å°è£…åç«¯è°ƒç”¨ï¼Œç±»ä¼¼åç«¯ Controller
const production = {
  listOrders(params) {
    return ok("/api/production/order/list", "GET", params);
  },
  executeScan(payload) {
    return ok("/api/production/scan/execute", "POST", payload);
  },
  // ... 40+ ä¸ªæ–¹æ³•
};

export default { production, system, dashboard, wechat };
```

#### 2. dataValidator.js - æ•°æ®éªŒè¯å±‚

```javascript
// æ•°æ®ç»“æ„å®šä¹‰ + éªŒè¯ï¼ˆç±»ä¼¼åç«¯ DTOï¼‰
const ProductionOrderShape = {
  id: { required: true, type: "string" },
  orderNo: { required: true, type: "string" },
  orderQuantity: { required: true, type: "number" },
};

function validateProductionOrder(order) {
  // éªŒè¯é€»è¾‘
}
```

#### 3. errorHandler.js - é”™è¯¯å¤„ç†å±‚

```javascript
// ç»Ÿä¸€é”™è¯¯åˆ†ç±»å’Œå¤„ç†
const ErrorTypes = {
  NETWORK: "network",
  AUTH: "auth",
  BUSINESS: "biz",
  VALIDATION: "validation",
  TIMEOUT: "timeout",
};

function classifyError(error) {
  /* ... */
}
```

#### 4. eventBus.js - äº‹ä»¶æ€»çº¿ï¼ˆå¤šé¡µé¢åŒæ­¥ï¼‰

```javascript
// å‘å¸ƒ/è®¢é˜…æ¨¡å¼å®ç°è·¨é¡µé¢é€šä¿¡
function triggerDataRefresh(dataType, payload) {
  eventBus.emit("data:changed", { type: dataType, ...payload });
}

function onDataRefresh(callback) {
  eventBus.on("data:changed", callback);
}
```

#### 5. orderStatusHelper.js - çŠ¶æ€è½¬æ¢å·¥å…·

```javascript
// é¿å…é‡å¤å®šä¹‰çŠ¶æ€è½¬æ¢é€»è¾‘
function orderStatusText(status) {
  const map = {
    pending: "å¾…ç”Ÿäº§",
    production: "ç”Ÿäº§ä¸­",
    completed: "å·²å®Œæˆ",
  };
  return map[status] || "æœªçŸ¥";
}
```

#### 6-11. å…¶ä»–å·¥å…·

- **syncManager.js** - 30ç§’è½®è¯¢åŒæ­¥
- **storage.js** - æœ¬åœ°å­˜å‚¨å°è£…
- **permission.js** - æƒé™åˆ¤æ–­
- **request.js** - åº•å±‚HTTPè¯·æ±‚
- **validationRules.js** - éªŒè¯è§„åˆ™åº“ï¼ˆä¸PCç«¯ä¸€è‡´ï¼‰
- **reminderManager.js** - æé†’ç®¡ç†

### 2.4 å®é™…æ¡ˆä¾‹å¯¹æ¯”

#### åç«¯ï¼šé€€å›æ“ä½œï¼ˆOrchestrator æ¨¡å¼ï¼‰

```java
@Service
public class ProductionOrderOrchestrator {
    @Transactional(rollbackFor = Exception.class)
    public boolean rollbackByBundle(String bundleNo, int quantity) {
        // 1. æŸ¥è¯¢è®¢å•ï¼ˆè·¨æœåŠ¡ï¼‰
        ProductionOrder order = orderService.getByBundleNo(bundleNo);

        // 2. æ›´æ–°è¿›åº¦ï¼ˆè·¨æœåŠ¡ï¼‰
        orderService.rollbackProgress(order.getId(), quantity);

        // 3. ä½œåºŸæ‰«ç è®°å½•ï¼ˆè·¨æœåŠ¡ï¼‰
        scanRecordService.invalidateFlowAfterRollback(order);

        // 4. æ›´æ–°è´¢åŠ¡ï¼ˆè·¨æœåŠ¡ï¼‰
        financeService.recalculatePayroll(order.getId());

        return true;
    }
}
```

#### å°ç¨‹åºï¼šé€€å›æ“ä½œï¼ˆå·¥å…·å‡½æ•°æ¨¡å¼ï¼‰

```javascript
// pages/work/index.js
Page({
  async confirmRollback() {
    try {
      // ç›´æ¥è°ƒç”¨åç«¯ APIï¼ˆåç«¯ Orchestrator å¤„ç†æ‰€æœ‰é€»è¾‘ï¼‰
      await api.production.rollbackByBundle({
        orderId: this.data.rollback.orderId,
        cuttingBundleQrCode: this.data.rollback.cuttingBundleQrCode,
        rollbackQuantity: this.data.rollback.rollbackQuantity,
      });

      wx.showToast({ title: "å›é€€æˆåŠŸ", icon: "success" });

      // åˆ·æ–°æœ¬åœ°æ•°æ®
      await this.loadOrders(true);

      // è§¦å‘å…¨å±€åˆ·æ–°ï¼ˆä½¿ç”¨ eventBusï¼‰
      triggerDataRefresh("orders", { action: "rollback" });
    } catch (e) {
      errorHandler.logError(e, "å›é€€å¤±è´¥");
      wx.showToast({ title: "å›é€€å¤±è´¥", icon: "none" });
    }
  },
});
```

**å…³é”®åŒºåˆ«**ï¼š

- åç«¯ï¼šç¼–æ’3ä¸ªServiceï¼Œå¤„ç†äº‹åŠ¡
- å°ç¨‹åºï¼šè°ƒç”¨1ä¸ªAPIï¼Œè§¦å‘äº‹ä»¶ï¼Œ**æ‰€æœ‰å¤æ‚é€»è¾‘åœ¨åç«¯å®Œæˆ**

---

## äºŒç‚¹äº”ã€SKUç³»ç»Ÿ - ä¸‰ç«¯ç»Ÿä¸€è®¾è®¡

### 2.5.1 SKUæ ¸å¿ƒæ¦‚å¿µ

**SKU = æœ€å°åº“å­˜å•ä½ = æ¬¾å· + é¢œè‰² + å°ºç **

```javascript
// æ ‡å‡†SKUå¯¹è±¡
{
  styleNo: 'ST001',         // æ¬¾å·ï¼ˆä¸è®¢å•å·å¯èƒ½ä¸åŒï¼‰
  color: 'é»‘è‰²',            // é¢œè‰²ï¼ˆå¿…é¡»è§„èŒƒåŒ–ï¼‰
  size: 'L',                // å°ºç ï¼ˆS/M/L/XL/XXLç­‰ï¼‰
  orderNo: 'PO20260122001', // æ‰€å±è®¢å•

  // æ•°é‡å­—æ®µ
  totalQuantity: 50,        // è®¢å•æ€»æ•°
  completedQuantity: 30,    // å·²å®Œæˆæ•°
  pendingQuantity: 20,      // å¾…å®Œæˆæ•°ï¼ˆ= total - completedï¼‰

  // å¯é€‰å­—æ®µ
  bundleNo: 'PO-é»‘è‰²-01'   // å…³è”è²å·ï¼ˆè£å‰ªåäº§ç”Ÿï¼‰
}
```

### 2.5.2 ä¸‰ç§æ‰«ç æ¨¡å¼

#### æ¨¡å¼1ï¼šè®¢å•æ‰«ç ï¼ˆORDERï¼‰

```
æ‰«ç å†…å®¹: PO20260122001
è¯†åˆ«è§„åˆ™: çº¯è®¢å•å·æ ¼å¼
åç«¯è¿”å›: è®¢å•è¯¦æƒ… + SKUåˆ—è¡¨
å°ç¨‹åºæ˜¾ç¤º: SKUæ˜ç»†é€‰æ‹©è¡¨å•
é€‚ç”¨åœºæ™¯: é¦–æ¬¡è¿›å…¥å·¥åºï¼Œç¡®è®¤å„SKUæ•°é‡
```

#### æ¨¡å¼2ï¼šè²å·æ‰«ç ï¼ˆBUNDLEï¼‰

```
æ‰«ç å†…å®¹: PO20260122001-é»‘è‰²-01
è¯†åˆ«è§„åˆ™: è®¢å•å·-é¢œè‰²-åºå·
åç«¯è¿”å›: è²å·ä¿¡æ¯ï¼ˆä¸€ä¸ªé¢œè‰²ï¼Œå¯èƒ½å¤šä¸ªå°ºç ï¼‰
å°ç¨‹åºæ˜¾ç¤º: ç›´æ¥ç¡®è®¤ï¼ˆæ— éœ€é€‰æ‹©ï¼‰
é€‚ç”¨åœºæ™¯: è£å‰ªåï¼Œå¿«é€Ÿæ‰¹é‡æäº¤
```

#### æ¨¡å¼3ï¼šSKUæ‰«ç ï¼ˆSKUï¼‰

```
æ‰«ç å†…å®¹: {orderNo: 'PO...', color: 'é»‘è‰²', size: 'L', qty: 50}
è¯†åˆ«è§„åˆ™: JSONæ ¼å¼æˆ–CSVæ ¼å¼
åç«¯è¿”å›: SKUéªŒè¯ç»“æœ
å°ç¨‹åºæ˜¾ç¤º: å•ä¸ªSKUç¡®è®¤
é€‚ç”¨åœºæ™¯: ç‰¹å®šSKUç²¾ç¡®æ‰«æï¼ˆå¦‚è´¨æ£€å…¥åº“ï¼‰
```

### 2.5.3 SKUProcessor ç»Ÿä¸€å¤„ç†

**ä½ç½®**ï¼š`miniprogram/utils/SKUProcessor.js` (450è¡Œ)

```javascript
// æ ¸å¿ƒæ–¹æ³•
class SKUProcessor {
  // è§„èŒƒåŒ–åç«¯è¿”å›çš„itemsä¸ºæ ‡å‡†SKUåˆ—è¡¨
  static normalizeOrderItems(items, orderNo, styleNo) { ... }

  // æ„å»ºSKUè¾“å…¥è¡¨å•é¡¹
  static buildSKUInputList(skuList) { ... }

  // éªŒè¯SKUæ•°é‡æ‰¹æ¬¡
  static validateSKUInputBatch(skuList) { ... }

  // ç”Ÿæˆæ‰«ç è¯·æ±‚
  static generateScanRequests(skuList, processNode, operatorId) { ... }

  // è·å–SKUè¿›åº¦æ±‡æ€»
  static getSummary(skuList) { ... }

  // è§£æè²å·
  static parseBundleNo(bundleNo) { ... }
}
```

### 2.5.4 æ•°æ®æµå‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰«ç  (è®¢å•å·/è²å·/SKU)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QRCodeParser.parse() - è¯†åˆ«ç±»å‹                 â”‚
â”‚ â€¢ ORDER: çº¯è®¢å•å·                                â”‚
â”‚ â€¢ BUNDLE: è®¢å•å·-é¢œè‰²-åºå·                       â”‚
â”‚ â€¢ SKU: JSON/CSVæ ¼å¼                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è°ƒç”¨åç«¯APIè·å–è¯¦æƒ…                              â”‚
â”‚ â€¢ /api/production/order/detail (ORDER)          â”‚
â”‚ â€¢ /api/production/bundle/detail (BUNDLE)        â”‚
â”‚ â€¢ /api/production/sku/validate (SKU)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SKUProcessor.normalizeOrderItems()              â”‚
â”‚ å°†åç«¯è¿”å›è½¬ä¸ºæ ‡å‡†SKUåˆ—è¡¨                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å°ç¨‹åºæ˜¾ç¤ºSKUè¡¨å•ï¼ˆå¦‚éœ€ï¼‰                        â”‚
â”‚ â€¢ è®¢å•æ¨¡å¼ï¼šæ˜¾ç¤ºå¤šSKUé€‰æ‹©è¡¨                      â”‚
â”‚ â€¢ è²å·æ¨¡å¼ï¼šæ˜¾ç¤ºç¡®è®¤æŒ‰é’®                         â”‚
â”‚ â€¢ SKUæ¨¡å¼ï¼šæ˜¾ç¤ºå•SKUç¡®è®¤                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SKUProcessor.generateScanRequests()             â”‚
â”‚ ç”Ÿæˆæ ‡å‡†æ‰«ç è¯·æ±‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æäº¤åˆ°åç«¯ /api/production/scan/execute         â”‚
â”‚ åç«¯ Orchestrator å¤„ç†ä¸šåŠ¡é€»è¾‘                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.5.5 å…³é”®çº¦å®š

1. **é¢œè‰²å’Œå°ºç å¿…é¡»è§„èŒƒåŒ–**
   - ä½¿ç”¨ç»Ÿä¸€çš„ä¸­æ–‡å‘½å
   - åç«¯å’Œå‰ç«¯ä¿æŒä¸€è‡´

2. **æ•°é‡å­—æ®µè§„åˆ™**
   - `totalQuantity`: è®¢å•è¦æ±‚æ€»æ•°ï¼ˆä¸å˜ï¼‰
   - `completedQuantity`: å·²å®Œæˆæ•°ï¼ˆé€’å¢ï¼‰
   - `pendingQuantity`: å¾…å®Œæˆæ•°ï¼ˆ= total - completedï¼‰

3. **SKUå”¯ä¸€æ€§**
   - åŒè®¢å•å†… (styleNo + color + size) å”¯ä¸€
   - ç”¨äºè¿½è¸ªè¿›åº¦å’Œé˜²æ­¢é‡å¤

4. **è²å·å…³è”**
   - è²å·åœ¨è£å‰ªé˜¶æ®µç”Ÿæˆ
   - ä¸€ä¸ªè²å·å¯¹åº”ä¸€ä¸ªé¢œè‰²ï¼Œå¯èƒ½å¤šä¸ªå°ºç 
   - æ ¼å¼ï¼š`è®¢å•å·-é¢œè‰²-åºå·`ï¼ˆå¦‚ï¼šPO20260122001-é»‘è‰²-01ï¼‰

**è¯¦ç»†å‚è€ƒ**ï¼š[SKU_QUICK_REFERENCE.md](SKU_QUICK_REFERENCE.md)

---

## ä¸‰ã€å°ç¨‹åºé‡æ„æ–¹æ¡ˆ - æ¸è¿›å¼ç¼–æ’æ¨¡å¼

### 3.1 å½“å‰é—®é¢˜

**scan/index.js æœ‰ 2927 è¡Œä»£ç **ï¼ŒåŒ…å«ï¼š

- æ‰«ç é€»è¾‘ï¼ˆ500è¡Œï¼‰
- æ’¤é”€é€»è¾‘ï¼ˆ300è¡Œï¼‰
- è´¨æ£€å¼¹çª—ï¼ˆ400è¡Œï¼‰
- è²å·ç”Ÿæˆå¼¹çª—ï¼ˆ400è¡Œï¼‰
- æ•°æ®åŠ è½½ï¼ˆ500è¡Œï¼‰
- å…¶ä»–ä¸šåŠ¡ï¼ˆ800è¡Œï¼‰

**é—®é¢˜**ï¼š

- âŒ ç»´æŠ¤å›°éš¾ - éš¾ä»¥å®šä½é—®é¢˜
- âŒ ä»£ç å¤ç”¨å·® - é€»è¾‘é‡å¤
- âŒ æµ‹è¯•å›°éš¾ - æ— æ³•å•å…ƒæµ‹è¯•
- âŒ æ‰©å±•å›°éš¾ - æ–°å¢åŠŸèƒ½å®¹æ˜“ç ´ååŸæœ‰é€»è¾‘

### 3.2 é‡æ„æ–¹æ¡ˆï¼šè½»é‡çº§ç¼–æ’æ¨¡å¼

#### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ              | æ¶æ„                                  | ä¼˜ç‚¹               | ç¼ºç‚¹               | æ¨èåº¦ |
| ----------------- | ------------------------------------- | ------------------ | ------------------ | ------ |
| å®Œæ•´ Orchestrator | Page â†’ Orchestrator â†’ Service â†’ Utils | æ¶æ„æ¸…æ™°           | è¿‡åº¦è®¾è®¡ã€åŒ…ä½“ç§¯å¤§ | âŒ     |
| **è½»é‡çº§ç¼–æ’**    | **Page â†’ Handler â†’ Service â†’ Utils**  | **å¹³è¡¡å¥½ã€æ˜“ç»´æŠ¤** | **éœ€è¦è§„åˆ’**       | **âœ…** |
| å½“å‰çŠ¶æ€          | Pageï¼ˆ2927è¡Œï¼‰                        | ç®€å•               | éš¾ç»´æŠ¤             | âŒ     |

#### ç›®æ ‡æ¶æ„

```
Page (400è¡Œ)
  â”œâ”€â”€ åªè´Ÿè´£ UI å’Œäº‹ä»¶ç»‘å®š
  â””â”€â”€ è°ƒç”¨ Handlers

Handlers (ä¸šåŠ¡ç¼–æ’å±‚) (1300è¡Œ)
  â”œâ”€â”€ ScanHandler.js (500è¡Œ) - æ‰«ç ç¼–æ’
  â”œâ”€â”€ UndoHandler.js (200è¡Œ) - æ’¤é”€ç¼–æ’
  â”œâ”€â”€ BundleHandler.js (300è¡Œ) - è²å·ç¼–æ’
  â””â”€â”€ QualityHandler.js (300è¡Œ) - è´¨æ£€ç¼–æ’

Services (å¯å¤ç”¨ä¸šåŠ¡) (400è¡Œ)
  â”œâ”€â”€ QRCodeParser.js (200è¡Œ) - äºŒç»´ç è§£æ
  â””â”€â”€ StageDetector.js (200è¡Œ) - å·¥åºæ£€æµ‹

Utils (å·¥å…·å‡½æ•°) (å·²æœ‰)
  â””â”€â”€ api.js, eventBus.js, ...
```

### 3.3 é‡æ„ä»£ç ç¤ºä¾‹

#### é‡æ„å‰ï¼ˆæ··ä¹±ï¼‰

```javascript
// scan/index.js (2927è¡Œ)
Page({
  async handleScan(scanCode) {
    // 200è¡Œè§£æ + åˆ¤æ–­ + è°ƒç”¨ + åˆ·æ–°é€»è¾‘æ··åœ¨ä¸€èµ·
    // éš¾ä»¥ç†è§£å’Œç»´æŠ¤
  },
});
```

#### é‡æ„åï¼ˆæ¸…æ™°ï¼‰

**Page å±‚ (400è¡Œ)**

```javascript
// pages/scan/index.js
import ScanHandler from "./handlers/ScanHandler";
import UndoHandler from "./handlers/UndoHandler";

Page({
  data: {
    scanTypeIndex: 1,
    lastResult: null,
  },

  onLoad() {
    this.scanHandler = new ScanHandler(this);
    this.undoHandler = new UndoHandler(this);
  },

  // ç®€æ´çš„äº‹ä»¶å¤„ç†
  async onScanClick() {
    wx.scanCode({
      success: async (res) => {
        await this.scanHandler.handleScan(res.result);
      },
    });
  },

  async onUndoClick() {
    await this.undoHandler.performUndo(this.data.undo);
  },
});
```

**Handler å±‚ (500è¡Œ)**

```javascript
// pages/scan/handlers/ScanHandler.js
import api from "../../../utils/api";
import { triggerDataRefresh } from "../../../utils/eventBus";
import QRCodeParser from "../services/QRCodeParser";
import StageDetector from "../services/StageDetector";

class ScanHandler {
  constructor(page) {
    this.page = page;
    this.parser = new QRCodeParser();
    this.stageDetector = new StageDetector();
  }

  /**
   * æ‰«ç ä¸»æµç¨‹ï¼ˆä¸šåŠ¡ç¼–æ’ï¼‰
   */
  async handleScan(scanCode) {
    try {
      // 1. è§£æäºŒç»´ç 
      const parsed = this.parser.parse(scanCode);

      // 2. åˆ¤æ–­æ‰«ç ç±»å‹
      if (parsed.bundleNo) {
        return await this.handleBundleScan(parsed);
      } else {
        return await this.handleOrderScan(parsed);
      }
    } catch (error) {
      wx.showToast({ title: error.message, icon: "none" });
    }
  }

  /**
   * è²å·æ‰«ç æµç¨‹
   */
  async handleBundleScan(parsed) {
    // 1. æ£€æµ‹å·¥åº
    const stage = await this.stageDetector.detectNextStage(
      parsed.orderId,
      parsed.bundleNo,
    );

    // 2. è°ƒç”¨åç«¯ APIï¼ˆåç«¯ Orchestrator å¤„ç†å¤æ‚é€»è¾‘ï¼‰
    const result = await api.production.executeScan({
      orderId: parsed.orderId,
      bundleNo: parsed.bundleNo,
      stage: stage,
    });

    // 3. æ›´æ–°é¡µé¢çŠ¶æ€
    this.page.setData({
      lastResult: result,
      "undo.canUndo": true,
    });

    // 4. è§¦å‘å…¨å±€åˆ·æ–°
    triggerDataRefresh("scans", { action: "scan" });

    wx.showToast({ title: "æ‰«ç æˆåŠŸ", icon: "success" });
  }
}

export default ScanHandler;
```

**Service å±‚ (200è¡Œ)**

```javascript
// pages/scan/services/QRCodeParser.js
/**
 * äºŒç»´ç è§£ææœåŠ¡ï¼ˆå¯å¤ç”¨ï¼‰
 */
class QRCodeParser {
  /**
   * è§£æäºŒç»´ç 
   */
  parse(scanCode) {
    // 1. å°è¯•è§£æè²å·
    const bundleResult = this.parseBundleQR(scanCode);
    if (bundleResult) return bundleResult;

    // 2. å°è¯•è§£æè®¢å•
    const orderResult = this.parseOrderQR(scanCode);
    if (orderResult) return orderResult;

    throw new Error("æ— æ³•è¯†åˆ«çš„äºŒç»´ç æ ¼å¼");
  }

  /**
   * è§£æè²å·äºŒç»´ç : PO20260122001-é»‘è‰²-01
   */
  parseBundleQR(scanCode) {
    const match = scanCode.match(/^([A-Z0-9]+)-(.+)-(\d+)$/);
    if (!match) return null;

    return {
      type: "bundle",
      orderNo: match[1],
      color: match[2],
      seq: match[3],
      bundleNo: scanCode,
    };
  }

  /**
   * è§£æè®¢å•äºŒç»´ç : ORDER:123456
   */
  parseOrderQR(scanCode) {
    const match = scanCode.match(/^ORDER:(\d+)$/);
    if (!match) return null;

    return {
      type: "order",
      orderId: match[1],
    };
  }
}

export default QRCodeParser;
```

### 3.4 ç›®å½•ç»“æ„

#### é‡æ„å‰

```
pages/scan/
â”œâ”€â”€ index.js      (2927è¡Œ - å¤ªå¤§ï¼)
â”œâ”€â”€ index.wxml
â”œâ”€â”€ index.wxss
â””â”€â”€ index.json
```

#### é‡æ„å

```
pages/scan/
â”œâ”€â”€ index.js           (400è¡Œ - ç®€æ´)
â”œâ”€â”€ index.wxml
â”œâ”€â”€ index.wxss
â”œâ”€â”€ index.json
â”œâ”€â”€ handlers/          (ä¸šåŠ¡ç¼–æ’å±‚)
â”‚   â”œâ”€â”€ ScanHandler.js      (500è¡Œ)
â”‚   â”œâ”€â”€ UndoHandler.js      (200è¡Œ)
â”‚   â”œâ”€â”€ BundleHandler.js    (300è¡Œ)
â”‚   â””â”€â”€ QualityHandler.js   (300è¡Œ)
â””â”€â”€ services/          (å¯å¤ç”¨ä¸šåŠ¡)
    â”œâ”€â”€ QRCodeParser.js     (200è¡Œ)
    â””â”€â”€ StageDetector.js    (200è¡Œ)
```

### 3.5 é‡æ„æ•ˆæœ

| æŒ‡æ ‡      | é‡æ„å‰ | é‡æ„å | æ”¹å–„                     |
| --------- | ------ | ------ | ------------------------ |
| Page å¤§å° | 2927è¡Œ | 400è¡Œ  | âœ… å‡å°‘86%               |
| ä»£ç ç»“æ„  | æ··ä¹±   | æ¸…æ™°   | âœ… å±‚æ¬¡åˆ†æ˜              |
| ç»´æŠ¤æ€§    | å·®     | å¥½     | âœ… æ˜“äºå®šä½              |
| å¯æµ‹è¯•æ€§  | å·®     | å¥½     | âœ… å•å…ƒæµ‹è¯•              |
| ä»£ç å¤ç”¨  | å·®     | å¥½     | âœ… Parser/Detectorå¯å¤ç”¨ |
| æ‰©å±•æ€§    | å·®     | å¥½     | âœ… åŠ Handlerå³å¯         |

### 3.6 å®æ–½è®¡åˆ’ï¼ˆ5å‘¨ï¼‰

#### ç¬¬1å‘¨ï¼šæå– QRCodeParser

- [ ] åˆ›å»º `services/QRCodeParser.js`
- [ ] å°†è§£æé€»è¾‘ä» `handleScan()` æå–
- [ ] æµ‹è¯•éªŒè¯

#### ç¬¬2å‘¨ï¼šæå– StageDetector

- [ ] åˆ›å»º `services/StageDetector.js`
- [ ] å°†å·¥åºåˆ¤æ–­é€»è¾‘æå–
- [ ] æµ‹è¯•éªŒè¯

#### ç¬¬3å‘¨ï¼šåˆ›å»º ScanHandler

- [ ] åˆ›å»º `handlers/ScanHandler.js`
- [ ] å°†æ‰«ç ç¼–æ’é€»è¾‘ç§»å…¥
- [ ] Page ç®€åŒ–ä¸ºè°ƒç”¨ handler
- [ ] æµ‹è¯•éªŒè¯

#### ç¬¬4å‘¨ï¼šåˆ›å»ºå…¶ä»– Handlers

- [ ] UndoHandlerï¼ˆæ’¤é”€ï¼‰
- [ ] BundleHandlerï¼ˆè²å·ç”Ÿæˆï¼‰
- [ ] QualityHandlerï¼ˆè´¨æ£€ï¼‰
- [ ] æµ‹è¯•éªŒè¯

#### ç¬¬5å‘¨ï¼šå…¨é‡æµ‹è¯• + ä¸Šçº¿

- [ ] åŠŸèƒ½å›å½’æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] ç°åº¦å‘å¸ƒ
- [ ] å…¨é‡ä¸Šçº¿

### 3.7 æ³¨æ„äº‹é¡¹

#### âœ… æ¨èåšæ³•

1. **æ¸è¿›å¼é‡æ„** - ä¸€æ¬¡é‡æ„ä¸€ä¸ªæ¨¡å—
2. **ä¿æŒæµ‹è¯•** - æ¯æ¬¡é‡æ„åæµ‹è¯•éªŒè¯
3. **æ–‡æ¡£åŒæ­¥** - æ›´æ–°å¼€å‘æ–‡æ¡£
4. **ä»£ç å®¡æŸ¥** - é‡æ„ä»£ç éœ€è¦å®¡æŸ¥

#### âŒ é¿å…åšæ³•

1. **ä¸€æ¬¡æ€§é‡æ„** - ä¸è¦ä¸€æ¬¡æ”¹æ‰€æœ‰ä»£ç 
2. **è¿‡åº¦è®¾è®¡** - ä¸è¦å¼•å…¥ä¸å¿…è¦çš„æŠ½è±¡
3. **ç ´åå…¼å®¹** - ä¿æŒ API æ¥å£ä¸å˜
4. **å¿½ç•¥æµ‹è¯•** - å¿…é¡»æµ‹è¯•éªŒè¯

---

## å››ã€UIè®¾è®¡è§„èŒƒ

### 4.1 è®¾è®¡åŸåˆ™

- **ç»Ÿä¸€æ€§** - æ‰€æœ‰é¡µé¢ä½¿ç”¨ç›¸åŒçš„é¢œè‰²ã€åœ†è§’ã€é—´è·
- **ç®€æ´æ€§** - å‡å°‘è§†è§‰å¹²æ‰°ï¼Œçªå‡ºé‡è¦ä¿¡æ¯
- **ä¸€è‡´æ€§** - ç›¸åŒåŠŸèƒ½ä½¿ç”¨ç›¸åŒæ ·å¼
- **å“åº”å¼** - é€‚é…ä¸åŒå±å¹•å°ºå¯¸

### 4.2 é¢œè‰²ç³»ç»Ÿ

#### ä¸»è‰²è°ƒ

```css
/* æµ…è“æ¸å˜ - ç”¨äºé‡è¦å¡ç‰‡ã€å¼ºè°ƒæŒ‰é’®ã€å“ç‰Œå…ƒç´  */
background: linear-gradient(135deg, #e0f2fe 0%, #e0e7ff 100%);

/* ç¤ºä¾‹ï¼šæ‰«ç é¡µé¢å¡ç‰‡ã€çŠ¶æ€å±•ç¤ºåŒºåŸŸ */
```

#### è¾…åŠ©è‰²

```css
/* è“è‰²ç³» */
--color-blue: #3b82f6; /* ä¸»è“è‰² - æ ‡ç­¾ã€å›¾æ ‡ */
--color-blue-light: rgba(224, 242, 254, 0.8); /* æµ…è“è‰² - æ¿€æ´»çŠ¶æ€ã€é«˜äº® */
--color-blue-lighter: rgba(224, 242, 254, 0.3); /* è¶…æµ…è“ - æ‚¬åœçŠ¶æ€ */
```

#### åŠŸèƒ½è‰²

```css
--color-success: #10b981; /* æˆåŠŸ - ç»¿è‰² */
--color-warning: #f59e0b; /* è­¦å‘Š - æ©™è‰² */
--color-error: #ef4444; /* é”™è¯¯ - çº¢è‰² */
--color-info: #3b82f6; /* ä¿¡æ¯ - è“è‰² */
```

#### ä¸­æ€§è‰²

```css
/* èƒŒæ™¯è‰² */
--color-bg-page: #f7f8fa; /* é¡µé¢èƒŒæ™¯ */
--color-bg-card: #ffffff; /* å¡ç‰‡èƒŒæ™¯ */
--color-bg-gray: #f3f4f6; /* ç°è‰²èƒŒæ™¯ */
--color-bg-light: #f9fafb; /* æµ…è‰²èƒŒæ™¯ */

/* æ–‡å­—è‰² */
--color-text-primary: #111827; /* ä¸»è¦æ–‡å­— */
--color-text-secondary: #6b7280; /* æ¬¡è¦æ–‡å­— */
--color-text-disabled: #9ca3af; /* ç¦ç”¨æ–‡å­— */
--color-text-white: #ffffff; /* ç™½è‰²æ–‡å­— */

/* è¾¹æ¡†è‰² */
--color-border: #e5e7eb; /* æ ‡å‡†è¾¹æ¡† */
--color-border-light: #f3f4f6; /* æµ…è‰²è¾¹æ¡† */
```

### 4.3 åœ†è§’ç³»ç»Ÿ

#### æ ‡å‡†åœ†è§’å€¼

```css
--radius-sm: 8px; /* å°åœ†è§’ - å°æŒ‰é’®ã€æ ‡ç­¾ */
--radius-md: 12px; /* ä¸­åœ†è§’ - å¡ç‰‡ã€è¾“å…¥æ¡†ã€å°ç»„ä»¶ */
--radius-lg: 16px; /* å¤§åœ†è§’ - é‡è¦å¡ç‰‡ */
--radius-xl: 18px; /* ç‰¹å¤§åœ†è§’ - ä¸»å®¹å™¨ã€é¡µé¢å¡ç‰‡ */
--radius-full: 999px; /* å…¨åœ†è§’ - æŒ‰é’®ã€æœç´¢æ¡†ã€æ ‡ç­¾ */
```

#### ä½¿ç”¨åœºæ™¯å¯¹ç…§è¡¨

| å…ƒç´              | åœ†è§’å€¼       | ç¤ºä¾‹                       |
| ---------------- | ------------ | -------------------------- |
| é¡µé¢ä¸»å¡ç‰‡       | 18px (xl)    | `.card`                    |
| ç”¨æˆ·ä¿¡æ¯å¡ç‰‡     | 16px (lg)    | `.user-profile-card`       |
| åˆ—è¡¨é¡¹ã€ç»Ÿè®¡å¡ç‰‡ | 12px (md)    | `.stat-card`, `.list-item` |
| æ ‡ç­¾ã€è§’æ ‡       | 12px (md)    | `.profile-role`            |
| æŒ‰é’®ã€æœç´¢æ¡†     | 999px (full) | `.btn`, `.search-bar`      |
| æ ‡ç­¾é¡µ           | 999px (full) | `.tab`                     |

### 4.4 é—´è·ç³»ç»Ÿ

#### æ ‡å‡†é—´è·å€¼

```css
--spacing-xs: 4px; /* æœ€å°é—´è· - å…ƒç´ å†…å°é—´è· */
--spacing-sm: 8px; /* å°é—´è· - ç›¸å…³å…ƒç´ ä¹‹é—´ */
--spacing-md: 12px; /* ä¸­é—´è· - å¡ç‰‡å†…è¾¹è·ã€å…ƒç´ ç»„ä¹‹é—´ */
--spacing-lg: 16px; /* å¤§é—´è· - å¡ç‰‡å¤–è¾¹è·ã€åŒºå—ä¹‹é—´ */
--spacing-xl: 20px; /* ç‰¹å¤§é—´è· - é¡µé¢åŒºåŸŸåˆ†éš” */
--spacing-2xl: 24px; /* è¶…å¤§é—´è· - é¡µé¢å¤§åŒºåŸŸåˆ†éš” */
```

#### ä½¿ç”¨å»ºè®®

- ç›¸å…³å…ƒç´ é—´è·ï¼š8px
- å¡ç‰‡å†…è¾¹è·ï¼š12px
- å¡ç‰‡å¤–è¾¹è·ï¼š16px
- åŒºå—åˆ†éš”ï¼š20-24px

### 4.5 é˜´å½±ç³»ç»Ÿ

#### æ ‡å‡†é˜´å½±

```css
--shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05); /* å°é˜´å½± - å¾®å¦™å±‚æ¬¡ */
--shadow-md: 0 2px 6px rgba(0, 0, 0, 0.05); /* ä¸­é˜´å½± - å¡ç‰‡ */
--shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.08); /* å¤§é˜´å½± - æµ®å±‚ */
--shadow-primary: 0 4px 12px rgba(102, 126, 234, 0.25); /* å“ç‰Œé˜´å½± - ç´«è‰²å¡ç‰‡ */
```

#### ä½¿ç”¨åœºæ™¯

- æ™®é€šå¡ç‰‡ï¼š`shadow-md`
- æ‚¬æµ®å¼¹çª—ï¼š`shadow-lg`
- ç´«è‰²æ¸å˜å¡ç‰‡ï¼š`shadow-primary`

### 4.6 å­—ä½“ç³»ç»Ÿ

#### å­—å·è§„èŒƒ

```css
--font-size-xs: 11px; /* è¾…åŠ©ä¿¡æ¯ - åœ¨çº¿äººæ•°ã€æ—¶é—´æˆ³ */
--font-size-sm: 12px; /* å°æ–‡å­— - æ ‡ç­¾ã€æè¿°æ–‡å­— */
--font-size-base: 14px; /* æ­£æ–‡ - åˆ—è¡¨é¡¹å†…å®¹ã€æ™®é€šæ–‡å­— */
--font-size-lg: 16px; /* äºŒçº§æ ‡é¢˜ - åŒºå—æ ‡é¢˜ */
--font-size-xl: 18px; /* ä¸€çº§æ ‡é¢˜ - é¡µé¢æ ‡é¢˜ */
--font-size-2xl: 20px; /* æ•°å€¼å¼ºè°ƒ - ç»Ÿè®¡æ•°å­— */
```

#### å­—é‡è§„èŒƒ

```css
--font-weight-normal: 400; /* æ™®é€šæ–‡å­— */
--font-weight-medium: 500; /* æ¬¡è¦å¼ºè°ƒ */
--font-weight-semibold: 600; /* æ ‡é¢˜ã€é‡è¦æ–‡å­— */
--font-weight-bold: 700; /* æ•°å€¼ã€è¶…çº§å¼ºè°ƒ */
```

### 4.7 ç»„ä»¶è§„èŒƒ

#### 1. å¡ç‰‡ç»„ä»¶

```css
/* æ ‡å‡†å¡ç‰‡ */
.card {
  background: #ffffff;
  border-radius: 18px;
  padding: 12px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}

/* çŠ¶æ€å±•ç¤ºå¡ç‰‡ï¼ˆæµ…è“æ¸å˜ï¼‰ */
.status-display-card {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  background: linear-gradient(135deg, #e0f2fe 0%, #e0e7ff 100%);
  border-radius: 16px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  color: #1e40af;
}

/* ç»Ÿè®¡å¡ç‰‡ï¼ˆ4åˆ—ç½‘æ ¼ï¼‰ */
.stat-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
}

.stat-card {
  padding: 12px 8px;
  background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  text-align: center;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}

.stat-label {
  font-size: 12px;
  color: #6b7280;
  margin-bottom: 4px;
}

.stat-value {
  font-size: 20px;
  font-weight: 700;
  color: #111827;
}
```

#### 2. æŒ‰é’®ç»„ä»¶

```css
/* ä¸»è¦æŒ‰é’®ï¼ˆæµ…è“èƒŒæ™¯ï¼‰ */
.btn-primary {
  padding: 10px 18px;
  background: #e0f2fe;
  color: #1e40af;
  border-radius: 999px;
  font-weight: 600;
  border: 1px solid #bae6fd;
  box-shadow: 0 2px 6px rgba(59, 130, 246, 0.15);
}

/* æ¬¡è¦æŒ‰é’®ï¼ˆæµ…è“è‰²ï¼‰ */
.btn-secondary {
  padding: 10px 18px;
  background: rgba(224, 242, 254, 0.8);
  color: #1f2937;
  border-radius: 999px;
  border: 1px solid rgba(224, 242, 254, 0.9);
  font-weight: 500;
}

/* æ–‡å­—æŒ‰é’® */
.btn-text {
  padding: 10px 18px;
  background: transparent;
  color: #667eea;
  border-radius: 999px;
  border: 1px solid #e5e7eb;
}

/* å±é™©æŒ‰é’® */
.btn-danger {
  padding: 10px 18px;
  background: #ef4444;
  color: #ffffff;
  border-radius: 999px;
  font-weight: 600;
}
```

#### 3. æ ‡ç­¾é¡µç»„ä»¶

```css
/* æ ‡ç­¾æ å®¹å™¨ */
.tabbar {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 4px;
  padding: 4px;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 999px;
  margin-bottom: 12px;
}

/* æ ‡ç­¾é¡¹ */
.tab {
  padding: 5px 6px;
  font-size: 11px;
  background: rgba(255, 255, 255, 0.55);
  border-radius: 999px;
  text-align: center;
  color: #6b7280;
  transition: all 0.2s;
}

/* æ¿€æ´»çŠ¶æ€ */
.tab-active {
  background: rgba(224, 242, 254, 0.8);
  color: #1f2937;
  font-weight: 600;
}
```

#### 4. è¾“å…¥æ¡†ç»„ä»¶

```css
/* æœç´¢æ¡† */
.search-bar {
  display: flex;
  align-items: center;
  padding: 8px 16px;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 999px;
  gap: 8px;
}

.search-input {
  flex: 1;
  font-size: 14px;
  border: none;
  outline: none;
  background: transparent;
}

/* æ ‡å‡†è¾“å…¥æ¡† */
.input {
  padding: 10px 12px;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  font-size: 14px;
  outline: none;
}

.input:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}
```

#### 5. æ ‡ç­¾/å¾½ç« ç»„ä»¶

```css
/* çŠ¶æ€æ ‡ç­¾ */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
}

/* æˆåŠŸçŠ¶æ€ */
.badge-success {
  background: rgba(16, 185, 129, 0.1);
  color: #10b981;
}

/* è­¦å‘ŠçŠ¶æ€ */
.badge-warning {
  background: rgba(245, 158, 11, 0.1);
  color: #f59e0b;
}

/* é”™è¯¯çŠ¶æ€ */
.badge-error {
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
}

/* ä¿¡æ¯çŠ¶æ€ */
.badge-info {
  background: rgba(59, 130, 246, 0.1);
  color: #3b82f6;
}

/* è§’è‰²æ ‡ç­¾ï¼ˆç´«è‰²ï¼‰ */
.badge-role {
  background: rgba(102, 126, 234, 0.1);
  color: #667eea;
  border-radius: 999px;
}
```

### 4.8 é¡µé¢å¸ƒå±€è§„èŒƒ

#### 1. æ ‡å‡†é¡µé¢ç»“æ„

```xml
<!-- å°ç¨‹åºé¡µé¢ç»“æ„ -->
<view class="page-container">
  <!-- é¡µé¢å¤´éƒ¨ï¼ˆå¯é€‰ï¼‰ -->
  <view class="page-header">
    <text class="page-title">é¡µé¢æ ‡é¢˜</text>
  </view>

  <!-- é¡µé¢å†…å®¹ -->
  <view class="page-content">
    <!-- ä¸»è¦å†…å®¹åŒº -->
    <view class="content-section">
      <view class="section-title">åŒºå—æ ‡é¢˜</view>
      <view class="section-body">
        <!-- å¡ç‰‡åˆ—è¡¨ -->
      </view>
    </view>
  </view>
</view>
```

```css
/* å¯¹åº”æ ·å¼ */
.page-container {
  min-height: 100vh;
  background: #f7f8fa;
  padding: 12px;
}

.page-header {
  padding: 16px 0;
}

.page-title {
  font-size: 18px;
  font-weight: 600;
  color: #111827;
}

.content-section {
  margin-bottom: 16px;
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  color: #111827;
  margin-bottom: 12px;
}
```

#### 2. åˆ—è¡¨é¡¹å¸ƒå±€

```css
/* æ ‡å‡†åˆ—è¡¨é¡¹ */
.list-item {
  background: #ffffff;
  border-radius: 12px;
  padding: 12px;
  border: 1px solid #e5e7eb;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.list-item-icon {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(102, 126, 234, 0.1);
  color: #667eea;
}

.list-item-content {
  flex: 1;
}

.list-item-title {
  font-size: 14px;
  font-weight: 600;
  color: #111827;
  margin-bottom: 4px;
}

.list-item-desc {
  font-size: 12px;
  color: #6b7280;
}

.list-item-action {
  color: #667eea;
  font-size: 12px;
}
```

### 4.9 å“åº”å¼è®¾è®¡

#### å±å¹•æ–­ç‚¹

```css
/* å°å±å¹•ï¼ˆiPhone SEï¼‰ */
@media (max-width: 375px) {
  .stat-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* ä¸­å±å¹•ï¼ˆiPhone 12/13ï¼‰ */
@media (min-width: 390px) and (max-width: 428px) {
  .stat-grid {
    grid-template-columns: repeat(4, 1fr);
  }
}

/* å¤§å±å¹•ï¼ˆiPadï¼‰ */
@media (min-width: 768px) {
  .page-container {
    max-width: 768px;
    margin: 0 auto;
  }
}
```

### 4.10 è®¾è®¡è§„èŒƒä½¿ç”¨æŒ‡å—

#### âœ… å¿…é¡»éµå¾ªçš„è§„èŒƒ

1. **æ‰€æœ‰ä¸»å¡ç‰‡** â†’ `border-radius: 18px`
2. **æ‰€æœ‰å°å¡ç‰‡/åˆ—è¡¨é¡¹** â†’ `border-radius: 12px`
3. **æ‰€æœ‰æŒ‰é’®** â†’ `border-radius: 999px`
4. **æµ…è“æ¸å˜** â†’ ç»Ÿä¸€ä½¿ç”¨ `linear-gradient(135deg, #e0f2fe 0%, #e0e7ff 100%)`ï¼ˆæµ…è“åˆ°æ·¡ç´«è“ï¼‰
5. **æ¿€æ´»çŠ¶æ€** â†’ ç»Ÿä¸€ä½¿ç”¨ `rgba(224, 242, 254, 0.8)`
6. **é¡µé¢èƒŒæ™¯** â†’ ç»Ÿä¸€ä½¿ç”¨ `#f7f8fa`
7. **å¡ç‰‡é˜´å½±** â†’ ç»Ÿä¸€ä½¿ç”¨ `0 2px 6px rgba(0, 0, 0, 0.05)`
8. **æ–‡å­—é¢œè‰²** â†’ ä¸»æ–‡å­— `#111827`ï¼Œæ¬¡æ–‡å­— `#6b7280`
9. **å¼¹çª—å°ºå¯¸** â†’ ç»Ÿä¸€ä½¿ç”¨ `max-width: 90vw`, `border-radius: 16px`
10. **è¿›åº¦æ¡æ ·å¼** â†’ ä»…ä½¿ç”¨ `app.wxss` å…¨å±€æ ·å¼ï¼Œä¸å¾—åœ¨é¡µé¢é‡å¤å®šä¹‰

#### UIç»†èŠ‚ç»Ÿä¸€æ ‡å‡†ï¼ˆ2026-01-23 è¡¥å……ï¼‰

##### å¼¹çª— Modal

```css
/* âœ… ç»Ÿä¸€æ ‡å‡†ï¼šä½¿ç”¨ app.wxss çš„ .modal-backdrop + .modal-wrap */
.modal-wrap {
  max-width: 90vw; /* ç»Ÿä¸€å®½åº¦ */
  border-radius: 16px; /* ç»Ÿä¸€åœ†è§’ */
  box-shadow: 0 20px 48px rgba(0, 0, 0, 0.15);
}

/* âŒ ç¦æ­¢ï¼šé¡µé¢è‡ªå®šä¹‰å¼¹çª—æ ·å¼è¦†ç›– */
```

##### æŒ‰é’®é¢œè‰²

```css
/* âœ… ä¸»è¦æŒ‰é’®ï¼šæµ…è“æ¸å˜ */
.btn-primary {
  background: linear-gradient(135deg, #e0f2fe 0%, #e0e7ff 100%);
}

/* âŒ ç¦æ­¢ï¼šä½¿ç”¨ç´«è‰²æ¸å˜ #667eea â†’ #764ba2 */
```

##### è¿›åº¦æ¡

```css
/* âœ… ç»Ÿä¸€ä½¿ç”¨ app.wxss å…¨å±€æ ·å¼ */
.progress-wrapper {
  /* ä»…åœ¨ app.wxss å®šä¹‰ */
}
.progress-bar {
  /* ä»…åœ¨ app.wxss å®šä¹‰ */
}
.progress-fill {
  background: linear-gradient(90deg, #10b981 0%, #3b82f6 100%);
}

/* âŒ ç¦æ­¢ï¼šé¡µé¢ wxss é‡å¤å®šä¹‰è¿›åº¦æ¡æ ·å¼ */
```

##### èŠ‚ç‚¹è¿›åº¦æ–‡å­—é¢œè‰²

- è¿›åº¦ç™¾åˆ†æ¯”ï¼š`color: #6b7280`, `font-size: 11px`
- å½“å‰èŠ‚ç‚¹ï¼šä½¿ç”¨ app.wxss ç»Ÿä¸€æ ·å¼ï¼Œä¸å¾—å•ç‹¬å®šä¹‰

#### è®¾è®¡è§„èŒƒæ–‡ä»¶ä½ç½®

- **è®¾è®¡ç³»ç»Ÿæ–‡æ¡£**: `miniprogram/DESIGN_SYSTEM.md`
- **è®¾è®¡ Token**: `miniprogram/styles/design-tokens.wxss`
- **å…¨å±€æ ·å¼**: `miniprogram/app.wxss`

#### å¼•å…¥è®¾è®¡è§„èŒƒ

```css
/* åœ¨é¡µé¢ wxss æ–‡ä»¶é¡¶éƒ¨å¼•å…¥ */
@import "../../styles/design-tokens.wxss";
```

#### ä½¿ç”¨è®¾è®¡ Token

```css
/* âœ… æ­£ç¡®ï¼šä½¿ç”¨ Token */
.card {
  border-radius: var(--radius-xl);
  padding: var(--spacing-md);
  background: var(--color-bg-card);
  box-shadow: var(--shadow-md);
}

/* âŒ é”™è¯¯ï¼šç¡¬ç¼–ç å€¼ */
.card {
  border-radius: 18px;
  padding: 12px;
  background: #ffffff;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}
```

### 4.11 å·²ç»Ÿä¸€çš„é¡µé¢

#### âœ… ä¸ªäººé¡µé¢ (`admin/index`)

- ç´«è‰²æ¸å˜ç”¨æˆ·å¡ç‰‡
- 4åˆ—ç»Ÿè®¡ç½‘æ ¼
- ç»Ÿä¸€åœ†è§’å’Œé—´è·
- æ¿€æ´»çŠ¶æ€æ ·å¼

#### ğŸ”„ å¾…ç»Ÿä¸€çš„é¡µé¢

- é¦–é¡µ (`home/index`)
- ç”Ÿäº§é¡µ (`work/index`)
- æ‰«ç é¡µ (`scan/index`)

---

## äº”ã€å‰ç«¯æ¨¡å—åŒ–è§„èŒƒ

### 5.1 æ¨¡å—è¾¹ç•Œ

- åŸºç¡€èµ„æ–™ï¼šæ¬¾å·èµ„æ–™ã€ä¸‹å•ç®¡ç†ã€èµ„æ–™ä¸­å¿ƒã€å•ä»·æµç¨‹
- ç”Ÿäº§ç®¡ç†ï¼šè®¢å•ã€ç‰©æ–™é‡‡è´­ã€è£å‰ªã€è¿›åº¦ã€å…¥åº“
- è´¢åŠ¡ç®¡ç†ï¼šç‰©æ–™å¯¹è´¦ã€æˆå“ç»“ç®—ã€å®¡æ‰¹ä»˜æ¬¾ã€å‘˜å·¥å·¥åº
- ç³»ç»Ÿè®¾ç½®ï¼šäººå‘˜ã€è§’è‰²ã€ä¾›åº”å•†ã€ç™»å½•æ—¥å¿—ã€ä¸ªäººä¸­å¿ƒ
- ä»ªè¡¨ç›˜ï¼šæ•°æ®æ¦‚è§ˆä¸å¿«æ·å…¥å£

### 5.2 ç›®å½•ç»“æ„ï¼ˆå·²å®ç° âœ…ï¼‰

```
src/
  modules/                           # âœ… å·²å®ç°æ¨¡å—åŒ–
    basic/                           # åŸºç¡€èµ„æ–™æ¨¡å—
      index.tsx                      # æ¨¡å—å…¥å£ï¼ˆé¡µé¢å¯¼å‡ºï¼‰
      pages/                         # é¡µé¢ç›®å½•
        StyleInfo/                   # æ¬¾å·è¯¦æƒ…ï¼ˆå«7ä¸ªTabç»„ä»¶ï¼‰
        DataCenter/                  # èµ„æ–™ä¸­å¿ƒ
        TemplateCenter/              # æ¨¡æ¿ä¸­å¿ƒ
        OrderManagement/             # ä¸‹å•ç®¡ç†
    production/                      # ç”Ÿäº§ç®¡ç†æ¨¡å—ï¼ˆå¾…å®Œå–„ï¼‰
      index.tsx
      pages/
    finance/                         # è´¢åŠ¡ç®¡ç†æ¨¡å—ï¼ˆå¾…å®Œå–„ï¼‰
      index.tsx
      pages/
    system/                          # ç³»ç»Ÿç®¡ç†æ¨¡å—
      index.tsx
      pages/
        System/
          UserList/                  # ç”¨æˆ·åˆ—è¡¨
          RoleList/                  # è§’è‰²åˆ—è¡¨
          LoginLogList/              # ç™»å½•æ—¥å¿—
          UserApproval/              # ç”¨æˆ·å®¡æ‰¹
          Profile/                   # ä¸ªäººä¸­å¿ƒ
    dashboard/                       # ä»ªè¡¨ç›˜æ¨¡å—
      index.tsx
      pages/
        Dashboard/                   # æ•°æ®æ¦‚è§ˆ
  components/                        # å…±äº«ç»„ä»¶
    common/
      ResizableModal.tsx            # âœ… ç»Ÿä¸€å¼¹çª—ç»„ä»¶ï¼ˆ80vwÃ—85vhï¼‰
      SortableColumnTitle.tsx       # âœ… é€šç”¨æ’åºåˆ—ç»„ä»¶
      QRCodeBox.tsx                 # âœ… ç»Ÿä¸€äºŒç»´ç ç»„ä»¶
      ModalContentLayout.tsx        # âœ… å¼¹çª—å†…å®¹å¸ƒå±€ç»„ä»¶
  utils/                            # å·¥å…·å‡½æ•°
  services/                         # APIæœåŠ¡
  routeConfig.ts                    # è·¯ç”±é…ç½®
```

**æ¨¡å—åŒ–è¿›åº¦**ï¼š

- âœ… basic æ¨¡å—ï¼ˆ4ä¸ªé¡µé¢ï¼‰
- âœ… system æ¨¡å—ï¼ˆ5ä¸ªé¡µé¢ï¼‰
- âœ… dashboard æ¨¡å—ï¼ˆ1ä¸ªé¡µé¢ï¼‰
- â³ production æ¨¡å—ï¼ˆè¿ç§»ä¸­ï¼‰
- â³ finance æ¨¡å—ï¼ˆè¿ç§»ä¸­ï¼‰

### 5.3 æ¨¡å—å†…å¿…é¡»åšåˆ°

- é¡µé¢å…¥å£ç»Ÿä¸€æ”¾åœ¨ src/modules/<module>/index.tsxï¼Œåªåšé¡µé¢å¯¼å‡ºä¸æ‡’åŠ è½½
- é¡µé¢ã€ç»„ä»¶ã€æœåŠ¡ã€hooksã€types å¿…é¡»æ”¾åœ¨æœ¬æ¨¡å—ç›®å½•å†…
- æ¨¡å—å†…é¡µé¢åªå…è®¸å¼•ç”¨æœ¬æ¨¡å—ä¸ shared
- æ¨¡å—é—´ç¦æ­¢ç›´æ¥å¼•ç”¨å¯¹æ–¹çš„ pages/components/services/hooks/types
- è·¨æ¨¡å—å¤ç”¨å¿…é¡»æ²‰æ·€åˆ° sharedï¼Œå†ç”±æ¨¡å—å¼•ç”¨
- å…±äº«èƒ½åŠ›å¿…é¡»ä¿æŒé€šç”¨ï¼Œä¸å¾—è€¦åˆå•ä¸€æ¨¡å—ä¸šåŠ¡è¯­ä¹‰

### 5.4 è·¯ç”±ä¸èœå•å½’å±

- è·¯ç”±é›†ä¸­ç»´æŠ¤åœ¨ routeConfig.tsï¼Œæ¨¡å—ä»…æä¾›é¡µé¢å…¥å£
- èœå•é¡¹å¿…é¡»ä¸æ¨¡å—è¾¹ç•Œä¸€è‡´ï¼Œèœå• key ä½¿ç”¨æ¨¡å—å
- è·¯ç”± path éœ€ä¸æ¨¡å—å‰ç¼€ä¸€è‡´ï¼Œç¦æ­¢è·¨æ¨¡å—æ··ç”¨
- æ¨¡å—å†…éƒ¨é¡µé¢ä¸ç›´æ¥æ”¹å†™å…¨å±€è·¯ç”±ç»“æ„

### 5.5 æ–°å¢ä¸è¿ç§»æ¸…å•

- æ–°åŠŸèƒ½ï¼šç›´æ¥è½åœ¨å¯¹åº”æ¨¡å—ç›®å½•
- æ–°é¡µé¢ï¼šå…ˆåœ¨æ¨¡å—å…¥å£æ³¨å†Œï¼Œå†æ¥å…¥è·¯ç”±
- æ—§é¡µé¢ï¼šæŒ‰æ¨¡å—é€æ­¥è¿ç§»ï¼Œä¸æ”¹ç°æœ‰è·¯å¾„
- è¿ç§»æ—¶ä¿æŒè·¯ç”±ä¸å˜ï¼Œé¿å…å½±å“çº¿ä¸Šå…¥å£
- æ–°é¡µé¢è½åœ°æ­¥éª¤
  1. åœ¨æ¨¡å— pages å†…åˆ›å»ºé¡µé¢
  2. åœ¨æ¨¡å— index.tsx ç»Ÿä¸€å¯¼å‡º
  3. åœ¨ routeConfig.ts é…ç½® path ä¸èœå•
  4. åœ¨ App.tsx å¼•ç”¨æ¨¡å—å…¥å£

### 5.6 æ¨¡å—åŒ–éªŒæ”¶æ¸…å•

- é¡µé¢å…¥å£æ˜¯å¦åœ¨æ¨¡å— index.tsx
- æ¨¡å—å†…æ˜¯å¦åªä¾èµ–æœ¬æ¨¡å—ä¸ shared
- æ˜¯å¦å­˜åœ¨è·¨æ¨¡å—ç›´æ¥å¼•ç”¨
- è·¯ç”±ä¸èœå•æ˜¯å¦ä¸æ¨¡å—è¾¹ç•Œä¸€è‡´

### 5.7 å‰ç«¯æ¨¡å—åŒ–å¼€å‘å®æˆ˜æŒ‡å—

#### æ–°å¢é¡µé¢æµç¨‹ï¼ˆä»¥æ·»åŠ "ç”Ÿäº§è®¢å•åˆ—è¡¨"ä¸ºä¾‹ï¼‰

**æ­¥éª¤1ï¼šåˆ›å»ºé¡µé¢æ–‡ä»¶**

```bash
# åœ¨å¯¹åº”æ¨¡å—ä¸‹åˆ›å»ºé¡µé¢ç›®å½•
mkdir -p frontend/src/modules/production/pages/OrderList
touch frontend/src/modules/production/pages/OrderList/index.tsx
```

**æ­¥éª¤2ï¼šç¼–å†™é¡µé¢ç»„ä»¶**

```typescript
// frontend/src/modules/production/pages/OrderList/index.tsx
import React from 'react';
import { Table, Button } from 'antd';

const OrderList: React.FC = () => {
  return (
    <div>
      <h2>ç”Ÿäº§è®¢å•åˆ—è¡¨</h2>
      <Table />
    </div>
  );
};

export default OrderList;
```

**æ­¥éª¤3ï¼šåœ¨æ¨¡å—å…¥å£å¯¼å‡º**

```typescript
// frontend/src/modules/production/index.tsx
import React, { lazy } from "react";

export const OrderList = lazy(() => import("./pages/OrderList"));
export const CuttingList = lazy(() => import("./pages/CuttingList"));
// ... å…¶ä»–é¡µé¢
```

**æ­¥éª¤4ï¼šé…ç½®è·¯ç”±**

```typescript
// frontend/src/routeConfig.ts
import { OrderList } from './modules/production';

const routes = [
  {
    path: '/production/order-list',
    element: <OrderList />,
    meta: {
      title: 'ç”Ÿäº§è®¢å•',
      requiresAuth: true,
      permissionCode: 'PRODUCTION_ORDER_VIEW'
    }
  }
];
```

**æ­¥éª¤5ï¼šæ·»åŠ èœå•é¡¹**

```typescript
// frontend/src/routeConfig.ts - menuItems
{
  key: 'production',
  label: 'ç”Ÿäº§ç®¡ç†',
  children: [
    { key: '/production/order-list', label: 'ç”Ÿäº§è®¢å•' },
    // ...
  ]
}
```

#### é¡µé¢è¿ç§»æµç¨‹ï¼ˆä»¥è¿ç§»"è£å‰ªå•ç®¡ç†"ä¸ºä¾‹ï¼‰

**è¿ç§»å‰ä½ç½®**ï¼š`frontend/src/pages/Production/Cutting.tsx`  
**è¿ç§»åä½ç½®**ï¼š`frontend/src/modules/production/pages/CuttingList/index.tsx`

**æ­¥éª¤1ï¼šåˆ›å»ºæ–°ç›®å½•å¹¶å¤åˆ¶æ–‡ä»¶**

```bash
mkdir -p frontend/src/modules/production/pages/CuttingList
cp frontend/src/pages/Production/Cutting.tsx \
   frontend/src/modules/production/pages/CuttingList/index.tsx
```

**æ­¥éª¤2ï¼šä¿®å¤å¯¼å…¥è·¯å¾„**

```typescript
// ä¿®æ”¹å‰
import api from "../../services/api";
import ResizableModal from "../../components/common/ResizableModal";

// ä¿®æ”¹åï¼ˆä»æ¨¡å—å†…è®¿é—® sharedï¼‰
import api from "@/services/api";
import ResizableModal from "@/components/common/ResizableModal";
```

**æ­¥éª¤3ï¼šåœ¨æ¨¡å—å…¥å£å¯¼å‡º**

```typescript
// frontend/src/modules/production/index.tsx
export const CuttingList = lazy(() => import("./pages/CuttingList"));
```

**æ­¥éª¤4ï¼šæ›´æ–°è·¯ç”±å¼•ç”¨**

```typescript
// frontend/src/routeConfig.ts
// ä¿®æ”¹å‰
import Cutting from './pages/Production/Cutting';

// ä¿®æ”¹å
import { CuttingList } from './modules/production';

// è·¯ç”±é…ç½®ä¿æŒä¸å˜ï¼ˆè·¯å¾„ä¸å˜ï¼‰
{
  path: '/production/cutting',
  element: <CuttingList />,  // ç»„ä»¶å¼•ç”¨æ”¹ä¸ºæ¨¡å—å¯¼å‡º
  // ...
}
```

**æ­¥éª¤5ï¼šéªŒè¯å¹¶åˆ é™¤æ—§æ–‡ä»¶**

```bash
# 1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨æµ‹è¯•
npm run dev

# 2. è®¿é—®é¡µé¢ç¡®è®¤åŠŸèƒ½æ­£å¸¸

# 3. ç¡®è®¤æ— é—®é¢˜ååˆ é™¤æ—§æ–‡ä»¶
rm frontend/src/pages/Production/Cutting.tsx
```

#### æ¨¡å—é—´é€šä¿¡è§„èŒƒ

**âŒ é”™è¯¯ï¼šç›´æ¥è·¨æ¨¡å—å¼•ç”¨**

```typescript
// âŒ finance æ¨¡å—ç›´æ¥å¼•ç”¨ production æ¨¡å—ç»„ä»¶
import OrderSelector from "../../production/components/OrderSelector";
```

**âœ… æ­£ç¡®ï¼šé€šè¿‡ shared å…±äº«**

```typescript
// 1. å°† OrderSelector ç§»åˆ° shared
// frontend/src/components/business/OrderSelector.tsx

// 2. å„æ¨¡å—ä» shared å¼•ç”¨
import OrderSelector from "@/components/business/OrderSelector";
```

**è·¨æ¨¡å—æ•°æ®ä¼ é€’**ï¼š

- é€šè¿‡è·¯ç”±å‚æ•°ï¼š`navigate('/finance/reconciliation?orderId=123')`
- é€šè¿‡å…¨å±€çŠ¶æ€ï¼šä½¿ç”¨ Zustand storeï¼ˆå¦‚ `appContext.tsx`ï¼‰
- é€šè¿‡ APIï¼šè°ƒç”¨åç«¯æ¥å£è·å–è·¨æ¨¡å—æ•°æ®

---

## å…­ã€å¼€å‘æœ€ä½³å®è·µ

### 6.1 åç«¯å¼€å‘è§„èŒƒ

#### æ•°æ®æƒé™ä¸å¤šå·¥å‚éš”ç¦»

ç³»ç»Ÿæ”¯æŒ **4 å±‚æ•°æ®æƒé™**ï¼ˆåŸºäº `t_role.data_scope` å­—æ®µï¼‰ï¼š

**ğŸ”’ æƒé™å±‚çº§å…³ç³»å›¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ¢ æ€»éƒ¨ç®¡ç†å‘˜ (ALL)                           â”‚
â”‚              factory_id = NULLï¼ŒæŸ¥çœ‹æ‰€æœ‰æ•°æ®                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   å·¥å‚Aæ•°æ®   â”‚   å·¥å‚Bæ•°æ®   â”‚   å·¥å‚Cæ•°æ®   â”‚   æ— å·¥å‚æ•°æ®  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ åªèƒ½çœ‹è‡ªå·±å·¥å‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        ğŸ­ å·¥å‚Aç®¡ç†å‘˜ (FACTORY_ONLY)                   â”‚
    â”‚        factory_id = 'å·¥å‚A'ï¼Œåªçœ‹å·¥å‚A                  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚  â”‚            å·¥å‚Açš„æ‰€æœ‰æ•°æ®                     â”‚    â”‚
    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
    â”‚  â”‚  â”‚ ç»„é•¿1  â”‚ ç»„é•¿2  â”‚ ç»„é•¿3  â”‚ ç»„é•¿4  â”‚ â†â”€â”€â”  â”‚    â”‚
    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ åªèƒ½çœ‹è‡ªå·±å›¢é˜Ÿ
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   ğŸ‘¥ ç»„é•¿1 (TEAM)                â”‚
              â”‚   åªçœ‹ç»„é•¿1çš„å›¢é˜Ÿæ•°æ®             â”‚
              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
              â”‚  â”‚  å‘˜å·¥1 â”‚ å‘˜å·¥2 â”‚ å‘˜å·¥3  â”‚    â”‚
              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ åªèƒ½çœ‹è‡ªå·±
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ğŸ‘¤ å‘˜å·¥1 (OWN)   â”‚
                    â”‚  åªçœ‹è‡ªå·±çš„æ•°æ®    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“Š æƒé™çŸ©é˜µè¡¨**ï¼š

| æƒé™çº§åˆ« | data_scope | é€‚ç”¨è§’è‰² | factory_id | å¯è§æ•°æ®èŒƒå›´ | å…¸å‹ç”¨æˆ· |
|---------|-----------|---------|-----------|------------|---------|
| **å…¨å±€æƒé™** | `ALL` | æ€»éƒ¨ç®¡ç†å‘˜ | `NULL` | âœ… æ‰€æœ‰å·¥å‚ | CEOã€è´¢åŠ¡æ€»ç›‘ |
| **å·¥å‚æƒé™** | `FACTORY_ONLY` | å·¥å‚ç®¡ç†å‘˜ | `'å·¥å‚A'` | âœ… å·¥å‚A <br> âŒ å·¥å‚B/C | å·¥å‚å‚é•¿ã€ä¸»ç®¡ |
| **å›¢é˜Ÿæƒé™** | `TEAM` | ç»„é•¿ | - | âœ… æœ¬å›¢é˜Ÿ <br> âŒ å…¶ä»–å›¢é˜Ÿ | ç”Ÿäº§ç»„é•¿ã€ç­é•¿ |
| **ä¸ªäººæƒé™** | `OWN` | æ™®é€šå‘˜å·¥ | - | âœ… è‡ªå·± <br> âŒ å…¶ä»–äºº | ä¸€çº¿å·¥äººã€è´¨æ£€å‘˜ |

**ğŸ”„ æ•°æ®è¿‡æ»¤æµç¨‹å›¾**ï¼š
```
ç”¨æˆ·ç™»å½•
   â†“
è·å–ç”¨æˆ·ä¿¡æ¯ (username, role_id, factory_id)
   â†“
æŸ¥è¯¢è§’è‰²æƒé™ (data_scope)
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ ¹æ® data_scope å†³å®šè¿‡æ»¤ç­–ç•¥        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ALL          â†’ ä¸è¿‡æ»¤ï¼Œè¿”å›æ‰€æœ‰æ•°æ®  â”‚
â”‚  FACTORY_ONLY â†’ WHERE factory_id = ? â”‚
â”‚  TEAM         â†’ WHERE team_id = ?    â”‚
â”‚  OWN          â†’ WHERE operator_id = ?â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
æ‰§è¡Œ SQL æŸ¥è¯¢
   â†“
è¿”å›è¿‡æ»¤åçš„æ•°æ®
```

**ğŸ—„ï¸ æ•°æ®åº“è¡¨ç»“æ„**ï¼š
```sql
-- t_user è¡¨ï¼ˆå·²æ·»åŠ  factory_id å­—æ®µï¼‰âœ…
ALTER TABLE t_user ADD COLUMN factory_id VARCHAR(50);
ALTER TABLE t_user ADD INDEX idx_factory_id (factory_id);

-- t_role è¡¨ï¼ˆå·²æœ‰ data_scope å­—æ®µï¼‰âœ…
-- data_scope VARCHAR(20) DEFAULT 'ALL'

-- ç¤ºä¾‹æ•°æ®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ username â”‚ role_nameâ”‚ factory_id â”‚ data_scope â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ admin    â”‚ ç®¡ç†å‘˜   â”‚ NULL       â”‚ ALL        â”‚  â† æ€»éƒ¨çœ‹å…¨éƒ¨
â”‚ factory_aâ”‚ å·¥å‚ç®¡ç† â”‚ å·¥å‚A      â”‚FACTORY_ONLYâ”‚  â† åªçœ‹å·¥å‚A
â”‚ factory_bâ”‚ å·¥å‚ç®¡ç† â”‚ å·¥å‚B      â”‚FACTORY_ONLYâ”‚  â† åªçœ‹å·¥å‚B
â”‚ leader_1 â”‚ ç»„é•¿     â”‚ -          â”‚ TEAM       â”‚  â† åªçœ‹å›¢é˜Ÿ
â”‚ worker_1 â”‚ å‘˜å·¥     â”‚ -          â”‚ OWN        â”‚  â† åªçœ‹è‡ªå·±
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš™ï¸ é…ç½®æ­¥éª¤**ï¼š

```
ç¬¬1æ­¥: åˆ†é…ç”¨æˆ·åˆ°å·¥å‚        ç¬¬2æ­¥: é…ç½®è§’è‰²æƒé™         ç¬¬3æ­¥: åç«¯å®ç°è¿‡æ»¤
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UPDATE t_user    â”‚      â”‚ UPDATE t_role    â”‚      â”‚ ä»£ç å®ç°è¿‡æ»¤é€»è¾‘  â”‚
â”‚ SET factory_id   â”‚  â†’   â”‚ SET data_scope   â”‚  â†’   â”‚ (è§ä¸‹æ–¹ä»£ç )      â”‚
â”‚ WHERE username   â”‚      â”‚ WHERE role_code  â”‚      â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**1ï¸âƒ£ åˆ†é…ç”¨æˆ·åˆ°å·¥å‚**
```sql
-- å·¥å‚ç®¡ç†å‘˜åˆ†é…å·¥å‚ID
UPDATE t_user SET factory_id = 'å·¥å‚A' WHERE username = 'factory_a_admin';
UPDATE t_user SET factory_id = 'å·¥å‚B' WHERE username = 'factory_b_admin';

-- âš ï¸ æ€»éƒ¨ç®¡ç†å‘˜ä¸è®¾ç½® factory_idï¼ˆä¿æŒ NULL = çœ‹æ‰€æœ‰å·¥å‚ï¼‰
UPDATE t_user SET factory_id = NULL WHERE username = 'admin';
```

**2ï¸âƒ£ é…ç½®è§’è‰²æƒé™**
```sql
UPDATE t_role SET data_scope = 'ALL' WHERE role_code = 'ADMIN';           -- æ€»éƒ¨ç®¡ç†å‘˜
UPDATE t_role SET data_scope = 'FACTORY_ONLY' WHERE role_code LIKE '%FACTORY%'; -- å·¥å‚è§’è‰²
UPDATE t_role SET data_scope = 'TEAM' WHERE role_code LIKE '%LEADER%';    -- ç»„é•¿
UPDATE t_role SET data_scope = 'OWN' WHERE role_code LIKE '%WORKER%';     -- æ™®é€šå‘˜å·¥
```

**3ï¸âƒ£ åç«¯å®ç°è¿‡æ»¤é€»è¾‘**ï¼š

**æµç¨‹å›¾**ï¼š
```
Controller å±‚                Orchestrator/Service å±‚        DataPermissionHelper
     â”‚                              â”‚                              â”‚
     â”‚ æ¥æ”¶è¯·æ±‚                      â”‚                              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚                              â”‚
     â”‚                              â”‚ åˆ›å»ºæŸ¥è¯¢æ¡ä»¶                  â”‚
     â”‚                              â”‚ QueryWrapper wrapper = new    â”‚
     â”‚                              â”‚                              â”‚
     â”‚                              â”‚ è·å–å½“å‰ç”¨æˆ·æƒé™              â”‚
     â”‚                              â”‚ dataScope = getDataScope()    â”‚
     â”‚                              â”‚                              â”‚
     â”‚                              â”‚ åº”ç”¨æƒé™è¿‡æ»¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚
     â”‚                              â”‚                              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                              â”‚                              â”‚ â”‚ åˆ¤æ–­ scope  â”‚
     â”‚                              â”‚                              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                              â”‚                              â”‚       â†“
     â”‚                              â”‚                              â”‚  ALL? â†’ ä¸è¿‡æ»¤
     â”‚                              â”‚                              â”‚       â†“
     â”‚                              â”‚                              â”‚  FACTORY_ONLY?
     â”‚                              â”‚                              â”‚  â†’ wrapper.eq(
     â”‚                              â”‚                              â”‚     "factory_id",
     â”‚                              â”‚                              â”‚     factoryId)
     â”‚                              â”‚                              â”‚       â†“
     â”‚                              â”‚ â†â”€â”€â”€â”€ è¿”å›è¿‡æ»¤åçš„ wrapper â”€â”˜
     â”‚                              â”‚                              
     â”‚                              â”‚ æ‰§è¡ŒæŸ¥è¯¢
     â”‚                              â”‚ baseMapper.selectList(wrapper)
     â”‚                              â”‚                              
     â”‚ â†â”€â”€â”€â”€ è¿”å›æ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                              
è¿”å›ç»™å‰ç«¯
```

**ä»£ç å®ç°**ï¼š

```java
// UserContext.java - è·å–å½“å‰ç”¨æˆ·å·¥å‚ID
public String getFactoryId() {
    return currentUser.getFactoryId();
}

// DataPermissionHelper.java - åº”ç”¨å·¥å‚è¿‡æ»¤
public void applyFactoryFilter(QueryWrapper<?> wrapper, String dataScope) {
    String factoryId = UserContext.getFactoryId();
    
    // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    // â”‚ æƒé™åˆ¤æ–­é€»è¾‘ï¼ˆæ ¸å¿ƒï¼‰              â”‚
    // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    // ğŸŒ ALL: æ€»éƒ¨ç®¡ç†å‘˜ï¼Œä¸é™åˆ¶å·¥å‚èŒƒå›´
    if ("ALL".equals(dataScope)) {
        return; // âœ… ä¸æ·»åŠ ä»»ä½•è¿‡æ»¤ï¼Œè¿”å›æ‰€æœ‰æ•°æ®
    }
    
    // ğŸ­ FACTORY_ONLY: å·¥å‚ç®¡ç†å‘˜ï¼Œåªçœ‹æœ¬å·¥å‚
    if ("FACTORY_ONLY".equals(dataScope)) {
        if (factoryId == null) {
            throw new BusinessException("å·¥å‚ç®¡ç†å‘˜å¿…é¡»åˆ†é…å·¥å‚ID");
        }
        wrapper.eq("factory_id", factoryId); // âœ… æ·»åŠ å·¥å‚è¿‡æ»¤æ¡ä»¶
    }
    
    // ğŸ‘¥ TEAM/ğŸ‘¤ OWN: ç»§ç»­æŒ‰åŸæœ‰é€»è¾‘å¤„ç†
}

// Service å±‚åº”ç”¨è¿‡æ»¤ï¼ˆç¤ºä¾‹ï¼‰
public List<ProductionOrder> list() {
    QueryWrapper<ProductionOrder> wrapper = new QueryWrapper<>();
    String dataScope = UserContext.getDataScope();
    
    // ğŸ”’ åº”ç”¨å·¥å‚æƒé™è¿‡æ»¤ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
    DataPermissionHelper.applyFactoryFilter(wrapper, dataScope);
    
    return baseMapper.selectList(wrapper);
}
```

**ğŸ“‹ ä½¿ç”¨è§„åˆ™æ¸…å•**ï¼š

| åœºæ™¯ | æ“ä½œ | ç»“æœ | è¯´æ˜ |
|-----|------|------|------|
| âœ… æ€»éƒ¨ç®¡ç†å‘˜æŸ¥è¯¢ | `factory_id = NULL` + `data_scope = ALL` | è¿”å›**æ‰€æœ‰å·¥å‚**æ•°æ® | ä¸æ·»åŠ è¿‡æ»¤æ¡ä»¶ |
| âœ… å·¥å‚Aç®¡ç†å‘˜æŸ¥è¯¢ | `factory_id = 'å·¥å‚A'` + `data_scope = FACTORY_ONLY` | è¿”å›**å·¥å‚A**æ•°æ® | `WHERE factory_id = 'å·¥å‚A'` |
| âœ… å·¥å‚Bç®¡ç†å‘˜æŸ¥è¯¢ | `factory_id = 'å·¥å‚B'` + `data_scope = FACTORY_ONLY` | è¿”å›**å·¥å‚B**æ•°æ® | `WHERE factory_id = 'å·¥å‚B'` |
| âœ… ç”¨æˆ·åˆ‡æ¢å·¥å‚ | `UPDATE t_user SET factory_id = 'æ–°å·¥å‚'` | æŸ¥è¯¢èŒƒå›´æ”¹å˜ | éœ€æ‰‹åŠ¨æ›´æ–° |
| âŒ å·¥å‚ç®¡ç†å‘˜æ— å·¥å‚ID | `factory_id = NULL` + `data_scope = FACTORY_ONLY` | **æŠ›å‡ºå¼‚å¸¸** | å¿…é¡»åˆ†é…å·¥å‚ |

**âš ï¸ æ³¨æ„äº‹é¡¹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… æ­£ç¡®åšæ³•                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ€»éƒ¨ç®¡ç†å‘˜ï¼ˆfactory_id = NULLï¼‰ï¼šä¸å—é™åˆ¶ï¼ŒæŸ¥çœ‹æ‰€æœ‰æ•°æ®      â”‚
â”‚ â€¢ å·¥å‚ç®¡ç†å‘˜ï¼ˆfactory_id = 'å·¥å‚A'ï¼‰ï¼šåªèƒ½æŸ¥çœ‹å·¥å‚Açš„æ•°æ®     â”‚
â”‚ â€¢ åœ¨ Service å±‚åº”ç”¨è¿‡æ»¤ï¼ˆç»Ÿä¸€å…¥å£ï¼Œæ˜“ç»´æŠ¤ï¼‰                   â”‚
â”‚ â€¢ æ–°å¢ä¸šåŠ¡è¡¨ï¼šæ·»åŠ  factory_id å­—æ®µ + åº”ç”¨è¿‡æ»¤                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ ç¦æ­¢åšæ³•                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ä¸è¦åœ¨å‰ç«¯ä»£ç ä¸­ç¡¬ç¼–ç å·¥å‚IDï¼ˆå®‰å…¨é£é™©ï¼‰                    â”‚
â”‚ â€¢ ä¸è¦åœ¨ Controller å±‚åšæ•°æ®è¿‡æ»¤ï¼ˆåº”åœ¨ Service å±‚ï¼‰           â”‚
â”‚ â€¢ å·¥å‚ç®¡ç†å‘˜çš„ factory_id ä¸èƒ½ä¸ºç©ºï¼ˆå¦åˆ™æ— æ³•è¿‡æ»¤ï¼‰            â”‚
â”‚ â€¢ ä¸è¦è·³è¿‡ DataPermissionHelperï¼ˆç»•è¿‡æƒé™æ£€æŸ¥ï¼‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“š è¯¦ç»†å®æ–½æŒ‡å—**ï¼šå‚è€ƒ [docs/å¤šå·¥å‚æ•°æ®éš”ç¦»é…ç½®æŒ‡å—.md](docs/å¤šå·¥å‚æ•°æ®éš”ç¦»é…ç½®æŒ‡å—.md)

---

#### æƒé™ç®¡ç†ï¼ˆæ•æ„Ÿæ•°æ®ä¿æŠ¤ï¼‰

**ğŸ” è´¢åŠ¡æ•°æ®æƒé™åˆ†çº§æ§åˆ¶ç³»ç»Ÿ**

ç³»ç»Ÿå¯¹æ•æ„Ÿè´¢åŠ¡æ•°æ®é‡‡ç”¨**ä¸‰çº§æƒé™æ§åˆ¶**ï¼š
1. **æ€»å•ä»·å’Œæ€»é‡‘é¢**ï¼ˆæœ€é«˜çº§åˆ«ï¼‰ï¼šåªæœ‰ç®¡ç†å±‚å¯è§
2. **è½¦ç¼å•ä»·**ï¼ˆä¸­çº§åˆ«ï¼‰ï¼šç”Ÿäº§ä¸»ç®¡å’Œè½¦é—´ä¸»ä»»å¯è§
3. **åŸºç¡€æ•°æ®**ï¼ˆåŸºç¡€çº§åˆ«ï¼‰ï¼šæ‰€æœ‰å‘˜å·¥å¯è§ï¼ˆæ•°é‡ã€è¿›åº¦ç­‰ï¼‰

**ğŸ“Š å®Œæ•´æƒé™çŸ©é˜µè¡¨**ï¼ˆ7ç§è§’è‰² Ã— 8ç§æ•°æ®æƒé™ï¼‰ï¼š

| è§’è‰² | role_code | è®¢å•æ•°æ® | ğŸ”´ æ€»å•ä»· | ğŸ”´ æ€»é‡‘é¢ | ğŸŸ¡ è½¦ç¼å•ä»· | å…¶ä»–å·¥åºå•ä»· | åˆ«äººå·¥èµ„ | æ‰«ç åŠŸèƒ½ |
|-----|----------|---------|---------|---------|-----------|------------|---------|---------|
| **ç®¡ç†å‘˜** | admin | âœ… æ‰€æœ‰è®¢å• | âœ… èƒ½çœ‹ | âœ… èƒ½çœ‹ | âœ… èƒ½çœ‹ | âœ… èƒ½çœ‹ | âœ… æ‰€æœ‰äºº | âœ… æ­£å¸¸ |
| **è´¢åŠ¡ä¸»ç®¡** | finance_supervisor | âœ… æ‰€æœ‰è®¢å• | âœ… èƒ½çœ‹ | âœ… èƒ½çœ‹ | âœ… èƒ½çœ‹ | âœ… èƒ½çœ‹ | âœ… æ‰€æœ‰äºº | âœ… æ­£å¸¸ |
| **é‡‡è´­ä¸»ç®¡** | purchaser | âœ… æœ¬éƒ¨é—¨ | âœ… èƒ½çœ‹ | âœ… èƒ½çœ‹ | âœ… èƒ½çœ‹ | âœ… èƒ½çœ‹ | âœ… æœ¬éƒ¨é—¨ | âœ… æ­£å¸¸ |
| **è½¦é—´ä¸»ä»»** | workshop_director | âœ… æœ¬è½¦é—´ | âŒ `***` | âŒ `***` | âœ… èƒ½çœ‹ | âŒ `***` | âœ… æœ¬è½¦é—´ | âœ… æ­£å¸¸ |
| **è£å‰ªå‘˜** | cutter | âœ… æœ¬éƒ¨é—¨ | âŒ `***` | âŒ `***` | âœ… èƒ½çœ‹ | âŒ `***` | âŒ åªçœ‹è‡ªå·± | âœ… æ­£å¸¸ |
| **è½¦ç¼å‘˜** | sewing | âœ… æœ¬éƒ¨é—¨ | âŒ `***` | âŒ `***` | âœ… èƒ½çœ‹ | âŒ `***` | âŒ åªçœ‹è‡ªå·± | âœ… æ­£å¸¸ |
| **è´¨æ£€å‘˜** | quality | âœ… æœ¬éƒ¨é—¨ | âŒ `***` | âŒ `***` | âœ… èƒ½çœ‹ | âŒ `***` | âŒ åªçœ‹è‡ªå·± | âœ… æ­£å¸¸ |

**ğŸ¯ æƒé™ç è®¾è®¡ï¼ˆ3ä¸ªæƒé™ï¼‰**ï¼š

```sql
-- 1ï¸âƒ£ FINANCE_TOTAL_AMOUNT_VIEW: æŸ¥çœ‹æ€»å•ä»·å’Œæ€»é‡‘é¢ï¼ˆæœ€é«˜æƒé™ï¼‰
--    åˆ†é…ç»™ï¼šadmin, finance_supervisor, purchaser
--    æ§åˆ¶å­—æ®µï¼štotalPrice, totalAmount, grandTotal

-- 2ï¸âƒ£ FINANCE_SEWING_PRICE_ONLY: åªèƒ½æŸ¥çœ‹è½¦ç¼å•ä»·ï¼ˆä¸­çº§æƒé™ï¼‰
--    åˆ†é…ç»™ï¼šworkshop_directorï¼ˆè½¦é—´ä¸»ä»»ï¼‰
--    æ§åˆ¶å­—æ®µï¼šsewingUnitPrice, sewingAmount
--    é™åˆ¶ï¼šä¸èƒ½çœ‹å…¶ä»–å·¥åºï¼ˆè£å‰ªã€è´¨æ£€ã€åŒ…è£…ç­‰ï¼‰å•ä»·

-- 3ï¸âƒ£ FINANCE_BASIC_DATA_ONLY: åªèƒ½æŸ¥çœ‹åŸºç¡€æ•°æ®ï¼ˆæ™®é€šå‘˜å·¥ï¼‰
--    åˆ†é…ç»™ï¼šcutter, sewing, quality
--    å¯è§å­—æ®µï¼šorderNo, quantity, progress, status
--    éšè—å­—æ®µï¼šæ‰€æœ‰å•ä»·å’Œé‡‘é¢ç›¸å…³å­—æ®µ
```

**ğŸ”„ ä¸‰çº§æƒé™åˆ¤æ–­æµç¨‹å›¾**ï¼š

```
ç”¨æˆ·è®¿é—®é¡µé¢ï¼ˆè®¢å•ç®¡ç†/å‘˜å·¥å·¥èµ„æ±‡æ€»ç­‰ï¼‰
         â†“
    è·å–ç”¨æˆ·è§’è‰²å’Œæƒé™åˆ—è¡¨
         â†“
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ æƒé™åˆ¤æ–­ â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                             â”‚
    â†“                                             â†“
ã€åˆ¤æ–­1ã€‘åŒ…å« FINANCE_TOTAL_AMOUNT_VIEWï¼Ÿ    ã€åˆ¤æ–­2ã€‘åŒ…å« FINANCE_SEWING_PRICE_ONLYï¼Ÿ
    â”‚                                             â”‚
  â”Œâ”€â”´â”€â”                                         â”Œâ”€â”´â”€â”
  âœ…  âŒ                                         âœ…  âŒ
  â”‚   â”‚                                          â”‚   â”‚
  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â†“                      â†“                       â†“                 â†“
æ˜¾ç¤ºæ‰€æœ‰æ•°æ®:        è·³åˆ°ã€åˆ¤æ–­2ã€‘           æ˜¾ç¤ºè½¦ç¼å•ä»·:      æ˜¾ç¤ºåŸºç¡€æ•°æ®:
â€¢ æ€»å•ä»· âœ…                                 â€¢ è½¦ç¼å•ä»· âœ…      â€¢ è®¢å•å· âœ…
â€¢ æ€»é‡‘é¢ âœ…                                 â€¢ è½¦ç¼é‡‘é¢ âœ…      â€¢ æ•°é‡ âœ…
â€¢ è½¦ç¼å•ä»· âœ…                               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â€¢ è¿›åº¦ âœ…
â€¢ è£å‰ªå•ä»· âœ…                               å…¶ä»–éšè—:          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ è´¨æ£€å•ä»· âœ…                               â€¢ æ€»å•ä»· âŒ***    æ‰€æœ‰å•ä»·/é‡‘é¢:
â€¢ åŒ…è£…å•ä»· âœ…                               â€¢ æ€»é‡‘é¢ âŒ***    â€¢ å•ä»· âŒ***
â€¢ æ‰€æœ‰å·¥åºé‡‘é¢ âœ…                            â€¢ è£å‰ªå•ä»· âŒ***  â€¢ é‡‘é¢ âŒ***
                                           â€¢ è´¨æ£€å•ä»· âŒ***
                                           â€¢ åŒ…è£…å•ä»· âŒ***
    â”‚                      â”‚                       â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“
                            æ¸²æŸ“é¡µé¢ï¼ˆåº”ç”¨æƒé™æ§åˆ¶ï¼‰
```

**ğŸ“‹ æƒé™é…ç½®æ­¥éª¤æµç¨‹**ï¼š

```
ç¬¬1æ­¥: æ•°æ®åº“æ·»åŠ æƒé™         ç¬¬2æ­¥: åˆ†é…è§’è‰²æƒé™              ç¬¬3æ­¥: å‰ç«¯å¤šçº§åˆ¤æ–­
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ INSERT INTO         â”‚    â”‚ INSERT INTO          â”‚      â”‚ // 1ï¸âƒ£ æ£€æŸ¥æ€»é‡‘é¢æƒé™â”‚
â”‚ t_permission:       â”‚â†’   â”‚ t_role_permission:   â”‚â†’     â”‚ const canViewTotal  â”‚
â”‚                     â”‚    â”‚                      â”‚      â”‚   = hasPermission(  â”‚
â”‚ 1. TOTAL_AMOUNT     â”‚    â”‚ admin        â†’ 1+2   â”‚      â”‚       'TOTAL_AMOUNT'â”‚
â”‚ 2. SEWING_ONLY      â”‚    â”‚ finance_sup  â†’ 1+2   â”‚      â”‚     );              â”‚
â”‚ 3. BASIC_DATA       â”‚    â”‚ purchaser    â†’ 1+2   â”‚      â”‚                     â”‚
â”‚                     â”‚    â”‚ workshop_dir â†’ 2     â”‚      â”‚ // 2ï¸âƒ£ æ£€æŸ¥è½¦ç¼æƒé™ â”‚
â”‚                     â”‚    â”‚ cutter       â†’ 3     â”‚      â”‚ const canViewSewing â”‚
â”‚                     â”‚    â”‚ sewing       â†’ 3     â”‚      â”‚   = hasPermission(  â”‚
â”‚                     â”‚    â”‚ quality      â†’ 3     â”‚      â”‚       'SEWING_ONLY' â”‚
â”‚                     â”‚    â”‚                      â”‚      â”‚     );              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚                     â”‚
                                                          â”‚ // 3ï¸âƒ£ æ¸²æŸ“é€»è¾‘     â”‚
                                                          â”‚ if (canViewTotal) { â”‚
                                                          â”‚   æ˜¾ç¤ºæ‰€æœ‰å•ä»·      â”‚
                                                          â”‚ } else if           â”‚
                                                          â”‚   (canViewSewing) { â”‚
                                                          â”‚   åªæ˜¾ç¤ºè½¦ç¼å•ä»·    â”‚
                                                          â”‚ } else {            â”‚
                                                          â”‚   æ˜¾ç¤º ***          â”‚
                                                          â”‚ }                   â”‚
                                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ› ï¸ æƒé™é…ç½®æ–¹å¼ï¼ˆ2ç§æ–¹æ³•ï¼‰**ï¼š

**æ–¹æ³•1ï¸âƒ£: é€šè¿‡å‰ç«¯æƒé™ç®¡ç†ç•Œé¢é…ç½®ï¼ˆæ¨èï¼‰**

```
1. ç™»å½•ç³»ç»Ÿåï¼Œè¿›å…¥ã€ç³»ç»Ÿè®¾ç½®ã€‘â†’ã€è§’è‰²ç®¡ç†ã€‘
2. é€‰æ‹©è¦é…ç½®çš„è§’è‰²ï¼Œç‚¹å‡»ã€æˆæƒã€‘æŒ‰é’®
3. åœ¨æƒé™å¼¹çª—ä¸­æ‰¾åˆ°ã€è´¢åŠ¡ç®¡ç†ã€‘æ¨¡å—
4. å‹¾é€‰å¯¹åº”çš„è´¢åŠ¡æƒé™ï¼š
   ğŸ”´ æŸ¥çœ‹æ€»å•ä»·å’Œæ€»é‡‘é¢ï¼ˆç®¡ç†å‘˜ã€è´¢åŠ¡ä¸»ç®¡ã€é‡‡è´­ä¸»ç®¡ï¼‰
   ğŸŸ¡ åªèƒ½æŸ¥çœ‹è½¦ç¼å•ä»·ï¼ˆè½¦é—´ä¸»ä»»ã€è£å‰ªå‘˜ã€è½¦ç¼å‘˜ã€è´¨æ£€å‘˜ï¼‰
   ğŸŸ¢ åªèƒ½æŸ¥çœ‹åŸºç¡€æ•°æ®ï¼ˆæ— å•ä»·ï¼‰ï¼ˆåŒ…è£…å‘˜ã€ä»“ç®¡å‘˜ï¼‰
5. ç‚¹å‡»ã€ä¿å­˜ã€‘å®Œæˆé…ç½®
```

**ç•Œé¢æˆªå›¾ç¤ºæ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸ºã€Œè½¦é—´ä¸»ä»»ã€æˆæƒ                            [ Ã— ] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” æœç´¢æƒé™åç§°: [            ]   [æ¸…ç©ºæœç´¢]       â”‚
â”‚                                                     â”‚
â”‚ [å…¨é€‰] [æ¸…ç©º] [ç³»ç»Ÿç®¡ç†å‘˜(å…¨é‡)] [ç”Ÿäº§äººå‘˜] ...   â”‚
â”‚                                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ ç”Ÿäº§ç®¡ç† â”‚  â”‚ åŸºç¡€èµ„æ–™ â”‚  â”‚ ğŸ“Š è´¢åŠ¡ç®¡ç†  â”‚  â† è¿™é‡Œ
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â˜‘ è´¢åŠ¡ç®¡ç†            â”‚
â”‚                              â˜ ç‰©æ–™å¯¹è´¦            â”‚
â”‚                              â˜ æˆå“ç»“ç®—            â”‚
â”‚                              â˜ å®¡æ‰¹ä»˜æ¬¾            â”‚
â”‚                              â˜‘ æŸ¥çœ‹æ€»å•ä»·å’Œæ€»é‡‘é¢  â† æœ€é«˜æƒé™
â”‚                              â˜‘ åªèƒ½æŸ¥çœ‹è½¦ç¼å•ä»·    â† ä¸­çº§æƒé™
â”‚                              â˜ åªèƒ½æŸ¥çœ‹åŸºç¡€æ•°æ®... â† åŸºç¡€æƒé™
â”‚                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        [å–æ¶ˆ]  [ä¿å­˜]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ–¹æ³•2ï¸âƒ£: é€šè¿‡SQLè„šæœ¬é…ç½®ï¼ˆåˆå§‹åŒ–ç”¨ï¼‰**

**1ï¸âƒ£ æ•°æ®åº“é…ç½®ï¼ˆSQLï¼‰**ï¼š

```sql
-- ========== æ·»åŠ 3ä¸ªç»†ç²’åº¦æƒé™ ==========

-- æƒé™1: æŸ¥çœ‹æ€»å•ä»·å’Œæ€»é‡‘é¢ï¼ˆæœ€é«˜æƒé™ï¼‰
INSERT INTO t_permission (
  permission_code, 
  permission_name, 
  permission_type, 
  parent_id,
  sort
) VALUES (
  'FINANCE_TOTAL_AMOUNT_VIEW',  -- æƒé™ç 
  'æŸ¥çœ‹æ€»å•ä»·å’Œæ€»é‡‘é¢',          -- æƒé™å
  'button',                      -- ç±»å‹
  4,                             -- çˆ¶çº§ï¼ˆè´¢åŠ¡ç®¡ç†èœå•IDï¼‰
  10
) ON DUPLICATE KEY UPDATE permission_name = permission_name;

-- æƒé™2: åªèƒ½æŸ¥çœ‹è½¦ç¼å•ä»·ï¼ˆä¸­çº§æƒé™ï¼‰
INSERT INTO t_permission (
  permission_code, 
  permission_name, 
  permission_type, 
  parent_id,
  sort
) VALUES (
  'FINANCE_SEWING_PRICE_ONLY',   -- æƒé™ç 
  'åªèƒ½æŸ¥çœ‹è½¦ç¼å•ä»·',             -- æƒé™å
  'button',                       -- ç±»å‹
  4,                              -- çˆ¶çº§ï¼ˆè´¢åŠ¡ç®¡ç†èœå•IDï¼‰
  20
) ON DUPLICATE KEY UPDATE permission_name = permission_name;

-- æƒé™3: åªèƒ½æŸ¥çœ‹åŸºç¡€æ•°æ®ï¼ˆæ™®é€šå‘˜å·¥ï¼Œä¸çœ‹å•ä»·ï¼‰
INSERT INTO t_permission (
  permission_code, 
  permission_name, 
  permission_type, 
  parent_id,
  sort
) VALUES (
  'FINANCE_BASIC_DATA_ONLY',     -- æƒé™ç 
  'åªèƒ½æŸ¥çœ‹åŸºç¡€æ•°æ®ï¼ˆæ— å•ä»·ï¼‰',   -- æƒé™å
  'button',                       -- ç±»å‹
  4,                              -- çˆ¶çº§ï¼ˆè´¢åŠ¡ç®¡ç†èœå•IDï¼‰
  30
) ON DUPLICATE KEY UPDATE permission_name = permission_name;

-- ========== åˆ†é…æƒé™ç»™ä¸åŒè§’è‰² ==========

-- é«˜æƒé™è§’è‰²ï¼šç®¡ç†å‘˜ã€è´¢åŠ¡ä¸»ç®¡ã€é‡‡è´­ä¸»ç®¡ï¼ˆçœ‹æ‰€æœ‰æ•°æ®ï¼‰
INSERT INTO t_role_permission (role_id, permission_id)
SELECT r.id, p.id 
FROM t_role r
CROSS JOIN t_permission p
WHERE r.role_code IN ('admin', 'finance_supervisor', 'purchaser')
AND p.permission_code = 'FINANCE_TOTAL_AMOUNT_VIEW';

-- ä¸­æƒé™è§’è‰²ï¼šè½¦é—´ä¸»ä»»+ç”Ÿäº§ä¸€çº¿å‘˜å·¥ï¼ˆéƒ½èƒ½çœ‹è½¦ç¼å•ä»·ï¼‰
INSERT INTO t_role_permission (role_id, permission_id)
SELECT r.id, p.id 
FROM t_role r
CROSS JOIN t_permission p
WHERE r.role_code IN ('workshop_director', 'cutter', 'sewing', 'quality')
AND p.permission_code = 'FINANCE_SEWING_PRICE_ONLY';

-- ä½æƒé™è§’è‰²ï¼šåå‹¤äººå‘˜ï¼ˆåªçœ‹åŸºç¡€æ•°æ®ï¼Œä¸çœ‹ä»»ä½•å•ä»·ï¼‰
INSERT INTO t_role_permission (role_id, permission_id)
SELECT r.id, p.id 
FROM t_role r
CROSS JOIN t_permission p
WHERE r.role_code IN ('packager', 'warehouse')
AND p.permission_code = 'FINANCE_BASIC_DATA_ONLY';

-- ========== éªŒè¯æƒé™åˆ†é… ==========
SELECT 
  r.role_name AS 'è§’è‰²',
  r.role_code AS 'è§’è‰²ä»£ç ',
  GROUP_CONCAT(p.permission_name SEPARATOR ', ') AS 'æ‹¥æœ‰çš„è´¢åŠ¡æƒé™'
FROM t_role r
LEFT JOIN t_role_permission rp ON r.id = rp.role_id
LEFT JOIN t_permission p ON rp.permission_id = p.id
WHERE p.permission_code IN (
  'FINANCE_TOTAL_AMOUNT_VIEW',
  'FINANCE_SEWING_PRICE_ONLY',
  'FINANCE_BASIC_DATA_ONLY'
)
GROUP BY r.id, r.role_name, r.role_code
ORDER BY r.id;
```

**ğŸ“ æ‰§è¡ŒSQLè„šæœ¬**ï¼š

```bash
# æ‰§è¡Œå®Œæ•´çš„ä¸‰çº§æƒé™é…ç½®è„šæœ¬
docker exec -i fashion-mysql-simple mysql -uroot -pchangeme \
  fashion_supplychain --default-character-set=utf8mb4 \
  < scripts/add_three_level_price_permissions.sql

# éªŒè¯æƒé™æ˜¯å¦æ·»åŠ æˆåŠŸ
docker exec fashion-mysql-simple mysql -uroot -pchangeme \
  fashion_supplychain --default-character-set=utf8mb4 \
  -e "SELECT permission_code, permission_name FROM t_permission \
      WHERE permission_code LIKE 'FINANCE_%';"
```

**âš ï¸ æ³¨æ„äº‹é¡¹**ï¼š
- é¦–æ¬¡éƒ¨ç½²ä½¿ç”¨SQLè„šæœ¬åˆå§‹åŒ–æƒé™
- æ—¥å¸¸æƒé™è°ƒæ•´æ¨èä½¿ç”¨å‰ç«¯ç•Œé¢ï¼Œæ›´ç›´è§‚æ–¹ä¾¿
- æƒé™ä¿®æ”¹ä¼šç«‹å³ç”Ÿæ•ˆï¼Œå·²ç™»å½•ç”¨æˆ·éœ€é‡æ–°ç™»å½•
- æƒé™é…ç½®åœ¨ã€ç³»ç»Ÿè®¾ç½®ã€‘â†’ã€è§’è‰²ç®¡ç†ã€‘â†’ é€‰æ‹©è§’è‰² â†’ ç‚¹å‡»ã€æˆæƒã€‘
- è´¢åŠ¡æƒé™åœ¨"è´¢åŠ¡ç®¡ç†"æ¨¡å—ä¸‹ï¼Œå¯ç›´æ¥å‹¾é€‰é…ç½®

**ğŸ’¡ æƒé™åˆ†é…é€»è¾‘è¯´æ˜**ï¼š

| æƒé™çº§åˆ« | æƒé™ç  | åˆ†é…è§’è‰² | å¯è§æ•°æ®èŒƒå›´ |
|---------|-------|---------|------------|
| **ğŸ”´ æœ€é«˜æƒé™** | FINANCE_TOTAL_AMOUNT_VIEW | admin, finance_supervisor, purchaser | æ‰€æœ‰å•ä»·ã€æ‰€æœ‰é‡‘é¢ã€æ‰€æœ‰å·¥åº |
| **ğŸŸ¡ ä¸­çº§æƒé™** | FINANCE_SEWING_PRICE_ONLY | workshop_director, cutter, sewing, quality | åªèƒ½çœ‹è½¦ç¼å•ä»·å’Œè½¦ç¼é‡‘é¢ |
| **ğŸŸ¢ åŸºç¡€æƒé™** | FINANCE_BASIC_DATA_ONLY | packager, warehouse | åªèƒ½çœ‹è®¢å•å·ã€æ•°é‡ã€è¿›åº¦ï¼ˆæ— å•ä»·ï¼‰ |

**ğŸ“ æƒé™ä½ç½®**ï¼š
- æ•°æ®åº“è¡¨ï¼š`t_permission`ï¼ˆæƒé™ID: 8454, 8455, 8456ï¼‰
- çˆ¶çº§æ¨¡å—ï¼šè´¢åŠ¡ç®¡ç†ï¼ˆparent_id = 4ï¼‰
- å‰ç«¯è·¯å¾„ï¼šã€ç³»ç»Ÿè®¾ç½®ã€‘â†’ã€è§’è‰²ç®¡ç†ã€‘â†’ã€æˆæƒã€‘â†’ è´¢åŠ¡ç®¡ç†æ¨¡å—ä¸‹å¯è§
- SQLè„šæœ¬ï¼š`scripts/add_three_level_price_permissions.sql`

**2ï¸âƒ£ å‰ç«¯å¤šçº§æƒé™åˆ¤æ–­ï¼ˆReact/TypeScriptï¼‰**ï¼š

```typescript
// ========== æ–¹æ¡ˆ1: å·¥èµ„æ±‡æ€»é¡µé¢ï¼ˆPayrollOperatorSummary.tsxï¼‰==========
import { useAppContext } from '@/utils/appContext';

const PayrollOperatorSummary: React.FC = () => {
  const { userPermissions } = useAppContext();

  // ğŸ”´ æœ€é«˜æƒé™ï¼šæŸ¥çœ‹æ‰€æœ‰å•ä»·å’Œé‡‘é¢
  const canViewTotalAmount = userPermissions.includes('FINANCE_TOTAL_AMOUNT_VIEW');
  
  // ğŸŸ¡ ä¸­çº§æƒé™ï¼šåªèƒ½æŸ¥çœ‹è½¦ç¼å•ä»·
  const canViewSewingOnly = userPermissions.includes('FINANCE_SEWING_PRICE_ONLY');

  // å®šä¹‰åˆ—é…ç½®ï¼ˆæ ¹æ®æƒé™åŠ¨æ€æ¸²æŸ“ï¼‰
  const columns = [
    // åŸºç¡€åˆ—ï¼ˆæ‰€æœ‰äººå¯è§ï¼‰
    {
      title: 'è®¢å•å·',
      dataIndex: 'orderNo',
      key: 'orderNo',
      fixed: 'left' as const,
    },
    {
      title: 'å‘˜å·¥å§“å',
      dataIndex: 'operatorName',
      key: 'operatorName',
    },
    {
      title: 'å·¥åº',
      dataIndex: 'processName',
      key: 'processName',
    },
    {
      title: 'æ•°é‡(ä»¶)',
      dataIndex: 'quantity',
      key: 'quantity',
      render: (value: number) => value.toLocaleString(),
    },
    
    // ğŸ”´ é«˜æƒé™åˆ—ï¼šå•ä»·ï¼ˆæ‰€æœ‰å·¥åºï¼‰
    ...(canViewTotalAmount ? [
      {
        title: 'å•ä»·(å…ƒ)',
        dataIndex: 'unitPrice',
        key: 'unitPrice',
        render: (value: number) => (
          <span style={{ color: '#f59e0b', fontWeight: 600 }}>
            Â¥{toMoneyText(value)}
          </span>
        ),
      },
    ] : []),

    // ğŸŸ¡ ä¸­çº§æƒé™åˆ—ï¼šåªæ˜¾ç¤ºè½¦ç¼å•ä»·
    ...(canViewSewingOnly && !canViewTotalAmount ? [
      {
        title: 'è½¦ç¼å•ä»·(å…ƒ)',
        dataIndex: 'sewingUnitPrice',
        key: 'sewingUnitPrice',
        render: (value: number, record: any) => {
          // åªæœ‰è½¦ç¼å·¥åºæ˜¾ç¤ºå•ä»·ï¼Œå…¶ä»–å·¥åºæ˜¾ç¤º ***
          if (record.processName === 'è½¦ç¼' || record.processName === 'ä¸Šé¢†') {
            return (
              <span style={{ color: '#10b981', fontWeight: 600 }}>
                Â¥{toMoneyText(value)}
              </span>
            );
          }
          return <span style={{ color: '#999' }}>***</span>;
        },
      },
    ] : []),

    // ğŸŸ¢ ä½æƒé™ï¼šæ™®é€šå‘˜å·¥ä¸æ˜¾ç¤ºä»»ä½•å•ä»·
    ...(!canViewTotalAmount && !canViewSewingOnly ? [
      {
        title: 'å•ä»·',
        dataIndex: 'unitPrice',
        key: 'unitPrice',
        render: () => <span style={{ color: '#999' }}>***</span>,
      },
    ] : []),

    // ğŸ”´ é«˜æƒé™åˆ—ï¼šæ€»é‡‘é¢
    ...(canViewTotalAmount ? [
      {
        title: 'æ€»é‡‘é¢(å…ƒ)',
        dataIndex: 'totalAmount',
        key: 'totalAmount',
        render: (value: number) => (
          <span style={{ color: '#ef4444', fontWeight: 700, fontSize: '15px' }}>
            Â¥{toMoneyText(value)}
          </span>
        ),
      },
    ] : []),

    // ğŸŸ¡ ä¸­çº§æƒé™åˆ—ï¼šåªæ˜¾ç¤ºè½¦ç¼é‡‘é¢
    ...(canViewSewingOnly && !canViewTotalAmount ? [
      {
        title: 'è½¦ç¼é‡‘é¢(å…ƒ)',
        dataIndex: 'sewingAmount',
        key: 'sewingAmount',
        render: (value: number, record: any) => {
          if (record.processName === 'è½¦ç¼' || record.processName === 'ä¸Šé¢†') {
            return (
              <span style={{ color: '#10b981', fontWeight: 700 }}>
                Â¥{toMoneyText(value)}
              </span>
            );
          }
          return <span style={{ color: '#999' }}>***</span>;
        },
      },
    ] : []),

    // ğŸŸ¢ ä½æƒé™ï¼šä¸æ˜¾ç¤ºä»»ä½•é‡‘é¢
    ...(!canViewTotalAmount && !canViewSewingOnly ? [
      {
        title: 'é‡‘é¢',
        dataIndex: 'totalAmount',
        key: 'totalAmount',
        render: () => <span style={{ color: '#999' }}>***</span>,
      },
    ] : []),
  ];

  return (
    <Table
      columns={columns}
      dataSource={dataSource}
      rowKey="id"
      pagination={{ pageSize: 50 }}
    />
  );
};

// ========== æ–¹æ¡ˆ2: è®¢å•ç®¡ç†é¡µé¢ï¼ˆOrderManagement/index.tsxï¼‰==========
const OrderManagement: React.FC = () => {
  const { userPermissions } = useAppContext();

  const canViewTotalAmount = userPermissions.includes('FINANCE_TOTAL_AMOUNT_VIEW');
  const canViewSewingOnly = userPermissions.includes('FINANCE_SEWING_PRICE_ONLY');

  const columns = [
    // ... å…¶ä»–åŸºç¡€åˆ—

    // ğŸ”´ é«˜æƒé™ï¼šè®¢å•æ€»é‡‘é¢
    {
      title: 'è®¢å•æ€»é‡‘é¢',
      dataIndex: 'totalAmount',
      key: 'totalAmount',
      render: (value: number) => {
        if (canViewTotalAmount) {
          return (
            <span style={{ color: '#ef4444', fontWeight: 700 }}>
              Â¥{toMoneyText(value)}
            </span>
          );
        }
        return <span style={{ color: '#999' }}>***</span>;
      },
    },

    // ğŸŸ¡ ä¸­çº§æƒé™ï¼šè½¦ç¼å·¥åºé‡‘é¢ï¼ˆå•ç‹¬åˆ—ï¼‰
    ...(canViewSewingOnly && !canViewTotalAmount ? [
      {
        title: 'è½¦ç¼é‡‘é¢',
        dataIndex: 'sewingTotalAmount',
        key: 'sewingTotalAmount',
        render: (value: number) => (
          <span style={{ color: '#10b981', fontWeight: 600 }}>
            Â¥{toMoneyText(value)}
          </span>
        ),
      },
    ] : []),
  ];

  return <Table columns={columns} dataSource={orders} />;
};

// ========== æ–¹æ¡ˆ3: é€šç”¨æƒé™Hookï¼ˆæ¨èï¼Œå¯å¤ç”¨ï¼‰==========
// æ–‡ä»¶ï¼šsrc/hooks/useFinancePermission.ts
export const useFinancePermission = () => {
  const { userPermissions } = useAppContext();

  return {
    // ğŸ”´ æœ€é«˜æƒé™ï¼šæŸ¥çœ‹æ‰€æœ‰å•ä»·å’Œé‡‘é¢
    canViewTotalAmount: userPermissions.includes('FINANCE_TOTAL_AMOUNT_VIEW'),
    
    // ğŸŸ¡ ä¸­çº§æƒé™ï¼šåªèƒ½æŸ¥çœ‹è½¦ç¼å•ä»·
    canViewSewingOnly: userPermissions.includes('FINANCE_SEWING_PRICE_ONLY'),
    
    // ğŸŸ¢ åŸºç¡€æƒé™ï¼šåªèƒ½æŸ¥çœ‹åŸºç¡€æ•°æ®ï¼ˆæ— å•ä»·ï¼‰
    canViewBasicOnly: userPermissions.includes('FINANCE_BASIC_DATA_ONLY'),

    // å·¥å…·æ–¹æ³•ï¼šåˆ¤æ–­ç‰¹å®šå·¥åºæ˜¯å¦å¯è§å•ä»·
    canViewProcessPrice: (processName: string): boolean => {
      if (userPermissions.includes('FINANCE_TOTAL_AMOUNT_VIEW')) {
        return true; // é«˜æƒé™çœ‹æ‰€æœ‰å·¥åº
      }
      if (userPermissions.includes('FINANCE_SEWING_PRICE_ONLY')) {
        return processName === 'è½¦ç¼' || processName === 'ä¸Šé¢†'; // ä¸­æƒé™åªçœ‹è½¦ç¼
      }
      return false; // ä½æƒé™ä¸çœ‹ä»»ä½•å•ä»·
    },

    // æ ¼å¼åŒ–å•ä»·æ˜¾ç¤ºï¼ˆè‡ªåŠ¨åˆ¤æ–­æƒé™ï¼‰
    formatPrice: (value: number, processName?: string): string | JSX.Element => {
      if (userPermissions.includes('FINANCE_TOTAL_AMOUNT_VIEW')) {
        return toMoneyText(value);
      }
      if (userPermissions.includes('FINANCE_SEWING_PRICE_ONLY') && processName) {
        if (processName === 'è½¦ç¼' || processName === 'ä¸Šé¢†') {
          return toMoneyText(value);
        }
      }
      return <span style={{ color: '#999' }}>***</span>;
    },
  };
};

// ========== ä½¿ç”¨ç¤ºä¾‹ ==========
const MyComponent: React.FC = () => {
  const { canViewTotalAmount, canViewSewingOnly, formatPrice } = useFinancePermission();

  return (
    <div>
      {/* æ¡ä»¶æ¸²æŸ“æ•´ä¸ªæ¨¡å— */}
      {canViewTotalAmount && (
        <Card title="è´¢åŠ¡æ•°æ®ï¼ˆå…¨éƒ¨ï¼‰">
          <Statistic title="è®¢å•æ€»é‡‘é¢" value={12345.67} prefix="Â¥" />
        </Card>
      )}

      {/* ä½¿ç”¨å·¥å…·æ–¹æ³•æ ¼å¼åŒ– */}
      <Table
        columns={[
          {
            title: 'å•ä»·',
            dataIndex: 'unitPrice',
            render: (value, record) => formatPrice(value, record.processName),
          },
        ]}
      />
    </div>
  );
};
```

**3ï¸âƒ£ å°ç¨‹åºç«¯éšè—æ•æ„Ÿä¿¡æ¯**ï¼š

```javascript
// miniprogram/pages/work/index.js
// æ‰«ç æˆåŠŸåçš„æ˜¾ç¤º
showScanResult(result) {
  // å°ç¨‹åºç«¯å…¨éƒ¨éšè—å•ä»·å’Œé‡‘é¢
  wx.showToast({
    title: `æ‰«ç æˆåŠŸï¼æ•°é‡ï¼š${result.quantity}ä»¶`,
    icon: 'success'
  });
  
  // âŒ ä¸æ˜¾ç¤ºå•ä»·å’Œé‡‘é¢
  // âœ… åªæ˜¾ç¤ºæ•°é‡å’Œå·¥åºåç§°
}
```

**ğŸ”’ æ‰«ç ç³»ç»Ÿä¸å—å½±å“çš„åŸç†**ï¼ˆä¸‰çº§æƒé™ç»Ÿä¸€è¯´æ˜ï¼‰ï¼š

```
å‘˜å·¥æ‰«ç å®Œæ•´æµç¨‹ï¼ˆåç«¯æ­£å¸¸è®¡ç®—å’Œä¿å­˜ï¼Œå‰ç«¯æ ¹æ®æƒé™åˆ†çº§æ˜¾ç¤ºï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ğŸ“± å°ç¨‹åºï¼šå‘˜å·¥æ‰«æè²å·äºŒç»´ç                                       â”‚
â”‚    æ‰«ç å†…å®¹ï¼šPO20260125003-é»‘è‰²-01                                    â”‚
â”‚    å½“å‰å‘˜å·¥ï¼šå¼ ä¸‰ï¼ˆè½¦ç¼å‘˜ï¼Œrole_code='sewing'ï¼‰                       â”‚
â”‚    â†“                                                                  â”‚
â”‚ 2. ğŸ“¡ å‘é€è¯·æ±‚ï¼šPOST /api/production/scan/execute                     â”‚
â”‚    {                                                                  â”‚
â”‚      orderNo: "PO20260125003",                                       â”‚
â”‚      bundleNo: "01",                                                 â”‚
â”‚      color: "é»‘è‰²",                                                  â”‚
â”‚      quantity: 50,                                                   â”‚
â”‚      operatorId: "123"  â† å¼ ä¸‰çš„ID                                   â”‚
â”‚    }                                                                  â”‚
â”‚    â†“                                                                  â”‚
â”‚ 3. ğŸ–¥ï¸ åç«¯å¤„ç†ï¼ˆScanRecordOrchestrator.saveScanRecordï¼‰ï¼š            â”‚
â”‚    a. éªŒè¯è²å·æ˜¯å¦å­˜åœ¨              âœ…                                â”‚
â”‚    b. æŸ¥è¯¢è®¢å•å·¥åºé…ç½®ï¼ˆå«æ‰€æœ‰å·¥åºå•ä»·ï¼‰âœ…                             â”‚
â”‚       - è£å‰ªå•ä»·: 0.8å…ƒ/ä»¶                                            â”‚
â”‚       - è½¦ç¼å•ä»·: 1.5å…ƒ/ä»¶          â† å½“å‰å·¥åº                        â”‚
â”‚       - è´¨æ£€å•ä»·: 0.5å…ƒ/ä»¶                                            â”‚
â”‚       - åŒ…è£…å•ä»·: 0.3å…ƒ/ä»¶                                            â”‚
â”‚    c. åˆ¤æ–­å‘˜å·¥å½“å‰å·¥åºï¼šè½¦ç¼ï¼ˆç¬¬2æ¬¡æ‰«ç ï¼‰âœ…                            â”‚
â”‚    d. è®¡ç®—å·¥åºé‡‘é¢ï¼š50ä»¶ Ã— 1.5å…ƒ = 75å…ƒ                               â”‚
â”‚    â†“                                                                  â”‚
â”‚ 4. ğŸ’¾ ä¿å­˜æ‰«ç è®°å½•ï¼ˆåç«¯æ— æƒé™åˆ¤æ–­ï¼Œå…¨éƒ¨ä¿å­˜ï¼‰ï¼š                       â”‚
â”‚    INSERT INTO t_scan_record (                                        â”‚
â”‚      order_no,            -- PO20260125003                           â”‚
â”‚      process_name,        -- è½¦ç¼                                     â”‚
â”‚      operator_id,         -- 123ï¼ˆå¼ ä¸‰ï¼‰                              â”‚
â”‚      operator_name,       -- å¼ ä¸‰                                     â”‚
â”‚      quantity,            -- 50                                      â”‚
â”‚      unit_price,          -- 1.5  âœ… åç«¯è‡ªåŠ¨ä¿å­˜                     â”‚
â”‚      scan_cost,           -- 75   âœ… åç«¯è‡ªåŠ¨è®¡ç®—ä¿å­˜                 â”‚
â”‚      process_unit_price   -- 1.5  âœ… å·¥åºé…ç½®è¡¨çš„å•ä»·                 â”‚
â”‚    );                                                                 â”‚
â”‚    â†“                                                                  â”‚
â”‚ 5. ğŸ“± å°ç¨‹åºæ˜¾ç¤ºï¼ˆå‰ç«¯éšè—æ‰€æœ‰æ•æ„Ÿä¿¡æ¯ï¼‰ï¼š                             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚    â”‚ âœ… æ‰«ç æˆåŠŸï¼                  â”‚                                â”‚
â”‚    â”‚ è®¢å•å·ï¼šPO20260125003          â”‚                                â”‚
â”‚    â”‚ å·¥åºï¼šè½¦ç¼ï¼ˆç¬¬2æ¬¡æ‰«ç ï¼‰        â”‚                                â”‚
â”‚    â”‚ æ•°é‡ï¼š50 ä»¶                    â”‚                                â”‚
â”‚    â”‚ å•ä»·ï¼š***     â† å°ç¨‹åºå…¨éšè—   â”‚                                â”‚
â”‚    â”‚ æœ¬æ¬¡å·¥èµ„ï¼š*** â† å°ç¨‹åºå…¨éšè—   â”‚                                â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚    â†“                                                                  â”‚
â”‚ 6. ğŸ’¼ PCç«¯ä¸‰çº§æƒé™æ˜¾ç¤ºï¼ˆåŒä¸€æ¡æ‰«ç è®°å½•ï¼Œä¸åŒè§’è‰²çœ‹åˆ°ä¸åŒå†…å®¹ï¼‰ï¼š        â”‚
â”‚                                                                       â”‚
â”‚  ğŸ”´ ç®¡ç†å‘˜/è´¢åŠ¡ä¸»ç®¡/é‡‡è´­ä¸»ç®¡ï¼ˆFINANCE_TOTAL_AMOUNT_VIEWï¼‰ï¼š           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚    â”‚ æ‰«ç è®°å½• - å…¨éƒ¨å¯è§                        â”‚                    â”‚
â”‚    â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚                    â”‚
â”‚    â”‚ è®¢å•å·ï¼šPO20260125003                      â”‚                    â”‚
â”‚    â”‚ å·¥åºï¼šè½¦ç¼ï¼ˆç¬¬2æ¬¡æ‰«ç ï¼‰                    â”‚                    â”‚
â”‚    â”‚ å‘˜å·¥ï¼šå¼ ä¸‰                                 â”‚                    â”‚
â”‚    â”‚ æ•°é‡ï¼š50 ä»¶                                â”‚                    â”‚
â”‚    â”‚ âœ… è½¦ç¼å•ä»·ï¼šÂ¥1.5/ä»¶                       â”‚                    â”‚
â”‚    â”‚ âœ… æœ¬æ¬¡å·¥èµ„ï¼šÂ¥75                           â”‚                    â”‚
â”‚    â”‚ âœ… è®¢å•å…¶ä»–å·¥åºå•ä»·ï¼š                      â”‚                    â”‚
â”‚    â”‚    - è£å‰ªï¼šÂ¥0.8/ä»¶                         â”‚                    â”‚
â”‚    â”‚    - è´¨æ£€ï¼šÂ¥0.5/ä»¶                         â”‚                    â”‚
â”‚    â”‚    - åŒ…è£…ï¼šÂ¥0.3/ä»¶                         â”‚                    â”‚
â”‚    â”‚ âœ… è®¢å•æ€»æˆæœ¬ï¼šÂ¥3.1/ä»¶                     â”‚                    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                       â”‚
â”‚  ğŸŸ¡ è½¦é—´ä¸»ä»»ï¼ˆFINANCE_SEWING_PRICE_ONLYï¼‰ï¼š                           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚    â”‚ æ‰«ç è®°å½• - åªçœ‹è½¦ç¼å•ä»·                    â”‚                    â”‚
â”‚    â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚                    â”‚
â”‚    â”‚ è®¢å•å·ï¼šPO20260125003                      â”‚                    â”‚
â”‚    â”‚ å·¥åºï¼šè½¦ç¼ï¼ˆç¬¬2æ¬¡æ‰«ç ï¼‰                    â”‚                    â”‚
â”‚    â”‚ å‘˜å·¥ï¼šå¼ ä¸‰                                 â”‚                    â”‚
â”‚    â”‚ æ•°é‡ï¼š50 ä»¶                                â”‚                    â”‚
â”‚    â”‚ âœ… è½¦ç¼å•ä»·ï¼šÂ¥1.5/ä»¶  â† åªçœ‹è½¦ç¼           â”‚                    â”‚
â”‚    â”‚ âœ… æœ¬æ¬¡å·¥èµ„ï¼šÂ¥75      â† åªçœ‹è½¦ç¼å·¥èµ„       â”‚                    â”‚
â”‚    â”‚ âŒ è£å‰ªå•ä»·ï¼š***      â† å…¶ä»–å·¥åºéšè—       â”‚                    â”‚
â”‚    â”‚ âŒ è´¨æ£€å•ä»·ï¼š***                           â”‚                    â”‚
â”‚    â”‚ âŒ åŒ…è£…å•ä»·ï¼š***                           â”‚                    â”‚
â”‚    â”‚ âŒ è®¢å•æ€»æˆæœ¬ï¼š***    â† æ€»æˆæœ¬ä¹Ÿéšè—       â”‚                    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                       â”‚
â”‚  ğŸŸ¢ æ™®é€šå‘˜å·¥ï¼ˆè£å‰ªå‘˜/è½¦ç¼å‘˜/è´¨æ£€å‘˜ - FINANCE_BASIC_DATA_ONLYï¼‰ï¼š      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚    â”‚ æ‰«ç è®°å½• - åªçœ‹åŸºç¡€æ•°æ®                    â”‚                    â”‚
â”‚    â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚                    â”‚
â”‚    â”‚ è®¢å•å·ï¼šPO20260125003                      â”‚                    â”‚
â”‚    â”‚ å·¥åºï¼šè½¦ç¼ï¼ˆç¬¬2æ¬¡æ‰«ç ï¼‰                    â”‚                    â”‚
â”‚    â”‚ å‘˜å·¥ï¼šå¼ ä¸‰ï¼ˆåªèƒ½çœ‹è‡ªå·±çš„è®°å½•ï¼‰             â”‚                    â”‚
â”‚    â”‚ æ•°é‡ï¼š50 ä»¶                                â”‚                    â”‚
â”‚    â”‚ âŒ å•ä»·ï¼š***     â† å®Œå…¨éšè—                â”‚                    â”‚
â”‚    â”‚ âŒ å·¥èµ„ï¼š***     â† å®Œå…¨éšè—                â”‚                    â”‚
â”‚    â”‚ âŒ æ‰€æœ‰å·¥åºå•ä»·ï¼š*** â† å®Œå…¨éšè—            â”‚                    â”‚
â”‚    â”‚ âŒ è®¢å•æ€»æˆæœ¬ï¼š***   â† å®Œå…¨éšè—            â”‚                    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ” å…³é”®è®¾è®¡åŸåˆ™ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… æ•°æ®å®Œæ•´æ€§ï¼š                                                 â”‚
â”‚    - åç«¯ï¼šæ— è®ºç”¨æˆ·è§’è‰²ï¼Œéƒ½ä¿å­˜å®Œæ•´æ•°æ®ï¼ˆå•ä»·ã€é‡‘é¢ã€å·¥åºç­‰ï¼‰  â”‚
â”‚    - åŸå› ï¼šç¡®ä¿è´¢åŠ¡ç»Ÿè®¡å‡†ç¡®ï¼Œå¯¹è´¦ä¸å‡ºé”™                        â”‚
â”‚                                                                 â”‚
â”‚ âœ… åˆ†çº§æ˜¾ç¤ºï¼š                                                   â”‚
â”‚    - å‰ç«¯ï¼šæ ¹æ®ç”¨æˆ·æƒé™ï¼ŒåŠ¨æ€éšè—æ•æ„Ÿå­—æ®µ                      â”‚
â”‚    - ä¸‰çº§æƒé™ï¼šå…¨éƒ¨å¯è§ / åªçœ‹è½¦ç¼ / å®Œå…¨éšè—                  â”‚
â”‚                                                                 â”‚
â”‚ âœ… æ‰«ç ä¸å—å½±å“ï¼š                                               â”‚
â”‚    - å‘˜å·¥æ‰«ç ï¼šåŠŸèƒ½æ­£å¸¸ï¼Œåç«¯ç…§å¸¸è®¡ç®—å’Œè®°å½•                    â”‚
â”‚    - å°ç¨‹åºæ˜¾ç¤ºï¼šå…¨éƒ¨éšè—å•ä»·å’Œé‡‘é¢ï¼ˆå®‰å…¨ï¼‰                    â”‚
â”‚    - PCç«¯æ˜¾ç¤ºï¼šæ ¹æ®ç™»å½•ç”¨æˆ·æƒé™åŠ¨æ€æ˜¾ç¤º                        â”‚
â”‚                                                                 â”‚
â”‚ âœ… å®‰å…¨æ€§ï¼š                                                     â”‚
â”‚    - å‰ç«¯ï¼šéšè—UIï¼Œç”¨æˆ·çœ‹ä¸åˆ°                                  â”‚
â”‚    - åç«¯ï¼šAPIæƒé™éªŒè¯ï¼Œé˜²æ­¢ç»•è¿‡å‰ç«¯ç›´æ¥è°ƒç”¨                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“‹ æ¶‰åŠæ•æ„Ÿæ•°æ®çš„é¡µé¢æ¸…å•ï¼ˆéœ€ä¸‰çº§æƒé™æ”¹é€ ï¼‰**ï¼š

| åºå· | é¡µé¢åç§° | è·¯å¾„ | ğŸ”´ æ€»å•ä»·/æ€»é‡‘é¢ | ğŸŸ¡ è½¦ç¼å•ä»· | ğŸŸ¢ åŸºç¡€æ•°æ® | æ”¹é€ ä¼˜å…ˆçº§ |
|-----|---------|------|---------------|-----------|-----------|----------|
| 1ï¸âƒ£ | **å‘˜å·¥å·¥èµ„æ±‡æ€»** | `/modules/finance/pages/PayrollOperatorSummary.tsx` | unitPrice, totalAmount, grandTotal | sewingUnitPrice, sewingAmount | orderNo, quantity, operatorName | âš¡ æœ€é«˜ |
| 2ï¸âƒ£ | **è®¢å•ç®¡ç†** | `/modules/basic/pages/OrderManagement/index.tsx` | totalPrice, totalAmount, unitPrice | sewingTotalAmount | orderNo, styleNo, quantity | âš¡ é«˜ |
| 3ï¸âƒ£ | **è£å‰ªå•** | `/modules/production/pages/Production/Cutting/index.tsx` | unitPrice, cuttingCost | - | orderNo, bundleNo, quantity | ğŸ”¸ ä¸­ |
| 4ï¸âƒ£ | **æˆå“ç»“ç®—** | `/modules/finance/pages/FinishedSettlement/index.tsx` | unitPrice, settlementAmount, totalAmount | sewingUnitPrice | orderNo, quantity, status | âš¡ é«˜ |
| 5ï¸âƒ£ | **æ¬¾å¼ä¿¡æ¯** | `/modules/basic/pages/StyleInfo/index.tsx` | price, estimatedCost | - | styleNo, styleName, category | ğŸ”¸ ä¸­ |
| 6ï¸âƒ£ | **ç‰©æ–™å¯¹è´¦** | `/components/Finance/MaterialReconModalContent.tsx` | unitPrice, totalAmount | - | materialName, quantity | ğŸ”¸ ä¸­ |
| 7ï¸âƒ£ | **ç”Ÿäº§è¿›åº¦** | `/modules/production/pages/ProductionProgress/index.tsx` | processCost | sewingCost | orderNo, progress, completedQty | ğŸ”¹ ä½ |
| 8ï¸âƒ£ | **å·¥åºé…ç½®** | `/modules/production/pages/ProcessConfig/index.tsx` | unitPrice (æ‰€æœ‰å·¥åº) | sewingUnitPrice | processName, processOrder | ğŸ”¸ ä¸­ |

**ğŸ”§ æ”¹é€ ä»£ç æ¨¡æ¿**ï¼ˆé€‚ç”¨äºæ‰€æœ‰8ä¸ªé¡µé¢ï¼‰ï¼š

```typescript
// ========== ç»Ÿä¸€æ”¹é€ æ¨¡æ¿ ==========
import { useFinancePermission } from '@/hooks/useFinancePermission';

const YourPage: React.FC = () => {
  // 1ï¸âƒ£ è·å–æƒé™
  const { 
    canViewTotalAmount,    // ğŸ”´ æœ€é«˜æƒé™
    canViewSewingOnly,     // ğŸŸ¡ ä¸­çº§æƒé™
    formatPrice            // å·¥å…·æ–¹æ³•
  } = useFinancePermission();

  // 2ï¸âƒ£ å®šä¹‰åˆ—ï¼ˆæ ¹æ®æƒé™åŠ¨æ€æ·»åŠ ï¼‰
  const columns = [
    // ... åŸºç¡€åˆ—ï¼ˆæ‰€æœ‰äººå¯è§ï¼‰
    
    // ğŸ”´ æ€»å•ä»·åˆ—ï¼ˆåªæœ‰é«˜æƒé™å¯è§ï¼‰
    ...(canViewTotalAmount ? [{
      title: 'å•ä»·(å…ƒ)',
      dataIndex: 'unitPrice',
      render: (value: number) => (
        <span style={{ color: '#f59e0b' }}>Â¥{toMoneyText(value)}</span>
      ),
    }] : []),

    // ğŸŸ¡ è½¦ç¼å•ä»·åˆ—ï¼ˆä¸­çº§æƒé™å¯è§ï¼‰
    ...(canViewSewingOnly && !canViewTotalAmount ? [{
      title: 'è½¦ç¼å•ä»·(å…ƒ)',
      dataIndex: 'sewingUnitPrice',
      render: (value: number, record: any) => {
        if (record.processName === 'è½¦ç¼' || record.processName === 'ä¸Šé¢†') {
          return <span style={{ color: '#10b981' }}>Â¥{toMoneyText(value)}</span>;
        }
        return <span style={{ color: '#999' }}>***</span>;
      },
    }] : []),

    // ğŸŸ¢ ä½æƒé™ï¼šéšè—åˆ—ï¼ˆæ˜¾ç¤º ***ï¼‰
    ...(!canViewTotalAmount && !canViewSewingOnly ? [{
      title: 'å•ä»·',
      render: () => <span style={{ color: '#999' }}>***</span>,
    }] : []),
  ];

  // 3ï¸âƒ£ ç»Ÿè®¡å¡ç‰‡ï¼ˆæ¡ä»¶æ¸²æŸ“ï¼‰
  return (
    <div>
      {/* ğŸ”´ é«˜æƒé™ï¼šæ˜¾ç¤ºæ‰€æœ‰ç»Ÿè®¡ */}
      {canViewTotalAmount && (
        <Row gutter={16}>
          <Col span={6}>
            <Statistic title="è®¢å•æ€»é‡‘é¢" value={totalAmount} prefix="Â¥" />
          </Col>
          <Col span={6}>
            <Statistic title="å¹³å‡å•ä»·" value={avgPrice} prefix="Â¥" />
          </Col>
        </Row>
      )}

      {/* ğŸŸ¡ ä¸­çº§æƒé™ï¼šåªæ˜¾ç¤ºè½¦ç¼ç»Ÿè®¡ */}
      {canViewSewingOnly && !canViewTotalAmount && (
        <Row gutter={16}>
          <Col span={6}>
            <Statistic title="è½¦ç¼æ€»é‡‘é¢" value={sewingAmount} prefix="Â¥" />
          </Col>
        </Row>
      )}

      {/* ğŸŸ¢ ä½æƒé™ï¼šä¸æ˜¾ç¤ºä»»ä½•é‡‘é¢ç»Ÿè®¡ */}
      {!canViewTotalAmount && !canViewSewingOnly && (
        <Alert message="æ‚¨æ— æƒé™æŸ¥çœ‹è´¢åŠ¡æ•°æ®" type="info" showIcon />
      )}

      <Table columns={columns} dataSource={data} />
    </div>
  );
};
```

**âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… æ­£ç¡®åšæ³•                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ åŒé‡ä¿æŠ¤ï¼šå‰ç«¯éšè— + åç«¯æƒé™éªŒè¯                           â”‚
â”‚ â€¢ ç»Ÿä¸€æƒé™ç ï¼šFINANCE_PRICE_VIEW åœ¨æ‰€æœ‰é¡µé¢ç»Ÿä¸€ä½¿ç”¨          â”‚
â”‚ â€¢ å°ç¨‹åºå…¨éšè—ï¼šå‘˜å·¥ç«¯ä¸æ˜¾ç¤ºä»»ä½•å•ä»·/é‡‘é¢                    â”‚
â”‚ â€¢ æ•°æ®å®Œæ•´æ€§ï¼šåç«¯ç…§å¸¸ä¿å­˜ï¼Œä¸å› å‰ç«¯éšè—è€Œä¸è®°å½•              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ ç¦æ­¢åšæ³•                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ä¸è¦åœ¨APIå“åº”ä¸­å®Œå…¨åˆ é™¤æ•æ„Ÿå­—æ®µï¼ˆå‰ç«¯éœ€è¦è®¡ç®—æ€»é¢ï¼‰         â”‚
â”‚ â€¢ ä¸è¦ç¡¬ç¼–ç è§’è‰²åˆ¤æ–­ï¼ˆä½¿ç”¨æƒé™ç  canViewPriceï¼‰               â”‚
â”‚ â€¢ ä¸è¦è·³è¿‡åç«¯æƒé™éªŒè¯ï¼ˆå³ä½¿å‰ç«¯éšè—ä¹Ÿè¦åç«¯é™åˆ¶APIè®¿é—®ï¼‰     â”‚
â”‚ â€¢ ä¸è¦å› å‰ç«¯éšè—è€Œä¸ä¿å­˜æ•°æ®ï¼ˆå½±å“è´¢åŠ¡ç»Ÿè®¡å’Œå¯¹è´¦ï¼‰            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“Š æƒé™æ§åˆ¶æµç¨‹å›¾**ï¼š

```
ç”¨æˆ·è®¿é—®é¡µé¢
     â†“
è·å–ç”¨æˆ·æƒé™åˆ—è¡¨ï¼ˆuserPermissionsï¼‰
     â†“
æ£€æŸ¥æ˜¯å¦åŒ…å« FINANCE_PRICE_VIEW
     â†“
   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
   â”‚           â”‚
   âœ…          âŒ
 æœ‰æƒé™      æ— æƒé™
   â”‚           â”‚
   â†“           â†“
æ˜¾ç¤ºçœŸå®å•ä»·  æ˜¾ç¤º ***
æ˜¾ç¤ºçœŸå®é‡‘é¢  æ˜¾ç¤º ***
   â”‚           â”‚
   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â†“
    æ¸²æŸ“é¡µé¢
```

**ğŸ”§ å®æ–½æ­¥éª¤**ï¼š

1. **æ‰§è¡Œæ•°æ®åº“è„šæœ¬**ï¼ˆæ·»åŠ æƒé™ï¼‰
2. **ä¿®æ”¹å‰ç«¯é¡µé¢**ï¼ˆ6ä¸ªé¡µé¢æ·»åŠ æƒé™åˆ¤æ–­ï¼‰
3. **ä¿®æ”¹å°ç¨‹åº**ï¼ˆéšè—å•ä»·/é‡‘é¢æ˜¾ç¤ºï¼‰
4. **æµ‹è¯•éªŒè¯**ï¼ˆä¸åŒè§’è‰²ç™»å½•æ£€æŸ¥å¯è§æ€§ï¼‰

**ğŸ“š è¯¦ç»†å®æ–½æŒ‡å—**ï¼šå‚è€ƒä¸‹æ–¹ä»£ç ç¤ºä¾‹å’Œæƒé™çŸ©é˜µè¡¨

---

#### ä½•æ—¶ä½¿ç”¨ Orchestratorï¼Ÿ

âœ… **éœ€è¦ Orchestrator**ï¼š

- è·¨å¤šä¸ª Service çš„ä¸šåŠ¡æµç¨‹
- éœ€è¦äº‹åŠ¡ç®¡ç†ï¼ˆ@Transactionalï¼‰
- éœ€è¦ç¼–æ’å¤šä¸ªæ­¥éª¤
- æ¶‰åŠå¤æ‚çš„ä¸šåŠ¡é€»è¾‘

âŒ **ä¸éœ€è¦ Orchestrator**ï¼š

- å•è¡¨ CRUD æ“ä½œ
- ç®€å•æŸ¥è¯¢
- æ•°æ®æ ¼å¼è½¬æ¢

#### ç¤ºä¾‹å¯¹æ¯”

**âŒ é”™è¯¯ï¼šç®€å•æŸ¥è¯¢ä½¿ç”¨ Orchestrator**

```java
// ä¸éœ€è¦ Orchestrator
@Service
public class OrderOrchestrator {
    public Order getById(Long id) {
        return orderService.getById(id);  // å•è¡¨æŸ¥è¯¢
    }
}
```

**âœ… æ­£ç¡®ï¼šç›´æ¥ä½¿ç”¨ Service**

```java
@RestController
public class OrderController {
    @Autowired
    private OrderService orderService;

    @GetMapping("/{id}")
    public R<Order> getById(@PathVariable Long id) {
        return R.ok(orderService.getById(id));
    }
}
```

**âœ… æ­£ç¡®ï¼šå¤æ‚ä¸šåŠ¡ä½¿ç”¨ Orchestrator**

```java
@Service
public class OrderOrchestrator {
    @Transactional
    public Long createOrderWithBundles(OrderCreateDTO dto) {
        // 1. åˆ›å»ºè®¢å•
        Order order = orderService.create(dto);

        // 2. ç”Ÿæˆè²å·ï¼ˆè·¨æœåŠ¡ï¼‰
        bundleService.generateBundles(order.getId(), dto.getBundleCount());

        // 3. åˆå§‹åŒ–å·¥åºï¼ˆè·¨æœåŠ¡ï¼‰
        progressService.initProgress(order.getId(), dto.getStages());

        // 4. æ›´æ–°è´¢åŠ¡ç»Ÿè®¡ï¼ˆè·¨æœåŠ¡ï¼‰
        financeService.createOrderCost(order.getId());

        return order.getId();
    }
}
```

### 6.2 å‰ç«¯é€šç”¨ç»„ä»¶å¼€å‘è§„èŒƒ

#### SortableColumnTitle - é€šç”¨æ’åºåˆ—ç»„ä»¶

**ç»„ä»¶ä½ç½®**ï¼š`frontend/src/components/common/SortableColumnTitle.tsx`

**æ ¸å¿ƒç‰¹æ€§**ï¼š

- ä¸‰æ€æ’åºå›¾æ ‡ï¼ˆæ¿€æ´»è“è‰² / éæ¿€æ´»ç°è‰²åŒç®­å¤´ï¼‰
- æ”¯æŒæ•°å€¼ã€æ—¶é—´ã€å­—ç¬¦ä¸²æ’åº
- æ”¯æŒå·¦/ä¸­/å³å¯¹é½
- å¯å¤ç”¨åˆ°æ‰€æœ‰è¡¨æ ¼çš„æ—¶é—´åˆ—ã€é‡‘é¢åˆ—ã€æ•°é‡åˆ—

**ä½¿ç”¨æ­¥éª¤**ï¼š

1. **å¯¼å…¥ç»„ä»¶**

```typescript
import SortableColumnTitle from "@/components/common/SortableColumnTitle";
```

2. **æ·»åŠ æ’åºçŠ¶æ€**

```typescript
const [sortField, setSortField] = useState<string>("createTime");
const [sortOrder, setSortOrder] = useState<"asc" | "desc">("desc");
```

3. **å®ç°æ’åºå›è°ƒ**

```typescript
const handleSort = (field: string, order: "asc" | "desc") => {
  setSortField(field);
  setSortOrder(order);
};
```

4. **åœ¨åˆ—å®šä¹‰ä¸­ä½¿ç”¨**

```typescript
const columns = [
    {
        title: <SortableColumnTitle
            title="åˆ›å»ºæ—¶é—´"
            sortField={sortField}
            fieldName="createTime"
            sortOrder={sortOrder}
            onSort={handleSort}
            align="left"
        />,
        dataIndex: 'createTime',
        key: 'createTime',
        render: (v) => formatDateTime(v),
    },
    {
        title: <SortableColumnTitle
            title="æ€»é‡‘é¢(å…ƒ)"
            sortField={sortField}
            fieldName="totalAmount"
            sortOrder={sortOrder}
            onSort={handleSort}
        />,
        dataIndex: 'totalAmount',
        align: 'right',
    },
];
```

5. **å®ç°æ•°æ®æ’åº**

```typescript
const sortedData = useMemo(() => {
  const sorted = [...data];
  sorted.sort((a: any, b: any) => {
    const aVal = a[sortField];
    const bVal = b[sortField];

    // æ—¶é—´å­—æ®µæ’åº
    if (sortField === "createTime" || sortField === "updateTime") {
      const aTime = aVal ? new Date(aVal).getTime() : 0;
      const bTime = bVal ? new Date(bVal).getTime() : 0;
      return sortOrder === "desc" ? bTime - aTime : aTime - bTime;
    }

    // æ•°å€¼å­—æ®µæ’åº
    if (typeof aVal === "number" && typeof bVal === "number") {
      return sortOrder === "desc" ? bVal - aVal : aVal - bVal;
    }

    // å­—ç¬¦ä¸²å­—æ®µæ’åº
    const aStr = String(aVal || "");
    const bStr = String(bVal || "");
    return sortOrder === "desc"
      ? bStr.localeCompare(aStr, "zh-CN")
      : aStr.localeCompare(bStr, "zh-CN");
  });
  return sorted;
}, [data, sortField, sortOrder]);
```

**åº”ç”¨åœºæ™¯**ï¼š

- âœ… å‘˜å·¥å·¥èµ„æ±‡æ€»ï¼ˆæ€»é‡‘é¢ã€å®¡æ ¸æ—¶é—´ã€ä»˜æ¬¾æ—¶é—´ï¼‰
- âœ… å‘˜å·¥å·¥åºæ˜ç»†ï¼ˆå¼€å§‹æ—¶é—´ã€å®Œæˆæ—¶é—´ï¼‰
- âœ… è®¢å•åˆ—è¡¨ï¼ˆä¸‹å•æ—¶é—´ã€å®Œæˆæ—¶é—´ï¼‰
- âœ… è£å‰ªå•ï¼ˆé¢†å–æ—¶é—´ã€å®Œæˆæ—¶é—´ï¼‰
- âœ… ç‰©æ–™é‡‡è´­ï¼ˆåˆ›å»ºæ—¶é—´ã€åˆ°è´§æ—¶é—´ï¼‰

---

#### LiquidProgressBar - æ¶²ä½“æ³¢æµªè¿›åº¦æ¡ç»„ä»¶ ğŸŒŠ

**ç»„ä»¶ä½ç½®**ï¼š`frontend/src/components/common/LiquidProgressBar.tsx`

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- ğŸŒŠ æ¶²ä½“æ³¢æµªåŠ¨ç”»æ•ˆæœï¼ˆä¸¤å±‚æ³¢æµªå åŠ ï¼‰
- ğŸ¨ æ™ºèƒ½çŠ¶æ€é¢œè‰²ï¼ˆæ­£å¸¸/è­¦å‘Š/å»¶æœŸ/å®Œæˆï¼‰
- ğŸŸ¢ è„‰å†²æ³¢æµªçº¿ï¼ˆä¸Šä¸‹è¾¹ç¼˜æµåŠ¨ï¼Œè·ŸéšçŠ¶æ€å˜è‰²ï¼‰
- âš¡ GPU ç¡¬ä»¶åŠ é€Ÿï¼ˆé«˜æ€§èƒ½ï¼‰
- ğŸ“ ç»†é•¿æ¡å½¢è®¾è®¡ï¼ˆé€‚åˆè¡¨æ ¼å’Œå¡ç‰‡ï¼‰
- ğŸ¯ è‡ªé€‚åº”åŠ¨ç”»é€Ÿåº¦ï¼ˆè¿›åº¦è¶Šé«˜è¶Šå¿«ï¼‰

**æ€§èƒ½æ•°æ®**ï¼š
- CPU å ç”¨ï¼š2-4%ï¼ˆ100ä¸ªå®ä¾‹ï¼‰
- FPSï¼šç¨³å®š 60fps
- å†…å­˜ï¼š~2KB/å®ä¾‹
- **ç»“è®º**ï¼šå¯å¤§è§„æ¨¡ä½¿ç”¨ âœ…

**é¢œè‰²çŠ¶æ€ç³»ç»Ÿ**ï¼ˆ2026-01-29 æœ€æ–°ï¼‰ï¼š
```typescript
// âœ… å·²å®Œæˆï¼ˆpercent >= 100ï¼‰
ä¸»è‰²ï¼š#52c41aï¼ˆç»¿è‰²ï¼‰
å‰¯è‰²ï¼š#95de64ï¼ˆæµ…ç»¿è‰²ï¼‰
åŠ¨ç”»ï¼šæ— æ³¢æµªåŠ¨ç”»ï¼Œæ— è„‰å†²çº¿

// ğŸŸ¢ ç”Ÿäº§ä¸­ - æ­£å¸¸ï¼ˆstatus='normal'ï¼‰
ä¸»è‰²ï¼š#52c41aï¼ˆç»¿è‰²ï¼‰
å‰¯è‰²ï¼š#95de64ï¼ˆæµ…ç»¿è‰²ï¼‰
è„‰å†²çº¿ï¼šè§å…‰ç»¿ rgba(0, 255, 100, 1)

// ğŸŸ¡ ç”Ÿäº§ä¸­ - å¿«å»¶æœŸï¼ˆstatus='warning'ï¼‰
ä¸»è‰²ï¼š#faad14ï¼ˆé»„è‰²ï¼‰
å‰¯è‰²ï¼š#ffc53dï¼ˆæµ…é»„è‰²ï¼‰
è„‰å†²çº¿ï¼šäº®é»„è‰² rgba(255, 220, 50, 1)

// ğŸ”´ ç”Ÿäº§ä¸­ - å·²å»¶æœŸï¼ˆstatus='danger'ï¼‰
ä¸»è‰²ï¼š#ff4d4fï¼ˆçº¢è‰²ï¼‰
å‰¯è‰²ï¼š#ff7875ï¼ˆæµ…çº¢è‰²ï¼‰
è„‰å†²çº¿ï¼šäº®çº¢è‰² rgba(255, 80, 80, 1)

// èƒŒæ™¯è‰²
#f0f0f0ï¼ˆæµ…ç°è‰²ï¼‰
```

**ä½¿ç”¨æ–¹å¼ 1ï¼šåŸºç¡€ç”¨æ³•ï¼ˆè‡ªåŠ¨ç»¿è‰²ï¼‰**

```typescript
import LiquidProgressBar from '@/components/common/LiquidProgressBar';

// è¡¨æ ¼ä¸­çš„è¿›åº¦æ¡
{
  title: 'é‡‡è´­',
  dataIndex: 'procurementRate',
  render: (rate: number) => (
    <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
      <LiquidProgressBar
        percent={rate || 0}
        width="100%"
        height={12}
      />
      <span style={{ fontSize: '12px', color: '#666', minWidth: '40px' }}>
        {rate || 0}%
      </span>
    </div>
  ),
}
```

**ä½¿ç”¨æ–¹å¼ 2ï¼šå¸¦çŠ¶æ€åˆ¤æ–­ï¼ˆæ¨èï¼‰**

```typescript
import LiquidProgressBar from '@/components/common/LiquidProgressBar';

// æ ¹æ®è®¢å•çŠ¶æ€æ˜¾ç¤ºä¸åŒé¢œè‰²
{
  title: 'ç”Ÿäº§è¿›åº¦',
  dataIndex: 'productionProgress',
  render: (progress: number, record: ProductionOrder) => {
    // åˆ¤æ–­è®¢å•çŠ¶æ€
    const getStatus = () => {
      if (progress >= 100) return 'normal'; // å®Œæˆäº†
      const isOverdue = new Date(record.plannedEndDate) < new Date();
      const isDueSoon = /* å¿«åˆ°æœŸçš„é€»è¾‘ */;
      
      if (isOverdue) return 'danger';      // ğŸ”´ çº¢è‰² + çº¢è‰²è„‰å†²
      if (isDueSoon) return 'warning';     // ğŸŸ¡ é»„è‰² + é»„è‰²è„‰å†²
      return 'normal';                     // ğŸŸ¢ ç»¿è‰² + ç»¿è‰²è„‰å†²
    };
    
    return (
      <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
        <LiquidProgressBar
          percent={progress || 0}
          width="100%"
          height={12}
          status={getStatus()}  // ğŸŒŸ å…³é”®ï¼šä¼ å…¥çŠ¶æ€
        />
        <span style={{ fontSize: '12px', color: '#666' }}>
          {progress || 0}%
        </span>
      </div>
    );
  },
}
```

**ä½¿ç”¨æ–¹å¼ 3ï¼šUniversalCardView é›†æˆ**

```typescript
import UniversalCardView from '@/components/common/UniversalCardView';

<UniversalCardView
  dataSource={records}
  titleField="orderNo"
  fields={[...]}
  progressConfig={{
    calculate: (record) => record.productionProgress,
    type: 'liquid',  // ğŸŒŸ ä½¿ç”¨æ¶²ä½“æ³¢æµªè¿›åº¦æ¡
    show: true,
  }}
/>
```

**API æ–‡æ¡£**ï¼š

```typescript
interface LiquidProgressBarProps {
  percent: number;              // å¿…å¡«ï¼šè¿›åº¦ç™¾åˆ†æ¯” (0-100)
  width?: number | string;      // å¯é€‰ï¼šå®½åº¦ï¼Œé»˜è®¤ '100%'
  height?: number;              // å¯é€‰ï¼šé«˜åº¦ï¼Œé»˜è®¤ 12
  color?: string;               // å¯é€‰ï¼šè‡ªå®šä¹‰é¢œè‰²ï¼ˆè¦†ç›–è‡ªåŠ¨å˜è‰²ï¼‰
  backgroundColor?: string;     // å¯é€‰ï¼šèƒŒæ™¯è‰²ï¼Œé»˜è®¤ '#f0f0f0'
  status?: 'normal' | 'warning' | 'danger';  // å¯é€‰ï¼šçŠ¶æ€ï¼Œé»˜è®¤ 'normal'
}
```

**çŠ¶æ€è¯´æ˜**ï¼š
- `normal`: æ­£å¸¸ï¼ˆç»¿è‰²ï¼‰- é»˜è®¤å€¼
- `warning`: å¿«å»¶æœŸï¼ˆé»„è‰²ï¼‰- ä¸´è¿‘æˆªæ­¢æ—¥æœŸ
- `danger`: å·²å»¶æœŸï¼ˆçº¢è‰²ï¼‰- è¶…è¿‡æˆªæ­¢æ—¥æœŸ

**å°ºå¯¸è§„èŒƒ**ï¼š
```typescript
è¡¨æ ¼è¿›åº¦æ¡: height = 12pxï¼ˆæ¨èï¼‰
å¡ç‰‡è¿›åº¦æ¡: height = 10px
æ˜ç»†è¿›åº¦æ¡: height = 10px
```

**è§†è§‰æ•ˆæœè¯´æ˜**ï¼š
1. **æ¶²ä½“æ³¢æµªåŠ¨ç”»**ï¼šä¸¤å±‚æ³¢æµªä¸Šä¸‹èµ·ä¼ï¼Œåªåœ¨ percent < 100 æ—¶æ˜¾ç¤º
2. **è„‰å†²æ³¢æµªçº¿**ï¼šä¸Šä¸‹è¾¹ç¼˜æœ‰è§å…‰è‰²æ³¢æµªçº¿ä»å·¦åˆ°å³å¾ªç¯æµåŠ¨ï¼Œåªåœ¨ percent < 100 æ—¶æ˜¾ç¤º
3. **å·²å®ŒæˆçŠ¶æ€**ï¼špercent >= 100 æ—¶ï¼Œé™æ­¢ç»¿è‰²æ¡ï¼Œæ— åŠ¨ç”»ï¼Œæ— è„‰å†²çº¿

**åº”ç”¨åœºæ™¯**ï¼š
- âœ… è®¢å•åˆ—è¡¨ï¼ˆå·¥åºæ±‡æ€»è¿›åº¦ï¼‰
- âœ… è®¢å•å¡ç‰‡è§†å›¾ï¼ˆç”Ÿäº§è¿›åº¦ï¼‰
- âœ… æ ·æ¿ç”Ÿäº§ï¼ˆå¡ç‰‡è¿›åº¦ï¼‰
- âœ… è£å‰ªå•åˆ—è¡¨
- âœ… è´¨æ£€å…¥åº“åˆ—è¡¨
- âœ… æ•°æ®çœ‹æ¿ç»Ÿè®¡
- âœ… **å…¨ç«™é€šç”¨è¿›åº¦æ¡**ï¼ˆå–ä»£æ™®é€š Progress ç»„ä»¶ï¼‰

**è¯¦ç»†æ–‡æ¡£**ï¼š
- `docs/LiquidProgressBarä½¿ç”¨æŒ‡å—.md` - å®Œæ•´APIæ–‡æ¡£
- `docs/LiquidProgressBaræ€§èƒ½åˆ†æ.md` - æ€§èƒ½æµ‹è¯•æŠ¥å‘Š
- `docs/LiquidProgressBarç»Ÿä¸€ä½¿ç”¨å†³ç­–.md` - ç»Ÿä¸€ä½¿ç”¨å†³ç­–

---

### å‰ç«¯ï¼šHorizontalProgressPriceView æ¨ªå‘è¿›åº¦ä¸å·¥åºå•ä»·ç»„ä»¶

**æ–‡ä»¶ä½ç½®**ï¼š`frontend/src/components/common/HorizontalProgressPriceView.tsx`

#### æ ¸å¿ƒç‰¹æ€§

æ¨ªå‘æ»šåŠ¨å±•ç¤ºè¿›åº¦èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹æ˜¾ç¤ºï¼š
- **æ¶²ä½“æ³¢æµªè¿›åº¦æ¡**ï¼ˆé›†æˆ LiquidProgressBarï¼‰
- **å·¥åºå•ä»·è¾“å…¥æ¡†**
- **å·²å®Œæˆ/æ€»æ•°é‡/å‰©ä½™æ•°ç»Ÿè®¡**
- **é¢„ä¼°æ€»ä»·è®¡ç®—**
- **æ€»è®¡å¡ç‰‡**ï¼ˆå·¥åºæ•°ã€å·²å®Œæˆå·¥åºã€æ€»å•ä»·ã€æ€»æˆæœ¬ï¼‰

#### åŸºç¡€ç”¨æ³•

```typescript
import HorizontalProgressPriceView from '@/components/common/HorizontalProgressPriceView';

// åœ¨è¿›åº¦è¯¦æƒ…é¡µä½¿ç”¨
<HorizontalProgressPriceView
  nodes={nodes}                      // è¿›åº¦èŠ‚ç‚¹åˆ—è¡¨
  nodeStats={nodeStats.statsByName}  // èŠ‚ç‚¹ç»Ÿè®¡æ•°æ®
  totalQty={nodeStats.totalQty}      // æ€»æ•°é‡
  canEdit={canEditWorkflow}          // æ˜¯å¦å¯ç¼–è¾‘å•ä»·
  onPriceChange={updateNodeUnitPrice} // å•ä»·å˜æ›´å›è°ƒ
  frozen={frozen}                    // æ˜¯å¦å†»ç»“ï¼ˆå·²å®Œæˆè®¢å•ï¼‰
/>
```

#### æ•°æ®ç»“æ„

```typescript
// è¿›åº¦èŠ‚ç‚¹
type ProgressNode = {
  id: string;
  name: string;
  unitPrice?: number;
};

// èŠ‚ç‚¹ç»Ÿè®¡
type NodeStat = {
  done: number;       // å·²å®Œæˆæ•°é‡
  total: number;      // æ€»æ•°é‡
  remaining: number;  // å‰©ä½™æ•°é‡
  percent: number;    // å®Œæˆç™¾åˆ†æ¯”
};

// ç»„ä»¶å±æ€§
interface HorizontalProgressPriceViewProps {
  nodes: ProgressNode[];
  nodeStats: Record<string, NodeStat>;
  totalQty: number;
  canEdit?: boolean;
  onPriceChange?: (nodeId: string, newPrice: number) => void;
  frozen?: boolean;
}
```

#### è§†è§‰æ•ˆæœ

**å·¥åºå¡ç‰‡**ï¼ˆæ¨ªå‘æ»šåŠ¨ï¼‰ï¼š
- å¡ç‰‡å°ºå¯¸ï¼š280-320pxå®½
- æ¯›ç»ç’ƒæ•ˆæœèƒŒæ™¯ï¼ˆç™½è‰²åŠé€æ˜æ¸å˜ï¼‰
- å·²å®Œæˆå¡ç‰‡ï¼šç»¿è‰²è¾¹æ¡†
- å†»ç»“å¡ç‰‡ï¼šç°è‰²èƒŒæ™¯

**è¿›åº¦æ¡çŠ¶æ€**ï¼š
- æ­£å¸¸ï¼šç»¿è‰²æ¶²ä½“æ³¢æµª + è§å…‰ç»¿è„‰å†²çº¿
- è­¦å‘Šï¼šé»„è‰²æ¶²ä½“æ³¢æµª + äº®é»„è„‰å†²çº¿
- å»¶æœŸï¼šçº¢è‰²æ¶²ä½“æ³¢æµª + äº®çº¢è„‰å†²çº¿
- å·²å®Œæˆï¼šé™æ­¢ç»¿è‰²æ¡ï¼ˆæ— åŠ¨ç”»ï¼‰

**æ•°é‡ç»Ÿè®¡åŒº**ï¼š
- 3åˆ—å¸ƒå±€ï¼šå·²å®Œæˆï¼ˆç»¿è‰²ï¼‰/ æ€»æ•°é‡ï¼ˆç°è‰²ï¼‰/ å‰©ä½™ï¼ˆé»„è‰²ï¼‰
- ç«–çº¿åˆ†éš”
- æµ…ç°èƒŒæ™¯å¡ç‰‡

**å·¥åºå•ä»·åŒº**ï¼š
- è“è‰²æ¸å˜èƒŒæ™¯
- Â¥ å‰ç¼€
- å¯ç¼–è¾‘ InputNumber

**æ€»è®¡å¡ç‰‡**ï¼š
- å“åº”å¼ç½‘æ ¼å¸ƒå±€ï¼ˆauto-fit, minmax(200px, 1fr)ï¼‰
- æ˜¾ç¤ºï¼šæ€»å·¥åºæ•° / å·²å®Œæˆå·¥åº / å·¥åºæ€»å•ä»· / é¢„ä¼°æ€»æˆæœ¬
- è“è‰²åŠé€æ˜èƒŒæ™¯

#### åº”ç”¨åœºæ™¯

- âœ… ç”Ÿäº§è¿›åº¦è¯¦æƒ…é¡µï¼ˆProgressDetailï¼‰
- âœ… è®¢å•æ˜ç»†å·¥åºç®¡ç†
- âœ… æˆæœ¬æ ¸ç®—é¡µé¢
- âœ… å·¥åºå•ä»·é…ç½®é¡µé¢

**å·²åº”ç”¨é¡µé¢**ï¼š
- `modules/production/pages/Production/ProgressDetail/index.tsx` - è¿›åº¦ä¸å·¥åºå•ä»·åŒºåŸŸ

---

### å‰ç«¯ï¼šSortableColumn é€šç”¨æ’åºåˆ—ç»„ä»¶

**æ–‡ä»¶ä½ç½®**ï¼š`frontend/src/components/common/SortableColumnTitle.tsx`

#### ä½¿ç”¨æ–¹å¼

```typescript
import SortableColumnTitle from '@/components/common/SortableColumnTitle';

// è¡¨æ ¼åˆ—å®šä¹‰
{
  title: <SortableColumnTitle
    label="è®¢å•å·"
    currentSortKey={sortKey}
    currentOrder={sortOrder}
    sortKey="orderNo"
    onChange={(key, order) => handleSort(key, order)}
  />,
  dataIndex: 'orderNo',
  key: 'orderNo',
}
```

### 6.2.5 Modalæœ€ä½³å®è·µï¼ˆç±»å‹å®‰å…¨ + å¸ƒå±€ç»Ÿä¸€ï¼‰

ç³»ç»Ÿæä¾›ä¸¤ä¸ªæ ¸å¿ƒå·¥å…·æ¥ç®€åŒ–Modalå¼€å‘ï¼Œå®ç°**ä»£ç å‡å°‘50-75%**ã€**ç±»å‹å®‰å…¨100%**ã€**è§†è§‰ä¸€è‡´100%**ï¼š

#### å·¥å…·1ï¼šuseModal Hook - ç±»å‹å®‰å…¨çš„çŠ¶æ€ç®¡ç†

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âœ… **ç±»å‹å®‰å…¨**ï¼šå®Œæ•´TypeScriptæ”¯æŒï¼Œç¼–è¯‘æ—¶æ£€æŸ¥
- âœ… **ç®€åŒ–çŠ¶æ€**ï¼š4è¡Œä»£ç  â†’ 1è¡Œä»£ç ï¼ˆå‡å°‘75%ï¼‰
- âœ… **é˜²é—ªçƒ**ï¼š300mså»¶è¿Ÿæ¸…ç†ï¼Œæµç•…å…³é—­åŠ¨ç”»
- âœ… **ç»Ÿä¸€API**ï¼šæ‰€æœ‰Modalä½¿ç”¨ç›¸åŒæ¨¡å¼

**åŸºç¡€ç”¨æ³•**ï¼š

```typescript
import { useModal } from '@/hooks/useModal';

// 1. å®šä¹‰æ•°æ®ç±»å‹ï¼ˆå¼ºç±»å‹ï¼‰
interface OrderDetail {
  id: string;
  orderNo: string;
  quantity: number;
}

// 2. ä½¿ç”¨useModalï¼ˆ1è¡Œä»£ç ï¼‰
const orderModal = useModal<OrderDetail>();

// 3. æ‰“å¼€Modal
const handleEdit = (record: OrderDetail) => {
  orderModal.open(record);
};

// 4. åœ¨JSXä¸­ä½¿ç”¨
<Button onClick={() => handleEdit(record)}>ç¼–è¾‘</Button>

<Modal
  visible={orderModal.visible}
  onCancel={orderModal.close}
  title="ç¼–è¾‘è®¢å•"
>
  {orderModal.data && (
    <Form initialValues={orderModal.data}>
      <Form.Item label="è®¢å•å·" name="orderNo">
        <Input />
      </Form.Item>
    </Form>
  )}
</Modal>
```

**APIè¯´æ˜**ï¼š
```typescript
const modal = useModal<T>()

// è¿”å›å€¼ï¼š
{
  visible: boolean,           // Modalå¯è§æ€§
  data: T | null,            // Modalæ•°æ®ï¼ˆç±»å‹å®‰å…¨ï¼‰
  open: (data: T) => void,   // æ‰“å¼€Modal
  close: () => void,         // å…³é—­Modal
  setModalData: (data: T) => void  // æ›´æ–°æ•°æ®
}
```

**ä»£ç å¯¹æ¯”**ï¼š

```typescript
// âŒ ä¼ ç»Ÿæ–¹å¼ï¼ˆ4ä¸ªçŠ¶æ€ï¼‰
const [visible, setVisible] = useState(false);
const [editData, setEditData] = useState<OrderDetail | null>(null);
const handleOpen = (data: OrderDetail) => {
  setEditData(data);
  setVisible(true);
};
const handleClose = () => {
  setVisible(false);
  setTimeout(() => setEditData(null), 300);
};

// âœ… useModalæ–¹å¼ï¼ˆ1è¡Œï¼‰
const modal = useModal<OrderDetail>();
// API: modal.open(data), modal.close, modal.visible, modal.data
```

---

#### å·¥å…·2ï¼šModalContentLayout - ç»Ÿä¸€å¸ƒå±€ç»„ä»¶ç³»ç»Ÿ

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âœ… **9ä¸ªæ ‡å‡†ç»„ä»¶**ï¼šè¦†ç›–90%Modalå¸ƒå±€åœºæ™¯
- âœ… **å“åº”å¼è®¾è®¡**ï¼šPC/ç§»åŠ¨ç«¯è‡ªåŠ¨é€‚é…ï¼ˆisMobile propï¼‰
- âœ… **è®¾è®¡ç³»ç»Ÿé›†æˆ**ï¼š7ä¸ªCSSå˜é‡ï¼Œä¸€é”®æ¢è‚¤
- âœ… **ä»£ç å‡å°‘**ï¼š50-72%ï¼ˆ248è¡Œ â†’ 70è¡Œï¼‰

**9ä¸ªæ ¸å¿ƒç»„ä»¶**ï¼š

```typescript
import {
  ModalContentLayout,      // å®¹å™¨ï¼ˆpadding+overflowï¼‰
  ModalHeaderCard,         // å¤´éƒ¨ç°è‰²å¡ç‰‡
  ModalField,              // æ ‡å‡†å­—æ®µï¼ˆ13pxæ ‡ç­¾ + 14pxå€¼ï¼‰
  ModalPrimaryField,       // ä¸»è¦å­—æ®µï¼ˆ14pxæ ‡ç­¾ + 18pxå€¼ï¼ŒåŠ ç²—ï¼‰
  ModalFieldRow,           // æ¨ªå‘å­—æ®µå¸ƒå±€ï¼ˆgap=24pxï¼‰
  ModalFieldGrid,          // ç½‘æ ¼å¸ƒå±€ï¼ˆPC 3åˆ—ï¼Œç§»åŠ¨1åˆ—ï¼‰
  ModalInfoCard,           // ä¿¡æ¯å¡ç‰‡ï¼ˆç™½åº•+è¾¹æ¡†+é˜´å½±ï¼‰
  ModalSideLayout,         // å·¦å³å¸ƒå±€ï¼ˆå°é¢+å†…å®¹ï¼‰
  ModalVerticalStack,      // å‚ç›´å †å ï¼ˆgap=12pxï¼‰
} from '@/components/common/ModalContentLayout';
```

**å¿«é€Ÿç¤ºä¾‹ - è®¢å•è¯¦æƒ…Modal**ï¼š

```typescript
import { useModal } from '@/hooks/useModal';
import { ModalHeaderCard, ModalPrimaryField, ModalFieldRow, ModalField } from '@/components/common/ModalContentLayout';

const OrderDetailModal = () => {
  const { isMobile } = useViewport();
  const modal = useModal<Order>();
  
  return (
    <Modal
      visible={modal.visible}
      onCancel={modal.close}
      title="è®¢å•è¯¦æƒ…"
      width="60vw"
    >
      {modal.data && (
        <>
          {/* å¤´éƒ¨å…³é”®ä¿¡æ¯ï¼ˆç°è‰²å¡ç‰‡ï¼‰ */}
          <ModalHeaderCard isMobile={isMobile}>
            <ModalPrimaryField 
              label="è®¢å•å·" 
              value={modal.data.orderNo}
            />
            <ModalFieldRow>
              <ModalField label="æ¬¾å·" value={modal.data.styleNo} />
              <ModalField label="æ•°é‡" value={`${modal.data.quantity}ä»¶`} />
            </ModalFieldRow>
          </ModalHeaderCard>
          
          {/* è¯¦ç»†ä¿¡æ¯ï¼ˆç½‘æ ¼å¸ƒå±€ï¼‰ */}
          <ModalFieldGrid columns={3}>
            <ModalField label="é¢œè‰²" value={modal.data.color} />
            <ModalField label="å°ºç " value={modal.data.size} />
            <ModalField label="å•ä»·" value={`Â¥${modal.data.price}`} />
          </ModalFieldGrid>
        </>
      )}
    </Modal>
  );
};
```

---

#### å®Œæ•´ç¤ºä¾‹ï¼šè´¨æ£€å…¥åº“Modal

**ä»£ç å¯¹æ¯”**ï¼ˆ72%ä»£ç å‡å°‘ï¼‰ï¼š

**ä¼ ç»Ÿæ–¹å¼ï¼ˆ248è¡Œï¼‰**ï¼š
```typescript
const QualityInspectionModal = () => {
  // âŒ 4ä¸ªçŠ¶æ€å˜é‡
  const [visible, setVisible] = useState(false);
  const [data, setData] = useState<QualityData | null>(null);
  
  // âŒ 2ä¸ªå¤„ç†å‡½æ•°
  const handleOpen = (record: QualityData) => {
    setData(record);
    setVisible(true);
  };
  
  const handleClose = () => {
    setVisible(false);
    setTimeout(() => setData(null), 300);
  };
  
  return (
    <Modal visible={visible} onCancel={handleClose}>
      {/* âŒ è‡ªå®šä¹‰å¸ƒå±€ï¼Œ180è¡Œæ ·å¼ä»£ç  */}
      <div style={{ padding: '16px' }}>
        <div style={{ 
          background: '#f8f9fa', 
          padding: '12px', 
          borderRadius: '6px',
          marginBottom: '16px'
        }}>
          <div style={{ 
            display: 'flex', 
            justifyContent: 'space-between',
            marginBottom: '8px'
          }}>
            <span style={{ fontSize: '14px', color: '#6b7280', fontWeight: 600 }}>
              è®¢å•å·
            </span>
            <span style={{ fontSize: '18px', fontWeight: 700 }}>
              {data?.orderNo}
            </span>
          </div>
          {/* ...æ›´å¤šé‡å¤æ ·å¼ */}
        </div>
      </div>
    </Modal>
  );
};
```

**useModal + ModalContentLayout æ–¹å¼ï¼ˆ70è¡Œï¼Œå‡å°‘72%ï¼‰**ï¼š
```typescript
import { useModal } from '@/hooks/useModal';
import { 
  ModalHeaderCard, 
  ModalPrimaryField, 
  ModalFieldRow, 
  ModalField,
  ModalFieldGrid
} from '@/components/common/ModalContentLayout';

const QualityInspectionModal = () => {
  // âœ… 1è¡ŒçŠ¶æ€ç®¡ç†
  const modal = useModal<QualityData>();
  const { isMobile } = useViewport();
  
  return (
    <Modal 
      visible={modal.visible} 
      onCancel={modal.close}
      title="è´¨æ£€å…¥åº“"
      width="60vw"
    >
      {modal.data && (
        <>
          {/* âœ… æ ‡å‡†å¤´éƒ¨ï¼ˆæ— éœ€è‡ªå®šä¹‰æ ·å¼ï¼‰ */}
          <ModalHeaderCard isMobile={isMobile}>
            <ModalPrimaryField 
              label="è®¢å•å·" 
              value={modal.data.orderNo}
            />
            <ModalFieldRow>
              <ModalField label="æ¬¾å·" value={modal.data.styleNo} />
              <ModalField label="æ•°é‡" value={`${modal.data.quantity}ä»¶`} />
            </ModalFieldRow>
          </ModalHeaderCard>
          
          {/* âœ… æ ‡å‡†ç½‘æ ¼å¸ƒå±€ï¼ˆæ— éœ€è‡ªå®šä¹‰æ ·å¼ï¼‰ */}
          <ModalFieldGrid columns={3}>
            <ModalField label="é¢œè‰²" value={modal.data.color} />
            <ModalField label="å°ºç " value={modal.data.size} />
            <ModalField 
              label="è´¨æ£€ç»“æœ" 
              value={modal.data.result}
              valueColor={modal.data.result === 'åˆæ ¼' ? '#059669' : '#dc2626'}
            />
          </ModalFieldGrid>
        </>
      )}
    </Modal>
  );
};
```

**ä»£ç å‡å°‘å¯¹æ¯”**ï¼š
- çŠ¶æ€ç®¡ç†ï¼š4ä¸ªå˜é‡ + 2ä¸ªå‡½æ•° â†’ 1è¡Œä»£ç ï¼ˆå‡å°‘85%ï¼‰
- å¸ƒå±€æ ·å¼ï¼š180è¡Œè‡ªå®šä¹‰CSS â†’ 9ä¸ªæ ‡å‡†ç»„ä»¶ï¼ˆå‡å°‘95%ï¼‰
- æ€»ä»£ç é‡ï¼š248è¡Œ â†’ 70è¡Œï¼ˆ**å‡å°‘72%**ï¼‰

---

#### æ¨èå®è·µï¼ˆBest Practicesï¼‰

**âœ… DOï¼ˆæ¨èåšæ³•ï¼‰**ï¼š

1. **æ°¸è¿œä½¿ç”¨ useModal ç®¡ç†çŠ¶æ€**
   ```typescript
   âœ… const modal = useModal<OrderData>();
   âŒ const [visible, setVisible] = useState(false);
   ```

2. **ä½¿ç”¨ ModalContentLayout å¸ƒå±€**
   ```typescript
   âœ… <ModalHeaderCard><ModalPrimaryField /></ModalHeaderCard>
   âŒ <div style={{ background: '#f8f9fa', padding: '12px' }}>
   ```

3. **ä¸»è¦ä¿¡æ¯ä½¿ç”¨ PrimaryFieldï¼ˆ18pxåŠ ç²—ï¼‰**
   ```typescript
   âœ… <ModalPrimaryField label="è®¢å•å·" value={orderNo} />
   âŒ <ModalField label="è®¢å•å·" value={orderNo} />
   ```

4. **å“åº”å¼è®¾è®¡ä½¿ç”¨ isMobile**
   ```typescript
   âœ… const { isMobile } = useViewport();
   âœ… <ModalHeaderCard isMobile={isMobile}>
   âŒ ç¡¬ç¼–ç ç§»åŠ¨ç«¯æ ·å¼
   ```

**âŒ DON'Tï¼ˆç¦æ­¢åšæ³•ï¼‰**ï¼š

1. **ä¸è¦æ‰‹åŠ¨ç®¡ç†4ä¸ªModalçŠ¶æ€**
   ```typescript
   âŒ const [visible, setVisible] = useState(false);
   âŒ const [data, setData] = useState(null);
   âŒ const handleOpen = ...
   âŒ const handleClose = ...
   ```

2. **ä¸è¦è‡ªå®šä¹‰Modalå¸ƒå±€æ ·å¼**
   ```typescript
   âŒ <div style={{ padding: '16px', background: '#f8f9fa' }}>
   âœ… <ModalHeaderCard>  // ä½¿ç”¨æ ‡å‡†ç»„ä»¶
   ```

3. **ä¸è¦ç¡¬ç¼–ç å­—ä½“å¤§å°å’Œé¢œè‰²**
   ```typescript
   âŒ <span style={{ fontSize: '18px', color: '#6b7280' }}>
   âœ… <ModalPrimaryField />  // è‡ªåŠ¨åº”ç”¨è®¾è®¡è§„èŒƒ
   ```

4. **ä¸è¦å¿½ç•¥ç§»åŠ¨ç«¯é€‚é…**
   ```typescript
   âŒ åªæµ‹è¯•PCç«¯
   âœ… ä½¿ç”¨ isMobile prop ç¡®ä¿å“åº”å¼
   ```

---

#### è¿ç§»å»ºè®®ï¼ˆMigration Prioritiesï¼‰

**P0ä¼˜å…ˆçº§ï¼ˆæœ¬å‘¨å®Œæˆï¼‰**ï¼š
- âœ… `modules/production/pages/Production/OrderFlow/index.tsx` - ç”Ÿäº§è®¢å•æµç¨‹ï¼ˆå¤æ‚Modalï¼Œé¢„è®¡å‡å°‘75%ä»£ç ï¼‰
- âœ… `modules/production/pages/Production/QualityInspection/index.tsx` - è´¨æ£€å…¥åº“ï¼ˆå¤šå­—æ®µModalï¼Œé¢„è®¡å‡å°‘72%ä»£ç ï¼‰
- âœ… `modules/production/pages/Production/Warehousing/index.tsx` - å…¥åº“ç®¡ç†ï¼ˆæ•°æ®å¯†é›†Modalï¼Œé¢„è®¡å‡å°‘68%ä»£ç ï¼‰

**P1ä¼˜å…ˆçº§ï¼ˆä¸‹å‘¨å®Œæˆï¼‰**ï¼š
- â³ `modules/basic/pages/StyleInfo/index.tsx` - æ¬¾å¼èµ„æ–™ï¼ˆå¤šTab Modalï¼‰
- â³ `modules/system/pages/System/UserApproval/index.tsx` - ç”¨æˆ·å®¡æ‰¹ï¼ˆè¡¨å•Modalï¼‰
- â³ `modules/finance/pages/FinishedSettlement/index.tsx` - æˆå“ç»“ç®—ï¼ˆå¤æ‚è®¡ç®—Modalï¼‰

**é¢„æœŸæ”¶ç›Š**ï¼š
- âœ… **ä»£ç é‡å‡å°‘**ï¼š50-75%ï¼ˆå¹³å‡248è¡Œ â†’ 70è¡Œï¼‰
- âœ… **ç»´æŠ¤æˆæœ¬é™ä½**ï¼š80%ï¼ˆç»Ÿä¸€ç»„ä»¶ï¼Œä¸€å¤„ä¿®æ”¹å…¨å±€ç”Ÿæ•ˆï¼‰
- âœ… **è§†è§‰ä¸€è‡´æ€§**ï¼š100%ï¼ˆè‡ªåŠ¨åº”ç”¨è®¾è®¡ç³»ç»Ÿè§„èŒƒï¼‰
- âœ… **ç±»å‹å®‰å…¨**ï¼š100%ï¼ˆTypeScriptç¼–è¯‘æ—¶æ£€æŸ¥ï¼‰
- âœ… **å“åº”å¼**ï¼š100%ï¼ˆisMobileè‡ªåŠ¨é€‚é…ï¼‰

---

#### ç›¸å…³èµ„æºï¼ˆDocumentationï¼‰

**è¯¦ç»†ä½¿ç”¨æŒ‡å—**ï¼š
- ğŸ“˜ **[useModalä½¿ç”¨æŒ‡å—.md](docs/useModalä½¿ç”¨æŒ‡å—.md)** - å®Œæ•´APIæ–‡æ¡£ã€6ä¸ªç¤ºä¾‹ã€FAQ
- ğŸ“˜ **[ModalContentLayoutä½¿ç”¨æŒ‡å—.md](docs/ModalContentLayoutä½¿ç”¨æŒ‡å—.md)** - 9ä¸ªç»„ä»¶è§„èŒƒã€3ä¸ªå®Œæ•´ç¤ºä¾‹ã€è¿ç§»æŒ‡å—

**è®¾è®¡è§„èŒƒ**ï¼š
- ğŸ“ **[è®¾è®¡ç³»ç»Ÿå®Œæ•´è§„èŒƒ-2026.md](è®¾è®¡ç³»ç»Ÿå®Œæ•´è§„èŒƒ-2026.md)** - å­—ä½“ã€é¢œè‰²ã€é—´è·ã€ç»„ä»¶è§„èŒƒ

**ç¤ºä¾‹ä»£ç **ï¼š
- ğŸ’» **modules/production/pages/Production/ProgressDetail/index.tsx** - useModalå®é™…åº”ç”¨
- ğŸ’» **modules/basic/pages/StyleInfo/Detail/index.tsx** - ModalContentLayoutå®é™…åº”ç”¨

---

### 6.3 å°ç¨‹åºå¼€å‘è§„èŒƒ

#### Page èŒè´£åˆ’åˆ†

âœ… **Page åº”è¯¥åš**ï¼š

- UI æ¸²æŸ“å’Œæ•°æ®ç»‘å®š
- äº‹ä»¶å¤„ç†ï¼ˆè°ƒç”¨ Handler/Utilsï¼‰
- ç”Ÿå‘½å‘¨æœŸç®¡ç†
- é¡µé¢çŠ¶æ€ç®¡ç†ï¼ˆdataï¼‰

âŒ **Page ä¸åº”è¯¥åš**ï¼š

- å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼ˆåº”åœ¨ Handlerï¼‰
- æ•°æ®è§£æ/è½¬æ¢ï¼ˆåº”åœ¨ Service/Utilsï¼‰
- é‡å¤çš„å·¥å…·å‡½æ•°ï¼ˆåº”åœ¨ Utilsï¼‰

#### ä»£ç ç¤ºä¾‹

**âŒ é”™è¯¯ï¼šä¸šåŠ¡é€»è¾‘åœ¨ Page ä¸­**

```javascript
Page({
    async handleScan(scanCode) {
        // âŒ 200è¡Œä¸šåŠ¡é€»è¾‘ç›´æ¥å†™åœ¨ Page é‡Œ
        const match = scanCode.match(/^([A-Z0-9]+)-(.+)-(\d+)$/);
        // ... æ›´å¤šè§£æé€»è¾‘
        const result = await api.production.executeScan(...);
        // ... æ›´å¤šå¤„ç†é€»è¾‘
    }
});
```

**âœ… æ­£ç¡®ï¼šä¸šåŠ¡é€»è¾‘åœ¨ Handler ä¸­**

```javascript
Page({
  onLoad() {
    this.scanHandler = new ScanHandler(this);
  },

  async handleScan(scanCode) {
    // âœ… ç®€æ´è°ƒç”¨ Handler
    await this.scanHandler.handleScan(scanCode);
  },
});
```

### 6.4 å¤šé¡µé¢åŒæ­¥æœ€ä½³å®è·µ

#### ä½¿ç”¨ EventBus å®ç°å®æ—¶åŒæ­¥

**è§¦å‘äº‹ä»¶**ï¼š

```javascript
// åœ¨æ“ä½œå®Œæˆåè§¦å‘
import { triggerDataRefresh } from '../../utils/eventBus';

async function onScanSuccess() {
    // 1. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    await api.production.executeScan(...);

    // 2. åˆ·æ–°æœ¬é¡µæ•°æ®
    await this.loadData();

    // 3. è§¦å‘å…¨å±€åˆ·æ–°
    triggerDataRefresh('scans', {
        action: 'scan',
        orderId: this.data.orderId
    });
}
```

**ç›‘å¬äº‹ä»¶**ï¼š

```javascript
// åœ¨ onShow ä¸­è®¾ç½®ç›‘å¬
import { onDataRefresh } from "../../utils/eventBus";

Page({
  onShow() {
    // ç›‘å¬æ•°æ®å˜åŒ–
    this._unsubscribe = onDataRefresh((event) => {
      if (event.type === "scans" || event.type === "orders") {
        this.loadData(); // åˆ·æ–°æ•°æ®
      }
    });
  },

  onHide() {
    // å–æ¶ˆç›‘å¬
    if (this._unsubscribe) {
      this._unsubscribe();
    }
  },
});
```

### 6.5 æ•°æ®è¿‡æ»¤è§„èŒƒ

#### å¿…é¡»è¿‡æ»¤çš„åœºæ™¯

**1. æ’é™¤é‡‡è´­è®°å½•**ï¼ˆé‡‡è´­æŒ‰åˆ°è´§ä»˜æ¬¾ï¼Œä¸æŒ‰æ‰«ç è®¡æ•°ï¼‰

```javascript
// æŸ¥è¯¢æ‰«ç è®°å½•æ—¶
const records = await api.production.getScanRecords({
  orderId: this.data.orderId,
  scanType: { $ne: "procurement" }, // æ’é™¤é‡‡è´­
});
```

**2. æ’é™¤å¤±è´¥è®°å½•**ï¼ˆå›æ»šåçš„è®°å½•æ ‡è®°ä¸º failureï¼‰

```javascript
const records = await api.production.getScanRecords({
  orderId: this.data.orderId,
  scanResult: { $ne: "failure" }, // æ’é™¤å¤±è´¥
});
```

**3. ç»„åˆè¿‡æ»¤**ï¼ˆæœ€å¸¸ç”¨ï¼‰

```javascript
const records = await api.production.getScanRecords({
  orderId: this.data.orderId,
  scanType: { $ne: "procurement" },
  scanResult: { $ne: "failure" },
});
```

---

## ä¸ƒã€å¿«é€Ÿå¼€å§‹

### 7.1 ç¯å¢ƒå¯åŠ¨

#### ä¸€é”®å¯åŠ¨åç«¯ï¼ˆæ¨èï¼‰

```bash
# ä½¿ç”¨ä¸€é”®å¯åŠ¨è„šæœ¬
./start-backend.sh

# åŠŸèƒ½ï¼š
# âœ… è‡ªåŠ¨æ£€æµ‹å·²è¿è¡Œçš„è¿›ç¨‹
# âœ… å¯é€‰æ‹©åœæ­¢æ—§è¿›ç¨‹å¹¶é‡å¯
# âœ… åå°å¯åŠ¨æœåŠ¡
# âœ… æ—¥å¿—è¾“å‡ºåˆ° backend/logs/backend.log
# âœ… å¯åŠ¨æˆåŠŸæç¤º
```

#### æ‰‹åŠ¨å¯åŠ¨ï¼ˆå¤‡é€‰ï¼‰

```bash
# 1. å¯åŠ¨ MySQLï¼ˆDockerï¼‰
docker start fashion-mysql-simple

# 2. å¯åŠ¨åç«¯ï¼ˆç«¯å£ 8088ï¼‰
cd backend && mvn spring-boot:run &

# 3. å¯åŠ¨å‰ç«¯ï¼ˆç«¯å£ 5173ï¼‰
cd frontend && npm run dev

# 4. å¾®ä¿¡å°ç¨‹åº
# ä½¿ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·æ‰“å¼€ miniprogram/ ç›®å½•
```

#### å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹åç«¯æ—¥å¿—
tail -f backend/logs/backend.log
tail -f backend/nohup.out

# åœæ­¢åç«¯æœåŠ¡
pkill -f "spring-boot:run"

# æ£€æŸ¥åç«¯è¿›ç¨‹
ps aux | grep "spring-boot:run" | grep -v grep

# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :8088   # åç«¯
lsof -i :5173   # å‰ç«¯
```

### 7.2 å‰ç«¯ API ä»£ç†é…ç½®

#### Vite ä»£ç†é…ç½®ï¼ˆå·²é…ç½®ï¼‰

**ä½ç½®**ï¼š`frontend/vite.config.ts`

```typescript
server: {
  host: true,
  port: 5173,
  allowedHosts: true,
  proxy: {
    '/api': {
      target: 'http://127.0.0.1:8088',  // åç«¯åœ°å€
      changeOrigin: true
    }
  }
}
```

#### âš ï¸ é‡è¦ï¼šè®¿é—®åœ°å€

- âœ… **æ­£ç¡®**ï¼š`http://localhost:5173`
- âŒ **é”™è¯¯**ï¼š`http://192.168.x.x:5173`ï¼ˆå†…ç½‘IPä¼šç»•è¿‡ä»£ç†ï¼‰

**åŸå› **ï¼šä½¿ç”¨å†…ç½‘IPè®¿é—®æ—¶ï¼ŒViteçš„proxyé…ç½®ä¸ä¼šç”Ÿæ•ˆï¼Œå¯¼è‡´ API è¯·æ±‚ 404ã€‚

#### API è°ƒç”¨æµç¨‹

```
æµè§ˆå™¨è¯·æ±‚ http://localhost:5173/api/production/order/list
           â†“
    Vite Proxy æ‹¦æˆª /api è¯·æ±‚
           â†“
    è½¬å‘åˆ° http://127.0.0.1:8088/api/production/order/list
           â†“
    åç«¯ Spring Boot å¤„ç†
```

### 7.3 å‰ç«¯ API ä»£ç†é…ç½®

#### Vite ä»£ç†é…ç½®ï¼ˆå·²é…ç½®ï¼‰

**ä½ç½®**ï¼š`frontend/vite.config.ts`

```typescript
server: {
  host: true,
  port: 5173,
  allowedHosts: true,
  proxy: {
    '/api': {
      target: 'http://127.0.0.1:8088',  // åç«¯åœ°å€
      changeOrigin: true
    }
  }
}
```

#### âš ï¸ é‡è¦ï¼šè®¿é—®åœ°å€

- âœ… **æ­£ç¡®**ï¼š`http://localhost:5173`
- âŒ **é”™è¯¯**ï¼š`http://192.168.x.x:5173`ï¼ˆå†…ç½‘IPä¼šç»•è¿‡ä»£ç†ï¼‰

**åŸå› **ï¼šä½¿ç”¨å†…ç½‘IPè®¿é—®æ—¶ï¼ŒViteçš„proxyé…ç½®ä¸ä¼šç”Ÿæ•ˆï¼Œå¯¼è‡´ API è¯·æ±‚ 404ã€‚

#### API è°ƒç”¨æµç¨‹

```
æµè§ˆå™¨è¯·æ±‚ http://localhost:5173/api/production/order/list
           â†“
    Vite Proxy æ‹¦æˆª /api è¯·æ±‚
           â†“
    è½¬å‘åˆ° http://127.0.0.1:8088/api/production/order/list
           â†“
    åç«¯ Spring Boot å¤„ç†
```

### 7.4 åç«¯å¼€å‘æµç¨‹

#### 1. åˆ›å»ºæ–°çš„ä¸šåŠ¡æ¨¡å—

```bash
# ç›®å½•ç»“æ„
backend/src/main/java/com/fashion/supplychain/newmodule/
â”œâ”€â”€ entity/
â”‚   â””â”€â”€ NewEntity.java
â”œâ”€â”€ mapper/
â”‚   â””â”€â”€ NewMapper.java
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ NewService.java
â”‚   â””â”€â”€ impl/
â”‚       â””â”€â”€ NewServiceImpl.java
â”œâ”€â”€ orchestration/          # å¦‚éœ€å¤æ‚ä¸šåŠ¡
â”‚   â””â”€â”€ NewOrchestrator.java
â””â”€â”€ controller/
    â””â”€â”€ NewController.java
```

#### 2. åˆ¤æ–­æ˜¯å¦éœ€è¦ Orchestrator

- âœ… è·¨å¤šä¸ª Service â†’ éœ€è¦
- âœ… éœ€è¦äº‹åŠ¡ç®¡ç† â†’ éœ€è¦
- âœ… å¤æ‚ä¸šåŠ¡æµç¨‹ â†’ éœ€è¦
- âŒ å•è¡¨ CRUD â†’ ä¸éœ€è¦

#### 3. ç¼–å†™ä»£ç é¡ºåº

```
Entity â†’ Mapper â†’ Service â†’ Orchestratorï¼ˆå¯é€‰ï¼‰â†’ Controller
```

### 7.5 å°ç¨‹åºå¼€å‘æµç¨‹

#### 1. åˆ›å»ºæ–°é¡µé¢

```bash
# åˆ›å»ºç›®å½•
miniprogram/pages/newpage/
â”œâ”€â”€ index.js
â”œâ”€â”€ index.wxml
â”œâ”€â”€ index.wxss
â””â”€â”€ index.json
```

#### 2. åˆ¤æ–­æ˜¯å¦éœ€è¦ Handler

- âœ… é¡µé¢é€»è¾‘ > 500è¡Œ â†’ éœ€è¦é‡æ„
- âœ… æœ‰å¤æ‚ä¸šåŠ¡æµç¨‹ â†’ è€ƒè™‘ Handler
- âœ… é€»è¾‘å¯å¤ç”¨ â†’ æå– Service
- âŒ ç®€å•é¡µé¢ â†’ ä¸éœ€è¦

#### 3. ä½¿ç”¨ Utils

```javascript
// å¯¼å…¥éœ€è¦çš„å·¥å…·
import api from "../../utils/api";
import { triggerDataRefresh, onDataRefresh } from "../../utils/eventBus";
import { validateProductionOrder } from "../../utils/dataValidator";
import { orderStatusText } from "../../utils/orderStatusHelper";
```

### 7.6 å¸¸è§å¼€å‘åœºæ™¯

#### åœºæ™¯1ï¼šæ–°å¢è®¢å•çŠ¶æ€

**åç«¯**ï¼š

```java
// 1. åœ¨ Entity ä¸­æ·»åŠ æ–°çŠ¶æ€
public class ProductionOrder {
    private String status;  // æ–°å¢ "CANCELLED"
}

// 2. åœ¨ Orchestrator ä¸­æ·»åŠ çŠ¶æ€å˜æ›´é€»è¾‘
@Service
public class ProductionOrderOrchestrator {
    @Transactional
    public void cancelOrder(Long orderId, String reason) {
        // 1. æ›´æ–°è®¢å•çŠ¶æ€
        orderService.updateStatus(orderId, "CANCELLED");

        // 2. æ›´æ–°è´¢åŠ¡ï¼ˆè·¨æœåŠ¡ï¼‰
        financeService.cancelOrderCost(orderId);

        // 3. é€šçŸ¥ç›¸å…³äººå‘˜ï¼ˆè·¨æœåŠ¡ï¼‰
        notificationService.notifyOrderCancelled(orderId);
    }
}
```

**å°ç¨‹åº**ï¼š

```javascript
// 1. åœ¨ orderStatusHelper.js æ·»åŠ çŠ¶æ€æ˜ å°„
function orderStatusText(status) {
  const map = {
    // ... å…¶ä»–çŠ¶æ€
    cancelled: "å·²å–æ¶ˆ", // æ–°å¢
  };
  return map[status] || "æœªçŸ¥";
}

// 2. åœ¨é¡µé¢ä¸­ä½¿ç”¨
this.setData({
  statusText: orderStatusText(order.status),
});
```

#### åœºæ™¯2ï¼šæ–°å¢æ‰«ç ç±»å‹

**åç«¯**ï¼š

```java
// åœ¨ ScanOrchestrator ä¸­æ·»åŠ å¤„ç†é€»è¾‘
@Service
public class ProductionOrderScanOrchestrator {
    public void executeScan(ScanDTO dto) {
        if ("NEW_TYPE".equals(dto.getScanType())) {
            // æ–°ç±»å‹çš„å¤„ç†é€»è¾‘
            handleNewTypeScan(dto);
        }
    }
}
```

**å°ç¨‹åº**ï¼š

```javascript
// 1. åœ¨ QRCodeParser ä¸­æ·»åŠ è§£æ
class QRCodeParser {
  parse(scanCode) {
    // å°è¯•è§£ææ–°ç±»å‹
    const newTypeResult = this.parseNewType(scanCode);
    if (newTypeResult) return newTypeResult;

    // ... å…¶ä»–è§£æ
  }
}

// 2. åœ¨ ScanHandler ä¸­æ·»åŠ å¤„ç†
class ScanHandler {
  async handleScan(scanCode) {
    const parsed = this.parser.parse(scanCode);

    if (parsed.type === "newType") {
      return await this.handleNewTypeScan(parsed);
    }
  }
}
```

---

## ä¸ƒã€æ•…éšœæ’æŸ¥æŒ‡å—

### 7.1 åç«¯å¸¸è§é—®é¢˜

#### é—®é¢˜0ï¼šAPI è¯·æ±‚ 404 é”™è¯¯

**ç—‡çŠ¶**ï¼šå‰ç«¯è¯·æ±‚åç«¯APIè¿”å›404ï¼Œæ§åˆ¶å°æ˜¾ç¤º `http://192.168.x.x:5173/api/...`  
**åŸå› **ï¼šä½¿ç”¨å†…ç½‘IPè®¿é—®å‰ç«¯ï¼Œç»•è¿‡äº†Viteçš„ä»£ç†é…ç½®

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# âŒ é”™è¯¯ï¼šä½¿ç”¨å†…ç½‘IP
http://192.168.2.248:5173

# âœ… æ­£ç¡®ï¼šä½¿ç”¨ localhost
http://localhost:5173
```

**éªŒè¯ä»£ç†é…ç½®**ï¼š

```typescript
// frontend/vite.config.ts
server: {
  proxy: {
    '/api': {
      target: 'http://127.0.0.1:8088',  // ç¡®ä¿æŒ‡å‘æ­£ç¡®çš„åç«¯ç«¯å£
      changeOrigin: true
    }
  }
}
```

#### é—®é¢˜1ï¼šäº‹åŠ¡ä¸ç”Ÿæ•ˆ

**ç—‡çŠ¶**ï¼šæ•°æ®éƒ¨åˆ†ä¿å­˜ï¼Œéƒ¨åˆ†å›æ»š  
**åŸå› **ï¼š`@Transactional` å¤±æ•ˆ

**æ’æŸ¥æ­¥éª¤**ï¼š

1. æ£€æŸ¥æ–¹æ³•æ˜¯å¦ `public`
2. æ£€æŸ¥æ˜¯å¦åœ¨åŒä¸€ä¸ªç±»å†…éƒ¨è°ƒç”¨ï¼ˆSpring AOP é™åˆ¶ï¼‰
3. æ£€æŸ¥å¼‚å¸¸ç±»å‹æ˜¯å¦åœ¨ `rollbackFor` èŒƒå›´å†…

**è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// âŒ é”™è¯¯ï¼šåŒç±»è°ƒç”¨äº‹åŠ¡å¤±æ•ˆ
@Service
public class OrderService {
    public void create() {
        this.createWithTransaction();  // äº‹åŠ¡å¤±æ•ˆ
    }

    @Transactional
    private void createWithTransaction() { }
}

// âœ… æ­£ç¡®ï¼šé€šè¿‡ Orchestrator è°ƒç”¨
@Service
public class OrderOrchestrator {
    @Autowired
    private OrderService orderService;

    @Transactional
    public void create() {
        orderService.createOrder();  // äº‹åŠ¡ç”Ÿæ•ˆ
    }
}
```

#### é—®é¢˜2ï¼šå¾ªç¯ä¾èµ–

**ç—‡çŠ¶**ï¼šå¯åŠ¨æŠ¥é”™ `BeanCurrentlyInCreationException`  
**åŸå› **ï¼šOrchestrator ä¹‹é—´äº’ç›¸æ³¨å…¥

**è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// âŒ é”™è¯¯ï¼šå¾ªç¯ä¾èµ–
@Service
public class OrderOrchestrator {
    @Autowired
    private FinanceOrchestrator financeOrchestrator;
}

@Service
public class FinanceOrchestrator {
    @Autowired
    private OrderOrchestrator orderOrchestrator;  // å¾ªç¯äº†
}

// âœ… æ­£ç¡®ï¼šé€šè¿‡ Service å±‚é€šä¿¡
@Service
public class OrderOrchestrator {
    @Autowired
    private FinanceService financeService;  // æ³¨å…¥ Service
}
```

### 7.2 å°ç¨‹åºå¸¸è§é—®é¢˜

#### é—®é¢˜1ï¼šå¤šé¡µé¢æ•°æ®ä¸åŒæ­¥

**ç—‡çŠ¶**ï¼šæ‰«ç åï¼Œå…¶ä»–é¡µé¢æ•°æ®æœªæ›´æ–°  
**åŸå› **ï¼šæœªä½¿ç”¨ EventBus è§¦å‘åˆ·æ–°

**è§£å†³æ–¹æ¡ˆ**ï¼š

```javascript
// âœ… åœ¨æ“ä½œåè§¦å‘äº‹ä»¶
import { triggerDataRefresh } from '../../utils/eventBus';

async function onScanSuccess() {
    await api.production.executeScan(...);

    // å¿…é¡»è§¦å‘å…¨å±€åˆ·æ–°
    triggerDataRefresh('scans', { action: 'scan' });
}

// âœ… åœ¨å…¶ä»–é¡µé¢ç›‘å¬
import { onDataRefresh } from '../../utils/eventBus';

Page({
    onShow() {
        this._unsubscribe = onDataRefresh(() => {
            this.loadData();  // åˆ·æ–°
        });
    },

    onHide() {
        this._unsubscribe?.();  // å¿…é¡»å–æ¶ˆç›‘å¬
    }
});
```

#### é—®é¢˜2ï¼šæ•°æ®æ˜¾ç¤ºä¸ä¸€è‡´

**ç—‡çŠ¶**ï¼šadmin é¡µé¢æ˜¾ç¤º"è£å‰ª"ï¼Œscan é¡µé¢æ˜¾ç¤º"è½¦ç¼"  
**åŸå› **ï¼šæœªè¿‡æ»¤ `scanType='procurement'` æˆ– `scanResult='failure'`

**è§£å†³æ–¹æ¡ˆ**ï¼š

```javascript
// âœ… å¿…é¡»åŒæ—¶è¿‡æ»¤
const records = await api.production.getScanRecords({
  orderId: this.data.orderId,
  scanType: { $ne: "procurement" }, // æ’é™¤é‡‡è´­
  scanResult: { $ne: "failure" }, // æ’é™¤å¤±è´¥
});
```

---

## å…«ã€ç›¸å…³æ–‡æ¡£ç´¢å¼•

### æ¶æ„è®¾è®¡

- [ORCHESTRATOR_PATTERN_GUIDE.md](ORCHESTRATOR_PATTERN_GUIDE.md) - åç«¯ç¼–æ’å™¨è¯¦è§£
- [MINIPROGRAM_ARCHITECTURE_GUIDE.md](MINIPROGRAM_ARCHITECTURE_GUIDE.md) - å°ç¨‹åºæ¶æ„
- [MINIPROGRAM_REFACTORING_PROPOSAL.md](MINIPROGRAM_REFACTORING_PROPOSAL.md) - é‡æ„æ–¹æ¡ˆ

### ä¸šåŠ¡æµç¨‹

- [WORKFLOW_EXPLANATION.md](WORKFLOW_EXPLANATION.md) - ä¸šåŠ¡æµç¨‹è¯´æ˜
- [SCAN_SYSTEM_LOGIC.md](SCAN_SYSTEM_LOGIC.md) - æ‰«ç ç³»ç»Ÿé€»è¾‘
- [DATA_PERMISSION_DESIGN.md](DATA_PERMISSION_DESIGN.md) - æ•°æ®æƒé™è®¾è®¡

### æŠ€æœ¯å®ç°

- [CODE_CLEANUP_REPORT.md](CODE_CLEANUP_REPORT.md) - ä»£ç æ¸…ç†æŠ¥å‘Š
- [MULTI_PAGE_SYNC_GUIDE.md](MULTI_PAGE_SYNC_GUIDE.md) - å¤šé¡µé¢åŒæ­¥
- [DATA_SYNC_ANALYSIS.md](DATA_SYNC_ANALYSIS.md) - æ•°æ®åŒæ­¥åˆ†æ

### æµ‹è¯•éƒ¨ç½²

- [QUICK_TEST_GUIDE.md](QUICK_TEST_GUIDE.md) - å¿«é€Ÿæµ‹è¯•æŒ‡å—
- [DEPLOYMENT_CHECKLIST.md](DEPLOYMENT_CHECKLIST.md) - éƒ¨ç½²æ£€æŸ¥æ¸…å•
- [deployment/DATABASE_CONFIG.md](deployment/DATABASE_CONFIG.md) - æ•°æ®åº“é…ç½®

### ç³»ç»Ÿæ–‡æ¡£

- [SYSTEM_STATUS.md](SYSTEM_STATUS.md) - ç³»ç»ŸçŠ¶æ€æ€»è§ˆ
- [PROJECT_DOCUMENTATION.md](PROJECT_DOCUMENTATION.md) - é¡¹ç›®å®Œæ•´æ–‡æ¡£
- [xindiedai.md](xindiedai.md) - æ¶æ„è¯„ä¼°æŠ¥å‘Šï¼ˆ96åˆ†ï¼‰

---

## ä¹ã€ç»´æŠ¤ä¸æ›´æ–°

### 9.1 æ–‡æ¡£æ›´æ–°è§„åˆ™

**ä½•æ—¶æ›´æ–°æ­¤æ–‡æ¡£ï¼Ÿ**

1. âœ… æ–°å¢ Orchestrator æ—¶
2. âœ… ä¿®æ”¹æ¶æ„æ¨¡å¼æ—¶
3. âœ… æ–°å¢å¼€å‘è§„èŒƒæ—¶
4. âœ… å‘ç°é‡è¦é—®é¢˜åŠè§£å†³æ–¹æ¡ˆæ—¶

**æ›´æ–°æµç¨‹**ï¼š

```bash
# 1. ä¿®æ”¹æ–‡æ¡£
vim DEVELOPMENT_GUIDE.md

# 2. æäº¤æ›´æ–°
git add DEVELOPMENT_GUIDE.md
git commit -m "docs: æ›´æ–°å¼€å‘æŒ‡å— - [æ›´æ–°å†…å®¹]"
git push
```

### æ¶æ„æ¼”è¿›å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ       | å˜æ›´å†…å®¹                                                                                   |
| ---- | ---------- | ------------------------------------------------------------------------------------------ |
| 1.0  | 2026-01-20 | åˆå§‹ç‰ˆæœ¬ï¼Œ26ä¸ª Orchestrator                                                                |
| 1.5  | 2026-01-22 | æ–°å¢å¤šé¡µé¢åŒæ­¥æœºåˆ¶ï¼ˆEventBusï¼‰                                                             |
| 2.0  | 2026-01-23 | æ•´åˆæ¶æ„æ–‡æ¡£ã€æ–°å¢é‡æ„æ–¹æ¡ˆã€æ–°å¢UIè®¾è®¡è§„èŒƒ                                                 |
| 2.1  | 2026-01-25 | æ–°å¢é€šç”¨æ’åºç»„ä»¶ï¼ˆSortableColumnTitleï¼‰ï¼Œæ”¯æŒå…¨ç«™æ—¶é—´åˆ—æ’åºï¼›æ–°å¢ä¸€é”®å¯åŠ¨è„šæœ¬å’ŒAPIä»£ç†è¯´æ˜ |
| 2.2  | 2026-01-26 | ç»Ÿä¸€å‰ç«¯ä¸å°ç¨‹åºçŠ¶æ€é¢œè‰²ä¸ºè®¾è®¡ç³»ç»Ÿæ ‡è®°ï¼Œä¿®å¤è‹¥å¹²å‰ç«¯ lint é˜»å¡é¡¹                           |

---

**æ–‡æ¡£ç»´æŠ¤**: GitHub Copilot  
**æœ€åæ›´æ–°**: 2026-01-26  
**ç‰ˆæœ¬**: 2.2

**ç‰ˆæœ¬æ›´æ–°è®°å½•**ï¼š

- 2.2 (2026-01-26):
  - ç»Ÿä¸€å‰ç«¯çŠ¶æ€æ ‡ç­¾é¢œè‰²ä¸ºè®¾è®¡ç³»ç»Ÿæ ‡è®°ï¼ˆdefault/success/warning/errorï¼‰
  - ç»Ÿä¸€å°ç¨‹åºçŠ¶æ€é¢œè‰²æ˜ å°„ä¸º design-tokens å˜é‡
  - ä¿®å¤å½±å“ lint çš„æœªä½¿ç”¨å˜é‡ä¸ç±»å‹å‘½åå†²çª

- 2.1 (2026-01-25):
  - æ–°å¢å‰ç«¯é€šç”¨æ’åºç»„ä»¶ `SortableColumnTitle`ï¼Œæ”¯æŒå…¨ç«™æ—¶é—´åˆ—æ’åº
  - æ–°å¢åç«¯ä¸€é”®å¯åŠ¨è„šæœ¬ `start-backend.sh`
  - æ–°å¢å‰ç«¯ API ä»£ç†é…ç½®è¯´æ˜å’Œå¸¸è§é—®é¢˜æ’æŸ¥
- 2.0 (2026-01-23): æ•´åˆæ¶æ„æ–‡æ¡£ã€æ–°å¢é‡æ„æ–¹æ¡ˆã€æ–°å¢UIè®¾è®¡è§„èŒƒ
- 1.5 (2026-01-22): æ–°å¢å¤šé¡µé¢åŒæ­¥æœºåˆ¶ï¼ˆEventBusï¼‰
- 1.0 (2026-01-20): åˆå§‹ç‰ˆæœ¬ï¼Œ26ä¸ª Orchestrator
