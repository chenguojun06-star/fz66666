# 财务权限配置指南

## 📋 快速配置步骤

### 方式1️⃣: 前端界面配置（推荐）

```
1. 登录系统 → 【系统设置】→【角色管理】
2. 选择要配置的角色（如"车间主任"）
3. 点击【授权】按钮
4. 在弹出的权限配置窗口中：
   - 找到【财务管理】模块
   - 勾选需要的财务权限：
     🔴 查看总单价和总金额（管理员级别）
     🟡 只能查看车缝单价（生产主管级别）
     🟢 只能查看基础数据（无单价）（普通员工级别）
5. 点击【保存】→ 输入操作原因 → 完成
```

**界面示意图**：
```
┌─────────────────────────────────────────────┐
│ 为「车间主任」授权                     [ × ] │
├─────────────────────────────────────────────┤
│ 🔍 搜索权限: [          ]  [清空]          │
│ [全选] [清空] [系统管理员] [生产人员]...   │
│                                             │
│ ┌────────┐  ┌────────┐  ┌──────────┐      │
│ │生产管理│  │基础资料│  │📊财务管理 │ ←点这 │
│ └────────┘  └────────┘  └──────────┘      │
│                          ☑ 财务管理         │
│                          ☐ 物料对账         │
│                          ☐ 成品结算         │
│                          ☑ 查看总单价... ←管理层
│                          ☑ 只能查看车缝... ←主管 │
│                          ☐ 只能查看基础... ←员工 │
│                                             │
└─────────────────────────────────────────────┘
```

### 方式2️⃣: SQL脚本配置（初始化）

**执行脚本**：
```bash
# 添加三级权限到数据库（仅首次部署时执行）
docker exec -i fashion-mysql-simple mysql -uroot -pchangeme \
  fashion_supplychain --default-character-set=utf8mb4 \
  < scripts/add_three_level_price_permissions.sql

# 验证权限是否添加成功
# ❓ --default-character-set=utf8mb4 确保中文正常显示，不加可能乱码
docker exec fashion-mysql-simple mysql -uroot -pchangeme \
  fashion_supplychain --default-character-set=utf8mb4 \
  -e "SELECT permission_code, permission_name FROM t_permission 
      WHERE permission_code LIKE 'FINANCE_%';"
```

## 🎯 权限分级说明

### 三级权限对照表

| 权限级别 | 权限码 | 适用角色 | 可见内容 |
|---------|--------|---------|---------|
| **🔴 最高权限** | `FINANCE_TOTAL_AMOUNT_VIEW` | • admin（管理员）<br>• finance_supervisor（财务主管）<br>• purchaser（采购主管） | ✅ 订单总价<br>✅ 订单总金额<br>✅ 所有工序单价<br>✅ 所有员工工资 |
| **🟡 中级权限** | `FINANCE_SEWING_PRICE_ONLY` | • workshop_director（车间主任）<br>• cutter（裁剪员）<br>• sewing（车缝员）<br>• quality（质检员） | ✅ 车缝单价<br>✅ 车缝金额<br>❌ 其他工序单价（显示 `***`）<br>❌ 订单总价/总金额（显示 `***`） |
| **🟢 基础权限** | `FINANCE_BASIC_DATA_ONLY` | • packager（包装员）<br>• warehouse（仓管员） | ✅ 订单号<br>✅ 数量<br>✅ 进度<br>❌ 所有单价和金额（显示 `***`） |

### 权限判断流程

```
用户访问页面（订单管理/工资汇总等）
         ↓
检查用户权限列表 (userPermissions)
         ↓
┌────────┴────────┐
│  权限判断逻辑    │
└────────┬────────┘
         │
    ┌────┴─────────────────────────────┐
    ↓                                  ↓
有 FINANCE_TOTAL_AMOUNT_VIEW?    有 FINANCE_SEWING_PRICE_ONLY?
    │                                  │
   YES                                YES
    ↓                                  ↓
显示所有数据                      只显示车缝单价
• 总单价 ✅                        • 车缝单价 ✅
• 总金额 ✅                        • 其他单价 ❌***
• 所有工序单价 ✅                  • 总价总额 ❌***
                                       │
                                      NO
                                       ↓
                                  显示基础数据
                                  • 订单号 ✅
                                  • 数量 ✅
                                  • 所有单价 ❌***
```

❓ **权限优先级说明**：
- 优先级从高到低：TOTAL_AMOUNT_VIEW > SEWING_PRICE_ONLY > BASIC_DATA_ONLY
- 如果用户同时拥有多个权限，系统会自动使用最高级别的权限
- 例如：车间主任同时有"查看车缝单价"和"查看总单价"，系统会显示所有数据

## 💻 技术实现

### 数据库结构

**权限表（t_permission）**：
```sql
id    permission_code              permission_name            parent_id  sort
8454  FINANCE_TOTAL_AMOUNT_VIEW    查看总单价和总金额          4         10
8455  FINANCE_SEWING_PRICE_ONLY    只能查看车缝单价           4         20
8456  FINANCE_BASIC_DATA_ONLY      只能查看基础数据(无单价)    4         30
```
- `parent_id = 4` 表示属于"财务管理"模块
- 会自动在权限管理界面的"财务管理"分组下显示
- ❓ **为什么ID是8454开头？** 系统预留了8000-9000作为财务相关权限的ID段，方便后续扩展
- ❓ **parent_id对应关系**：1=系统管理, 2=生产管理, 3=基础资料, 4=财务管理

**角色权限关联（t_role_permission）**：
```sql
role_id  permission_id  说明
1        8454          admin → 查看总单价
5        8455          cutter → 只看车缝单价
7        8456          packager → 只看基础数据
```

### 前端使用示例

**使用自定义Hook**：
```typescript
import { useFinancePermission } from '@/hooks/useFinancePermission';

const MyComponent: React.FC = () => {
  const {
    canViewTotalAmount,     // 🔴 能否查看总单价
    canViewSewingOnly,      // 🟡 能否查看车缝单价
    canViewBasicOnly,       // 🟢 只能查看基础数据
    canViewProcessPrice,    // 判断能否查看某工序单价
    formatPrice,            // 格式化单价（自动根据权限显示/隐藏）
    formatAmount,           // 格式化金额
  } = useFinancePermission();

  // 示例1: 条件渲染列
  const columns = [
    {
      title: '车缝单价',
      dataIndex: 'sewingPrice',
      render: (value) => formatPrice(value, '车缝'),
      // ❓ formatPrice会自动根据权限返回真实值或'***'
    },
    // 只有高权限才显示总金额列
    // ❓ 使用展开运算符...条件插入列，没权限时返回空数组，列完全不显示
    ...(canViewTotalAmount ? [{
      title: '订单总金额',
      dataIndex: 'totalAmount',
      render: (value) => formatAmount(value),
    }] : []),
  ];

  // 示例2: 直接判断
  return (
    <div>
      {canViewTotalAmount && <div>总金额: ¥{totalAmount}</div>}
      {canViewSewingOnly && <div>车缝单价: ¥{sewingPrice}</div>}
      {!canViewTotalAmount && !canViewSewingOnly && <div>单价: ***</div>}
    </div>
  );
};
```

## 🔧 常见问题

### Q1: 修改权限后何时生效？

❓ **为什么要重新登录？**
- 用户的权限信息存储在登录时生成的JWT Token中
- Token在有效期内（默认7天）不会自动更新
- 重新登录会生成新Token，包含最新的权限列表
**A**: 立即生效，但已登录的用户需要**重新登录**才能获取最新权限。

### Q2: 如何查看某角色的当前权限？
**A**: 
```bash
# 方法1: 前端界面查看
系统设置 → 角色管理 → 选择角色 → 点击【授权】→ 查看已勾选的权限

# 方法2: SQL查询
docker exec fashion-mysql-simple mysql -uroot -pchangeme \
  fashion_supplychain --default-character-set=utf8mb4 -e \
  "SELECT r.role_name, p.permission_name 
   FROM t_role r 
   JOIN t_role_permission rp ON r.id = rp.role_id 
   JOIN t_permission p ON rp.permission_id = p.id 
   WHERE r.role_code = 'cutter' 
   AND p.permission_code LIKE 'FINANCE_%';"
```

### Q3: 如何批量调整多个角色的权限？
**A**: 
1. **推荐方式**：在权限管理界面逐个角色配置（有操作日志记录）
2. **快速方式**：编辑SQL脚本修改角色列表后重新执行

### Q4: 如何临时给某用户提升权限？
**A**: 
```
系统设置 → 用户管理 → 选择用户 → 编辑 → 修改角色
（如从"车缝员"改为"车间主任"）
```

### Q5: 权限误配置如何回滚？
**A**: 
```sql
-- 删除某角色的某个权限
DELETE FROM t_role_permission 
WHERE role_id = (SELECT id FROM t_role WHERE role_code = 'cutter')
AND permission_id = (SELECT id FROM t_permission 
                     WHERE permission_code = 'FINANCE_TOTAL_AMOUNT_VIEW');
```

## 📊 权限配置最佳实践

### ✅ 推荐做法

1. **职责匹配原则**：
   - 管理层（admin, finance_supervisor）→ 🔴 最高权限
   - 生产主管（workshop_director, cutter, sewing, quality）→ 🟡 中级权限
   - 后勤人员（packager, warehouse）→ 🟢 基础权限

2. **最小权限原则**：
   - 默认给最低权限（BASIC_DATA_ONLY）
   - 根据工作需要逐步提升
   - 定期审查权限分配

3. **操作留痕**：
   - 每次权限变更填写原因
   - 定期查看操作日志：角色管理 → 操作日志

### ❌ 避免的做法

1. ❌ 给所有人最高权限（破坏数据安全）
2. ❌ 忽略权限配置，直接修改前端代码隐藏字段（不安全）
3. ❌ 频繁修改权限导致混乱
4. ❌ 不记录变更原因

## 🔗 相关文档

- [开发指南.md](../开发指南.md) - 完整权限系统技术说明
- [scripts/add_three_level_price_permissions.sql](../scripts/add_three_level_price_permissions.sql) - SQL配置脚本
- [frontend/src/hooks/useFinancePermission.ts](../frontend/src/hooks/useFinancePermission.ts) - 前端权限Hook

---

**文档维护**: GitHub Copilot  
**最后更新**: 2026-01-27  
**版本**: 1.0
