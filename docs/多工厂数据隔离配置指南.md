# å¤šå·¥å‚æ•°æ®éš”ç¦»é…ç½®æŒ‡å—

## ğŸ“‹ éœ€æ±‚è¯´æ˜

å¤šä¸ªå·¥å‚ä½¿ç”¨åŒä¸€å¥—ç³»ç»Ÿï¼Œå®ç°ï¼š
- âœ… **æ€»éƒ¨ç®¡ç†å‘˜**ï¼šæŸ¥çœ‹æ‰€æœ‰å·¥å‚æ•°æ®ï¼ˆæ±‡æ€»ï¼‰
- âœ… **å·¥å‚Aç®¡ç†å‘˜**ï¼šåªèƒ½æŸ¥çœ‹å·¥å‚Açš„æ•°æ®
- âœ… **å·¥å‚Bç®¡ç†å‘˜**ï¼šåªèƒ½æŸ¥çœ‹å·¥å‚Bçš„æ•°æ®
- âœ… **å·¥å‚ä¹‹é—´**ï¼šæ•°æ®å®Œå…¨éš”ç¦»ï¼Œäº’ä¸å¯è§

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ–¹æ¡ˆ

### æ–¹æ¡ˆï¼šåŸºäº `dataScope` + `factoryId` çš„æƒé™æ§åˆ¶

ç³»ç»Ÿå·²æœ‰ `t_role.data_scope` å­—æ®µï¼Œæ”¯æŒ4çº§æƒé™ï¼š

| æƒé™çº§åˆ« | è¯´æ˜ | é€‚ç”¨è§’è‰² | æ•°æ®èŒƒå›´ |
|---------|------|---------|---------|
| **ALL** | å…¨å±€æ•°æ® | æ€»éƒ¨ç®¡ç†å‘˜ã€è¶…çº§ç®¡ç†å‘˜ | æŸ¥çœ‹æ‰€æœ‰å·¥å‚ |
| **FACTORY_ONLY** | å·¥å‚æ•°æ® | å·¥å‚ç®¡ç†å‘˜ã€å·¥å‚ä¸»ç®¡ | åªçœ‹æœ¬å·¥å‚ |
| **TEAM** | å›¢é˜Ÿæ•°æ® | è½¦é—´ç»„é•¿ã€è´¨æ£€ä¸»ç®¡ | åªçœ‹æœ¬å›¢é˜Ÿ |
| **OWN** | ä¸ªäººæ•°æ® | æ™®é€šå‘˜å·¥ã€æ“ä½œå·¥ | åªçœ‹è‡ªå·± |

---

## ğŸ“ å®æ–½æ­¥éª¤

### ç¬¬1æ­¥ï¼šæ•°æ®åº“å‡çº§

æ‰§è¡Œ SQL è„šæœ¬æ·»åŠ å·¥å‚å…³è”å­—æ®µï¼š

```bash
cd /Users/guojunmini4/Documents/æœè£…66666
docker exec fashion-mysql-simple mysql -uroot -pchangeme fashion_supplychain < scripts/add_user_factory_id.sql
```

**è„šæœ¬å†…å®¹**ï¼š
- ä¸º `t_user` è¡¨æ·»åŠ  `factory_id` å­—æ®µ
- åˆ›å»ºç´¢å¼•æå‡æŸ¥è¯¢æ€§èƒ½
- æ›´æ–°è§’è‰²çš„ `data_scope` å€¼

### ç¬¬2æ­¥ï¼šåˆ†é…ç”¨æˆ·åˆ°å·¥å‚

#### 2.1 æŸ¥çœ‹ç°æœ‰å·¥å‚ID
```sql
SELECT id, factory_name FROM t_factory;
```

#### 2.2 ä¸ºç”¨æˆ·åˆ†é…å·¥å‚
```sql
-- å·¥å‚Açš„ç”¨æˆ·
UPDATE t_user 
SET factory_id = 'å·¥å‚Açš„ID' 
WHERE username IN ('factoryA_admin', 'factoryA_user1', 'factoryA_user2');

-- å·¥å‚Bçš„ç”¨æˆ·
UPDATE t_user 
SET factory_id = 'å·¥å‚Bçš„ID' 
WHERE username IN ('factoryB_admin', 'factoryB_user1');

-- æ€»éƒ¨ç”¨æˆ·ï¼ˆä¸åˆ†é…å·¥å‚IDï¼‰
-- ä¿æŒ factory_id = NULLï¼Œé…åˆ dataScope='ALL' å¯æŸ¥çœ‹æ‰€æœ‰æ•°æ®
```

### ç¬¬3æ­¥ï¼šé…ç½®è§’è‰²æƒé™

#### 3.1 åˆ›å»ºä¸åŒçº§åˆ«çš„è§’è‰²

```sql
-- æ€»éƒ¨ç®¡ç†å‘˜è§’è‰²
INSERT INTO t_role (role_name, role_code, data_scope, description) 
VALUES ('æ€»éƒ¨ç®¡ç†å‘˜', 'HQ_ADMIN', 'ALL', 'æŸ¥çœ‹æ‰€æœ‰å·¥å‚æ•°æ®');

-- å·¥å‚ç®¡ç†å‘˜è§’è‰²
INSERT INTO t_role (role_name, role_code, data_scope, description) 
VALUES ('å·¥å‚ç®¡ç†å‘˜', 'FACTORY_ADMIN', 'FACTORY_ONLY', 'åªçœ‹æœ¬å·¥å‚æ•°æ®');

-- å·¥å‚ä¸»ç®¡è§’è‰²
INSERT INTO t_role (role_name, role_code, data_scope, description) 
VALUES ('å·¥å‚ä¸»ç®¡', 'FACTORY_MANAGER', 'FACTORY_ONLY', 'åªçœ‹æœ¬å·¥å‚æ•°æ®');

-- è½¦é—´ç»„é•¿è§’è‰²
INSERT INTO t_role (role_name, role_code, data_scope, description) 
VALUES ('è½¦é—´ç»„é•¿', 'TEAM_LEADER', 'TEAM', 'åªçœ‹æœ¬å›¢é˜Ÿæ•°æ®');

-- æ™®é€šå‘˜å·¥è§’è‰²
INSERT INTO t_role (role_name, role_code, data_scope, description) 
VALUES ('æ™®é€šå‘˜å·¥', 'EMPLOYEE', 'OWN', 'åªçœ‹è‡ªå·±æ•°æ®');
```

#### 3.2 ä¸ºè§’è‰²åˆ†é…æƒé™ç 

```sql
-- æ€»éƒ¨ç®¡ç†å‘˜ï¼šå…¨éƒ¨æƒé™
INSERT INTO t_role_permission (role_id, permission_code)
SELECT r.id, p.permission_code
FROM t_role r
CROSS JOIN (
  SELECT 'PRODUCTION_ORDER_VIEW' AS permission_code UNION ALL
  SELECT 'FINANCE_SETTLEMENT_VIEW' UNION ALL
  SELECT 'FACTORY_MANAGE' UNION ALL
  SELECT 'USER_MANAGE' UNION ALL
  SELECT 'ROLE_MANAGE' UNION ALL
  SELECT 'DATA_DASHBOARD_VIEW'
) p
WHERE r.role_code = 'HQ_ADMIN';

-- å·¥å‚ç®¡ç†å‘˜ï¼šè®¢å•+è´¢åŠ¡+æ•°æ®çœ‹æ¿
INSERT INTO t_role_permission (role_id, permission_code)
SELECT r.id, p.permission_code
FROM t_role r
CROSS JOIN (
  SELECT 'PRODUCTION_ORDER_VIEW' AS permission_code UNION ALL
  SELECT 'FINANCE_SETTLEMENT_VIEW' UNION ALL
  SELECT 'DATA_DASHBOARD_VIEW' UNION ALL
  SELECT 'QUALITY_MANAGE'
) p
WHERE r.role_code = 'FACTORY_ADMIN';
```

### ç¬¬4æ­¥ï¼šåˆ†é…ç”¨æˆ·è§’è‰²

```sql
-- æ€»éƒ¨ç”¨æˆ·ï¼ˆæŸ¥çœ‹æ‰€æœ‰å·¥å‚ï¼‰
UPDATE t_user 
SET role_id = (SELECT id FROM t_role WHERE role_code = 'HQ_ADMIN'),
    role_name = 'æ€»éƒ¨ç®¡ç†å‘˜',
    factory_id = NULL  -- æ€»éƒ¨ç”¨æˆ·ä¸ç»‘å®šå·¥å‚
WHERE username = 'admin';

-- å·¥å‚Aç®¡ç†å‘˜ï¼ˆåªçœ‹å·¥å‚Aï¼‰
UPDATE t_user 
SET role_id = (SELECT id FROM t_role WHERE role_code = 'FACTORY_ADMIN'),
    role_name = 'å·¥å‚ç®¡ç†å‘˜',
    factory_id = 'å·¥å‚Açš„ID'
WHERE username = 'factoryA_admin';

-- å·¥å‚Bç®¡ç†å‘˜ï¼ˆåªçœ‹å·¥å‚Bï¼‰
UPDATE t_user 
SET role_id = (SELECT id FROM t_role WHERE role_code = 'FACTORY_ADMIN'),
    role_name = 'å·¥å‚ç®¡ç†å‘˜',
    factory_id = 'å·¥å‚Bçš„ID'
WHERE username = 'factoryB_admin';
```

---

## ğŸ”§ åç«¯ä»£ç ä¿®æ”¹

### ä¿®æ”¹1ï¼šUserå®ä½“æ·»åŠ factoryIdå­—æ®µ

**æ–‡ä»¶**ï¼š`backend/src/main/java/com/fashion/supplychain/system/entity/User.java`

```java
@Data
@TableName("t_user")
public class User implements Serializable {
    // ...existing fields...
    
    /**
     * æ‰€å±å·¥å‚IDï¼ˆç”¨äºæ•°æ®æƒé™éš”ç¦»ï¼‰
     */
    private String factoryId;
    
    // ...existing fields...
}
```

### ä¿®æ”¹2ï¼šUserContextæ·»åŠ factoryId

**æ–‡ä»¶**ï¼š`backend/src/main/java/com/fashion/supplychain/common/UserContext.java`

åœ¨ `UserContext` ç±»ä¸­æ·»åŠ ï¼š

```java
public static String factoryId() {
    UserContext ctx = get();
    return ctx == null ? null : ctx.getFactoryId();
}

// åœ¨æ„é€ å‡½æ•°æˆ– set æ–¹æ³•ä¸­æ·»åŠ  factoryId å­—æ®µ
private String factoryId;

public String getFactoryId() {
    return factoryId;
}

public void setFactoryId(String factoryId) {
    this.factoryId = factoryId;
}
```

### ä¿®æ”¹3ï¼šDataPermissionHelperæ”¯æŒå·¥å‚æƒé™

**æ–‡ä»¶**ï¼š`backend/src/main/java/com/fashion/supplychain/common/DataPermissionHelper.java`

æ·»åŠ å·¥å‚çº§åˆ«çš„æ•°æ®è¿‡æ»¤æ–¹æ³•ï¼š

```java
/**
 * ä¸ºQueryWrapperæ·»åŠ å·¥å‚æ•°æ®æƒé™è¿‡æ»¤
 * 
 * @param wrapper æŸ¥è¯¢åŒ…è£…å™¨
 * @param factoryIdField å·¥å‚IDå­—æ®µåï¼ˆå¦‚ "factory_id"ï¼‰
 * @param <T> å®ä½“ç±»å‹
 * @return æ˜¯å¦æ·»åŠ äº†è¿‡æ»¤æ¡ä»¶
 */
public static <T> boolean applyFactoryFilter(QueryWrapper<T> wrapper, String factoryIdField) {
    String dataScope = UserContext.getDataScope();
    
    switch (dataScope) {
        case "ALL":
            // æ€»éƒ¨ç®¡ç†å‘˜çœ‹å…¨éƒ¨ï¼Œä¸æ·»åŠ è¿‡æ»¤
            return false;
            
        case "FACTORY_ONLY":
            // å·¥å‚ç®¡ç†å‘˜åªçœ‹æœ¬å·¥å‚
            String factoryId = UserContext.factoryId();
            if (StringUtils.hasText(factoryId)) {
                wrapper.eq(factoryIdField, factoryId);
                return true;
            }
            return false;
            
        case "TEAM":
        case "OWN":
        default:
            // å›¢é˜Ÿ/ä¸ªäººæƒé™é€šå¸¸ä¸ç”¨å·¥å‚è¿‡æ»¤ï¼ˆç”±æ“ä½œäººè¿‡æ»¤ï¼‰
            return false;
    }
}
```

### ä¿®æ”¹4ï¼šåœ¨å„ä¸ªServiceä¸­åº”ç”¨å·¥å‚è¿‡æ»¤

**ç¤ºä¾‹**ï¼š`ProductionOrderServiceImpl.java`

```java
@Override
public IPage<ProductionOrder> page(Page<ProductionOrder> page, String keyword) {
    QueryWrapper<ProductionOrder> wrapper = new QueryWrapper<>();
    
    // åº”ç”¨å·¥å‚æ•°æ®æƒé™è¿‡æ»¤
    DataPermissionHelper.applyFactoryFilter(wrapper, "factory_id");
    
    // å…¶ä»–æŸ¥è¯¢æ¡ä»¶...
    if (StringUtils.hasText(keyword)) {
        wrapper.like("order_no", keyword);
    }
    
    return this.page(page, wrapper);
}
```

**éœ€è¦ä¿®æ”¹çš„Service**ï¼š
- `ProductionOrderServiceImpl` - ç”Ÿäº§è®¢å•
- `FinishedProductSettlementService` - è´¢åŠ¡ç»“ç®—ï¼ˆå·²æœ‰factory_idå­—æ®µï¼‰
- `ScanRecordServiceImpl` - æ‰«ç è®°å½•
- `ProductWarehousingServiceImpl` - æˆå“å…¥åº“
- `MaterialPurchaseServiceImpl` - ç‰©æ–™é‡‡è´­
- å…¶ä»–æœ‰å·¥å‚å…³è”çš„Service

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. åˆ›å»ºæµ‹è¯•ç”¨æˆ·

```sql
-- æ€»éƒ¨ç®¡ç†å‘˜
INSERT INTO t_user (username, password, name, role_id, role_name, factory_id)
VALUES ('hq_admin', '$2a$10$...', 'æ€»éƒ¨å¼ ä¸‰', 
        (SELECT id FROM t_role WHERE role_code = 'HQ_ADMIN'), 
        'æ€»éƒ¨ç®¡ç†å‘˜', NULL);

-- å·¥å‚Aç®¡ç†å‘˜
INSERT INTO t_user (username, password, name, role_id, role_name, factory_id)
VALUES ('factory_a_admin', '$2a$10$...', 'å·¥å‚Aæå››', 
        (SELECT id FROM t_role WHERE role_code = 'FACTORY_ADMIN'), 
        'å·¥å‚ç®¡ç†å‘˜', 'å·¥å‚Açš„ID');

-- å·¥å‚Bç®¡ç†å‘˜
INSERT INTO t_user (username, password, name, role_id, role_name, factory_id)
VALUES ('factory_b_admin', '$2a$10$...', 'å·¥å‚Bç‹äº”', 
        (SELECT id FROM t_role WHERE role_code = 'FACTORY_ADMIN'), 
        'å·¥å‚ç®¡ç†å‘˜', 'å·¥å‚Bçš„ID');
```

### 2. éªŒè¯æ•°æ®éš”ç¦»

#### æµ‹è¯•1ï¼šæ€»éƒ¨ç®¡ç†å‘˜ç™»å½•
- âœ… æ•°æ®çœ‹æ¿ï¼šæ˜¾ç¤ºæ‰€æœ‰å·¥å‚æ•°æ®
- âœ… å·¥å‚æ’è¡Œï¼šæ˜¾ç¤ºæ‰€æœ‰å·¥å‚æ’å
- âœ… å¯ä»¥åˆ‡æ¢å·¥å‚ç­›é€‰å™¨æŸ¥çœ‹å„å·¥å‚è¯¦æƒ…

#### æµ‹è¯•2ï¼šå·¥å‚Aç®¡ç†å‘˜ç™»å½•
- âœ… æ•°æ®çœ‹æ¿ï¼šåªæ˜¾ç¤ºå·¥å‚Açš„æ•°æ®
- âœ… å·¥å‚æ’è¡Œï¼šåªæ˜¾ç¤ºå·¥å‚A
- âœ… ç”Ÿäº§è®¢å•åˆ—è¡¨ï¼šåªæ˜¾ç¤ºå·¥å‚Açš„è®¢å•
- âŒ çœ‹ä¸åˆ°å·¥å‚Bçš„ä»»ä½•æ•°æ®

#### æµ‹è¯•3ï¼šå·¥å‚Bç®¡ç†å‘˜ç™»å½•
- âœ… æ•°æ®çœ‹æ¿ï¼šåªæ˜¾ç¤ºå·¥å‚Bçš„æ•°æ®
- âœ… å·¥å‚æ’è¡Œï¼šåªæ˜¾ç¤ºå·¥å‚B
- âŒ çœ‹ä¸åˆ°å·¥å‚Açš„ä»»ä½•æ•°æ®

---

## ğŸ“Š å‰ç«¯é€‚é…ï¼ˆå¯é€‰ï¼‰

### éšè—å·¥å‚é€‰æ‹©å™¨

å¯¹äºå·¥å‚ç®¡ç†å‘˜ï¼Œå¯ä»¥éšè—é¡¶éƒ¨çš„å·¥å‚ç­›é€‰å™¨ï¼ˆå› ä¸ºåªèƒ½çœ‹æœ¬å·¥å‚ï¼‰ï¼š

**æ–‡ä»¶**ï¼š`frontend/src/modules/finance/pages/FinanceCenter/DashboardContent.tsx`

```tsx
// è·å–å½“å‰ç”¨æˆ·æƒé™
const userDataScope = appContext.user?.dataScope || 'OWN';

// åªæœ‰ ALL æƒé™æ‰æ˜¾ç¤ºå·¥å‚é€‰æ‹©å™¨
{userDataScope === 'ALL' && (
  <Select
    placeholder="é€‰æ‹©å·¥å‚ï¼ˆå…¨å±€ç­›é€‰ï¼‰"
    allowClear
    style={{ width: 220 }}
    value={selectedFactory}
    onChange={setSelectedFactory}
    showSearch
    optionFilterProp="children"
  >
    {factories.map((factory) => (
      <Option key={factory.id} value={factory.id}>
        {factory.factoryName}
      </Option>
    ))}
  </Select>
)}
```

---

## ğŸ¯ å®æ–½æ€»ç»“

### ä¼˜åŠ¿
1. **æœ€å°æ”¹åŠ¨**ï¼šåˆ©ç”¨ç°æœ‰çš„ `dataScope` æœºåˆ¶ï¼Œåªéœ€æ·»åŠ  `factoryId` å­—æ®µ
2. **çµæ´»æ§åˆ¶**ï¼š4çº§æƒé™æ»¡è¶³ä¸åŒåœºæ™¯ï¼ˆæ€»éƒ¨/å·¥å‚/å›¢é˜Ÿ/ä¸ªäººï¼‰
3. **æ•°æ®å®‰å…¨**ï¼šåç«¯å¼ºåˆ¶è¿‡æ»¤ï¼Œå‰ç«¯æ— æ³•ç»•è¿‡
4. **æ˜“äºæ‰©å±•**ï¼šæ–°å¢å·¥å‚åªéœ€åˆ†é… `factory_id`

### å…³é”®é…ç½®ç‚¹
- âœ… æ•°æ®åº“ï¼š`t_user.factory_id` + `t_role.data_scope`
- âœ… åç«¯ï¼š`UserContext.factoryId()` + `DataPermissionHelper.applyFactoryFilter()`
- âœ… Serviceï¼šåœ¨æ‰€æœ‰æŸ¥è¯¢æ–¹æ³•ä¸­è°ƒç”¨å·¥å‚è¿‡æ»¤
- âœ… ç”¨æˆ·åˆ†é…ï¼šæ€»éƒ¨ç”¨æˆ· `factory_id = NULL`ï¼Œå·¥å‚ç”¨æˆ·è®¾ç½®å¯¹åº”å·¥å‚ID

### ä¸‹ä¸€æ­¥å»ºè®®
1. æ‰§è¡Œæ•°æ®åº“å‡çº§è„šæœ¬
2. ä¿®æ”¹åç«¯ä»£ç æ·»åŠ å·¥å‚è¿‡æ»¤
3. åˆ†é…ç°æœ‰ç”¨æˆ·åˆ°å„å·¥å‚
4. æµ‹è¯•éªŒè¯æ•°æ®éš”ç¦»æ•ˆæœ
5. ï¼ˆå¯é€‰ï¼‰å‰ç«¯æ ¹æ®æƒé™éšè—/æ˜¾ç¤ºå·¥å‚é€‰æ‹©å™¨

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**ï¼š2026-01-27  
**é€‚ç”¨ç‰ˆæœ¬**ï¼šv1.0+  
**ç»´æŠ¤è€…**ï¼šç³»ç»Ÿç®¡ç†å‘˜
