# 智能化实施清单（开发 → 生产 → 出入库）

> 目标：在不破坏现有流程前提下，先做可落地、可灰度、可回滚的智能能力。
> 
> 范围：仅覆盖开发端、生产端、出入库链路。

---

## 1. 第一批先做什么（建议按优先级）

## P0（本周可开工）

1. 生产进度预计完成时间（父节点 + 子工序）
- 输出：`predictedFinishTime`、`confidence`、`reasons`
- 前端展示：进度球/进度条悬浮提示 + 风险标记

2. 扫码前置预检（不拦截，仅提示）
- 输出：`riskLevel`、`issues[]`、`suggestions[]`
- 覆盖：重复扫、阶段错配、库存不足、已结算不可撤回

3. 出入库智能分流建议（库存足够优先出库）
- 基于现有 `smart-receive-all` 增强解释能力
- 输出：为什么走出库/为什么走采购

## P1（下一周）

4. 开发端阶段推进建议（Style 阶段）
- 根据 `stage-action` 当前状态给下一步动作建议
- 输出：`nextActions[]`、`blockingFields[]`

5. 采购到货风险预警
- 基于历史采购周期给订单履约风险评分
- 输出：`delayRiskScore`、`etaDrift`

---

## 2. 现有接口复用（优先复用，不重造轮子）

## 开发端
- `POST /api/style/info/{id}/stage-action`
- `GET /api/style/info/{id}`
- `GET /api/style/bom/list?styleId=...`
- `POST /api/style/bom/generate-purchase`

## 生产端
- `GET /api/production/order/flow/{id}`
- `POST /api/production/scan/execute`
- `POST /api/production/scan/undo`
- `GET /api/production/scan/list`
- `POST /api/production/order/recompute-progress`

## 出入库
- `POST /api/production/purchase/smart-receive-all`
- `GET /api/production/purchase/smart-receive-preview`
- `POST /api/production/material/inbound/confirm-arrival`
- `POST /api/production/warehousing/batch`
- `GET /api/production/outstock/list`

---

## 3. 新增“独立智能编排层”接口（建议）

> 新增域：`/api/intelligence/**`，不改旧接口行为。

1. `POST /api/intelligence/precheck/scan`
- 入参：订单、工序、数量、操作人
- 出参：`riskLevel`、`issues[]`、`suggestions[]`

2. `POST /api/intelligence/predict/process-finish`
- 入参：订单ID、工序/节点、当前进度
- 出参：`predictedFinishTime`、`confidence`、`reasons[]`

3. `POST /api/intelligence/recommend/inout-strategy`
- 入参：订单号/采购任务集合
- 出参：`strategy=OUTBOUND|PURCHASE`、`reason`、`materialBreakdown[]`

4. `POST /api/intelligence/feedback/actual-result`
- 入参：预测ID、实际完成时间/实际结果
- 出参：`accepted=true`、`deviation`（用于学习闭环）

---

## 4. 后端模块建议（保持四层架构）

目录建议：

- `backend/src/main/java/com/fashion/supplychain/intelligence/controller/`
- `backend/src/main/java/com/fashion/supplychain/intelligence/orchestration/`
- `backend/src/main/java/com/fashion/supplychain/intelligence/service/`
- `backend/src/main/java/com/fashion/supplychain/intelligence/mapper/`
- `backend/src/main/java/com/fashion/supplychain/intelligence/entity/`

首批编排器：
- `SmartPrecheckOrchestrator`
- `ProgressPredictionOrchestrator`
- `InoutDecisionOrchestrator`
- `FeedbackLearningOrchestrator`

---

## 5. 首批数据库变更（你手工执行）

> 云端 `FLYWAY_ENABLED=false`，以下 SQL 需手工执行。

建议首批表：

1. `t_smart_prediction_record`
- 存预测请求与结果（预测时间、置信度、原因）

2. `t_smart_feedback_record`
- 存实际结果回写（实际完成时间、偏差、是否采纳建议）

3. `t_smart_feature_snapshot`
- 存每次决策的特征快照（便于审计与回放）

建议索引：
- `idx_smart_pred_order_stage`（order_id, stage_name, created_time）
- `idx_smart_feedback_pred`（prediction_id, created_time）

执行规范：见 `deployment/云端SQL发布检查清单.md`

---

## 6. 灰度上线策略

1. 先“只提示不拦截”
- 前端展示建议，不改变原提交结果

2. 开关按模块放量
- `smart.production.precheck.enabled`
- `smart.guide.enabled`
- 后续增加后端租户级开关（建议）

3. 观测指标（每日）
- 提示命中率
- 误报率
- 用户采纳率
- 预测偏差均值（分钟）

---

## 7. 开工顺序（建议）

Day 1-2
- 建 `intelligence` 模块骨架 + 统一返回 DTO

Day 3-4
- 实现 `precheck/scan`（规则引擎）
- 接入生产扫码页提示

Day 5-6
- 实现 `predict/process-finish`（先规则版）
- 接入进度球悬浮预计完成时间

Day 7
- 实现 `feedback/actual-result` 回写
- 打通最小学习闭环

---

## 8. 完成定义（DoD）

- 不改原接口行为，关闭智能开关后与现网一致
- 关键链路：开发→生产→出入库可跑通
- 失败可解释（每条建议有 reason）
- SQL 执行与校验记录齐全
