# 智能化改造风险分析与隔离实施细则

## 1. 实施原则
- 只新增独立能力层，不直接改写现有业务流程代码。
- 智能能力默认关闭，通过开关灰度启用。
- 所有能力先提示后拦截，先旁路验证，再决定是否进入强约束。

## 2. 风险矩阵

| 风险项 | 级别 | 触发场景 | 控制措施 | 回滚方式 |
|---|---|---|---|---|
| 老流程被改变 | 高 | 智能逻辑直接替代旧逻辑 | 禁止替代，只做提示层 | 关闭模块开关 |
| 新提示误报 | 中 | 规则不完整 | 先旁路埋点观察命中率 | 降级为仅记录不提示 |
| 双端规则不一致 | 高 | PC 与小程序规则分叉 | 规则集中配置与共享文档 | 关闭小程序侧智能能力 |
| 性能下降 | 中 | 高频页面实时计算 | 本地缓存 + 防抖 + 懒加载 | 关闭单能力开关 |
| 用户学习成本增加 | 中 | 新入口过多 | 不新增流程页，只在原位增强 | 隐藏提示层 |

## 3. 隔离架构

前端新增独立目录：
- `frontend/src/smart/core/*`
- `frontend/src/smart/components/*`

约束：
- 现有业务组件仅“按需引入”，不强制接管。
- 不修改既有服务层 API 签名。
- 智能层组件可整体移除，不影响业务组件编译。

## 4. 灰度策略
1. `dev` 环境开启单模块验证。
2. 测试租户灰度开启。
3. 生产按模块逐步开启，默认保守。

## 5. 质量门禁
每次提交必须满足：
- 走查：确认旧入口仍可完整操作。
- 质检：`./scripts/qa-after-change.sh` 通过。
- 回归：至少覆盖开发→生产→财务主路径一次。

## 6. 一键回退清单
- 关闭以下开关恢复旧行为：
  - `smart.guide.enabled`
  - `smart.dict.autocollect.enabled`
  - `smart.production.precheck.enabled`
  - `smart.finance.explain.enabled`
  - `smart.system.guard.enabled`

## 7. 当前落地状态
- 已新增独立智能层骨架与开关能力（默认关闭）。
- 已在以下页面接入“可执行错误提示（SmartErrorNotice）”，且均保持“提示不拦截、原流程不变”：
  - 生产：`Production/List`、`Production/ProgressDetail`、`Production/ProductWarehousing`。
  - 财务：`Finance/MaterialReconciliation`、`Finance/ExpenseReimbursement`、`Finance/WagePayment`、`Finance/PayrollOperatorSummary`、`FinanceDashboard`、`FinanceCenter/FinishedSettlementContent`、`FinanceCenter/FactorySummaryContent`、`FinanceCenter/DashboardContent`。
  - 仓库：`MaterialInventory`、`FinishedInventory`、`SampleInventory`、`Dashboard`、`MaterialDatabase`。
- 已在以下弹窗/抽屉场景补齐提示一致性：
  - `SampleInventory/LoanHistoryModal`
  - `SampleInventory/LoanHistoryDrawer`
  - `SampleInventory/LoanModal`
  - `SampleInventory/InboundModal`
  - `Finance/ExpenseReimbursement`（提交/删除/审批/付款确认失败）
  - `FinanceCenter/FinishedSettlementContent`（备注保存/日志加载失败）
- 当前影响范围：
  - 开关关闭（默认）：系统行为与历史版本一致。
  - 开关开启：仅增加错误原因/重试提示，不改变既有 API 调用链和业务提交链。

## 8. 覆盖与待办
- 已覆盖高频列表/看板页面，优先保障“查询失败可见、可重试”。
- 待办建议：
  - 按模块补齐二级弹窗与抽屉场景（如历史记录弹窗）的提示一致性。
  - 增加一份按模块的开关启用 SOP（测试租户→灰度租户→全量租户）。
  - 每次新增接入后更新本清单，保证可审计与可回滚。
