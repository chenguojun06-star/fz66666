# 智能编排接口清单（可开工版）

> 范围：开发 → 生产 → 出入库

---

## A. 可直接复用（不改旧接口）

### 开发端
- `POST /api/style/info/{id}/stage-action`
- `GET /api/style/info/{id}`
- `GET /api/style/bom/list`
- `POST /api/style/bom/generate-purchase`

### 生产端
- `POST /api/production/scan/execute`
- `POST /api/production/scan/undo`
- `GET /api/production/scan/list`
- `GET /api/production/order/flow/{id}`
- `POST /api/production/order/recompute-progress`

### 出入库
- `POST /api/production/material/inbound/confirm-arrival`
- `POST /api/production/warehousing/batch`
- `GET /api/production/outstock/list`
- `POST /api/production/purchase/smart-receive-all`
- `GET /api/production/purchase/smart-receive-preview`

---

## B. 新增独立智能编排接口（已建占位）

- `POST /api/intelligence/precheck/scan`
- `POST /api/intelligence/predict/finish-time`
- `POST /api/intelligence/recommend/inout`
- `POST /api/intelligence/feedback`

说明：
- 新接口只做预检/预测/建议/反馈，不改变旧链路结果。
- 旧接口继续可用，开关关闭后可完全回退。

---

## C. 前端接入现状（2026-02-27）

### 接入点汇总

| 接入位置 | 触发时机 | 调用接口 | 降级策略 |
|---|---|---|---|
| Web 扫码提交（`useSubmitScan.ts`） | 用户点击"确认扫码"前 | `precheck/scan` | catch 静默，流程不阻断 |
| Web 进度球（`useProgressColumns.tsx`） | 鼠标悬浮进度球时 | `predict/finish-time` | catch 静默，不展示 hint |
| Web 生产列表（`useProgressTracking.tsx`） | 鼠标悬浮工序时间标签时（含入库列） | `predict/finish-time` | catch 静默，不展示 hint |
| 小程序扫码（`ScanSubmitter.js`） | `executeScan` 执行前 | `precheck/scan` | catch console.warn，扫码继续 |

### 降级策略统一规则

1. **只提示，不阻断**：无论预检/预测接口返回什么，旧扫码/旧进度流程必须正常执行。
2. **失败静默**：网络错误、5xx 等均 catch 忽略，不向用户展示错误弹窗。
3. **有建议才展示**：`precheck/scan` 返回 `issues` 非空时才 `message.warning`；`predict/finish-time` 返回有效日期时才在 tooltip 追加置信度文案。
4. **小程序提示内嵌**：预检命中时，提示文案追加在扫码成功消息的 `precheckHint` 字段，不独立弹窗。

### 共享 Hook：`usePredictFinishHint`

**位置**：`frontend/src/modules/production/pages/Production/ProgressDetail/hooks/usePredictFinishHint.ts`

**用法**：
```typescript
const { getPredictHint, triggerPredict } = usePredictFinishHint(formatCompletionTime);

// 鼠标悬浮时触发（幂等，内部防并发）
triggerPredict({ orderId, orderNo, stageName, currentProgress: percent });

// 获取当前 hint 文案（undefined 表示尚未请求到结果）
const hint = getPredictHint(orderId, stageName, percent);
```

**缓存键策略**：`${orderId}::${stageName}::${currentProgress}`  
**置信度格式**：`（置信度 XX%）`  
**复用方**：`useProgressColumns.tsx`（进度详情球）+ `useProgressTracking.tsx`（生产列表工序标签）

---

## D. 后续待接入（预留）

| 接口 | 计划接入位置 | 状态 |
|---|---|---|
| `recommend/inout` | 入库审批弹窗旁"AI建议" | ⏳ 未开始 |
| `feedback` | 进度球弹窗/扫码结果弹窗"反馈" | ⏳ 未开始 |
