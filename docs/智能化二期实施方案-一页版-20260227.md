# 智能化二期实施方案（一页版）

> 版本：2026-02-27  
> 目标：在不改变现有操作路径前提下，完成“建议可解释 + 闭环可学习 + 租户可灰度”的二期落地。

---

## 1. 二期范围（聚焦 4 条主线）

1. **生产侧：预测与预检闭环**
- 继续使用 `/api/intelligence/precheck/scan`、`/api/intelligence/predict/finish-time`
- 新增预测采纳回写，形成“预测 → 实际 → 偏差修正”

2. **出入库侧：策略推荐可执行化**
- 强化 `/api/intelligence/recommend/inout` 推荐解释
- 前端提供“按推荐执行”与“忽略推荐并手动处理”双入口（默认不拦截）

3. **财务侧：差异解释可追溯**
- 结算差异面板展示来源记录、计算过程、风险级别
- 增加“建议结论 + 人工确认”模式，保留原审批流

4. **系统侧：治理能力补齐**
- 打通词典自动收录待审池
- 角色权限防呆建议（只提示，不自动改）

---

## 2. 二期前置对齐清单（先修再放量）

1. **Feature Flag 默认值对齐文档**
- 现状：`smart.production.precheck.enabled` 默认 `true`
- 目标：所有智能开关默认 `false`，仅灰度开启

2. **接口命名统一**
- 文档与实现统一为：`POST /api/intelligence/feedback`（或统一改文档到 `feedback/actual-result`，二选一）

3. **未消费开关落地**
- `smart.system.guard.enabled`
- `smart.dict.autocollect.enabled`

4. **前端 API 完整暴露**
- 在 `productionApi` 补齐 `recommendInout`、`feedback` 方法并在页面接入

---

## 3. 架构与接口（保持现有四层）

### 3.1 后端架构（保持不变）
`Controller → Orchestrator → Service → Mapper`

- Controller：`intelligence/controller/IntelligenceController`
- Orchestrator：`SmartPrecheckOrchestrator`、`ProgressPredictOrchestrator`、`InoutDecisionOrchestrator`、`FeedbackLearningOrchestrator`

### 3.2 二期接口清单（建议稳定版）
- `POST /api/intelligence/precheck/scan`
- `POST /api/intelligence/predict/finish-time`
- `POST /api/intelligence/recommend/inout`
- `POST /api/intelligence/feedback`

### 3.3 返回协议约束
- 统一 `Result<T>`，`code=200` 成功
- 所有建议必须附 `reasons[]`
- 所有风险必须附 `riskLevel`（LOW/MEDIUM/HIGH）

---

## 4. 数据与发布策略

### 4.1 数据模型（若需新增）
- `t_smart_prediction_record`（预测记录）
- `t_smart_feedback_record`（实际回写）
- `t_smart_feature_snapshot`（特征快照审计）

> 云端 `FLYWAY_ENABLED=false`：SQL 需在微信云托管控制台手工执行，并留存执行记录。

### 4.2 灰度策略
- 维度：租户级 + 模块级开关
- 阶段：`只提示` → `提示+推荐执行` → `局部软拦截（可回退）`
- 回滚：单开关关闭即恢复旧行为

---

## 5. 二期里程碑（建议 2 周）

### Week 1（基础补齐）
- D1-D2：前置对齐项（开关默认值、接口命名、API 暴露）
- D3-D4：推荐/反馈链路前后端打通
- D5：联调与冒烟（开发→生产→出入库）

### Week 2（业务强化）
- D1-D2：财务差异解释面板上线（只读）
- D3：系统治理能力（词典待审 + 权限防呆）
- D4：租户灰度放量 + 指标观察
- D5：复盘与三期候选池

---

## 6. 验收标准（DoD）

1. 关闭所有智能开关后，行为与现网一致  
2. 开启智能后，不阻断主流程（除已批准的软拦截场景）  
3. 关键链路无新增 500，建议可解释、可追溯  
4. 生产/财务/系统/小程序至少各 1 个页面完成真实数据验收  
5. 二期上线后 7 天内可提供：命中率、采纳率、误报率、偏差均值

---

## 7. 三期预留（不在本期承诺）
- 规则权重自动调参
- 租户个性化策略模板
- 跨端统一智能运营看板
