# 双端异常提示独立方案（不混入业务代码）

> 目标：先独立定义“异常类型→统一文案→展示方式→排查信息”，作为单独交付物。
> 
> 约束：**本方案不直接改现有业务代码**，仅提供标准和落地步骤。

---

## 1. 统一目标

- PC 端 + 小程序对同类异常展示一致的中文提示。
- 用户看到提示后能直接判断问题类型（网络、权限、参数、库存、业务状态）。
- 提示中可携带短 requestId（例如 `RID: ab12cd34`），便于快速定位日志。

---

## 2. 异常分类与标准文案（第一批高频）

| 错误码 | 类型 | 标准文案 | 用户动作建议 |
|---|---|---|---|
| AUTH_EXPIRED | 认证 | 登录已过期，请重新登录 | 重新登录 |
| NO_PERMISSION | 权限 | 无权限执行此操作，请联系管理员开通权限 | 联系管理员 |
| PARAM_INVALID | 参数 | 输入信息不完整或格式不正确，请检查后重试 | 修正输入 |
| RESOURCE_NOT_FOUND | 数据 | 数据不存在或已被删除，请刷新后重试 | 刷新页面 |
| ORDER_LOCKED | 业务状态 | 订单已完成，无法继续操作 | 返回订单列表 |
| STOCK_NOT_ENOUGH | 库存 | 库存不足，请减少数量或补货后再试 | 调整数量 |
| SCAN_DUPLICATE | 扫码防重 | 检测到重复扫码，请稍后再试 | 稍后重试 |
| PAYROLL_SETTLED_DENY_UNDO | 结算约束 | 该扫码记录已参与工资结算，无法撤回 | 联系财务 |
| NETWORK_TIMEOUT | 网络 | 网络超时，请检查网络后重试 | 重试 |
| SERVER_UNAVAILABLE | 服务 | 服务暂不可用，请稍后重试 | 稍后重试 |
| FILE_INVALID | 上传 | 文件格式不支持，请上传正确文件 | 更换文件 |
| FILE_TOO_LARGE | 上传 | 文件过大，请压缩后重试 | 压缩文件 |
| SYSTEM_ERROR | 系统 | 系统繁忙，请稍后重试 | 稍后重试 |

> 说明：
> - 后端若未返回错误码，前端/小程序按 HTTP 状态码兜底映射。
> - 保留服务端 message 作为补充信息，但以标准文案为主。

---

## 3. 双端展示规则（统一）

### 3.1 PC 端（Ant Design）

- 默认：`message.error(标准文案)`。
- 关键阻塞（如权限、结算禁止撤回）：可用 `Modal.error` 显示更明确说明。
- 文案附短 requestId：
  - 示例：`库存不足，请减少数量或补货后再试（RID: ab12cd34）`

### 3.2 小程序端

- 默认：`toast.error(标准文案)` 或 `wx.showToast({ icon: 'none' })`。
- 关键阻塞：`wx.showModal({ title: '操作失败', content: 标准文案 })`。
- 文案附短 requestId：
  - 示例：`登录已过期，请重新登录（RID: ab12cd34）`

---

## 4. 后端响应约定（目标态）

统一返回结构（已有基础 Result）：

```json
{
  "code": 400,
  "message": "库存不足",
  "errorCode": "STOCK_NOT_ENOUGH",
  "requestId": "ab12cd34ef...",
  "data": null
}
```

- `errorCode`：稳定机器码，用于双端精确映射。
- `message`：可读信息（日志与人工排查）。
- `requestId`：追踪ID（已存在）。

---

## 5. 实施方式（仍保持“单独做，不混业务”）

### Phase A（本次建议）

仅新增独立规范与映射文件，不改业务流程：

- PC 端独立映射文件：`frontend/src/constants/errorMessageMap.ts`
- 小程序独立映射文件：`miniprogram/utils/errorMessageMap.js`
- 统一规则文档：本文件

### Phase B（下次单独变更）

仅改“网关/请求层”接入映射：

- PC：`frontend/src/utils/api/core.ts` 内统一处理错误码映射
- 小程序：`miniprogram/utils/request.js` 内统一处理错误码映射

> 业务页面不需要逐页修改，避免混入大量业务代码。

---

## 6. 验收标准

- 同一错误码在 PC/小程序显示同一主文案。
- 401/403/库存不足/参数错误/结算禁止撤回可稳定复现并提示正确。
- 80%+ 异常提示包含 requestId（或在错误详情可见）。
- 新增业务异常时，先补映射文件再上线。

---

## 7. 运维与排查模板

用户上报模板：

- 操作时间：
- 页面：
- 提示文案：
- RID：
- 账号/工厂：

后端检索建议：

- 按 `requestId` 检索日志
- 再按 `errorCode` 聚合统计高频异常

---

## 8. 结论

这套方案已经从实现层拆离，作为**独立标准**可先落地执行；后续接入时只改请求层，不改业务页面逻辑，最大限度降低风险。
