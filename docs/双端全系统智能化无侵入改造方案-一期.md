# 双端全系统智能化无侵入改造方案（一期）

> 目标：在**不改变现有操作路径**的前提下，让系统“更智能、合理、傻瓜式”。
> 
> 核心承诺：**旧流程可原样使用**，新增能力全部为增强层（提示/建议/自动补全），可灰度、可回退。

---

## 1. 硬约束（不破坏现有使用习惯）

### 1.1 不变项（强制）
- 不删除现有按钮，不重排关键操作顺序。
- 不修改核心业务状态流转（开发 → 生产 → 结算）的既有后端规则。
- 不改已有接口入参结构与返回结构（仅可增加可选字段）。
- 用户即使不使用“智能提示”，也能按旧方式完整操作。

### 1.2 增强项（允许）
- 自动推荐、默认填充、风险提示、下一步引导。
- 一键修复入口（跳转到问题字段/页面）。
- 智能解释（为什么失败、如何修）。

### 1.3 风险控制
- 按模块 Feature Flag（开发/生产/财务/系统）灰度开启。
- 旁路计算（shadow mode）：先提示不拦截，验证稳定后再可选拦截。
- 任意模块可单独关闭，不影响其他模块。

---

## 2. 一期改造范围（双端全链路）

## 2.1 PC 端（Web）

### A. 开发模块（款式/样衣）
**覆盖页面：**
- `frontend/src/modules/basic/pages/StyleInfo/index.tsx`
- `frontend/src/modules/basic/pages/StyleInfo/components/*.tsx`

**无侵入智能化：**
1) 统一“下一步引导条”
- 每个阶段头部显示：当前状态、下一步动作、未完成项数量。
- 仅提示，不拦截原操作。

2) 智能默认填充
- BOM/工序/尺码中，自动记忆最近一次有效输入（同租户、同用户）。
- 新建行时预填，不覆盖用户手动输入。

3) 可执行错误提示
- 失败提示格式统一：问题 + 原因 + “去修复”入口。
- 示例：`供应商缺失 → 点击定位到该行供应商字段`。

4) 词典自动收录（已做基础）增强
- 增加“收录成功/失败埋点”，防止静默失败不可见。
- 去重标准统一（空格、大小写、全半角）。

### B. 生产模块（订单/扫码/入库）
**覆盖页面：**
- `frontend/src/modules/production/pages/Production/List/index.tsx`
- `frontend/src/modules/production/pages/Production/ProgressDetail/index.tsx`
- `frontend/src/modules/production/pages/Production/ProductWarehousing/index.tsx`
- `frontend/src/modules/production/pages/Production/Cutting/index.tsx`

**无侵入智能化：**
1) 扫码异常前置提示
- 重复扫、阶段不匹配、库存不足、结算锁定等在提交前提示。
- 默认不拦截（先提示模式）。

2) 自动解释进度差异
- 进度球与明细不一致时显示“原因说明条”。
- 示例：`该节点已存在扫码，比例兜底已跳过`。

3) 一键纠错入口
- 从弹窗错误信息直接跳转到对应操作（重试、刷新、查看失败块）。

### C. 财务模块（工资/结算/对账）
**覆盖页面：**
- `frontend/src/modules/finance/pages/Finance/PayrollOperatorSummary/index.tsx`
- `frontend/src/modules/finance/pages/Finance/WagePayment/index.tsx`
- `frontend/src/modules/finance/pages/Finance/MaterialReconciliation/index.tsx`

**无侵入智能化：**
1) 结算差异解释面板（只读）
- 自动列出“差异来源记录 + 金额构成”。
- 不改变原审批按钮流程。

2) 风险提示分级
- 高风险（跨期、负值、重复结算）红色提示；中风险黄色提示。
- 仅提示，不自动驳回。

3) 审批建议
- 根据历史规则给出“建议通过/建议复核”，最终仍人工确认。

### D. 系统模块（用户/角色/字典/应用）
**覆盖页面：**
- `frontend/src/modules/system/pages/System/UserList/index.tsx`
- `frontend/src/modules/system/pages/System/RoleList/index.tsx`
- `frontend/src/modules/system/pages/System/DictManage/index.tsx`
- `frontend/src/modules/system/pages/AppStore/index.tsx`

**无侵入智能化：**
1) 向导提示卡片
- 每页顶部显示“推荐配置步骤”。
- 保留原功能入口。

2) 权限配置防呆
- 给出“角色缺关键权限”的即时提示与一键补齐建议。
- 不自动改权限，仅推荐。

3) 字典治理
- 自动收录词条进入“待审核”池（可选开关），管理员一键通过。

---

## 2.2 小程序端（Mini Program）

**覆盖页面：**
- `miniprogram/pages/scan/index.js`
- `miniprogram/pages/work/index.js`
- `miniprogram/pages/warehouse/**/index.js`
- `miniprogram/pages/admin/**/index.js`

**无侵入智能化：**
1) 扫码结果可执行反馈
- 失败时给明确下一步按钮（重试/查看原因/切换模式）。

2) 自动默认值
- 自动记忆最近工序、仓库、班组，不改原选择控件。

3) 词典能力补齐
- 新词自动收录（与 PC 一致，防抖+去重）。
- 当前仅支持读取词典，需补齐提交能力。

4) 离线友好提示
- 离线缓存数量与待上传状态显式展示。
- 上传成功后显示“已同步条数”。

---

## 3. 技术方案（先稳后快）

## 3.1 Feature Flag 设计
- `smart.guide.enabled`
- `smart.dict.autocollect.enabled`
- `smart.production.precheck.enabled`
- `smart.finance.explain.enabled`
- `smart.system.guard.enabled`

默认：全部 `false`，按模块灰度开启。

## 3.2 实施顺序（一期）
1) 只做提示层（不改提交结果）。
2) 埋点观察 1 周（提示命中率、误报率、用户跳出）。
3) 误报可控后，再评估部分场景启用“软拦截”。

## 3.3 回滚策略
- 任一模块异常：关闭对应 flag，立即恢复旧行为。
- 不需要回滚数据库结构（一期尽量不引入强依赖 schema 变更）。

---

## 4. 验收标准（必须全部满足）

### 4.1 兼容性验收
- 老用户不学习也可完成原流程。
- 关闭智能开关后，行为与现网一致。

### 4.2 体验验收
- 首次用户在关键页面可通过提示完成操作，不需要阅读文档。
- 错误提示可直接定位修复，不出现“只报错不指路”。

### 4.3 稳定性验收
- 前端 lint/type-check 通过。
- 小程序 eslint/type-check 通过（允许 warning，不允许 error）。
- 后端 compile / 关键测试通过。
- 关键链路回归：开发建款、扫码、入库、结算、权限配置。

---

## 5. 一期开发任务拆分（可直接排期）

### Sprint-1（低风险）
- 统一“下一步引导条”组件（开发/生产/财务）
- 统一错误提示协议（问题+原因+修复入口）
- 小程序扫码页反馈增强

### Sprint-2（中风险）
- 生产预检查提示（重复扫/阶段错配/库存不足）
- 财务差异解释面板（只读）
- 系统权限防呆提示

### Sprint-3（可选）
- 词条待审核池
- 智能推荐排序（基于最近行为）

---

## 6. 你最关心的“不会加学习成本”落地规则
- 新增信息只出现在用户原本会看的位置（页头、弹窗顶部、提交后提示）。
- 新增入口统一命名：`下一步`、`去修复`、`一键填充`，不造新术语。
- 禁止引入新流程页，优先在原页面“就地增强”。

---

## 7. 下一步（先评审后开发）
评审通过后，我会按以下方式执行：
1) 每次只改一个模块（开发/生产/财务/系统）。
2) 每次改动都带“走查 + 统一质检”报告。
3) 每个模块完成后先灰度给你试用，再扩大范围。
