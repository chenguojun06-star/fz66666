# 📱 小程序延期订单功能使用指南

**更新时间**: 2026-02-10  
**功能版本**: v1.0  
**状态**: ✅ 已实现

---

## 🎯 功能概述

小程序新增**延期订单归纳与提醒功能**，帮助用户快速发现和处理超期订单：

### 核心功能
1. ✅ **订单时间排序** - 订单列表按创建时间从新到老排序
2. ✅ **延期订单归纳** - 铃铛提醒中统计并显示所有延期订单
3. ✅ **分级提醒** - 根据延期天数分为严重/紧急/轻度三个等级
4. ✅ **一键跳转** - 点击延期订单可直接跳转到订单详情并高亮显示

---

## 📋 延期订单分级标准

| 延期天数 | 等级 | 颜色标识 | 优先级 |
|---------|------|---------|-------|
| **> 7天** | 🔴 严重延期 | 红色 | 最高 |
| **4-7天** | 🟠 紧急延期 | 橙色 | 高 |
| **1-3天** | 🟡 轻度延期 | 黄色 | 中 |

---

## 🔔 铃铛提醒功能

### 位置
小程序右上角的铃铛按钮

### 显示内容

#### 1. 延期订单统计卡片
```
严重延期 (>7天)     3 单
紧急延期 (4-7天)    5 单  
轻度延期 (1-3天)    2 单
```

#### 2. 延期订单详细列表
每个延期订单卡片显示：
- **订单号**: PO20260201001
- **超期标签**: "超期8天" (红色/橙色/黄色)
- **款号**: FZ2024001
- **工厂**: 广州工厂
- **当前工序**: 裁剪
- **完成进度**: 50/100 (50%)
- **进度条**: 可视化显示完成百分比

### 操作流程

```
1. 点击铃铛按钮
   ↓
2. 查看延期订单统计
   ↓
3. 点击任意延期订单
   ↓
4. 自动跳转到工作页面
   ↓
5. 订单高亮显示（蓝色边框 + 呼吸动画）
```

---

## 📑 工作页面订单列表

### 时间排序
所有订单按**创建时间从新到老**排序，确保最新订单在前。

### 延期订单视觉标识

#### 左侧红色边框
延期订单左侧有**红色竖线**标识，便于快速识别

#### 订单号后显示延期标签
```
PO20260201001  ⏰延期
```

#### 交期信息显示
```
交期：2026-01-28    超期8天
```

### 高亮显示
从铃铛跳转的订单会有：
- 蓝色边框
- 呼吸动画效果（2秒）
- 阴影加强

---

## 🚀 使用场景示例

### 场景 1：每日检查延期订单

```
1. 打开小程序
2. 查看右上角铃铛（有红色数字提示）
3. 点击铃铛
4. 查看"延期订单"部分
5. 了解延期订单数量和分布
```

### 场景 2：处理严重延期订单

```
1. 点击铃铛
2. 查看"严重延期 (>7天)" 统计
3. 点击任一严重延期订单
4. 跳转到订单详情（高亮显示）
5. 查看订单进度和当前工序
6. 采取相应措施（扫码、调度等）
```

### 场景 3：批量处理延期订单

```
1. 在铃铛中记录所有延期订单号
2. 前往工作页面
3. 使用搜索框逐个定位
4. 或按时间顺序处理（已自动排序）
```

---

## 📊 数据统计

### 延期订单统计包含

- **总数**: 所有延期订单数量
- **严重/紧急/轻度**: 分级统计
- **总订单量**: 所有延期订单的总数量
- **已完成量**: 所有延期订单已完成的数量
- **完成率**: 总完成百分比

### 示例显示

```
延期订单 (10)

严重延期 (>7天)     3
紧急延期 (4-7天)    5
轻度延期 (1-3天)    2

订单详情：
PO20260201001  超期8天
款号: FZ2024001 · 广州工厂
工序: 裁剪 · 完成: 50/100 (50%)
[==========----------] 50%
```

---

## 🔧 技术实现

### 文件结构

```
miniprogram/
├── components/floating-bell/
│   ├── index.js                    # 铃铛组件主逻辑
│   ├── index.wxml                  # 铃铛组件UI（含延期订单部分）
│   ├── index.wxss                  # 铃铛组件样式（含延期样式）
│   ├── bellTaskLoader.js           # 任务加载器（包含延期订单）
│   ├── bellTaskActions.js          # 任务点击处理（包含跳转）
│   └── overdueOrderLoader.js       # 延期订单专用加载器（新增）
└── pages/work/
    ├── index.js                     # 工作页面（含排序和高亮）
    ├── index.wxml                   # 订单列表UI（含延期标识）
    └── index.wxss                   # 订单列表样式（含高亮样式）
```

### 核心逻辑

#### 1. 延期判断
```javascript
// 计算超期天数
function calculateOverdueDays(deadline) {
  const now = new Date();
  const deadlineDate = new Date(deadline);
  const diffDays = Math.floor((now - deadlineDate) / (1000 * 60 * 60 * 24));
  return diffDays; // 正数表示超期
}
```

#### 2. 分级标识
```javascript
// 格式化超期信息
function formatOverdueInfo(overdueDays) {
  if (overdueDays > 7) return { text: `超期${overdueDays}天`, level: 'critical' };
  if (overdueDays > 3) return { text: `超期${overdueDays}天`, level: 'urgent' };
  return { text: `超期${overdueDays}天`, level: 'warning' };
}
```

#### 3. 跳转高亮
```javascript
// 存储需要高亮的订单号
wx.setStorageSync('highlight_order_no', orderNo);

// 跳转
wx.switchTab({ url: '/pages/work/index' });

// 工作页面读取并高亮
const highlightOrderNo = wx.getStorageSync('highlight_order_no');
this.setData({ highlightOrderNo });
```

---

## 🎨 UI/UX 设计

### 颜色方案

| 元素 | 颜色 | 用途 |
|-----|------|------|
| 严重延期背景 | #fee2e2 → #fecaca | 卡片背景渐变 |
| 严重延期边框 | #f87171 | 分隔线 |
| 严重延期文字 | #dc2626 | 标签文字 |
| 紧急延期背景 | #fed7aa → #fdba74 | 卡片背景渐变 |
| 轻度延期背景 | #fef3c7 → #fde68a | 卡片背景渐变 |
| 高亮边框 | #3b82f6 | 跳转高亮 |

### 动画效果

#### 高亮呼吸动画
```css
@keyframes highlight-pulse {
  0%, 100% { box-shadow: 0 4rpx 16rpx rgba(59, 130, 246, 0.2); }
  50% { box-shadow: 0 4rpx 24rpx rgba(59, 130, 246, 0.4); }
}
```

#### 进度条过渡
```css
.progress-fill {
  transition: width 0.3s ease;
}
```

---

## ⚡ 性能优化

### 数据加载策略

1. **分页加载**: 延期订单最多加载100条（避免性能问题）
2. **并行加载**: 延期订单与其他任务并行加载
3. **本地排序**: 获取数据后前端排序，减少服务器压力

### 刷新策略

1. **页面显示刷新**: 每次进入页面自动刷新
2. **手动刷新**: 铃铛面板提供刷新按钮
3. **后台轮询**: 工作页面30秒轮询一次（已有）

---

## 🐛 常见问题

### Q: 为什么铃铛没有显示延期订单？

**A**: 可能原因：
1. 当前没有延期订单
2. 网络请求失败（查看控制台）
3. 订单数据中缺少交期字段

### Q: 点击延期订单后没有跳转？

**A**: 检查：
1. 是否点击了订单卡片（不是统计卡片）
2. 控制台是否有错误
3. 工作页面是否配置为 tabBar

### Q: 订单列表排序不正确？

**A**: 确认：
1. 订单数据中是否有 `createdAt` 或 `createTime` 字段
2. 字段格式是否为标准时间格式
3. 是否在正确的标签页（全部/采购/裁剪等）

---

## 🔄 版本更新

### v1.0 (2026-02-10)

#### 新增功能
- ✅ 延期订单自动识别和分级
- ✅ 铃铛提醒中显示延期订单归纳
- ✅ 延期订单统计卡片（严重/紧急/轻度）
- ✅ 订单列表按时间排序
- ✅ 点击跳转和高亮显示
- ✅ 延期订单左侧红色边框标识

#### 技术优化
- ✅ 创建独立的延期订单加载器
- ✅ 优化铃铛组件性能
- ✅ 添加跳转动画效果
- ✅ 响应式UI设计

---

## 📝 开发者备注

### 数据依赖

延期订单功能依赖以下字段：
- `id` - 订单ID
- `orderNo` - 订单号
- `styleNo` - 款号
- `factoryName` - 工厂名称
- `orderQuantity` - 订单数量
- `completedQuantity` - 完成数量
- `currentProcessName` - 当前工序
- `progress` - 进度百分比
- `deadline` 或 `deliveryDate` - 交期日期（**必需**）
- `createdAt` 或 `createTime` - 创建时间

### API 端点

- **订单列表**: `/api/production/order/list`
  - 参数: `{ page, pageSize, orderNo?, styleNo?, factoryName?, currentProcessName? }`
  - 返回: `{ records: [...], total, pages }`

### 扩展建议

1. **后端优化**: 添加 `isOverdue` 字段，后端直接标识延期订单
2. **推送通知**: 严重延期订单主动推送通知
3. **数据分析**: 统计延期订单趋势图
4. **批量操作**: 支持批量调整延期订单的交期
5. **权限控制**: 只有管理员可见所有延期订单

---

## 🎓 使用建议

### 最佳实践

1. **每日检查**: 建议每天上班第一件事检查延期订单
2. **按优先级处理**: 优先处理严重延期订单
3. **及时沟通**: 发现延期订单及时与客户沟通
4. **调整计划**: 根据延期情况调整生产计划

### 角色建议

| 角色 | 使用重点 |
|------|---------|
| **生产主管** | 每日检查延期统计，分配资源 |
| **车间工人** | 查看自己负责订单是否延期 |
| **客服** | 提前通知客户延期情况 |
| **管理员** | 分析延期趋势，优化流程 |

---

**文档维护**: AI Assistant  
**最后更新**: 2026-02-10  
**反馈渠道**: 通过小程序反馈功能提交建议
