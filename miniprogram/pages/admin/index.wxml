<view class="container">
  <!-- é€šç”¨æ‚¬æµ®é“ƒé“›ç»„ä»¶ -->
  <floating-bell />

  <view class="card">
    <view class="title-row">
      <view class="title-left-group">
        <view class="title">æˆ‘çš„</view>
        <view class="logout-btn" bindtap="onLogout">
          <text class="logout-text">é€€å‡º</text>
        </view>
      </view>
    </view>

    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <view wx:if="{{userInfo}}" class="user-profile-card">
      <view class="profile-avatar">{{avatarLetter}}</view>
      <view class="profile-name">{{userInfo.name || userInfo.username || 'æœªçŸ¥ç”¨æˆ·'}}</view>
      <view class="profile-role">{{roleDisplayName || 'æ™®é€šç”¨æˆ·'}}</view>
      <view wx:if="{{showApprovalEntry}}" class="profile-online">
        <text class="online-icon">ğŸ‘¥</text>
        <text>{{onlineCount}}äºº</text>
      </view>
    </view>

    <!-- ä¿®æ”¹å¯†ç å…¥å£ -->
    <view class="action-row" bindtap="onShowChangePwd">
      <text class="action-row-label">ğŸ”’ ä¿®æ”¹å¯†ç </text>
      <text class="action-row-arrow">â€º</text>
    </view>

    <!-- ä¿®æ”¹å¯†ç è¡¨å•ï¼ˆå±•å¼€ï¼‰ -->
    <view wx:if="{{showChangePwd}}" class="change-pwd-panel">
      <view class="change-pwd-title">ä¿®æ”¹å¯†ç </view>
      <view class="change-pwd-field">
        <text class="field-label">åŸå¯†ç </text>
        <input class="field-input" type="safe-password" placeholder="è¯·è¾“å…¥åŸå¯†ç " bindinput="onOldPwdInput" value="{{pwdForm.oldPassword}}" password="{{true}}" />
      </view>
      <view class="change-pwd-field">
        <text class="field-label">æ–°å¯†ç </text>
        <input class="field-input" type="safe-password" placeholder="æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" bindinput="onNewPwdInput" value="{{pwdForm.newPassword}}" password="{{true}}" />
      </view>
      <view class="change-pwd-field">
        <text class="field-label">ç¡®è®¤æ–°å¯†ç </text>
        <input class="field-input" type="safe-password" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " bindinput="onConfirmPwdInput" value="{{pwdForm.confirmPassword}}" password="{{true}}" />
      </view>
      <view class="change-pwd-btns">
        <view class="pwd-btn-cancel" bindtap="onCancelChangePwd">å–æ¶ˆ</view>
        <view class="pwd-btn-confirm {{savingPwd ? 'disabled' : ''}}" bindtap="onSubmitChangePwd">{{savingPwd ? 'æäº¤ä¸­...' : 'ç¡®è®¤ä¿®æ”¹'}}</view>
      </view>
    </view>

    <!-- é‚€è¯·å‘˜å·¥åŠ å…¥å·¥å‚ï¼ˆç§Ÿæˆ·ç®¡ç†å‘˜ä¸“ç”¨ï¼‰ -->
    <view wx:if="{{showInviteSection}}" class="invite-card">
      <view class="invite-title">
        <text class="invite-icon">ğŸ‘¥</text>
        <text>é‚€è¯·å‘˜å·¥åŠ å…¥</text>
      </view>
      <view class="invite-desc">å°†ä»¥ä¸‹å·¥å‚ç å‘ç»™å‘˜å·¥ï¼Œå‘˜å·¥åœ¨æ³¨å†Œé¡µè¾“å…¥å³å¯ç”³è¯·åŠ å…¥</view>
      <view class="invite-code-row">
        <view class="invite-code">{{tenantCode || 'æš‚æ— å·¥å‚ç '}}</view>
        <view class="invite-copy-btn" bindtap="onCopyTenantCode">å¤åˆ¶å·¥å‚ç </view>
      </view>
      <view class="invite-link-row" bindtap="onCopyInviteUrl">
        <text class="invite-link-text">ğŸ”— å¤åˆ¶PCç«¯æ³¨å†Œé“¾æ¥</text>
      </view>
    </view>

    <!-- é—®é¢˜åé¦ˆå…¥å£ -->
    <view class="action-row" bindtap="onShowFeedbackForm">
      <text class="action-row-label">ğŸ“ é—®é¢˜åé¦ˆ</text>
      <text class="action-row-arrow">â€º</text>
    </view>

    <!-- é—®é¢˜åé¦ˆè¡¨å•ï¼ˆå±•å¼€ï¼‰ -->
    <view wx:if="{{showFeedbackForm}}" class="change-pwd-panel">
      <view class="change-pwd-title">æäº¤é—®é¢˜åé¦ˆ</view>
      <view class="change-pwd-field">
        <text class="field-label">é—®é¢˜ç±»å‹</text>
        <picker class="field-input" mode="selector" range="{{['Bugç¼ºé™·', 'åŠŸèƒ½å»ºè®®', 'ä½¿ç”¨ç–‘é—®', 'å…¶ä»–']}}" value="{{['BUG','SUGGESTION','QUESTION','OTHER'].indexOf(feedbackForm.category)}}" bindchange="onFeedbackCategoryChange">
          <view class="picker-value">{{feedbackForm.category === 'BUG' ? 'Bugç¼ºé™·' : feedbackForm.category === 'SUGGESTION' ? 'åŠŸèƒ½å»ºè®®' : feedbackForm.category === 'QUESTION' ? 'ä½¿ç”¨ç–‘é—®' : 'å…¶ä»–'}}</view>
        </picker>
      </view>
      <view class="change-pwd-field">
        <text class="field-label">æ ‡é¢˜</text>
        <input class="field-input" placeholder="ç®€è¦æè¿°é—®é¢˜" bindinput="onFeedbackTitleInput" value="{{feedbackForm.title}}" maxlength="100" />
      </view>
      <view class="change-pwd-field">
        <text class="field-label">è¯¦ç»†æè¿°</text>
        <textarea class="field-textarea" placeholder="è¯·è¯¦ç»†æè¿°é‡åˆ°çš„é—®é¢˜ã€æ“ä½œæ­¥éª¤ç­‰" bindinput="onFeedbackContentInput" value="{{feedbackForm.content}}" maxlength="2000" auto-height="{{true}}" />
      </view>
      <view class="change-pwd-field">
        <text class="field-label">è”ç³»æ–¹å¼</text>
        <input class="field-input" placeholder="æ‰‹æœºå·æˆ–å¾®ä¿¡å·ï¼ˆé€‰å¡«ï¼‰" bindinput="onFeedbackContactInput" value="{{feedbackForm.contact}}" />
      </view>
      <view class="change-pwd-btns">
        <view class="pwd-btn-cancel" bindtap="onCloseFeedbackForm">å–æ¶ˆ</view>
        <view class="pwd-btn-confirm {{submittingFeedback ? 'disabled' : ''}}" bindtap="onSubmitFeedback">{{submittingFeedback ? 'æäº¤ä¸­...' : 'æäº¤åé¦ˆ'}}</view>
      </view>
    </view>

    <!-- æˆ‘çš„åé¦ˆå†å² -->
    <view class="action-row" bindtap="onToggleMyFeedbacks">
      <text class="action-row-label">ğŸ“‹ æˆ‘çš„åé¦ˆ</text>
      <text class="action-row-arrow">{{showMyFeedbacks ? 'âˆ¨' : 'â€º'}}</text>
    </view>
    <view wx:if="{{showMyFeedbacks}}" class="feedback-list">
      <view wx:if="{{myFeedbacks.length === 0}}" class="hint">æš‚æ— åé¦ˆè®°å½•</view>
      <view wx:for="{{myFeedbacks}}" wx:key="id" class="feedback-item">
        <view class="feedback-item-head">
          <text class="feedback-item-title">{{item.title}}</text>
          <text class="feedback-status feedback-status-{{item.status}}">{{item.status === 'PENDING' ? 'å¾…å¤„ç†' : item.status === 'PROCESSING' ? 'å¤„ç†ä¸­' : item.status === 'RESOLVED' ? 'å·²è§£å†³' : 'å·²å…³é—­'}}</text>
        </view>
        <view class="feedback-item-content">{{item.content}}</view>
        <view wx:if="{{item.reply}}" class="feedback-item-reply">
          <text class="reply-label">å›å¤ï¼š</text>
          <text>{{item.reply}}</text>
        </view>
        <view class="feedback-item-time">{{item.createTime}}</view>
      </view>
    </view>

    <!-- åŠŸèƒ½å¯¼èˆªè¡Œ -->
    <view class="nav-row">
      <view class="user-info-item">
        <text class="user-info-label">å½“æœˆå·¥èµ„</text>
        <text class="user-info-text">{{stats && stats.totalAmount != null ? stats.totalAmount : 0}}</text>
      </view>
      <view class="user-info-item {{loadingStats || loadingHistory ? 'disabled' : ''}}" bindtap="refreshAll">
        <text class="user-info-label">åˆ·æ–°</text>
      </view>
    </view>

    <!-- å·¥èµ„æ˜ç»†é¢æ¿ï¼ˆå›ºå®šåœ¨ä¸Šæ–¹ï¼‰ -->
    <view class="section-title">å·¥èµ„æ˜ç»†ï¼ˆæœ¬æœˆï¼‰</view>
    <view wx:if="{{loadingStats}}" class="hint">åŠ è½½ä¸­...</view>
    <view wx:if="{{stats}}" class="stat-grid">
      <view class="stat-card">
        <view class="stat-value">{{stats.scanCount || 0}}</view>
        <view class="stat-label">æ¬¡æ•°</view>
      </view>
      <view class="stat-card">
        <view class="stat-value">{{stats.orderCount || 0}}</view>
        <view class="stat-label">è®¢å•</view>
      </view>
      <view class="stat-card">
        <view class="stat-value">{{stats.totalQuantity || 0}}</view>
        <view class="stat-label">æ•°é‡</view>
      </view>
      <view class="stat-card">
        <view class="stat-value">{{stats.totalAmount || 0}}</view>
        <view class="stat-label">é‡‘é¢</view>
      </view>
    </view>
    <view wx:if="{{!stats && !loadingStats}}" class="hint">æš‚æ— ç»Ÿè®¡</view>

    <!-- æ‰«ç è®°å½•åˆ—è¡¨ï¼ˆæ»šåŠ¨åŒºåŸŸï¼‰ -->
    <view class="section-title" style="margin-top: 32rpx;">æ‰«ç è®°å½•åˆ—è¡¨</view>
    <view wx:if="{{history.list.length === 0 && !loadingHistory}}" class="hint">æš‚æ— è®°å½•</view>
    <view wx:for="{{history.list}}" wx:key="id" class="list-item">
      <view class="item-head">
        <view class="item-title">{{item.orderNo || '-'}}</view>
        <text class="tag">{{item.processName || item.progressStage || item.scanType || '-'}}</text>
      </view>
      <view class="item-fields">
        <text class="item-field">é¢œè‰²ï¼š{{item.color || '-'}}</text>
        <text class="item-field">å°ºç ï¼š{{item.size || '-'}}</text>
        <text class="item-field">æ•°é‡ï¼š{{item.quantity || 0}}</text>
        <text class="item-field">å•ä»·ï¼š{{item.unitPrice == null || item.unitPrice === '' ? '-' : item.unitPrice}}</text>
        <text class="item-field">é‡‘é¢ï¼š{{item.amount || item.totalAmount || item.salaryAmount || 0}}</text>
      </view>
      <view wx:if="{{item.scanTime}}" class="item-sub">æ—¶é—´ï¼š{{item.scanTime}}</view>
    </view>
  </view>
</view>
