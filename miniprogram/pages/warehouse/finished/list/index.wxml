<view class="container">
  <!-- æœç´¢æ  -->
  <view class="search-bar">
    <view class="search-input-wrap">
      <icon type="search" size="14" color="#999" />
      <input
        class="search-input"
        placeholder="æœç´¢æ¬¾å·/æ¬¾å"
        value="{{keyword}}"
        bindinput="onKeywordInput"
        bindconfirm="onSearch"
      />
    </view>
  </view>

  <!-- ç»Ÿè®¡æ  -->
  <view class="summary-filter-bar">
    <view class="summary-pill summary-pill-active">
      <text class="summary-label">æˆå“æ€»æ•°</text>
      <text class="summary-value">{{stats.totalQty}}</text>
    </view>
    <view class="summary-pill">
      <text class="summary-label">å¯ç”¨åº“å­˜</text>
      <text class="summary-value green">{{stats.availableQty}}</text>
    </view>
    <view class="summary-pill">
      <text class="summary-label">æ¬¡å“</text>
      <text class="summary-value {{stats.defectQty > 0 ? 'red' : ''}}">{{stats.defectQty}}</text>
    </view>
  </view>

  <!-- åˆ—è¡¨å†…å®¹ -->
  <scroll-view
    scroll-y
    class="list-container"
    bindscrolltolower="onLoadMore"
    refresher-enabled
    refresher-triggered="{{isRefreshing}}"
    bindrefresherrefresh="onRefresh"
  >
    <block wx:if="{{list.length > 0}}">
      <view class="list-item" wx:for="{{list}}" wx:key="id">
        <!-- å›¾ç‰‡ -->
        <image
          wx:if="{{item.imageUrl}}"
          class="item-img"
          src="{{item.imageUrl}}"
          mode="aspectFill"
          data-index="{{index}}"
          binderror="onImageError"
        />
        <view wx:else class="item-img-placeholder">
          <text>æš‚æ— å›¾ç‰‡</text>
        </view>

        <!-- ä¿¡æ¯åŒº -->
        <view class="item-content">
          <!-- æ“ä½œæŒ‰é’® -->
          <view class="item-op-row">
            <view
              class="item-op-btn item-op-btn-primary"
              bindtap="openOutstockModal"
              data-index="{{index}}"
            >å‡ºåº“</view>
          </view>

          <!-- æ¬¾å· + æ¬¾å -->
          <view class="item-header">
            <text class="item-title">{{item.styleNo}}</text>
          </view>
          <view class="item-desc">{{item.styleName || 'æœªå‘½åæ¬¾å¼'}}</view>

          <!-- é¢œè‰² & å°ºç  -->
          <view class="item-tags-row">
            <text class="tag tag-color" wx:for="{{item.colors}}" wx:key="*this" wx:for-item="c">{{c}}</text>
          </view>
          <view class="item-tags-row" wx:if="{{item.sizes.length > 0}}">
            <text class="tag tag-size" wx:for="{{item.sizes}}" wx:key="*this" wx:for-item="s">{{s}}</text>
          </view>

          <!-- åº“å­˜çŠ¶æ€ -->
          <view class="item-stock">
            <view class="stock-info">
              <text class="label">å¯ç”¨</text>
              <text class="value green">{{item.availableQty}}</text>
              <text class="unit">ä»¶</text>
            </view>
            <view class="stock-info">
              <text class="label">é”å®š</text>
              <text class="value orange">{{item.lockedQty}}</text>
              <text class="unit">ä»¶</text>
            </view>
            <view class="stock-info">
              <text class="label">æ¬¡å“</text>
              <text class="value red">{{item.defectQty}}</text>
              <text class="unit">ä»¶</text>
            </view>
          </view>
        </view>
      </view>
    </block>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:elif="{{!loading}}" class="empty-state">
      <image src="/assets/icons/empty.svg" mode="widthFix" class="empty-img" />
      <text>æš‚æ— æˆå“åº“å­˜æ•°æ®</text>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="loading-more" wx:if="{{loading}}">
      <text>åŠ è½½ä¸­...</text>
    </view>
    <view class="no-more" wx:if="{{!hasMore && list.length > 0}}">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
  </scroll-view>

  <!-- å‡ºåº“å¼¹çª— â€”â€” mp-modal é€šç”¨ç»„ä»¶ -->
  <mp-modal
    visible="{{modal.visible}}"
    title="æˆå“å‡ºåº“ - å¤šå°ºç æ˜ç»†"
    show-close="{{false}}"
  >
    <view class="modal-body">
        <!-- åŸºç¡€ä¿¡æ¯ -->
        <view class="modal-row">
          <text class="label">æ¬¾å·</text>
          <text class="value">{{modal.order.styleNo || '-'}}</text>
        </view>
        <view class="modal-row">
          <text class="label">æ¬¾å¼åç§°</text>
          <text class="value">{{modal.order.styleName || '-'}}</text>
        </view>
        <view class="modal-row">
          <text class="label">å¯ç”¨åº“å­˜</text>
          <text class="value">{{modal.order.availableQty || 0}} ä»¶</text>
        </view>

        <!-- SKUåˆ—è¡¨ -->
        <view class="sku-section">
          <view class="section-title">ğŸ“‹ è¯·é€‰æ‹©éœ€è¦å‡ºåº“çš„é¢œè‰²å’Œå°ºç ï¼š</view>

          <view wx:if="{{modal.loadingSkus}}" class="loading-skus">
            <text>åŠ è½½SKUä¿¡æ¯ä¸­...</text>
          </view>

          <view wx:elif="{{modal.skuList.length > 0}}" class="sku-list">
            <view class="sku-item" wx:for="{{modal.skuList}}" wx:key="sku">
              <view class="sku-info">
                <view class="sku-header">
                  <text class="sku-color">{{item.color}}</text>
                  <text class="sku-size">{{item.size}}</text>
                </view>
                <view class="sku-stock">
                  <text class="stock-label">å¯ç”¨:</text>
                  <text class="stock-value">{{item.availableQty}}</text>
                </view>
              </view>
              <view class="sku-qty-input">
                <input
                  class="qty-input"
                  type="number"
                  placeholder="0"
                  value="{{item.outboundQty}}"
                  data-index="{{index}}"
                  bindinput="onSkuQtyInput"
                />
                <view class="max-btn" data-index="{{index}}" bindtap="onFillMaxQty">MAX</view>
              </view>
            </view>
          </view>

          <view wx:else class="empty-skus">
            <text>è¯¥æ¬¾å¼æš‚æ— å¯ç”¨åº“å­˜</text>
          </view>
        </view>

        <!-- æ±‡æ€»ä¿¡æ¯ -->
        <view class="summary-section">
          <view class="summary-row">
            <text class="summary-label">æ€»å‡ºåº“æ•°é‡</text>
            <text class="summary-value">{{modal.totalOutbound}} ä»¶</text>
          </view>
        </view>

        <!-- å¤‡æ³¨ -->
        <view class="modal-row">
          <text class="label">å¤‡æ³¨</text>
          <textarea class="modal-textarea" placeholder="é€‰å¡«" value="{{modal.remark}}" bindinput="onModalRemarkInput" />
        </view>
      </view>
    <view class="modal-actions">
        <view class="btn cancel" bindtap="closeOutstockModal">å–æ¶ˆ</view>
        <view class="btn ok {{modal.submitting || modal.totalOutbound === 0 ? 'disabled' : ''}}" bindtap="onConfirmOutstock">
          {{modal.submitting ? 'æäº¤ä¸­...' : 'ç¡®è®¤å‡ºåº“'}}
        </view>
      </view>
  </mp-modal>
</view>
