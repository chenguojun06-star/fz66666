<view class="container">
  <view class="header">
    <text class="title">面辅料需求排行</text>
    <text class="subtitle">按近{{days}}天出库频率计算</text>
  </view>

  <view class="toolbar">
    <view class="days-tabs">
      <view class="tab {{days === 7 ? 'active' : ''}}" data-days="7" bindtap="onChangeDays">7天</view>
      <view class="tab {{days === 30 ? 'active' : ''}}" data-days="30" bindtap="onChangeDays">30天</view>
      <view class="tab {{days === 60 ? 'active' : ''}}" data-days="60" bindtap="onChangeDays">60天</view>
    </view>
    <view class="need-switch {{onlyNeed ? 'on' : ''}}" bindtap="onToggleNeedOnly">
      {{onlyNeed ? '仅缺料' : '全部'}}
    </view>
  </view>

  <view wx:if="{{loading}}" class="loading">加载中...</view>

  <view wx:if="{{!loading && list.length === 0}}" class="empty">
    <image class="empty-img" src="/assets/icons/empty.svg" mode="widthFix" />
    <text>暂无库存预警</text>
  </view>

  <view class="ranking-list">
    <view
      wx:for="{{list}}"
      wx:key="stockId"
      class="ranking-item"
      bindtap="onItemTap"
      data-item="{{item}}"
    >
      <view class="item-head">
        <view class="rank-badge">{{index + 1}}</view>
        <view class="rank-info">
          <text class="rank-title">{{item.materialName || item.materialCode || '物料'}}</text>
          <text class="rank-sub">编码：{{item.materialCode || '-'}} · 类型：{{item.materialTypeText || '-'}}</text>
        </view>
        <view class="rank-count {{item.shortage > 0 ? 'warn' : 'ok'}}">
          {{item.shortage > 0 ? ('缺 ' + item.shortage) : '充足'}}
        </view>
      </view>
      <view class="item-metrics">
        <view class="metric"><text class="m-label">规格</text><text class="m-value">{{item.specText}}</text></view>
        <view class="metric"><text class="m-label">库存</text><text class="m-value">{{item.quantity || 0}} {{item.unit || ''}}</text></view>
        <view class="metric"><text class="m-label">建议水位</text><text class="m-value">{{item.suggestedSafetyStock || item.safetyStock || 0}}</text></view>
        <view class="metric"><text class="m-label">近{{days}}天出库</text><text class="m-value">{{item.recentOutQuantity || 0}}</text></view>
      </view>
      <view class="item-actions">
        <view class="action secondary" catchtap="onViewDetailTap" data-item="{{item}}">查看明细</view>
        <view class="action primary" catchtap="onQuickOrderTap" data-item="{{item}}">快捷下发</view>
      </view>
    </view>
  </view>

  <view class="btn" bindtap="goScan">去扫码</view>

  <!-- 采购指令弹窗 —— mp-modal 通用组件 -->
  <mp-modal
    visible="{{orderModal.visible}}"
    title="下发采购指令"
    show-close="{{false}}"
  >
    <view class="mf-body">
      <view class="mf-section">
        <view class="mf-section-title">{{orderModal.item.materialName || orderModal.item.materialCode}}</view>
      </view>
      <view class="mf-kv-list">
        <view class="mf-kv"><text class="mf-kv-key">编码</text><text class="mf-kv-val">{{orderModal.item.materialCode || '-'}}</text></view>
        <view class="mf-kv"><text class="mf-kv-key">规格</text><text class="mf-kv-val">{{orderModal.item.specText || '-'}}</text></view>
        <view class="mf-kv"><text class="mf-kv-key">库存</text><text class="mf-kv-val">{{orderModal.item.quantity || 0}} {{orderModal.item.unit || ''}} / 建议：{{orderModal.item.safetyStock || 0}}</text></view>
        <view class="mf-kv"><text class="mf-kv-key">缺口</text><text class="mf-kv-val">{{orderModal.shortage || 0}}</text></view>
        <view class="mf-kv"><text class="mf-kv-key">单件用量</text><text class="mf-kv-val">{{orderModal.item.perPieceUsage || '-'}}</text></view>
        <view class="mf-kv"><text class="mf-kv-key">可生产</text><text class="mf-kv-val">{{orderModal.item.minProductionQty || '-'}} ~ {{orderModal.item.maxProductionQty || '-'}}</text></view>
      </view>
      <view class="mf-item">
        <text class="mf-label">采购数量</text>
        <view class="qty-picker">
          <view class="qty-btn" data-delta="-1" bindtap="onQtyStep">-</view>
          <input class="qty-input" type="number" value="{{orderModal.quantity}}" bindinput="onQtyInput" />
          <view class="qty-btn" data-delta="1" bindtap="onQtyStep">+</view>
          <view class="qty-shortage" bindtap="onUseShortageQty">按缺口</view>
        </view>
      </view>
      <view class="mf-item">
        <text class="mf-label">备注</text>
        <textarea class="mf-textarea" value="{{orderModal.remark}}" bindinput="onRemarkInput" placeholder="可选" />
      </view>
    </view>
    <view class="mf-actions">
      <view class="mf-btn cancel" bindtap="onCancelOrder">取消</view>
      <view class="mf-btn ok" bindtap="onConfirmOrder">
        {{orderModal.submitting ? '提交中...' : '下发'}}
      </view>
    </view>
  </mp-modal>
</view>
