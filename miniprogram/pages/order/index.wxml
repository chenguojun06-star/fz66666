<view class="container">
  <floating-bell />

  <!-- æœç´¢æ  -->
  <view class="search-row">
    <view class="search-box">
      <text class="search-icon">ğŸ”</text>
      <input class="search-input" placeholder="æœç´¢æ¬¾å·/æ¬¾å" value="{{keyword}}" bindinput="onSearchInput" confirm-type="search" bindconfirm="doSearch" />
      <text wx:if="{{keyword}}" class="search-clear" bindtap="clearSearch">âœ•</text>
    </view>
    <view class="search-btn" hover-class="search-btn-hover" bindtap="doSearch">æœç´¢</view>
  </view>

  <!-- æ¬¾å¼å¡ç‰‡åˆ—è¡¨ -->
  <view wx:if="{{loading && styles.length === 0}}" class="hint">åŠ è½½ä¸­...</view>

  <!-- é”™è¯¯æç¤ºï¼ˆAPI å¤±è´¥æ—¶æ˜¾ç¤ºï¼‰ -->
  <view wx:elif="{{errorMsg}}" class="error-state">
    <text class="error-icon">âš ï¸</text>
    <text class="error-text">{{errorMsg}}</text>
    <view class="retry-btn" hover-class="retry-btn-hover" bindtap="retryLoad">ç‚¹å‡»é‡è¯•</view>
  </view>

  <view wx:elif="{{!loading && styles.length === 0}}" class="empty-state">
    <text class="empty-icon">ğŸ“‹</text>
    <text class="empty-text">æš‚æ— æ¬¾å¼æ•°æ®</text>
    <text class="empty-hint">è¯·å…ˆåœ¨PCç«¯åˆ›å»ºæ¬¾å¼</text>
    <view class="retry-btn" hover-class="retry-btn-hover" bindtap="retryLoad">åˆ·æ–°è¯•è¯•</view>
  </view>

  <!-- æ’è¡Œç»Ÿè®¡ -->
  <view wx:if="{{styles.length > 0 && !keyword}}" class="rank-summary">
    <text class="rank-summary-title">ä¸‹å•æ’è¡Œ TOP{{styles.length}}</text>
    <text class="rank-summary-sub">æŒ‰ä¸‹å•æ¬¡æ•°æ’åº Â· æ•°æ®ä¸PCåŒæ­¥</text>
  </view>

  <view wx:for="{{styles}}" wx:key="id" class="style-card" hover-class="style-card-hover">
    <view class="card-body">
      <!-- æ’åå¾½æ ‡ -->
      <view wx:if="{{item.rank && !keyword}}" class="rank-badge rank-{{item.rank <= 3 ? 'top' : 'normal'}}">{{item.rank}}</view>
      <!-- å·¦ä¾§å°é¢å›¾ -->
      <view class="card-cover-box">
        <image wx:if="{{item.cover}}" class="card-cover" src="{{item.cover}}" mode="aspectFill" lazy-load />
        <view wx:else class="card-cover-empty">æš‚æ— \nå›¾ç‰‡</view>
      </view>
      <!-- å³ä¾§ä¿¡æ¯ -->
      <view class="card-info">
        <view class="card-head">
          <text class="card-title">{{item.styleNo || '-'}}</text>
          <text wx:if="{{item.orderCount > 0}}" class="order-tag order-tag-has">{{item.orderCount}}æ¬¡ä¸‹å•</text>
          <text wx:else class="order-tag order-tag-none">æœªä¸‹å•</text>
        </view>
        <text class="card-subtitle">{{item.styleName || '-'}}</text>
        <view class="card-meta-row">
          <text class="meta-label">ç æ•°</text>
          <text class="meta-value">{{item.size || '-'}}</text>
          <text class="meta-sep">ï½œ</text>
          <text class="meta-label">æ•°é‡</text>
          <text class="meta-value meta-value-bold">{{item.displayQty}}</text>
        </view>
        <view class="card-meta-row">
          <text class="meta-label">ä¸‹å•</text>
          <text class="meta-value">{{item.latestOrderTimeShort || '-'}}</text>
          <text class="meta-sep">ï½œ</text>
          <text class="meta-label">ä¸‹å•äºº</text>
          <text class="meta-value">{{item.latestOrderCreator || '-'}}</text>
        </view>
        <view class="card-actions">
          <view class="action-btn" hover-class="action-btn-hover" data-index="{{index}}" bindtap="openCreateOrder">ä¸‹å•</view>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view wx:if="{{styles.length > 0}}" class="load-more-row">
    <view class="load-more-btn {{loading || !hasMore ? 'btn-disabled' : ''}}" bindtap="loadMore">
      {{loading ? 'åŠ è½½ä¸­...' : (hasMore ? 'åŠ è½½æ›´å¤š' : 'æ²¡æœ‰æ›´å¤šäº†')}}
    </view>
  </view>

  <!-- ä¸‹å•å¼¹çª— -->
  <mp-modal visible="{{modal.visible}}" title="{{modal.title}}" size="large" bind:close="closeModal">
    <view class="mf-body">
      <!-- åŸºç¡€ä¿¡æ¯ -->
      <view class="mf-section">
        <text class="mf-section-title">åŸºç¡€ä¿¡æ¯</text>
        <view class="mf-item">
          <text class="mf-label">è®¢å•å· <text class="mf-required">*</text></text>
          <view class="mf-row-input">
            <input class="mf-input mf-flex-1" placeholder="è‡ªåŠ¨ç”Ÿæˆ" value="{{form.orderNo}}" data-field="orderNo" bindinput="onFormInput" />
            <view class="mf-mini-btn" hover-class="mf-mini-btn-hover" bindtap="generateOrderNo">ç”Ÿæˆ</view>
          </view>
        </view>
        <view class="mf-item">
          <text class="mf-label">åŠ å·¥å‚ <text class="mf-required">*</text></text>
          <picker mode="selector" range="{{factoryNames}}" value="{{form.factoryIndex}}" data-field="factoryIndex" bindchange="onFactoryChange">
            <view class="mf-picker">{{form.factoryIndex >= 0 ? factoryNames[form.factoryIndex] : 'è¯·é€‰æ‹©åŠ å·¥å‚'}}<text class="mf-picker-arrow">â–¾</text></view>
          </picker>
        </view>
        <!-- æ€¥å• + å•å‹ åˆå¹¶ä¸€è¡Œ -->
        <view class="mf-2col">
          <view class="mf-col">
            <text class="mf-label">æ€¥å•</text>
            <view class="mf-toggle-row">
              <view class="mf-toggle {{form.urgencyLevel === 'normal' ? 'active' : ''}}" data-val="normal" bindtap="setUrgency">æ™®é€š</view>
              <view class="mf-toggle danger {{form.urgencyLevel === 'urgent' ? 'active' : ''}}" data-val="urgent" bindtap="setUrgency">æ€¥å•</view>
            </view>
          </view>
          <view class="mf-col">
            <text class="mf-label">å•å‹</text>
            <picker mode="selector" range="{{plateTypes}}" range-key="label" value="{{form.plateTypeIndex}}" data-field="plateTypeIndex" bindchange="onPlateTypeChange">
              <view class="mf-picker">{{form.plateTypeIndex >= 0 ? plateTypes[form.plateTypeIndex].label : 'é€‰æ‹©å•å‹'}}<text class="mf-picker-arrow">â–¾</text></view>
            </picker>
          </view>
        </view>
        <view class="mf-item">
          <text class="mf-label">è®¡åˆ’æ—¥æœŸ</text>
          <view class="mf-date-row">
            <picker mode="date" value="{{form.plannedStartDate}}" bindchange="onStartDateChange" class="mf-date-picker">
              <view class="mf-picker">{{form.plannedStartDate || 'å¼€å§‹'}}<text class="mf-picker-arrow">â–¾</text></view>
            </picker>
            <text class="mf-date-sep">â†’</text>
            <picker mode="date" value="{{form.plannedEndDate}}" bindchange="onEndDateChange" class="mf-date-picker">
              <view class="mf-picker">{{form.plannedEndDate || 'ç»“æŸ'}}<text class="mf-picker-arrow">â–¾</text></view>
            </picker>
          </view>
        </view>
      </view>

      <!-- è®¢å•æ˜ç»† -->
      <view class="mf-section">
        <view class="mf-section-head">
          <text class="mf-section-title">è®¢å•æ˜ç»†</text>
          <view class="mf-add-btn" hover-class="mf-add-btn-hover" bindtap="addOrderLine">+ æ·»åŠ </view>
        </view>
        <view wx:if="{{form.orderLines.length === 0}}" class="mf-empty">è¯·æ·»åŠ é¢œè‰²/ç æ•°/æ•°é‡</view>
        <!-- è¡¨å¤´æ ‡ç­¾ -->
        <view wx:if="{{form.orderLines.length > 0}}" class="mf-line-header">
          <text class="mf-line-label col-color">é¢œè‰²</text>
          <text class="mf-line-label col-size">ç æ•°</text>
          <text class="mf-line-label col-qty">æ•°é‡</text>
          <view class="mf-del-placeholder"></view>
        </view>
        <view wx:for="{{form.orderLines}}" wx:key="key" class="mf-line">
          <input class="mf-line-input col-color" placeholder="å¦‚:çº¢" value="{{item.color}}" data-idx="{{index}}" data-field="color" bindinput="onLineInput" />
          <input class="mf-line-input col-size" placeholder="å¦‚:XL" value="{{item.size}}" data-idx="{{index}}" data-field="size" bindinput="onLineInput" />
          <input class="mf-line-input col-qty" type="number" placeholder="ä»¶æ•°" value="{{item.quantity}}" data-idx="{{index}}" data-field="quantity" bindinput="onLineInput" />
          <view class="mf-del" data-idx="{{index}}" bindtap="removeOrderLine">âœ•</view>
        </view>
        <view wx:if="{{form.orderLines.length > 0}}" class="mf-total">
          <text class="mf-total-label">åˆè®¡</text>
          <text class="mf-total-value">{{form.totalQuantity}} ä»¶</text>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="mf-actions">
      <view class="mf-btn cancel" hover-class="mf-btn-hover" bindtap="closeModal">å–æ¶ˆ</view>
      <view class="mf-btn ok {{submitting ? 'disabled' : ''}}" hover-class="mf-btn-hover" bindtap="submitOrder">{{submitting ? 'æäº¤ä¸­...' : 'ç¡®è®¤ä¸‹å•'}}</view>
    </view>
  </mp-modal>
</view>
