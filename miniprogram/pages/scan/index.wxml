<wxs module="utils">
  // æ ¼å¼åŒ–ç›¸å¯¹æ—¶é—´
  function formatRelativeTime(timeStr) {
    if (!timeStr) return '-';

    var now = getDate().getTime();
    var time = getDate(timeStr).getTime();
    var diff = now - time;

    var minute = 60 * 1000;
    var hour = 60 * minute;
    var day = 24 * hour;

    if (diff < minute) {
      return 'åˆšåˆš';
    } else if (diff < hour) {
      return Math.floor(diff / minute) + 'åˆ†é’Ÿå‰';
    } else if (diff < day) {
      return Math.floor(diff / hour) + 'å°æ—¶å‰';
    } else if (diff < 7 * day) {
      return Math.floor(diff / day) + 'å¤©å‰';
    } else {
      var date = getDate(timeStr);
      var month = '' + (date.getMonth() + 1);
      var dayNum = '' + date.getDate();
      var hours = '' + date.getHours();
      var minutes = '' + date.getMinutes();

      if (month.length < 2) month = '0' + month;
      if (dayNum.length < 2) dayNum = '0' + dayNum;
      if (hours.length < 2) hours = '0' + hours;
      if (minutes.length < 2) minutes = '0' + minutes;

      return month + '-' + dayNum + ' ' + hours + ':' + minutes;
    }
  }

  module.exports = {
    formatRelativeTime: formatRelativeTime
  };
</wxs>

<view class="page">
  <!-- é€šç”¨æ‚¬æµ®é“ƒé“›ç»„ä»¶ -->
  <floating-bell />

  <!-- â‘  ä»Šæ—¥ç»Ÿè®¡ï¼ˆé¡¶éƒ¨ï¼‰ -->
  <view class="today-stats-card">
    <view class="tsc-head">
      <text class="tsc-title">ğŸ“Š ä»Šæ—¥ç»Ÿè®¡</text>
      <text class="tsc-refresh {{my.loadingStats ? 'off' : ''}}" bindtap="refreshMy">åˆ·æ–°</text>
    </view>
    <view class="tsc-grid">
      <view class="tsc-item">
        <text class="tsc-num">{{my.stats.scanCount || 0}}</text>
        <text class="tsc-label">æ‰«ç </text>
      </view>
      <view class="tsc-item">
        <text class="tsc-num">{{my.stats.orderCount || 0}}</text>
        <text class="tsc-label">è®¢å•</text>
      </view>
      <view class="tsc-item">
        <text class="tsc-num">{{my.stats.totalQuantity || 0}}</text>
        <text class="tsc-label">æ•°é‡</text>
      </view>
      <view class="tsc-item tsc-hl">
        <text class="tsc-num">Â¥{{my.stats.totalAmount || 0}}</text>
        <text class="tsc-label">æ”¶å…¥</text>
      </view>
    </view>
  </view>

  <!-- â‘¡ å¿«æ·å…¥å£å¡ç‰‡ï¼ˆå†å²è®°å½• | å½“æœˆè®°å½•ï¼‰ -->
  <view class="quick-entry-row">
    <view class="quick-entry-card" hover-class="quick-entry-card-hover" hover-stay-time="100" bindtap="onGoToHistory">
      <text class="qe-icon">ğŸ“‹</text>
      <view class="qe-text">
        <text class="qe-title">å†å²è®°å½•</text>
        <text class="qe-desc">å…¨éƒ¨æ‰«ç è®°å½•</text>
      </view>
    </view>
    <view class="quick-entry-card" hover-class="quick-entry-card-hover" hover-stay-time="100" bindtap="onGoToMonthly">
      <text class="qe-icon">ğŸ“…</text>
      <view class="qe-text">
        <text class="qe-title">å½“æœˆè®°å½•</text>
        <text class="qe-desc">æœ¬æœˆæ±‡æ€»ç»Ÿè®¡</text>
      </view>
    </view>
  </view>

  <!-- â‘¢ æ‰«ç ç»“æœ -->
  <view wx:if="{{lastResult}}" class="result {{lastResult.success ? 'ok' : 'err'}}">
    <view class="res-top">
      <text class="res-tag {{lastResult.success ? 'ok' : 'err'}}">{{lastResult.success ? 'æˆåŠŸ' : 'å¤±è´¥'}}</text>
      <text class="res-msg">{{lastResult.message}}</text>
      <text wx:if="{{lastResult.success && undo.canUndo}}" class="res-undo" hover-class="res-undo-hover" hover-stay-time="100" bindtap="onUndoLast">{{undo.loading ? '...' : 'æ’¤é”€'}}</text>
    </view>
    <view class="res-info">
      <text wx:if="{{lastResult.orderNo}}" class="res-order">{{lastResult.orderNo}}</text>
      <text wx:if="{{lastResult.styleNo}}" class="res-style">{{lastResult.styleNo}}</text>
      <text wx:if="{{lastResult.color}}">{{lastResult.color}}</text>
      <text wx:if="{{lastResult.size}}">{{lastResult.size}}</text>
      <text wx:if="{{lastResult.processName}}" class="res-proc">{{lastResult.processName}}</text>
      <text wx:if="{{lastResult.unitPrice != null}}" class="{{lastResult.unitPriceHint ? 'res-price-warn' : ''}}">Â¥{{lastResult.unitPrice}}{{lastResult.unitPriceHint ? ' âš ï¸' : ''}}</text>
    </view>
    <view wx:if="{{lastResult.unitPriceHint}}" class="res-hint">
      <text class="hint-icon">âš ï¸</text>
      <text class="hint-text">{{lastResult.unitPriceHint}}</text>
    </view>
  </view>

  <!-- â‘£ æ‰«ç åŒºï¼ˆä¸€è¡Œï¼šæ‰«ç ä¸»é”®ï¼‰ -->
  <view class="scan-area-big">
    <view class="scan-row">
      <view class="scan-btn-big {{loading ? 'off' : ''}}" hover-class="scan-btn-big-hover" hover-stay-time="100" bindtap="onScan">
        <text class="scan-btn-icon">ğŸ“·</text>
        <view class="scan-btn-text-group">
          <text class="scan-btn-main">{{loading ? 'è¯†åˆ«ä¸­...' : 'æ‰«ç è¯†åˆ«'}}</text>
          <text class="scan-btn-sub">è‡ªåŠ¨åŒ¹é…å·¥åº</text>
        </view>
      </view>
    </view>
    <!-- å…¥åº“æ‰«ç æ—¶æ˜¾ç¤ºä»“åº“é€‰æ‹©ï¼ˆç‹¬ç«‹ä¸€è¡Œï¼Œä¸å æ‰«ç ä¸»é”®ä½ï¼‰ -->
    <view wx:if="{{scanType === 'warehouse'}}" class="warehouse-input-row">
      <view class="warehouse-label">ç›®æ ‡ä»“åº“ï¼ˆé€‰å¡«ï¼‰ï¼š</view>
      <!-- é¢„è®¾ä»“åº“å¿«é€Ÿé€‰æ‹© -->
      <view class="warehouse-option-row">
        <view
          wx:for="{{warehouseOptions}}"
          wx:key="index"
          class="warehouse-chip {{warehouse === item ? 'warehouse-chip--active' : ''}}"
          bindtap="onWarehouseChipTap"
          data-value="{{item}}"
        >{{item}}</view>
        <view
          class="warehouse-chip warehouse-chip--clear {{warehouse ? '' : 'warehouse-chip--disabled'}}"
          bindtap="onWarehouseClear"
        >æ¸…é™¤</view>
      </view>
      <!-- è‡ªå®šä¹‰ä»“åº“ä»£ç è¾“å…¥ -->
      <input
        class="warehouse-input-field"
        placeholder="æˆ–æ‰‹åŠ¨è¾“å…¥ä»“åº“ç¼–å·"
        value="{{warehouse}}"
        bindinput="onWarehouseCodeInput"
      />
    </view>
    <view class="scan-mode-tip">
      <text>è¯´æ˜ï¼šç³»ç»Ÿä¼šæŒ‰è®¢å•å·¥åºæ¨¡æ¿ä¸å†å²æ‰«ç è‡ªåŠ¨è¯†åˆ«å½“å‰åº”æ‰§è¡Œå·¥åºï¼Œä»…å…è®¸æµè½¬åˆ°æœªå®Œæˆå·¥åºã€‚</text>
    </view>
  </view>

  <!-- â‘¤ æˆ‘çš„è£å‰ªä»»åŠ¡ -->
  <view wx:if="{{my.cuttingTasks && my.cuttingTasks.length > 0}}" class="section">
    <view class="sec-head">
      <text class="section-title">âœ‚ï¸ æˆ‘çš„è£å‰ªä»»åŠ¡</text>
    </view>
    <view wx:for="{{my.cuttingTasks}}" wx:key="id" class="procurement-task-card">
      <view class="ptc-header">
        <text class="ptc-order">è®¢å•: {{item.productionOrderNo}}</text>
        <text class="ptc-style">æ¬¾å·: {{item.styleNo}}</text>
      </view>
      <view wx:if="{{item.color}}" class="ptc-name">é¢œè‰²: {{item.color}}</view>
      <view class="ptc-footer">
        <text class="ptc-count">æ•°é‡: {{item.orderQuantity || 0}}</text>
        <view class="ptc-btn" hover-class="ptc-btn-hover" hover-stay-time="100" bindtap="onHandleCutting" data-task-id="{{item.id}}">å¼€å§‹è£å‰ª</view>
      </view>
    </view>
  </view>

  <!-- â‘¥ æˆ‘çš„é‡‡è´­ä»»åŠ¡ -->
  <view wx:if="{{my.procurementTasks && my.procurementTasks.length > 0}}" class="section">
    <view class="sec-head">
      <text class="section-title">ğŸ›’ æˆ‘çš„é‡‡è´­ä»»åŠ¡</text>
    </view>
    <view wx:for="{{my.procurementTasks}}" wx:key="orderNo" class="procurement-task-card">
      <view class="ptc-header">
        <text class="ptc-order">è®¢å•: {{item.orderNo}}</text>
        <text class="ptc-style">æ¬¾å·: {{item.styleNo}}</text>
      </view>
      <view wx:if="{{item.styleName}}" class="ptc-name">{{item.styleName}}</view>
      <view class="ptc-footer">
        <text class="ptc-count">{{item.totalCount}}é¡¹å¾…é‡‡è´­</text>
        <view class="ptc-btn" hover-class="ptc-btn-hover" hover-stay-time="100" bindtap="onHandleProcurement" data-order-no="{{item.orderNo}}">å¡«å†™æ•°é‡</view>
      </view>
    </view>
  </view>

  <!-- â‘¦ ä»Šæ—¥æ‰«ç è®°å½•ï¼ˆåªæ˜¾ç¤ºå½“å¤©ï¼‰ -->
  <view class="section">
    <view class="sec-head">
      <text class="section-title">ğŸ“‹ ä»Šæ—¥è®°å½•</text>
    </view>
    <view wx:if="{{my.groupedHistory.length === 0 && !my.loadingHistory}}" class="empty">æš‚æ— ä»Šæ—¥è®°å½•</view>

    <view wx:for="{{my.groupedHistory}}" wx:key="id" class="hist-group">
      <view class="hist-group-header" hover-class="hist-group-header-hover" hover-stay-time="100" bindtap="toggleGroupExpand" data-group-id="{{item.id}}">
        <view class="hgh-top">
          <view class="hgh-main">
            <text class="hgh-order">{{item.orderNo}}</text>
            <text class="hgh-style">{{item.styleNo}}</text>
            <text class="hgh-stage">{{item.stage}}</text>
          </view>
        </view>
        <view class="hgh-bottom">
          <text class="hgh-time">{{utils.formatRelativeTime(item.latestTime)}}</text>
          <text class="hgh-total">å…±{{item.totalQuantity}}ä»¶</text>
          <text wx:if="{{item.deliveryDateStr}}" class="hgh-delivery-tag">{{item.deliveryDateStr}}</text>
          <text wx:if="{{item.remainDaysText}}" class="delivery-days-tag {{item.remainDaysClass}}">{{item.remainDaysText}}</text>
          <text class="hgh-expand-hint">{{item.expanded ? 'æ”¶èµ·' : 'å±•å¼€'}} â€º</text>
        </view>
      </view>

      <view wx:if="{{item.expanded}}" class="hist-group-details">
        <view wx:for="{{item.items}}" wx:for-item="record" wx:for-index="recordIdx" wx:key="id" class="hist-detail-item">
          <view class="hdi-row">
            <text class="hdi-label">é¢œè‰²:</text>
            <text class="hdi-value">{{record.color || '-'}}</text>
            <text class="hdi-label">å•ä»·:</text>
            <text class="hdi-value">Â¥{{record.unitPrice || '-'}}</text>
          </view>
          <view wx:if="{{record.sizeArr && record.sizeArr.length}}" class="hdi-size-grid">
            <view class="hdi-size-row">
              <text wx:for="{{record.sizeArr}}" wx:for-item="s" wx:key="*this" class="hdi-size-cell">{{s}}</text>
            </view>
            <view class="hdi-size-row">
              <text wx:for="{{record.qtyArr}}" wx:for-item="q" wx:key="index" class="hdi-size-cell qty">{{q}}</text>
            </view>
          </view>
          <view wx:else class="hdi-row">
            <text class="hdi-label">ç æ•°:</text>
            <text class="hdi-value">{{record.size || '-'}}</text>
            <text class="hdi-label">æ•°é‡:</text>
            <text class="hdi-value">{{record.quantity || 0}}ä»¶</text>
          </view>
          <view class="hdi-row">
            <text class="hdi-time">{{record.createdAt || record.scanTime || record.time}}</text>
            <text wx:if="{{record.operatorName}}" class="hdi-operator">{{record.operatorName}}</text>
            <view wx:if="{{record.isProcurement && !record.procurementCompleted}}" class="hdi-action" hover-class="hdi-action-hover" hover-stay-time="100" bindtap="onHandleProcurement" data-group-id="{{item.id}}" data-record-idx="{{recordIdx}}">å¤„ç†</view>
            <view wx:if="{{record.isQualityReceive}}" class="hdi-action" hover-class="hdi-action-hover" hover-stay-time="100" bindtap="onHandleQuality" data-group-id="{{item.id}}" data-record-idx="{{recordIdx}}">å¤„ç†</view>
            <view wx:if="{{(record.scanResult === 'success' || record.scanResult === 'qualified') && record.canRescan}}" class="hdi-action rescan-btn" hover-class="hdi-action-hover" hover-stay-time="100" catchtap="onRescanRecord" data-group-id="{{item.id}}" data-record-idx="{{recordIdx}}" data-record="{{record}}">é€€å›é‡æ‰«</view>
          </view>
        </view>
      </view>
    </view>

    <view class="load-more" hover-class="load-more-hover" hover-stay-time="100" bindtap="loadMoreMyHistory">
      <text wx:if="{{my.loadingHistory}}">åŠ è½½ä¸­...</text>
      <text wx:elif="{{my.history.hasMore}}">åŠ è½½æ›´å¤š</text>
      <text wx:else class="no-more">â€” END â€”</text>
    </view>
  </view>

  <!-- é€€å›é‡æ‰«ç¡®è®¤å¼¹çª— -->
  <view wx:if="{{rescanConfirm.visible}}" class="modal rescan-modal">
    <view class="modal-box rescan-box">
      <view class="modal-head rescan-head">
        <text>é€€å›é‡æ‰«</text>
        <view class="modal-close" hover-class="modal-close-hover" hover-stay-time="100" catchtap="onCancelRescan">âœ•</view>
      </view>
      <view class="modal-body">
        <view class="rescan-info">
          <view class="rescan-row">
            <text class="rescan-label">è®¢å•å·</text>
            <text class="rescan-value">{{rescanConfirm.orderNo || '-'}}</text>
          </view>
          <view class="rescan-row">
            <text class="rescan-label">è²å·</text>
            <text class="rescan-value">{{rescanConfirm.bundleNo || '-'}}</text>
          </view>
          <view class="rescan-row">
            <text class="rescan-label">æ•°é‡</text>
            <text class="rescan-value">{{rescanConfirm.quantity || 0}}ä»¶</text>
          </view>
          <view class="rescan-row">
            <text class="rescan-label">æ‰«ç æ—¶é—´</text>
            <text class="rescan-value">{{rescanConfirm.scanTime || '-'}}</text>
          </view>
        </view>
        <view class="rescan-warning">
          <text class="warning-icon">âš ï¸</text>
          <text class="warning-text">ä»…å…è®¸é€€å›1å°æ—¶å†…çš„æ‰«ç è®°å½•ï¼Œé€€å›åå¯é‡æ–°æ‰«ç </text>
        </view>
      </view>
      <view class="modal-foot">
        <view class="rescan-cancel" hover-class="rescan-cancel-hover" hover-stay-time="100" catchtap="onCancelRescan">å–æ¶ˆ</view>
        <view class="rescan-confirm {{rescanConfirm.loading ? 'disabled' : ''}}" hover-class="rescan-confirm-hover" hover-stay-time="100" catchtap="onConfirmRescan">
          {{rescanConfirm.loading ? 'å¤„ç†ä¸­...' : 'ç¡®è®¤é€€å›'}}
        </view>
      </view>
    </view>
  </view>

  <!-- ğŸ†• æ‰«ç ç»“æœç¡®è®¤å¼¹çª—ï¼ˆ2026-02-06 æ··åˆæ¨¡å¼ï¼‰ -->
  <view wx:if="{{scanResultConfirm.visible}}" class="modal scan-result-modal">
    <view class="modal-box">
      <view class="modal-head">
        æ‰«ç è¯†åˆ«ç»“æœ
      </view>
      <view class="modal-body">
        <view class="scan-result-info">
          <view class="result-item">
            <text class="item-label">è®¢å•å·</text>
            <text class="item-value highlight">{{scanResultConfirm.orderNo}}</text>
          </view>
          <view wx:if="{{scanResultConfirm.bundleNo}}" class="result-item">
            <text class="item-label">è²å·</text>
            <text class="item-value">{{scanResultConfirm.bundleNo}}</text>
          </view>
          <view wx:if="{{scanResultConfirm.styleNo}}" class="result-item">
            <text class="item-label">æ¬¾å·</text>
            <text class="item-value">{{scanResultConfirm.styleNo}}</text>
          </view>
          <view class="result-item">
            <text class="item-label">æ•°é‡</text>
            <input
              class="result-qty-input"
              type="number"
              placeholder="è¯·è¾“å…¥æ•°é‡"
              value="{{scanResultConfirm.quantity}}"
              bindinput="onScanResultQuantityInput"
            />
          </view>

          <!-- å·¥åºé€‰æ‹©å™¨ï¼ˆå†…è”æ»šåŠ¨é€‰æ‹©ï¼Œç‚¹å‡»åˆ‡æ¢å·¥åºï¼‰ -->
          <view class="inline-selector process-scroll-selector">
            <view class="process-scroll-header">
              <text class="process-scroll-title">é€‰æ‹©å·¥åº</text>
              <text class="process-scroll-hint">ä¸Šä¸‹æ»‘åŠ¨é€‰æ‹©</text>
            </view>
            <scroll-view
              class="process-scroll-list"
              scroll-y="{{true}}"
              scroll-into-view="process-item-{{scanResultConfirm.processIndex}}"
              scroll-with-animation="{{true}}"
              enhanced="{{true}}"
              show-scrollbar="{{false}}">
              <view
                wx:for="{{scanResultConfirm.processOptions}}"
                wx:key="value"
                id="process-item-{{index}}"
                class="inline-selector-item {{scanResultConfirm.processIndex === index ? 'active' : ''}}"
                data-index="{{index}}"
                bindtap="onProcessScrollSelect">
                <view class="inline-selector-left">
                  <view class="inline-selector-radio {{scanResultConfirm.processIndex === index ? 'checked' : ''}}">
                    <view wx:if="{{scanResultConfirm.processIndex === index}}" class="inline-selector-radio-dot"></view>
                  </view>
                  <text class="inline-selector-label">{{item.value}}</text>
                </view>
                <text class="process-item-price">Â¥{{item.unitPrice}}</text>
              </view>
            </scroll-view>
          </view>

          <!-- æ¬¡å“è¿”ä¿®å…¥åº“æç¤º -->
          <view wx:if="{{scanResultConfirm.isDefectiveReentry}}" class="result-hint defect-hint">
            <text class="hint-icon">âš ï¸</text>
            <text class="hint-text">æ­¤è²å·æœ‰ {{scanResultConfirm.defectQty}} ä»¶æ¬¡å“ï¼Œè¿”ä¿®åç›´æ¥å…¥åº“ï¼Œå…¥åº“æ•°é‡ä¸èƒ½è¶…è¿‡æ¬¡å“æ•°</text>
          </view>
          <view wx:else class="result-hint">
            <text class="hint-icon">ğŸ’¡</text>
            <text class="hint-text">{{scanResultConfirm.scanData.qualityStage === 'confirm' ? 'å¡«å†™è´¨æ£€ç»“æœï¼Œç‚¹å‡»"å½•å…¥ç»“æœ"æäº¤' : 'ç¡®è®¤å·¥åºæ— è¯¯åï¼Œç‚¹å‡»"é¢†å–è®°å½•"æäº¤'}}</text>
          </view>
        </view>
      </view>
      <view class="modal-foot">
        <view class="modal-btn cancel" bindtap="closeScanResultConfirm">å–æ¶ˆ</view>
        <view class="modal-btn ok {{scanResultConfirm.loading ? 'loading' : ''}}" bindtap="onConfirmScanResult">
          {{scanResultConfirm.loading ? 'æäº¤ä¸­...' : (scanResultConfirm.isDefectiveReentry ? 'æ¬¡å“å…¥åº“' : (scanResultConfirm.scanData.qualityStage === 'confirm' ? 'å½•å…¥ç»“æœ' : 'é¢†å–è®°å½•'))}}
        </view>
      </view>
    </view>
  </view>

  <!-- ç¡®è®¤å¼¹çª— -->
  <view wx:if="{{scanConfirm.visible}}" class="modal">
    <view class="modal-box {{(scanConfirm.detail.isProcurement || scanConfirm.detail.isPattern) ? 'wide' : ''}}">
      <view class="modal-head">
        {{scanConfirm.detail.isPattern ? 'æ ·æ¿ç”Ÿäº§' : (scanConfirm.detail.isProcurement ? 'é¢è¾…æ–™é‡‡è´­' : 'ç¡®è®¤æäº¤')}}
        <text class="modal-cd">{{scanConfirm.remain}}s</text>
      </view>
      <view class="modal-body">
        <view wx:if="{{scanConfirm.detail}}" class="cf-list">
          <view wx:if="{{scanConfirm.detail.isPattern}}" class="cf-item"><text class="cf-k">æ¬¾å·</text><text class="cf-v hl">{{scanConfirm.detail.styleNo || '-'}}</text></view>
          <view wx:if="{{scanConfirm.detail.isPattern}}" class="cf-item"><text class="cf-k">é¢œè‰²</text><text class="cf-v">{{scanConfirm.detail.color || '-'}}</text></view>
          <view wx:if="{{scanConfirm.detail.isPattern}}" class="cf-item"><text class="cf-k">è®¾è®¡å¸ˆ</text><text class="cf-v">{{scanConfirm.detail.designer || '-'}}</text></view>
          <view wx:if="{{scanConfirm.detail.isPattern}}" class="cf-item"><text class="cf-k">çº¸æ ·å¸ˆ</text><text class="cf-v">{{scanConfirm.detail.patternDeveloper || '-'}}</text></view>
          <view wx:if="{{scanConfirm.detail.isPattern}}" class="cf-item"><text class="cf-k">äº¤æ¿æ—¥æœŸ</text><text class="cf-v">{{scanConfirm.detail.deliveryTime || '-'}}</text></view>
          <!-- åªåœ¨éé‡‡è´­ç±»å‹æ—¶æ˜¾ç¤ºäºŒç»´ç  -->
          <view wx:if="{{!scanConfirm.detail.isProcurement && !scanConfirm.detail.isPattern}}" class="cf-item"><text class="cf-k">äºŒç»´ç </text><text class="cf-v mono">{{scanConfirm.detail.scanCode}}</text></view>
          <view wx:if="{{!scanConfirm.detail.isProcurement && !scanConfirm.detail.isPattern}}" class="cf-item">
            <text class="cf-k">æ•°é‡</text>
            <text class="cf-v">{{scanConfirm.detail.quantity}}</text>
          </view>
          <view wx:if="{{scanConfirm.detail.orderNo}}" class="cf-item"><text class="cf-k">è®¢å•</text><text class="cf-v hl">{{scanConfirm.detail.orderNo}}</text></view>
          <view wx:if="{{scanConfirm.detail.styleNo}}" class="cf-item"><text class="cf-k">æ¬¾å·</text><text class="cf-v">{{scanConfirm.detail.styleNo}}</text></view>
          <view wx:if="{{scanConfirm.detail.sizeDetails}}" class="cf-item compact"><text class="cf-k">ç æ•°æ˜ç»†</text><text class="cf-v wrap">{{scanConfirm.detail.sizeDetails}}</text></view>
          <view wx:if="{{(scanConfirm.detail.processName || scanConfirm.detail.progressStage) && !scanConfirm.detail.isProcurement && !scanConfirm.detail.isPattern}}" class="cf-item"><text class="cf-k">å·¥åº</text><text class="cf-v">{{scanConfirm.detail.processName || scanConfirm.detail.progressStage}}</text></view>
        </view>

        <!-- æ ·è¡£æ“ä½œåŒºï¼ˆå¤ç”¨ scanConfirm é€šç”¨å¼¹çª—ï¼‰ -->
        <view wx:if="{{scanConfirm.detail.isPattern}}" class="purchase-modal-list">
          <view class="purchase-modal-item">
            <view class="pmi-row">
              <text class="pmi-label">é€‰æ‹©å·¥åº</text>
              <view class="inline-selector" style="margin-top: 8rpx;">
                <scroll-view class="inline-selector-list" scroll-y="{{true}}" enhanced="{{true}}" show-scrollbar="{{false}}">
                  <view
                    wx:for="{{scanConfirm.detail.operationOptions}}"
                    wx:key="value"
                    class="inline-selector-item {{scanConfirm.detail.operationType == item.value ? 'active' : ''}}"
                    data-type="{{item.value}}"
                    bindtap="onPatternOperationChange">
                    <view class="inline-selector-left">
                      <view class="inline-selector-radio {{scanConfirm.detail.operationType == item.value ? 'checked' : ''}}">
                        <view wx:if="{{scanConfirm.detail.operationType == item.value}}" class="inline-selector-radio-dot"></view>
                      </view>
                      <text class="inline-selector-label">{{item.icon || 'ğŸ§µ'}} {{item.label || item.value}}</text>
                    </view>
                  </view>
                </scroll-view>
              </view>
            </view>

            <view wx:if="{{scanConfirm.detail.requiresReviewBeforeInbound}}" class="qc-receive-tip" style="margin-top: 8rpx; background: #fff7e6; border-color: #ffd591;">
              <text class="qc-tip-text" style="color: #d46b08;">âš ï¸ å½“å‰æœªå®Œæˆæ ·è¡£å®¡æ ¸ï¼Œæœ¬æ¬¡ä¼šå…ˆæäº¤å®¡æ ¸å†æ‰§è¡Œå…¥åº“</text>
            </view>

            <view class="pmi-row pmi-row-inline">
              <view class="pmi-col">
                <text class="pmi-label">å½“å‰æ“ä½œ</text>
                <text class="pmi-value demand">{{scanConfirm.detail.operationLabel || '-'}}</text>
              </view>
              <view class="pmi-col">
                <text class="pmi-label">æ•°é‡</text>
                <input
                  class="pmi-input"
                  type="digit"
                  placeholder="è¯·è¾“å…¥æ•°é‡"
                  value="{{scanConfirm.detail.quantity}}"
                  bindinput="onPatternQuantityInput"
                />
              </view>
            </view>
          </view>

          <view wx:if="{{scanConfirm.detail.requiresWarehouseInput}}" class="pmi-row">
            <text class="pmi-label">ä»“ä½ç¼–å·</text>
            <input
              class="pmi-input"
              placeholder="ä»“åº“æ“ä½œå¿…å¡«ï¼Œä¾‹å¦‚ A-01-01"
              value="{{scanConfirm.detail.warehouseCode}}"
              bindinput="onPatternWarehouseInput"
            />
          </view>

          <view class="pmi-row">
            <text class="pmi-label">å¤‡æ³¨</text>
            <textarea
              class="pattern-remark-input"
              placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯..."
              value="{{scanConfirm.detail.remark}}"
              bindinput="onPatternRemarkInput"
              maxlength="200"
            />
          </view>
        </view>

        <!--è£å‰ªä»»åŠ¡åˆ—è¡¨ - åœ¨å¼¹çª—ä¸­æ˜¾ç¤º -->
        <view wx:if="{{!scanConfirm.detail.isPattern && scanConfirm.detail.progressStage === 'è£å‰ª' && scanConfirm.cuttingTasks && scanConfirm.cuttingTasks.length}}" class="purchase-modal-list">
          <!-- ä¸€é”®å¯¼å…¥æŒ‰é’®ï¼ˆä»…æ¥è‡ª"æˆ‘çš„ä»»åŠ¡"æ—¶æ˜¾ç¤ºï¼‰ -->
          <view wx:if="{{scanConfirm.fromMyTasks}}" class="cutting-action-bar">
            <view class="cutting-btn auto" hover-class="cutting-btn-hover" hover-stay-time="100" bindtap="onAutoImportCutting">ä¸€é”®å¯¼å…¥(20ä»¶/æ‰)</view>
            <view class="cutting-btn clear" hover-class="cutting-btn-hover" hover-stay-time="100" bindtap="onClearCuttingInput">æ¸…ç©º</view>
          </view>

          <view wx:for="{{scanConfirm.cuttingTasks}}" wx:key="index" class="purchase-modal-item">
            <view class="pmi-header">
              <text class="pmi-name">{{item.color || 'é¢œè‰²'}} - {{item.size || 'å°ºç '}}</text>
            </view>
            <view class="pmi-row pmi-row-inline">
              <view class="pmi-col">
                <text class="pmi-label">è®¡åˆ’æ•°é‡</text>
                <text class="pmi-value demand">{{item.plannedQuantity || 0}}</text>
              </view>
              <view class="pmi-col">
                <text class="pmi-label">è£å‰ªæ•°é‡</text>
                <input
                  class="pmi-input"
                  type="digit"
                  placeholder="è¯·å¡«å†™æ•°é‡"
                  value="{{item.cuttingInput}}"
                  bindinput="onModalCuttingInput"
                  data-color="{{item.color}}"
                  data-size="{{item.size}}"
                  data-idx="{{index}}"
                />
              </view>
            </view>
          </view>
        </view>

        <!-- âœ… é‡‡è´­ä»»åŠ¡ï¼šæ˜¾ç¤ºé¢æ–™é‡‡è´­æ˜ç»† -->
        <view wx:if="{{!scanConfirm.detail.isPattern && scanConfirm.detail.isProcurement && scanConfirm.materialPurchases && scanConfirm.materialPurchases.length > 0}}" class="purchase-modal-list">
          <!-- BOMå›é€€æç¤º -->
          <view wx:if="{{scanConfirm.bomFallback}}" class="bom-fallback-notice">
            <text class="bom-fallback-icon">ğŸ“‹</text>
            <text class="bom-fallback-text">å°šæœªåˆ›å»ºé‡‡è´­ä»»åŠ¡ï¼Œä»¥ä¸‹ä¸ºBOMç‰©æ–™æ¸…å•ï¼ˆä»…ä¾›å‚è€ƒï¼‰</text>
          </view>
          <!-- é¢æ–™ç»Ÿè®¡æ‘˜è¦ -->
          <view class="sku-summary">
            <view class="summary-stat">
              <text class="summary-label">{{scanConfirm.bomFallback ? 'BOMç‰©æ–™' : 'é¢æ–™æ€»æ•°'}}:</text>
              <text class="summary-value">{{scanConfirm.materialPurchases.length}}</text>
            </view>
          </view>

          <view wx:for="{{scanConfirm.materialPurchases}}" wx:key="id" class="purchase-modal-item">
            <view class="pmi-header">
              <text class="pmi-name">{{item.materialName || 'æœªå‘½å'}}</text>
              <text wx:if="{{item.materialCode}}" class="pmi-code">({{item.materialCode}})</text>
            </view>
            <view wx:if="{{item.purchaseNo}}" class="pmi-row">
              <text class="pmi-label">é‡‡è´­å•å·</text>
              <text class="pmi-value" style="font-size: 12px; color: #666;">{{item.purchaseNo}}</text>
            </view>
            <view wx:if="{{item.specifications}}" class="pmi-row">
              <text class="pmi-label">è§„æ ¼:</text>
              <text class="pmi-value">{{item.specifications}}</text>
            </view>
            <!-- é‡‡è´­æ•°é‡ä¿¡æ¯ï¼šæ¨ªå‘å¸ƒå±€ -->
            <view class="pmi-row pmi-row-inline">
              <view class="pmi-col">
                <text class="pmi-label">{{scanConfirm.bomFallback ? 'BOMç”¨é‡' : 'éœ€é‡‡è´­'}}</text>
                <text class="pmi-value demand">{{item.purchaseQuantity || 0}} {{item.unit || 'ç±³'}}</text>
              </view>
              <view wx:if="{{!scanConfirm.bomFallback}}" class="pmi-col">
                <text class="pmi-label">å·²åˆ°è´§</text>
                <text class="pmi-value">{{item.arrivedQuantity || 0}} {{item.unit || 'ç±³'}}</text>
              </view>
            </view>
            <!-- æœ¬æ¬¡åˆ°è´§è¾“å…¥ -->
            <view wx:if="{{!scanConfirm.bomFallback}}" class="pmi-row">
              <text class="pmi-label">æœ¬æ¬¡åˆ°è´§</text>
              <input
                class="pmi-input"
                type="digit"
                placeholder="æ•°é‡"
                value="{{item.inputQuantity}}"
                bindinput="onMaterialInput"
                data-id="{{item.id}}"
              />
              <text class="pmi-unit">{{item.unit || 'ç±³'}}</text>
            </view>
            <view wx:if="{{!scanConfirm.bomFallback}}" class="pmi-row">
              <text class="pmi-label">å¤‡æ³¨</text>
              <input
                class="pmi-input"
                placeholder="é€‰å¡«ï¼ˆåˆ°è´§<70%å¿…å¡«ï¼‰"
                value="{{item.remarkInput}}"
                bindinput="onMaterialRemarkInput"
                data-id="{{item.id}}"
              />
            </view>
          </view>
        </view>

        <!-- âœ… éé‡‡è´­æ¨¡å¼ï¼ˆæˆ–é‡‡è´­ä½†æ²¡æœ‰é¢æ–™æ•°æ®ï¼‰ï¼šæ˜¾ç¤º SKU åˆ—è¡¨ -->
        <view wx:if="{{!scanConfirm.detail.isPattern && scanConfirm.detail.isProcurement && scanConfirm.skuList && scanConfirm.skuList.length && (!scanConfirm.materialPurchases || scanConfirm.materialPurchases.length === 0)}}" class="purchase-modal-list">
          <!-- SKUç»Ÿè®¡æ‘˜è¦ -->
          <view wx:if="{{scanConfirm.summary}}" class="sku-summary">
            <view class="summary-stat">
              <text class="summary-label">SKUæ€»æ•°:</text>
              <text class="summary-value">{{scanConfirm.summary.totalSKUs}}</text>
            </view>
            <view class="summary-stat">
              <text class="summary-label">å·²é€‰:</text>
              <text class="summary-value">{{scanConfirm.summary.completedSKUs}}</text>
            </view>
            <view class="summary-stat">
              <text class="summary-label">è¿›åº¦:</text>
              <text class="summary-value">{{scanConfirm.summary.overallProgress}}%</text>
            </view>
          </view>

          <view wx:for="{{scanConfirm.skuList}}" wx:key="index" class="purchase-modal-item">
            <view class="pmi-header">
              <text class="pmi-name">{{item.color}} - {{item.size}}</text>
            </view>
            <view class="pmi-row pmi-row-inline">
              <view class="pmi-col">
                <text class="pmi-label">éœ€é‡‡è´­</text>
                <text class="pmi-value demand">{{item.totalQuantity || 0}}</text>
              </view>
              <view class="pmi-col">
                <text class="pmi-label">æœ¬æ¬¡é‡‡è´­</text>
                <input
                  class="pmi-input"
                  type="digit"
                  placeholder="æ•°é‡"
                  value="{{item.inputQuantity}}"
                  bindinput="onModalSkuInput"
                  data-idx="{{index}}"
                />
              </view>
            </view>
          </view>
        </view>

        <!-- é€šç”¨ SKU åˆ—è¡¨ (éé‡‡è´­ã€éè£å‰ª) -->
        <view wx:if="{{!scanConfirm.detail.isPattern && !scanConfirm.detail.isProcurement && scanConfirm.detail.progressStage !== 'è£å‰ª' && scanConfirm.skuList && scanConfirm.skuList.length}}" class="purchase-modal-list">
          <!-- âœ… æ–°å¢: SKUç»Ÿè®¡æ‘˜è¦ -->
          <view wx:if="{{scanConfirm.summary}}" class="sku-summary">
            <view class="summary-stat">
              <text class="summary-label">SKUæ€»æ•°:</text>
              <text class="summary-value">{{scanConfirm.summary.totalSKUs}}</text>
            </view>
            <view class="summary-stat">
              <text class="summary-label">å·²é€‰:</text>
              <text class="summary-value">{{scanConfirm.summary.completedSKUs}}</text>
            </view>
            <view class="summary-stat">
              <text class="summary-label">è¿›åº¦:</text>
              <text class="summary-value">{{scanConfirm.summary.overallProgress}}%</text>
            </view>
          </view>

          <view wx:for="{{scanConfirm.skuList}}" wx:key="index" class="purchase-modal-item">
            <view class="pmi-header">
              <text class="pmi-name">{{item.color}} - {{item.size}}</text>
            </view>
            <view class="pmi-row pmi-row-inline">
              <view class="pmi-col">
                <text class="pmi-label">å¾…å®Œæˆ</text>
                <text class="pmi-value demand">{{item.quantity || item.num || 0}}</text>
              </view>
              <view class="pmi-col">
                <text class="pmi-label">æœ¬æ¬¡å®Œæˆ</text>
                <input
                  class="pmi-input"
                  type="digit"
                  placeholder="æ•°é‡"
                  value="{{item.inputQuantity}}"
                  bindinput="onModalSkuInput"
                  data-idx="{{index}}"
                />
              </view>
            </view>
          </view>
        </view>

        <!-- è£å‰ªä»»åŠ¡å·²é¢†å–æç¤º -->
        <view wx:if="{{!scanConfirm.detail.isPattern && scanConfirm.detail.progressStage === 'è£å‰ª' && scanConfirm.cuttingTaskReceived}}" class="qc-receive-tip" style="background: #f6ffed; border-color: #b7eb8f;">
          <text class="qc-tip-text" style="color: #52c41a;">âœ“ ä»»åŠ¡å·²é¢†å–ï¼Œå¯ä¿®æ”¹æ•°é‡å¼€å§‹è£å‰ª</text>
        </view>

        <!-- è´¨æ£€é¢†å–æç¤º -->
        <view wx:if="{{!scanConfirm.detail.isPattern && scanConfirm.detail.isQualityReceive}}" class="qc-receive-tip">
          <text class="qc-tip-text">è¯·ç‚¹å‡»"é¢†å–"åè¿›è¡Œè´¨æ£€</text>
        </view>

        <!-- æ•°æ®è°ƒè¯•ä¿¡æ¯ï¼ˆä»…åœ¨debugæ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰ -->
        <view wx:if="{{debug}}" style="margin-top: 12px; padding: 8px; background: #f0f0f0; border-radius: 4px; font-size: 11px; color: #666;">
          <text style="display: block;">è°ƒè¯•ä¿¡æ¯:</text>
          <text style="display: block;">isProcurement: {{scanConfirm.detail.isProcurement ? 'æ˜¯' : 'å¦'}}</text>
          <text style="display: block;">fromMyTasks: {{scanConfirm.fromMyTasks ? 'æ˜¯' : 'å¦'}}</text>
          <text style="display: block;">materialPurchases: {{scanConfirm.materialPurchases.length}}æ¡</text>
          <text style="display: block;">æŒ‰é’®æ¡ä»¶: {{scanConfirm.detail.isProcurement && scanConfirm.fromMyTasks ? 'æ»¡è¶³' : 'ä¸æ»¡è¶³'}}</text>
        </view>
      </view>
      <view class="modal-btns">
        <view class="mbtn cancel" hover-class="mbtn-hover" hover-stay-time="100" bindtap="onCancelScan">å–æ¶ˆ</view>
        <!-- è£å‰ªæ¨¡å¼ï¼šæ‰«ç æ—¶åªæ˜¾ç¤º"é¢†å–ä»»åŠ¡"ï¼ˆæœªé¢†å–çŠ¶æ€ï¼‰ -->
        <view wx:if="{{!scanConfirm.detail.isPattern && scanConfirm.detail.progressStage === 'è£å‰ª' && !scanConfirm.cuttingTaskReceived && !scanConfirm.fromMyTasks}}" class="mbtn" hover-class="mbtn-hover" hover-stay-time="100" style="background: #52c41a; {{scanConfirm.loading ? 'opacity: 0.6;' : ''}}" bindtap="onReceiveOnly">
          {{scanConfirm.loading ? '...' : 'é¢†å–ä»»åŠ¡'}}
        </view>
        <!-- è£å‰ªæ¨¡å¼ï¼šæ¥è‡ª"æˆ‘çš„ä»»åŠ¡"æ˜¾ç¤º"ç¡®è®¤è£å‰ª" -->
        <view wx:if="{{!scanConfirm.detail.isPattern && scanConfirm.detail.progressStage === 'è£å‰ª' && scanConfirm.fromMyTasks}}" class="mbtn ok {{scanConfirm.loading ? 'off' : ''}}" hover-class="mbtn-hover" hover-stay-time="100" bindtap="onRegenerateCuttingBundles">
          {{scanConfirm.loading ? '...' : 'ç¡®è®¤è£å‰ª'}}
        </view>
        <!-- é‡‡è´­æ¨¡å¼ -->
        <!-- BOMå›é€€æ¨¡å¼ï¼šä»…æ˜¾ç¤ºå‚è€ƒä¿¡æ¯ï¼Œä¸å…è®¸æ“ä½œ -->
        <view wx:if="{{!scanConfirm.detail.isPattern && scanConfirm.detail.isProcurement && scanConfirm.bomFallback}}" class="mbtn" hover-class="mbtn-hover" hover-stay-time="100" style="background: #999; opacity: 0.7;" bindtap="onCancelScan">
          å…³é—­ï¼ˆè¯·å…ˆåœ¨PCç«¯åˆ›å»ºé‡‡è´­ä»»åŠ¡ï¼‰
        </view>
        <!-- æ‰«ç é¢†å–ï¼šåªæ˜¾ç¤º"é¢†å–ä»»åŠ¡"æŒ‰é’® -->
        <view wx:if="{{!scanConfirm.detail.isPattern && scanConfirm.detail.isProcurement && !scanConfirm.fromMyTasks && !scanConfirm.bomFallback}}" class="mbtn" hover-class="mbtn-hover" hover-stay-time="100" style="background: #52c41a; {{scanConfirm.loading ? 'opacity: 0.6;' : ''}}" bindtap="onReceiveOnly">
          {{scanConfirm.loading ? '...' : 'é¢†å–ä»»åŠ¡'}}
        </view>
        <!-- æ¥è‡ª"æˆ‘çš„ä»»åŠ¡"ï¼šåªæ˜¾ç¤º"ç¡®è®¤æäº¤"æŒ‰é’® -->
        <view wx:if="{{!scanConfirm.detail.isPattern && scanConfirm.detail.isProcurement && scanConfirm.fromMyTasks && !scanConfirm.bomFallback}}" class="mbtn ok {{scanConfirm.loading ? 'off' : ''}}" hover-class="mbtn-hover" hover-stay-time="100" bindtap="onSubmitProcurement">
          {{scanConfirm.loading ? '...' : 'ç¡®è®¤æäº¤'}}
        </view>
        <!-- å…¶ä»–æ¨¡å¼ -->
        <view wx:if="{{scanConfirm.detail.isPattern}}" class="mbtn {{scanConfirm.loading ? 'off' : ''}}" hover-class="mbtn-hover" hover-stay-time="100" style="background: #10b981;" bindtap="submitPatternScanAll">
          {{scanConfirm.loading ? 'æäº¤ä¸­...' : (scanConfirm.detail.operationLabel ? ('æäº¤ï¼š' + scanConfirm.detail.operationLabel) : 'ç¡®è®¤æäº¤')}}
        </view>
        <view wx:if="{{!scanConfirm.detail.isPattern && !scanConfirm.detail.isProcurement && scanConfirm.detail.progressStage !== 'è£å‰ª'}}" class="mbtn ok {{scanConfirm.loading ? 'off' : ''}}" hover-class="mbtn-hover" hover-stay-time="100" bindtap="onConfirmScan">
          {{scanConfirm.loading ? '...' : (scanConfirm.detail.isQualityReceive ? 'é¢†å–' : 'ç¡®è®¤')}}
        </view>
      </view>
    </view>
  </view>
</view>

<!-- è´¨æ£€ç»“æœå¼¹çª— -->
<view class="modal-backdrop" wx:if="{{qualityModal.show}}" catchtap="closeQualityModal"></view>
<view wx:if="{{qualityModal.show}}" class="modal-wrap quality-modal show">
  <view class="modal-container" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">è´¨æ£€ç»“æœå½•å…¥</text>
      <view class="modal-close" hover-class="modal-close-hover" hover-stay-time="100" catchtap="closeQualityModal">Ã—</view>
    </view>

    <view class="modal-body">
      <!-- è®¢å•ä¿¡æ¯ -->
      <view class="qm-info">
        <text class="qm-label">è®¢å•å·ï¼š</text>
        <text class="qm-value">{{qualityModal.detail.orderNo}}</text>
      </view>
      <view class="qm-info" wx:if="{{qualityModal.detail.bundleNo}}">
        <text class="qm-label">è²å·ï¼š</text>
        <text class="qm-value">{{qualityModal.detail.bundleNo}}</text>
      </view>
      <view class="qm-info">
        <text class="qm-label">æ¬¾å·/é¢œè‰²ï¼š</text>
        <text class="qm-value">{{qualityModal.detail.styleNo}} Â· {{qualityModal.detail.color || '-'}}</text>
      </view>
      <view class="qm-info">
        <text class="qm-label">æ•°é‡ï¼š</text>
        <text class="qm-value">{{qualityModal.detail.quantity || 1}}</text>
      </view>

      <!-- è´¨æ£€ç»“æœé€‰æ‹©ï¼ˆåˆæ ¼/ä¸åˆæ ¼ï¼‰ -->
      <view class="qm-section">
        <text class="qm-section-title">è´¨æ£€ç»“æœ <text style="color: #ef4444;">*</text></text>
        <view class="qm-radio-group">
          <view class="qm-radio {{qualityModal.result === 'qualified' ? 'active' : ''}}" bindtap="onSelectQualityResult" data-value="qualified">
            <view class="qm-radio-icon">{{qualityModal.result === 'qualified' ? 'âœ“' : ''}}</view>
            <text>åˆæ ¼</text>
          </view>
          <view class="qm-radio {{qualityModal.result === 'unqualified' ? 'active' : ''}}" bindtap="onSelectQualityResult" data-value="unqualified">
            <view class="qm-radio-icon">{{qualityModal.result === 'unqualified' ? 'âœ“' : ''}}</view>
            <text>ä¸åˆæ ¼</text>
          </view>
        </view>
      </view>

      <!-- ä¸åˆæ ¼è¯¦æƒ…ï¼ˆä»…ä¸åˆæ ¼æ—¶æ˜¾ç¤ºï¼‰ -->
      <view wx:if="{{qualityModal.result === 'unqualified'}}" class="qm-defective">
        <!-- ä¸åˆæ ¼æ•°é‡ -->
        <view class="qm-field">
          <text class="qm-field-label">ä¸åˆæ ¼æ•°é‡</text>
          <input class="qm-input" type="number" placeholder="è¯·è¾“å…¥ä¸åˆæ ¼æ•°é‡" value="{{qualityModal.unqualifiedQuantity}}" bindinput="onDefectiveQuantityInput" />
        </view>

        <!-- ç¼ºé™·åˆ†ç±» -->
        <view class="qm-field">
          <text class="qm-field-label">ç¼ºé™·åˆ†ç±» <text style="color: #ef4444;">*</text></text>
          <view class="inline-selector">
            <scroll-view class="inline-selector-list" scroll-y="{{true}}" enhanced="{{true}}" show-scrollbar="{{false}}">
              <view
                wx:for="{{defectCategories}}"
                wx:key="index"
                class="inline-selector-item {{qualityModal.defectCategory == index ? 'active' : ''}}"
                data-index="{{index}}"
                data-field="defectCategory"
                bindtap="onQmSelectorTap">
                <view class="inline-selector-left">
                  <view class="inline-selector-radio {{qualityModal.defectCategory == index ? 'checked' : ''}}">
                    <view wx:if="{{qualityModal.defectCategory == index}}" class="inline-selector-radio-dot"></view>
                  </view>
                  <text class="inline-selector-label">{{item}}</text>
                </view>
              </view>
            </scroll-view>
          </view>
        </view>

        <!-- å¤„ç†æ–¹å¼ -->
        <view class="qm-field">
          <text class="qm-field-label">å¤„ç†æ–¹å¼ <text style="color: #ef4444;">*</text></text>
          <view class="inline-selector">
            <scroll-view class="inline-selector-list" scroll-y="{{true}}" enhanced="{{true}}" show-scrollbar="{{false}}">
              <view
                wx:for="{{handleMethods}}"
                wx:key="index"
                class="inline-selector-item {{qualityModal.handleMethod == index ? 'active' : ''}}"
                data-index="{{index}}"
                data-field="handleMethod"
                bindtap="onQmSelectorTap">
                <view class="inline-selector-left">
                  <view class="inline-selector-radio {{qualityModal.handleMethod == index ? 'checked' : ''}}">
                    <view wx:if="{{qualityModal.handleMethod == index}}" class="inline-selector-radio-dot"></view>
                  </view>
                  <text class="inline-selector-label">{{item}}</text>
                </view>
              </view>
            </scroll-view>
          </view>
        </view>

        <!-- å¤‡æ³¨ -->
        <view class="qm-field">
          <text class="qm-field-label">å¤‡æ³¨</text>
          <textarea class="qm-textarea" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰" value="{{qualityModal.remark}}" bindinput="onRemarkInput" maxlength="200" />
        </view>

        <!-- ç…§ç‰‡ä¸Šä¼  -->
        <view class="qm-field">
          <text class="qm-field-label">è´¨æ£€ç…§ç‰‡ï¼ˆé€‰å¡«ï¼Œæœ€å¤š5å¼ ï¼‰</text>
          <view class="qm-images">
            <view wx:for="{{qualityModal.images}}" wx:key="index" class="qm-image-item">
              <image class="qm-image" src="{{item}}" mode="aspectFill" />
              <view class="qm-image-del" catchtap="onDeleteQualityImage" data-index="{{index}}">Ã—</view>
            </view>
            <view wx:if="{{qualityModal.images.length < 5}}" class="qm-image-upload" bindtap="onUploadQualityImage">
              <text class="qm-upload-icon">+</text>
              <text style="font-size: 10px; color: #999;">ä¸Šä¼ </text>
            </view>
          </view>
        </view>
      </view>

      <!-- æç¤ºï¼šè´¨æ£€ç»“æœæäº¤åè¯·è¿›è¡ŒåŒ…è£…å·¥åºï¼ŒåŒ…è£…å®Œæˆåæ–¹å¯å…¥åº“ -->
      <view class="qm-section">
        <view style="background:#f0f9eb;border-radius:8rpx;padding:16rpx 20rpx;color:#67c23a;font-size:24rpx;line-height:1.6;">
          <text wx:if="{{qualityModal.result === 'qualified'}}">âœ… åˆæ ¼åè¯·å®ŒæˆåŒ…è£…å·¥åºï¼Œå†ç”±ä»“åº“äººå‘˜æ‰«ç å…¥åº“</text>
          <text wx:if="{{qualityModal.result === 'unqualified'}}">âš ï¸ ä¸åˆæ ¼å“å°†è®°å½•åœ¨æ¡ˆï¼Œè¯·å®‰æ’è¿”ä¿®å¤„ç†</text>
          <text wx:if="{{!qualityModal.result}}">è¯·å…ˆé€‰æ‹©è´¨æ£€ç»“æœ</text>
        </view>
      </view>
    </view>

    <view class="modal-footer">
      <button class="modal-btn cancel" bindtap="closeQualityModal">å–æ¶ˆ</button>
      <button class="modal-btn confirm" bindtap="submitQualityResult" disabled="{{!qualityModal.result}}">
        {{qualityModal.result === 'qualified' ? 'æäº¤è´¨æ£€åˆæ ¼' : (qualityModal.result === 'unqualified' ? 'æäº¤ä¸åˆæ ¼' : 'è¯·å…ˆé€‰æ‹©ç»“æœ')}}
      </button>
    </view>
  </view>
</view>

<!-- ç‰©æ–™é‡‡è´­å¤„ç†å¼¹çª— -->
<view class="modal-backdrop" wx:if="{{procurementModal.show}}" catchtap="closeProcurementModal"></view>
<view wx:if="{{procurementModal.show}}" class="modal-wrap procurement-modal show">
  <view class="modal-container" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">ç‰©æ–™é‡‡è´­</text>
      <view class="modal-close" hover-class="modal-close-hover" hover-stay-time="100" catchtap="closeProcurementModal">Ã—</view>
    </view>

    <view class="modal-body">
      <!-- è®¢å•ä¿¡æ¯ -->
      <view class="pm-info">
        <text class="pm-label">è®¢å•å·ï¼š</text>
        <text class="pm-value">{{procurementModal.orderNo}}</text>
      </view>

      <!-- ç‰©æ–™åˆ—è¡¨ -->
      <view wx:if="{{procurementModal.materials && procurementModal.materials.length}}" class="pm-list">
        <view wx:for="{{procurementModal.materials}}" wx:key="id" class="pm-item">
          <view class="pm-item-header">
            <text class="pm-item-name">{{item.materialName || item.materialCode || 'ç‰©æ–™'}}</text>
            <text class="pm-item-unit">{{item.unit || 'ç±³'}}</text>
          </view>

          <view wx:if="{{item.purchaseNo}}" class="pm-field">
            <text class="pm-field-label">é‡‡è´­å•å·</text>
            <text class="pm-field-value" style="font-size: 12px; color: #666;">{{item.purchaseNo}}</text>
          </view>

          <view class="pm-field">
            <text class="pm-field-label">éœ€æ±‚æ•°é‡</text>
            <text class="pm-field-value demand">{{item.demandQuantity || item.purchaseQuantity || 0}}</text>
          </view>

          <view class="pm-field">
            <text class="pm-field-label">é‡‡è´­æ•°é‡</text>
            <input class="pm-input" type="digit" placeholder="è¯·å¡«å†™å®é™…é‡‡è´­æ•°é‡" value="{{item.purchaseInput}}" bindinput="onProcurementQuantityInput" data-idx="{{index}}" />
          </view>

          <view class="pm-field">
            <text class="pm-field-label">å¤‡æ³¨</text>
            <input class="pm-input" placeholder="é€‰å¡«" value="{{item.remarkInput}}" bindinput="onProcurementRemarkInput" data-idx="{{index}}" />
          </view>
        </view>
      </view>
    </view>

    <view class="modal-footer">
      <button class="modal-btn cancel" bindtap="closeProcurementModal">å–æ¶ˆ</button>
      <button class="modal-btn confirm" bindtap="submitProcurementResult">æäº¤</button>
    </view>
  </view>
</view>
<!-- éšç§ä¿æŠ¤æˆæƒå¼¹çª—ï¼ˆå¾®ä¿¡ 2023-09-15 å¼ºåˆ¶è¦æ±‚ï¼‰ -->
<privacy-dialog id="privacyDialog" />
