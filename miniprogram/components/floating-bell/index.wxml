<!-- æ‚¬æµ®é“ƒé“›ç»„ä»¶ - æ˜¾ç¤ºå¾…å¤„ç†ä»»åŠ¡å’Œç´§æ€¥äº‹ä»¶ -->
<view class="floating-bell-container">
  <!-- æ‚¬æµ®é“ƒé“›æŒ‰é’® -->
  <view class="floating-bell {{expanded ? 'expanded' : ''}}" bindtap="togglePanel" catchtouchmove="preventMove">
    <image class="bell-icon" src="/assets/icons/bell.svg" mode="aspectFit" />
    <view wx:if="{{totalCount > 0}}" class="bell-badge">{{totalCount > 99 ? '99+' : totalCount}}</view>
  </view>

  <!-- ä»»åŠ¡é¢æ¿ -->
  <view class="task-panel {{showPanel ? 'show' : ''}}">
    <view class="panel-header">
      <view class="panel-title">ğŸ“‹ å¾…å¤„ç†ä»»åŠ¡</view>
      <view class="panel-header-actions">
        <view class="refresh-btn-mini" bindtap="refreshTasks">ğŸ”„</view>
        <view class="panel-close" bindtap="closePanel">âœ•</view>
      </view>
    </view>

    <!-- åŠ è½½ä¸­ -->
    <view wx:if="{{loading}}" class="panel-loading">
      <view class="loading-spinner"></view>
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- ä»»åŠ¡å†…å®¹ -->
    <scroll-view wx:else class="panel-content" scroll-y>
      <!-- ç´§æ€¥äº‹ä»¶ -->
      <view wx:if="{{urgentEvents.length > 0}}" class="task-section">
        <view class="section-title urgent">
          <text class="section-icon">ğŸš¨</text>
          <text>ç´§æ€¥äº‹ä»¶ ({{urgentEvents.length}})</text>
        </view>
        <view
          wx:for="{{urgentEvents}}"
          wx:key="id"
          class="task-item urgent"
          bindtap="onTaskClick"
          data-task="{{item}}"
          data-type="urgent"
        >
          <view class="task-main">
            <view class="task-title">{{item.title || 'ç´§æ€¥äº‹ä»¶'}}</view>
            <view class="task-desc">{{item.description || item.orderNo}}</view>
          </view>
          <view class="task-action">
            <text class="action-text">å¤„ç†</text>
            <text class="action-arrow">â€º</text>
          </view>
        </view>
      </view>

      <!-- è£å‰ªä»»åŠ¡ -->
      <view wx:if="{{cuttingTasks.length > 0}}" class="task-section">
        <view class="section-title cutting">
          <text class="section-icon">âœ‚ï¸</text>
          <text>è£å‰ªä»»åŠ¡ ({{cuttingTasks.length}})</text>
        </view>
        <view
          wx:for="{{cuttingTasks}}"
          wx:key="id"
          class="task-item"
          bindtap="onTaskClick"
          data-task="{{item}}"
          data-type="cutting"
        >
          <view class="task-main">
            <view class="task-title">{{item.productionOrderNo || item.orderNo}}</view>
            <view class="task-desc">æ¬¾å·: {{item.styleNo}} Â· æ•°é‡: {{item.orderQuantity}}</view>
            <view class="task-time">é¢†å–äº {{item.receivedTimeText}}</view>
          </view>
          <view class="task-action">
            <text class="action-text">æŸ¥çœ‹è¯¦æƒ…</text>
            <text class="action-arrow">â€º</text>
          </view>
        </view>
      </view>

      <!-- é‡‡è´­ä»»åŠ¡ -->
      <view wx:if="{{procurementTasks.length > 0}}" class="task-section">
        <view class="section-title procurement">
          <text class="section-icon">ğŸ“¦</text>
          <text>é‡‡è´­ä»»åŠ¡ ({{procurementTasks.length}})</text>
        </view>
        <view
          wx:for="{{procurementTasks}}"
          wx:key="id"
          class="task-item"
          bindtap="onTaskClick"
          data-task="{{item}}"
          data-type="procurement"
        >
          <view class="task-main">
            <view class="task-title">{{item.orderNo}}</view>
            <view class="task-desc">ç‰©æ–™: {{item.materialName}} Â· æ•°é‡: {{item.purchaseQuantity}}{{item.unit}}</view>
            <view class="task-time">é¢†å–äº {{item.receivedTimeText}}</view>
          </view>
          <view class="task-action">
            <text class="action-text">ç¡®è®¤æäº¤</text>
            <text class="action-arrow">â€º</text>
          </view>
        </view>
      </view>

      <!-- è´¨æ£€å¾…å¤„ç† -->
      <view wx:if="{{qualityTasks.length > 0}}" class="task-section">
        <view class="section-title quality">
          <text class="section-icon">âœ…</text>
          <text>è´¨æ£€å¾…å¤„ç† ({{qualityTasks.length}})</text>
        </view>
        <view
          wx:for="{{qualityTasks}}"
          wx:key="id"
          class="task-item"
          bindtap="onTaskClick"
          data-task="{{item}}"
          data-type="quality"
        >
          <view class="task-main">
            <view class="task-title">{{item.orderNo}}</view>
            <view class="task-desc">{{item.color || '-'}} Â· {{item.size || '-'}} Â· æ•°é‡: {{item.quantity}}</view>
            <view class="task-desc" wx:if="{{item.bundleNo || item.cuttingBundleNo}}">è²å·: {{item.bundleNo || item.cuttingBundleNo}}</view>
            <view class="task-desc quality-remark" wx:if="{{item.remark}}">é—®é¢˜: {{item.remark}}</view>
            <view class="task-time">é¢†å–äº {{item.receivedTimeText}}</view>
            <view class="task-hint">âš ï¸ è¯·è”ç³»è´¨æ£€äººå‘˜é¢†å–è¿”ä¿®ä»¶</view>
          </view>
          <view class="task-action">
            <text class="action-text">å½•å…¥ç»“æœ</text>
            <text class="action-arrow">â€º</text>
          </view>
        </view>
      </view>

      <!-- å»¶æœŸè®¢å• -->
      <view wx:if="{{overdueOrders.length > 0}}" class="task-section">
        <view class="section-title overdue">
          <text class="section-icon">â°</text>
          <text>å»¶æœŸè®¢å• ({{overdueOrders.length}})</text>
        </view>
        <!-- å»¶æœŸè®¢å•ç»Ÿè®¡å¡ç‰‡ -->
        <view class="overdue-summary">
          <view class="summary-item critical" wx:if="{{overdueSummary.criticalCount > 0}}">
            <text class="summary-label">ä¸¥é‡å»¶æœŸ (>7å¤©)</text>
            <text class="summary-value">{{overdueSummary.criticalCount}}</text>
          </view>
          <view class="summary-item urgent" wx:if="{{overdueSummary.urgentCount > 0}}">
            <text class="summary-label">ç´§æ€¥å»¶æœŸ (4-7å¤©)</text>
            <text class="summary-value">{{overdueSummary.urgentCount}}</text>
          </view>
          <view class="summary-item warning" wx:if="{{overdueSummary.warningCount > 0}}">
            <text class="summary-label">è½»åº¦å»¶æœŸ (1-3å¤©)</text>
            <text class="summary-value">{{overdueSummary.warningCount}}</text>
          </view>
        </view>
        <!-- å»¶æœŸè®¢å•åˆ—è¡¨ -->
        <view
          wx:for="{{overdueOrders}}"
          wx:key="id"
          class="task-item overdue-item {{item.overdueLevel}}"
          bindtap="onTaskClick"
          data-task="{{item}}"
          data-type="overdue"
        >
          <view class="task-main">
            <view class="task-header">
              <view class="task-title">{{item.orderNo}}</view>
              <view class="overdue-badge {{item.overdueLevel}}">{{item.overdueText}}</view>
            </view>
            <view class="task-desc">
              <text>æ¬¾å·: {{item.styleNo}}</text>
              <text class="task-desc-sep">Â·</text>
              <text>{{item.factoryName}}</text>
            </view>
            <view class="task-meta">
              <text>å·¥åº: {{item.currentProcessName}}</text>
              <text class="task-desc-sep">Â·</text>
              <text>å®Œæˆ: {{item.completedQuantity}}/{{item.orderQuantity}} ({{item.completionRate}}%)</text>
            </view>
            <view class="task-progress">
              <view class="progress-bar">
                <view class="progress-fill" style="width: {{item.completionRate}}%"></view>
              </view>
            </view>
          </view>
          <view class="task-action">
            <text class="action-text">æŸ¥çœ‹</text>
            <text class="action-arrow">â€º</text>
          </view>
        </view>
      </view>

      <!-- è¶…æ—¶æé†’ -->
      <view wx:if="{{timeoutReminders.length > 0}}" class="task-section">
        <view class="section-title timeout">
          <text class="section-icon">â°</text>
          <text>è¶…æ—¶æé†’ ({{timeoutReminders.length}})</text>
        </view>
        <view
          wx:for="{{timeoutReminders}}"
          wx:key="id"
          class="task-item timeout"
          bindtap="onTaskClick"
          data-task="{{item}}"
          data-type="reminder"
        >
          <view class="task-main">
            <view class="task-title">{{item.type}} - {{item.orderNo}}</view>
            <view class="task-desc">å·²è¶…è¿‡ {{item.timeAgo}}</view>
          </view>
          <view class="task-action">
            <text class="action-text">å¤„ç†</text>
            <text class="action-arrow">â€º</text>
          </view>
        </view>
      </view>

      <!-- å¾…å®¡æ‰¹ç”¨æˆ·ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰ -->
      <view wx:if="{{isAdmin && pendingUsers.length > 0}}" class="task-section">
        <view class="section-title approval">
          <text class="section-icon">ğŸ‘¤</text>
          <text>å¾…å®¡æ‰¹ç”¨æˆ· ({{pendingUsers.length}})</text>
        </view>
        <view
          wx:for="{{pendingUsers}}"
          wx:key="id"
          class="task-item approval-item"
        >
          <view class="task-main" bindtap="onTaskClick" data-task="{{item}}" data-type="approval">
            <view class="task-title">{{item.name}}</view>
            <view class="task-desc">{{item.phone || 'æ— æ‰‹æœºå·'}} Â· {{item.timeText}}</view>
          </view>
          <view class="task-actions">
            <view class="action-btn approve-btn" catchtap="onApproveUser" data-user-id="{{item.id}}" data-action="approve">
              <text>âœ“ é€šè¿‡</text>
            </view>
            <view class="action-btn reject-btn" catchtap="onApproveUser" data-user-id="{{item.id}}" data-action="reject">
              <text>âœ— æ‹’ç»</text>
            </view>
          </view>
        </view>
      </view>

      <!-- å‘˜å·¥æ³¨å†Œå¾…å®¡æ‰¹ï¼ˆä»…ç§Ÿæˆ·ä¸»è´¦å·å¯è§ï¼‰ -->
      <view wx:if="{{isTenantOwner && pendingRegistrations.length > 0}}" class="task-section">
        <view class="section-title approval">
          <text class="section-icon">ğŸ§‘â€ğŸ­</text>
          <text>å‘˜å·¥æ³¨å†Œç”³è¯· ({{pendingRegistrations.length}})</text>
        </view>
        <view
          wx:for="{{pendingRegistrations}}"
          wx:key="id"
          class="task-item approval-item"
        >
          <view class="task-main" bindtap="onTaskClick" data-task="{{item}}" data-type="registration">
            <view class="task-title">{{item.name || item.username}}</view>
            <view class="task-desc">{{item.phone || 'æ— æ‰‹æœºå·'}} Â· {{item.timeText}}</view>
          </view>
          <view class="task-actions">
            <view class="action-btn approve-btn" catchtap="onApproveRegistration" data-user-id="{{item.id}}" data-action="approve">
              <text>âœ“ é€šè¿‡</text>
            </view>
            <view class="action-btn reject-btn" catchtap="onApproveRegistration" data-user-id="{{item.id}}" data-action="reject">
              <text>âœ— æ‹’ç»</text>
            </view>
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view wx:if="{{!hasAnyTask}}" class="empty-state">
        <text class="empty-icon">âœ…</text>
        <text class="empty-text">æš‚æ— å¾…å¤„ç†ä»»åŠ¡</text>
        <text class="empty-hint">æ‚¨çš„ä»»åŠ¡å·²å…¨éƒ¨å®Œæˆ</text>
      </view>
    </scroll-view>
  </view>

  <!-- é®ç½©å±‚ -->
  <view wx:if="{{showPanel}}" class="panel-mask" bindtap="closePanel" catchtouchmove="preventMove"></view>
</view>
