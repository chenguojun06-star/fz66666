# 系统数据稳定性优化报告

## 1. 概述
针对云端部署后出现的“数据不稳定”问题，进行了全链路排查。核心问题定位为：数据库连接池在云端环境配置不当导致连接超时、Redis 连接池过小导致高并发下获取连接等待、以及前端缺乏网络波动的容错机制。

## 2. 优化措施

### 2.1 数据库连接池优化 (HikariCP)
*   **连接超时 (connection-timeout)**：从 5s 增加到 **10s**。云端数据库（如 TDSQL-C）在网络波动时握手较慢，原配置易误判超时。
*   **泄漏检测 (leak-detection-threshold)**：从 60s 缩短到 **5s**。更灵敏地捕捉未关闭的连接（如未在 finally 中释放资源的代码），防止连接池被耗尽。
*   **连接数调整**：
    *   `maximum-pool-size`: 30 -> **20**（避免超过云数据库实例的连接数限制）。
    *   `minimum-idle`: 10 -> **5**（减少空闲连接维护开销）。

### 2.2 缓存稳定性优化 (Redis)
*   **连接池扩容 (Lettuce)**：
    *   `max-active`: 16 -> **32**（翻倍并发处理能力）。
    *   `max-wait`: 3000ms -> **5000ms**（给予更多等待时间，避免瞬间高并发抛出“无法获取连接”异常）。
*   **超时调整**：
    *   `timeout`: 3000ms -> **5000ms**（适应云端跨可用区访问延迟）。

### 2.3 前端网络容错 (Frontend Retry)
*   **超时延长**：Axios 请求超时从 15s 延长至 **30s**，适应复杂报表查询。
*   **自动重试机制**：新增了智能重试策略。
    *   **触发条件**：仅针对 `GET` 请求（幂等）或 `502/503/504` 网关错误。
    *   **策略**：默认重试 **2次**。
    *   **退避算法**：指数退避（1s -> 2s），避免雪崩效应。

## 3. 后续建议
1.  **监控**：建议在微信云托管控制台开启 Redis 和 MySQL 的慢查询日志监控。
2.  **慢接口治理**：若部分接口（如 Dashboard 统计）仍然频繁超时，需考虑后端异步化改造（返回 TaskID，前端轮询）。
