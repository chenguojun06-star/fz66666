# 进销存系统操作与逻辑指南 (Inventory System Guide)

> **版本**: 1.0
> **更新日期**: 2026-01-30
> **适用范围**: 成品进销存、面辅料进销存、样衣管理

本文档详细说明了系统最新的库存管理逻辑、操作流程以及前后端数据流转规则。

---

## 1. 核心库存体系 (Core Inventory System)

系统目前维护两套核心库存数据：

1.  **成品库存 (Finished Goods Stock)**
    *   **数据表**: `t_product_sku`
    *   **维度**: SKU (款号 + 颜色 + 尺码)
    *   **逻辑**: 实时库存，支持正负数（允许超卖或修正）。

2.  **面辅料库存 (Material Stock)**
    *   **数据表**: `t_material_stock`
    *   **维度**: 物料ID (MaterialID) 或 物料编码 + 颜色 + 尺码
    *   **逻辑**: 实时库存，记录仓库中的实际余量。

---

## 2. 成品进销存 (Finished Goods)

### 2.1 入库流程 (Inbound)
*   **场景**: 工厂生产完成，质检合格后入库。
*   **操作端**: 手机端小程序 (扫码) / PC端 (手工录入)。
*   **逻辑**:
    1.  **扫码**: 扫描菲号（包含款号、颜色、尺码信息）。
    2.  **记录**: 生成 `ProductWarehousing` 记录。
    3.  **增库存**: 系统自动调用 `ProductSkuService.updateStock`，**增加**对应 SKU 的库存。
    *   **注意**: 如果删除了入库记录，库存会自动**扣减**回滚。

### 2.2 出库流程 (Outbound)
*   **场景**: 电商发货、线下批发、调拨出库。
*   **操作端**: PC端 (成品出库页面)。
*   **逻辑**:
    1.  **制单**: 创建 `ProductOutstock` 单据，选择款号、颜色、尺码及数量。
    2.  **扣库存**: 单据保存成功后，系统自动调用 `ProductSkuService.updateStock`，**扣减**对应 SKU 的库存。
    3.  **校验**: 如果库存不足（且配置为不允许负库存），操作会被拦截。

### 2.3 查库存
*   **手机端**: “查库存”功能，扫描任意商品条码或菲号，即时显示当前 SKU 的总库存。
*   **PC端**: “成品库存”页面，支持多维度筛选和导出。

---

## 3. 面辅料进销存 (Materials & Fabrics)

### 3.1 采购入库流程 (Purchase Inbound)
*   **场景**: 采购的面料、辅料到货。
*   **操作端**: PC端 (采购管理) / 手机端 (采购收货)。
*   **逻辑**:
    1.  **收货**: 在采购单 (`MaterialPurchase`) 上更新“到货数量 (Arrived Quantity)”。
    2.  **计算差额**: 系统自动计算本次更新与上次的差额（例如：原到货0 -> 现到货100，差额+100）。
    3.  **增库存**: 系统根据差额调用 `MaterialStockService.increaseStock`，更新 `t_material_stock` 表。
    *   **修正**: 如果输入错误（如把100改成90），系统会自动**扣减** 10 个库存。

### 3.2 生产领料/出库 (Production Outbound)
*   **场景**: 生产开裁，领用面料。
*   **现状**:
    *   目前暂无“领料单”功能（待开发）。
    *   **临时方案**: 可在 PC 端“面辅料库存”页面手动调整库存，或通过“出库单”功能（已预留接口）进行扣减。

### 3.3 查库存
*   **PC端**: 新增“面辅料库存”页面，实时展示每种物料（区分颜色/规格）的 `availableQty` (可用库存)。

---

## 4. 数据一致性机制 (Data Consistency)

为保证“账实相符”，系统实现了以下机制：

1.  **事务管理**: 入库/出库记录的生成与库存变更在同一个数据库事务 (`@Transactional`) 中。如果库存更新失败，单据会自动回滚，不会出现“有单据无库存”的情况。
2.  **快照同步**: 每次修改采购单或入库单时，系统会重新计算应有的库存变更量，确保多次修改后的最终状态一致。
3.  **防止负库存**: 关键操作（如出库）会校验当前库存量（可配置）。

---

## 5. 常见问题 (FAQ)

**Q: 为什么手机扫码入库了，PC端库存没变？**
A: 请检查网络状态。如果提示成功，请刷新 PC 端页面。系统逻辑是实时同步的。

**Q: 我把采购单删除了，库存会少吗？**
A: 会。删除已到货的采购单（或入库单），系统会自动扣除这部分之前增加的库存。

**Q: 面料库存支持分缸号/批次吗？**
A: 目前版本主要支持按“颜色/规格”汇总管理。批次管理功能在后续规划中 (`t_material_batch`)。
