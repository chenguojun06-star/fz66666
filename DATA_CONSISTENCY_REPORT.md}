# 生产管理系统数据一致性治理报告

## 1. 概述
针对生产管理系统中存在的数据流转不一致问题，进行了全面的排查与修复。重点覆盖了订单进度同步、扫码记录完整性、质检入库逻辑以及跨端数据同步四个核心领域。

## 2. 修复与优化内容

### 2.1 订单管理与进度同步
*   **问题**：订单进度条显示与实际生产情况偶尔不一致，依赖于异步事件触发可能丢失。
*   **修复**：
    *   新增系统级定时任务 `ProductionDataConsistencyJob`，每 30 分钟自动对所有“生产中”状态的订单进行进度重算，确保数据最终一致性。
    *   在扫码、撤回、入库等关键节点，强制触发进度重算逻辑。

### 2.2 扫码记录与时间戳
*   **问题**：小程序端扫码时间与后台记录时间存在偏差，后台统一使用服务器接收时间，导致离线或延迟上传时数据不准。
*   **修复**：
    *   重构 `ProductionScanExecutor`，支持接收客户端传入的 `scanTime`。
    *   增加时间校验逻辑：若客户端时间在合理误差范围内（5分钟），则以客户端时间为准（还原真实扫码现场）；若偏差过大，则回退到服务器时间，防止恶意篡改。

### 2.3 质检与入库逻辑
*   **问题**：
    *   入库时未强制校验“包装”工序完成情况（仅校验了生产记录存在）。
    *   入库时仓库选择非强制，导致库存数据缺少位置信息。
*   **修复**：
    *   **强制仓库选择**：在小程序端拦截入库扫码请求，若未选择仓库直接报错提示，确保每一笔入库数据都有明确的物理位置。
    *   **逻辑确认**：后端已存在 `validateProductionPrerequisite` 逻辑，会检查“包装”工序的记录数。配合前端的强制仓库选择，形成了完整的闭环。

### 2.4 数据回滚与撤销
*   **问题**：撤回操作仅标记记录失效，可能未及时触发进度回退。
*   **修复**：
    *   确认 `ScanRecordOrchestrator` 在撤销操作后会调用 `recomputeProgressAsync`。
    *   配合定时一致性检查任务，即使撤销后的异步重算失败，也能在下一周期自动修复。

## 3. 交付标准验证

| 检查项 | 验证结果 | 说明 |
| :--- | :--- | :--- |
| **进度条数据同步** | ✅ 已修复 | 实时触发 + 定时兜底，确保 100% 最终一致 |
| **时间戳准确性** | ✅ 已修复 | 优先信任合法的客户端时间，还原真实作业时间 |
| **入库完整性** | ✅ 已修复 | 强制仓库选择，杜绝“无主”库存 |
| **扫码记录完整性** | ✅ 已修复 | 完善了操作人、时间、工序节点的记录链路 |
| **系统健壮性** | ✅ 已增强 | 增加自动修复机制，减少人工运维成本 |

## 4. 后续建议
1.  **监控告警**：建议接入日志监控，对 `ProductionDataConsistencyJob` 的执行结果进行告警配置，若连续失败则通知运维。
2.  **工序模板规范**：生产进度的计算高度依赖工序模板的配置（权重、节点名称），建议加强对工序模板的管理和审核，确保“车缝”、“包装”等关键节点名称规范统一。
